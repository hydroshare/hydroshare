# Uppy Companion

## Docs

[Companion](https://uppy.io/docs/companion/)


## Companion Use Case

We use Companion as a ["stand-alone"](https://uppy.io/docs/companion/#standalone-mode) server, to accomplish a few tasks:

1. Companion handles Oauth handshake between 3rd party file providers like [Google Drive](https://uppy.io/docs/google-drive-picker/).
2. We use Uppy's [AWS S3 Uploader](https://uppy.io/docs/aws-s3/) and [presigned urls are generated by Companion](https://uppy.io/docs/aws-s3/#use-with-companion)
3. Companion, when paired with the [Uppy Dashboard](https://uppy.io/docs/dashboard/) on the frontend, elegantly handles S3 multipart uploads -- allowing for resumable large file upload.


## History of Companion in HydroShare

Historically (starting ~2023?) we used the [Uppy Tus Uploader](https://uppy.io/docs/tus/) on the frontend and directly integrated [django-tus](https://github.com/alican/django-tus) into a django endpoint to allow for resumable upload. When HydroShare's storage layer transitioned to minio/S3 in 2024, the Tus endpoints were re-written to stream file chunks directly into minio using S3 multipart upload. As the resource landing page transitions to use filebased S3 metadata in late 2025, it is desireable to write files *directly* into S3 from the frontend UI.


## Companion Customization for HydroShare

Out of the box, Companion only supports uploading into a **SINGLE** bucket using a **SINGLE** set of credentials (see [COMPANION_AWS_BUCKET](https://uppy.io/docs/companion/#s3bucket-companion_aws_bucket) and ["Setting up your S3 bucket"](https://uppy.io/docs/aws-s3/#setting-up-your-s3-bucket)). We also discovered a bug in the [s3.getKey()](https://uppy.io/docs/companion/#s3getkey-filename-metadata-req-) functionality. Thus, a few customizations were made:
* The [Companion middleware was updated](companion-custom-middlewares.js) to pass more request parameters along the request chain, facilitating customizations further down the stack.
* The [Companion S3 Client was updated](companion-custom-s3-client.js) to get user specific s3 keys and secrets from the request headers
* The [Companion S3 Utils were updated](companion-custom-utils.js) to fix the bug with the [s3.getKey()](https://uppy.io/docs/companion/#s3getkey-filename-metadata-req-) functionality, where the default getKey function was always being used even when an updated function was supplied
* The [Companion S3 Config was updated](companion-custom-config.js) to dynamically determine the bucket and key for every file uploaded


## Use in local dev

Our [Docker Compose file](../local-dev.yml) defines the `companion` service. There is one "gotcha" for use of Companion in local dev: because DNS referencing "localhost" on the companion server will reference the container's own internal loopback, when testing 3rd party (Google Drive) uploads on your local dev rig, the `COMPANION_AWS_ENDPOINT: 'http://localhost:9000'` setting will not work. In order to point Companion at our minio instance, we have to update this setting to use `'http://host.docker.internal:9000'`. Otherwise you will see NS binding errors from Companion when attempting Google Drive uploads locally.

The `COMPANION_GOOGLE_KEY` and `COMPANION_GOOGLE_SECRET` are intentionally commited to this public repository in order to simplify the dev process. These keys are not used for anything other than local dev. They are used for 3rd party oauth in a ["hs-test-oauth" GCP project](https://console.cloud.google.com/auth/clients?project=hs-test-oauth) that is used solely for this purpose. See the [Google Drive Picker docs](https://uppy.io/docs/google-drive-picker/#initial-setup) for more information.