name: Test HydroShare Pull Requests

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: 
      - '**'
  workflow_dispatch:

jobs:
  hydroshare-pull-request-tests:

    runs-on: ubuntu-latest
    #env:
    #  COVERAGE_TOTAL: 10

    steps:
    - uses: actions/checkout@v4

    - name: Run flake8
      run: |
        python -m pip install flake8
        ./run-pylint-jenkins

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Restore cached tarball of Docker images
      id: cache-images-restore
      uses: actions/cache/restore@v4
      with:
        path: |
          /tmp/docker-cache/images.tar
        key: ${{ runner.os }}-cache-docker-images-${{ hashFiles('**/local-dev.yml') }}

    - name: Load cached images into Docker
      if: steps.cache-images-restore.outputs.cache-hit == 'true'
      run: |
        echo "Loading cached Docker images"
        if [ -f "/tmp/docker-cache/images.tar" ]; then
          docker load -i /tmp/docker-cache/images.tar
          echo "✓ Docker images loaded from cache"
          
          # Verify images were loaded
          echo "Loaded images:"
          docker images
        else
          echo "✗ No images.tar file found in cache"
        fi

    - name: Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose

    - name: Setup HydroShare
      run: |
        printf "%s\n" c | ./local-dev-first-start-only.sh

    - name: Run HydroShare Tests
      run: |
        docker exec hydroshare ./run-tests-jenkins

    - name: Save Docker images to tarball
      if: steps.cache-images-restore.outputs.cache-hit != 'true'
      run: |
        echo "No cache found, building and saving images..."
        mkdir -p /tmp/docker-cache

        # Get list of images used in the compose file
        echo "Saving Docker images:"
        IMAGES=$(docker-compose -f local-dev.yml config | grep image: | awk '{print $2}')
        echo "Images from compose file: $IMAGES"

        # also include images built in the docker-compose file
        # BUILT_IMAGES=$(docker-compose -f local-dev.yml config | grep build: | awk '{print $2}' | xargs -I {} sh -c "docker build -q {}")
        # echo "Built images: $BUILT_IMAGES"
        # IMAGES="$IMAGES $BUILT_IMAGES"
        # Add additional images to the array
        
        # Save images to a tar file
        docker save $IMAGES -o /tmp/docker-cache/images.tar
        echo "✓ Docker images saved to cache"
        
        # Verify the file was created
        ls -la /tmp/docker-cache/
        echo "Cache size:"
        du -sh /tmp/docker-cache/images.tar
    
    - name: Save tarball to GitHub cache
      if: steps.cache-images-restore.outputs.cache-hit != 'true'
      id: cache-images-save
      uses: actions/cache/save@v4
      with:
        path: |
          /tmp/docker-cache/images.tar
        key: ${{ steps.cache-images-restore.outputs.cache-primary-key }}
