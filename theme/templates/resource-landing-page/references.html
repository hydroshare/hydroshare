{% load hydroshare_tags crispy_forms_tags %}

{% if not metadata_form %}
    {% if sources or show_relations_section %}
        <div class="col-xs-12 content-block">
            <h3>References</h3>
        </div>
    {% endif %}
    {% if sources %}
        <div class="col-xs-12 content-block">
            <h4>Sources</h4>
            <table class="info-table">
                {% for source in sources %}
                    <tr>
                        <th class="dataset-label"><strong>Derived From:</strong></th>
                        <td class="dataset-details">{{ source.derived_from|urlize }}</td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    {% endif %}
    {% if show_relations_section %}
        <div class="col-xs-12 content-block">
            <h4>Relations</h4>
            <table class="info-table">
                {% for relation in relations %}
                    {% if relation.type|lower != "haspart" %}
                        <tr>
                            <th class="dataset-label"><strong>{{ relation.type }}:</strong></th>
                            <td class="dataset-details">{{ relation.value|urlize }}</td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </table>
        </div>
    {% endif %}
{% else %}
    <div class="col-xs-12 content-block">
        <h3>References</h3>
    </div>
    <div class="col-xs-12 content-block">
        <h4>Sources</h4>
        <table class="table hs-table">
            <tbody>
            {% for source in source_formset.initial %}
                <tr>
                    <th scope="row" class="dataset-label">Derived From:</th>
                    <td class="dataset-details">{{ source.derived_from|urlize }}</td>
                    <td>
                        <a data-toggle="modal" data-placement="auto" title="Edit"
                           class="glyphicon glyphicon-pencil icon-button table-icon icon-blue"
                           data-target="#edit-source-dialog{{ source.id }}"></a>
                         <a data-toggle="modal" data-placement="auto"
                           title="Remove"
                           class="glyphicon glyphicon-trash icon-button table-icon btn-remove"
                           data-target="#delete-source-element-dialog{{ source.id }}"></a>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <p><i>If the data in your resource was derived from another source or dataset, you can cite or acknowledge
            those
            references here. Click on "Add Source" and then add a full text citation to the original content, a web
            link, or text describing the source of the data.</i></p>

        <a id="add-source" class="btn btn-success" data-toggle="modal"
           data-target="#add-source-dialog"><i
                class="fa fa-plus"></i> Add Source</a>
        <span data-toggle="tooltip" data-placement="auto"
              title='If this resource was derived from another resource, click this button to create a link to the source resource from which this resource was derived. If the source resource is a HydroShare resource, you should paste in the URL to the source resource in HydroShare. If the source resource is something outside of HydroShare, you can paste in a URL or a full text citation to the external resource.'
              class="glyphicon glyphicon-info-sign text-muted"></span>
    </div>
    <div class="col-xs-12 content-block">
        <br>
        <h4>Relations</h4>
        <table class="table hs-table">
            <tbody>
            {% for relation in relation_formset.initial %}
                {% if  relation.type|lower != "haspart" %}
                    <tr>
                        <th scope="row" class="dataset-label">{{ relation.type }}:</th>
                        <td class="dataset-details">{{ relation.value|urlize }}</td>
                        <td>
                            <span data-toggle="modal" data-placement="auto" title="Edit"
                               class="glyphicon glyphicon-pencil icon-blue icon-button table-icon"
                               data-target="#edit-relation-dialog_{{ relation.id }}">
                            </span>
                            <span data-toggle="modal" data-placement="auto" title="Remove"
                               class="glyphicon glyphicon-trash table-icon icon-button btn-remove"
                               data-target="#delete-relation-element-dialog{{ relation.id }}"></span>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>

        <p><i>If this resource is related to other documents, datasets, websites, etc., you can record those
        relationships here as references. For example, if this resource is cited by a paper you published,
        select a relationship type of "Data for" and then provide a full text citation for the paper that used
        the data, including the paper's DOI encoded as an HTTP URL if available. This records that this resource
        is the data for the paper that cited it. If you enter a URL as part of the citation, it will be
        converted to an active link.</i></p>

        <a id="add-relation" class="btn btn-success" data-toggle="modal"
           data-target="#add-relation-dialog">
            <i class="fa fa-plus"></i> Add Relation</a>

        <span data-toggle="tooltip" data-placement="auto"
              title='Click this button to add a relationship to another resource, external website, or document. You can express the type of relationship and then enter a URL to the resource or website. If the related resource does not have a URL, you can paste in a full text citation.'
              class="glyphicon glyphicon-info-sign text-muted"></span>
    </div>
{% endif %}

{% if belongs_to_collections %}
    <div class="col-xs-12 content-block">
        <legend>This resource belongs to the following collections:</legend>
        <table id="collected-by-table" class="table-hover table-striped resource-custom-table" width="100%">
            <thead>
            <tr>
                <th>Title</th>
                <th>Owners</th>
                <th>Sharing Status</th>
                <th>My Permission</th>
            </tr>
            </thead>
            <tbody>
            {% for res in belongs_to_collections %}
                <tr id="{{ res.short_id }}">
                    <td>
                        {% if res|user_permission:request.user.pk|lower == "none" %}
                            <strong>{{ res.metadata.title }}</strong>
                        {% else %}
                            <strong><a href="{{ res.get_absolute_url }}"
                                       target="_blank">{{ res.metadata.title }}</a></strong>
                        {% endif %}
                    </td>
                    <td>
                        {% for owner in res.raccess.owners.all %}
                            {% if forloop.counter0 > 0 %} Â· {% endif %}
                            {% if owner.first_name %}
                                <a href='/user/{{ owner.pk }}/'
                                   target="_blank">{{ owner.first_name }} {{ owner.last_name }}</a>
                            {% else %}
                                <a href='/user/{{ owner.pk }}/'
                                   target="_blank">{{ owner.username }}</a>
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        {% if res.raccess.published %}
                            <strong class="label-public">&nbsp;Published</strong>
                        {% elif res.raccess.public %}
                            <strong class="label-public">&nbsp;Public</strong>
                        {% elif res.raccess.discoverable %}
                            <strong class="label-discoverable">
                                &nbsp;Discoverable</strong>
                        {% else %}
                            <strong class="label-private">&nbsp;Private</strong>
                        {% endif %}
                        {% if res.raccess.published %}
                            {% if "pending" in cm.doi or "failure" in cm.doi %}
                                &#8210; Note that the DOI will not be available
                                until
                                it has been registered and activated.{% endif %}
                        {% else %}
                            &{% if res.raccess.shareable %}
                            <strong style="color:#5cb85c">&nbsp;Shareable</strong>
                        {% else %}<strong style="color:#d9534f">&nbsp;Not
                                Shareable</strong>{% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if res|user_permission:request.user.pk|lower == "none" %}
                            <strong class="label-private">{{ res|user_permission:request.user.pk }}</strong>
                        {% elif res|user_permission:request.user.pk|lower == "open access" %}
                            <strong class="label-public">{{ res|user_permission:request.user.pk }}</strong>
                        {% else %}
                            {{ res|user_permission:request.user.pk }}
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endif %}