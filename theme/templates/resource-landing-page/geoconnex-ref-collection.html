{% load hydroshare_tags crispy_forms_tags %}
{% if resource_edit_mode %}
    {% load staticfiles %}
    <div class="col-xs-12 content-block" id="app-geoconnex">
        <h3>Related Geospatial Features</h3>
        <div class="row">
            <div class="col-xs-12 col-sm-6">
                <div>
                    {% if resource_edit_mode %}
                        <form action="/hsapi/_internal/{{ cm.short_id }}/relation/add-metadata/"
                            method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <section v-if="errored">
                                <p>We're sorry, we're not able to retrieve this information at the moment, please try back later</p>
                            </section>
                            
                            <section v-else>
                                <div>
                                    <v-app>
                                        <v-combobox
                                        v-model="values"
                                        :items="items"
                                        chips
                                        deletable-chips
                                        multiple
                                        outlined
                                        filled
                                        full-width="true"
                                        label="Type URI or select from Geoconnex"
                                        :disabled="loading"
                                        color="blue-grey"
                                        item-text="text"
                                        item-value="uri"
                                        :search-input.sync="search"
                                        >
                                        <template v-slot:item="data">
                                            <template v-if="typeof data.item !== 'object'">
                                            <v-list-tile-content v-text="data.item"></v-list-tile-content>
                                            </template>
                                            <template v-else>
                                                <v-list-item-content>
                                                    <v-list-item-title v-html="data.item.NAME"></v-list-item-title>
                                                    <v-list-item-subtitle v-html="data.item.relative_id"></v-list-item-subtitle>
                                                </v-list-item-content>
                                            </template>
                                        </template>
                                        <template v-slot:no-data>
                                            <v-list-item>
                                              <v-list-item-content>
                                                <v-list-item-title>
                                                  No results matching "<strong>${ search }</strong>". Press <kbd>enter</kbd> to create a new one
                                                </v-list-item-title>
                                              </v-list-item-content>
                                            </v-list-item>
                                          </template>
                                        </v-combobox>
                                        <h4 v-if="debug && values.length > 0">SELECTED VALUES</h4>
                                        
                                        <div style="border: thin solid red" v-if="debug && values.length > 0">
                                            <ul>
                                                <li v-for="value in values">${value}<hr><a :href="value.value">${value.value}</a></li>
                                            </ul>
                                        </div>
                                    </v-app>
                                </div>
                                <div v-if="loading">
                                    <p>Loading Geoconnex collection: ${currentLoading}</p>
                                </div>
                                <div v-if="errorMsg" class="alert alert-danger alert-dismissible" role="alert">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                                        aria-hidden="true">&times;</span></button>
                                    <p>${errorMsg}</p>
                                </div>
                            </section>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% block extra_css %}
        {% if resource_edit_mode %}
            <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
            <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.4.95/css/materialdesignicons.min.css" rel="stylesheet">
            <link href="{% static 'css/vuetify.min.css' %}" rel="stylesheet">
        {% endif %}
    {% endblock %}
    {% block extra_js %}
        {% if resource_edit_mode %}
            <script src="https://unpkg.com/axios@0.26.1/dist/axios.min.js"></script>
            <script src="https://unpkg.com/vuetify@2.6.4/dist/vuetify.min.js"></script>
            <script type="text/javascript" src="{% static 'js/hs-vue/geoconnex-reference-collection.js' %}"></script>
        {% endif %}
    {% endblock %}
{% else %}
    {% if show_relations_section or belongs_to_collections %}
        <div class="col-xs-12 content-block" id="app-geoconnex">
            <h3>Related Geospatial Features</h3>
        </div>
    {% endif %}
    {% if show_relations_section %}
        <div class="col-xs-12 content-block">
            <table class="table hs-table info-table">
                {% for relation in relations %}
                    {% if relation.type|lower == "relation" %}
                        <tr style="padding-bottom: 20px">
                            <td class="dataset-label" style="min-width: 100px;">
                                {{ relation.type_description }}
                            </td>
                            <td class="dataset-details">{{ relation.value|urlize }}</td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </table>
        </div>
    {% endif %}
{% endif %}