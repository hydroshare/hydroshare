{% load hydroshare_tags crispy_forms_tags staticfiles %}

{% block extra_css %}
<link rel='stylesheet' type='text/css' href="{% static 'css/geoconnex.css' %}">
{% endblock %}

{% if resource_edit_mode or generic_relations %}
    <div class="col-xs-12 content-block" id="app-geoconnex">
        <h3>Related Geospatial Features</h3>
        <label>This HydroShare resource is related to the following geospatial features
            <span v-show="resMode=='Edit'" data-toggle="tooltip" data-placement="auto"
            title='Use this section to add persistent identifiers pointing at related geospatial features.'
            class="glyphicon glyphicon-info-sign text-muted">
            </span>
        </label>
        <div id="geoconnex-message-wrapper" v-if="resMode=='Edit'">
            <div class="alert alert-info alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">Ã—</span>
                </button>
                <div class="flex">
                    <i class="glyphicon glyphicon-info-sign"></i>
                    <em style="padding-right:20px;">
                        If this resource is related to other geospatial resources, you can record those relationships by adding the items here.
                        <strong><a href="https://geoconnex.internetofwater.dev/" target="_blank">Geoconnex</a></strong>,
                        a project of the <strong><a href="https://internetofwater.org/" target="_blank">Internet of Water</a></strong>,
                        provides collections of reference resources within the United States that might overlap with your resource.
                        For example, if this resource has spatial extent contained within an Eight-digit Hydrologic Subbasin, you could search the "HU08" collection <strong><span :style="`color: ${searchColor}`">(step #1)</span></strong>.
                        Once you found the specific related item, you could select it <strong><span :style="`color: ${selectColor}`">(step #2)</span></strong>, adding it to you resource metadata.
                        A reference can alternatively be created by typing a URL that links to the related geospatial resource.
                        If you enter a URL, it will be converted to an active link. Adding these relations improves discoverability of your resource and contributes to
                        <strong><a href="https://www.go-fair.org/fair-principles/" target="_blank">FAIR Data</a></strong>.
                    </em>
                </div>
            </div>
            <div v-if="!resSpatialType && resMode=='Edit'" class="alert alert-warning alert-dismissible" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
                <p>We highly recommend that you add Spatial Coverage to this resource before searching for related geospatial items. Otherwise query times can be excessive.</p>
            </div>
            <div v-for="messageObj in appMessages" :class="'alert alert-dismissible alert-' + messageObj.level" role="alert">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
                <p>${ messageObj.message }</p>
            </div>
        </div>
        <v-app>
            <div class="container">
                <div class="row">
                    {% if resource_edit_mode %}
                        <div class="col-xs-12">
                            <!-- TODO: reduce size of collection box so it doesn't look like you should add more -->
                            <!-- TODO: perhaps multiple columns? -->
                            <v-autocomplete
                                :menu-props="{closeOnClick: true, closeOnContentClick: true}"
                                :readonly="lockCollections"
                                v-model="selectedCollections"
                                :items="collections"
                                :item-text="item => item.description"
                                :hide-no-data="!collectionTypeahead"
                                multiple
                                placeholder="Type to narrow down options or select from the list"
                                :label="limitToSingleCollection ? '1. Choose a collection to search' : '1. Choose collections to search'"
                                :disabled="loadingCollections"
                                :loading="loadingCollections"
                                outlined
                                :color="searchColor"
                                :item-color="searchColor"
                                :search-input.sync="collectionTypeahead"
                                return-object="true">
                                    <template v-slot:item="data">
                                        <template v-if="typeof data.item !== 'object'">
                                            <v-list-tile-content v-text="data.item"></v-list-tile-content>
                                        </template>
                                        <template v-else>
                                            <v-list-item-content>
                                                <v-list-item-title v-html="`${data.item.description} (${data.item.id})`"></v-list-item-title>
                                            </v-list-item-content>
                                        </template>
                                    </template>
                                    <template v-slot:no-data>
                                        <v-list-item>
                                            <v-list-item-content>
                                                <v-list-item-title>
                                                    No collections matching "<strong>${ collectionTypeahead }</strong>".
                                                </v-list-item-title>
                                            </v-list-item-content>
                                        </v-list-item>
                                    </template>
                                    <template v-slot:selection="{ attrs, item, parent, selected }">
                                        <v-chip v-bind="attrs" :input-value="selected" :color="searchColor" label outlined large>
                                            <span class="text-truncate">
                                                ${ item.description }
                                            </span>
                                        <span @click.stop="parent.selectItem(item)" class="glyphicon glyphicon-remove-circle text-muted"></span>
                                        </v-chip>
                                    </template>
                            </v-autocomplete>
                            <p v-show="items.length == limitNumberOfItemsPerRequest" class="small text-muted negative-top">
                                <span v-show="items.length == limitNumberOfItemsPerRequest" data-toggle="tooltip" data-placement="auto"
                                :title="`The collection you selected contains more than ${limitNumberOfItemsPerRequest}`"
                                class="glyphicon glyphicon-exclamation-sign text-muted"
                                :style="`color: ${infoColor}`">
                                </span>
                                The collection you selected contains more than the limit (${limitNumberOfItemsPerRequest} items).
                                We recommend that you reduce your resource spatial extent. Or clear the collections and point search by clicking on the map.
                            </p>
                            <v-combobox
                                v-model="selectedReferenceItems"
                                :class="{
                                    'col-xs-12 col-md-8': resMode === 'View', 
                                    'col-xs-12': resMode === 'Edit',
                                    'opaque': !hasSearches && selectedReferenceItems.length === 0
                                }" 
                                :items="items"
                                hide-no-data
                                allow-overflow="false"
                                chips
                                deletable-chips
                                multiple
                                outlined
                                hide-selected
                                :hide-no-data="!itemTypeahead"
                                label="2. Select related items to add to resource metadata"
                                placeholder="Type to narrow down options or select on the map"
                                :disabled="loadingCollections"
                                :loading="loadingRelations"
                                :color=selectColor
                                :search-input.sync="itemTypeahead"
                                :rules="rules"
                                return-object="true">
                                <template v-slot:item="data">
                                    <template v-if="typeof data.item !== 'object'">
                                        <v-list-tile-content v-text="data.item"></v-list-tile-content>
                                    </template>
                                    <template v-else>
                                        <v-list-item-content>
                                            <v-list-item-title v-html="data.item.NAME"></v-list-item-title>
                                            <v-list-item-subtitle v-html="data.item.relative_id"></v-list-item-subtitle>
                                        </v-list-item-content>
                                    </template>
                                </template>
                                <template v-slot:no-data>
                                    <v-list-item>
                                        <v-list-item-content>
                                            <v-list-item-title>
                                                No results matching "<strong>${ itemTypeahead }</strong>". 
                                                Press <kbd>enter</kbd> to add <v-chip :color=selectColor outlined><strong>${ itemTypeahead }</strong></v-chip> as a custom item.
                                            </v-list-item-title>
                                        </v-list-item-content>
                                    </v-list-item>
                                </template>
                                <template v-slot:selection="{ attrs, item, parent, selected }">
                                    <v-chip v-bind="attrs" :input-value="selected" :color=selectColor outlined>
                                        <span class="text-truncate">
                                            ${ item.text }
                                        </span>
                                      <span @click.stop="parent.selectItem(item)" class="glyphicon glyphicon-remove-circle text-muted"></span>
                                    </v-chip>
                                </template>
                            </v-combobox>
                            <p v-show="hasSearches" class="small text-muted negative-top">
                                <span v-if="hasSearches" data-toggle="tooltip" data-placement="auto"
                                title='Options in the above dropdown list have been filtered to only contain features that have been mapped in your searches'
                                class="glyphicon glyphicon-exclamation-sign text-muted"
                                :style="`color: ${infoColor}`">
                                </span>
                                Related item options have been limited to collection ${ selectedCollections.length > 1 ? "s" : "" } you selected above
                                <!-- TODO: this overlaps with URI warning -->
                            </p>
                            <div v-if="loadingCollections">
                                <p v-if="resMode=='Edit' && loadingCollections"><b>Loading Geoconnex collection:</b> ${searchingDescription}</p>
                                <p v-else>Loading Geoconnex relations...</p>
                            </div>
                            <v-progress-linear
                                :active="true"
                                v-if="searchingDescription || loadingCollections"
                                indeterminate
                            ></v-progress-linear>
                            <div v-if="searchingDescription">
                                <p><b>Searching Geoconnex collection:</b> ${searchingDescription}</p>
                            </div>
                            <div id="geoconnex-controls" class="flex">
                                <div v-show="!showingMap">
                                    <button :loading="searchingDescription" @click="toggleMapVisibility" class="btn btn-default" depressed small>
                                        <i class="fa fa-globe"></i>Select With Map
                                    </button>
                                    <span data-toggle="tooltip" data-placement="auto"
                                    title='Shows additional map that you can use to query and view related geospatial features'
                                    class="glyphicon glyphicon-info-sign text-muted">
                                    </span>
                                </div>
                                <button v-if="showingMap" @click="toggleMapVisibility" class="btn btn-default">
                                    <i class="fa fa-minus"></i>Hide Map
                                </button>
                            </div>
                        </div>
                    {% else %}
                        <div class="col-xs-12 col-md-4 info-table-wrapper" v-if="!loadingCollections && selectedReferenceItems.length > 0">
                            <table class="table hs-table info-table">
                                <tr v-for="value in selectedReferenceItems" style="padding-bottom: 20px">
                                    <td v-if="isUrl(value.value)" class="dataset-details">
                                        <a v-if="isUrl(value.value)" target="_blank" :href="value.value"> ${value.text}</a>
                                        <i class="fa fa-external-link"></i>
                                    </td>
                                    <td v-else class="dataset-details">${value.text}</td>
                                </tr>
                            </table>
                        </div>
                    {% endif %}
    
                    <div 
                        id="geoconnex-map-wrapper"
                        :class="{
                            'col-xs-12 col-md-8': resMode === 'View', 
                            'col-xs-12': resMode === 'Edit',
                            'opaque': !hasSearches && selectedReferenceItems.length === 0
                        }" 
                        v-show="showingMap" 
                    >
                        <div id="geoconnex-leaflet"></div>
                        <p v-if="resMode === 'Edit'" id="geoconnex-leaflet-info" class="small text-muted">Click a location to search for overlapping features, or select a feature for more info</p>
                    </div>
                </div>
            </div>

        </v-app>
    </div>
{% endif %}

{% block extra_js %}
    <script defer src="https://unpkg.com/axios@0.26.1/dist/axios.min.js"></script>
    <script defer src="https://unpkg.com/vuetify@2.6.4/dist/vuetify.min.js"></script>
    <script defer type="text/javascript" src="{% static 'js/hs-vue/geoconnex-reference-collection.js' %}"></script>
{% endblock %}