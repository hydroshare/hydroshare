{% extends "pages/page.html" %}
{% load geoanalytics_tags pages_tags mezzanine_tags keyword_tags comment_tags hydroshare_tags %}

{% block main %}



    <div class="collaborate-header">
        <div class="container">
            <div class="row">
                <div class="col-sm-12">
                    <div class="collaborate-nav">
                        <a href="{% url "collaborate" %}" class="collaborate-nav-item">Find Groups</a>
                        <a href="{% url "my_groups" %}" class="collaborate-nav-item">My Groups</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            {% if profile_user.is_group_owner or profile_user.is_group_editor %}
                {% if not group.gaccess.active %}
                    <div class="alert alert-warning alert-dismissible" role="alert">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        This group is set to <strong>inactive.</strong> Only owners of the group have access. Resources
                        cannot
                        be shared with the group and other users cannot be invited.
                        <hr>
                        <span class="glyphicon glyphicon-question-sign"></span>
                        <small> Click on the edit button ( <span class="glyphicon glyphicon-pencil"></span> ) below to
                            if
                            you want to make the group active again.
                        </small>
                    </div>
                {% endif %}
            {% endif %}
            <div class="col-sm-3">
                {#  Group Picture #}
                {% if group.gaccess.picture and group.gaccess.picture.url %}
                    <div class="group-image-wrapper group-image-wrapper-medium">
                        <div class="group-image" style="background-image: url({{ group.gaccess.picture.url }})"></div>
                    </div>

                {% else %}
                    <div class="group-image-wrapper group-image-wrapper-medium">
                        <div class="group-image group-preview-image-default"
                             style="background-image: url({{ STATIC_URL }}img/home-page/step4.png)"></div>
                    </div>
                {% endif %}
                </div>

            <div class="col-sm-7">
                <h2 class="group-title">{{ group.name }}</h2>
                <h4 class="text-muted">{{ group.gaccess.purpose }}</h4>

                <p>{{ group.gaccess.description }}</p>
            </div>


            {% if profile_user.is_group_owner or profile_user.is_group_editor or profile_user.is_group_viewer %}
                <div class="col-sm-2">
                    {% if profile_user.is_group_owner or profile_user.is_group_editor %}
                        <a href="#" id="btn-edit-group" data-toggle="modal" data-target="#edit-group-dialog">
                            <span class="glyphicon glyphicon-pencil icon-blue icon-button" data-toggle="tooltip" data-placement="auto" title="Edit Group"></span></a>
                    {% endif %}

                    <a href="#" id="btn-leave-group" data-toggle="modal" data-target="#leave-group-dialog">
                        <span class="glyphicon glyphicon-hand-left btn-remove icon-button" data-toggle="tooltip" data-placement="auto" title="Leave Group"></span></a>
                </div>
            {% endif %}
        </div>

        <div class="full-width-tabs-container" id="user-profile-tabs">
            <!-- Nav tabs -->
            <ul class="nav nav-tabs full-width-tabs" role="tablist">
                <li role="presentation" class="active">
                    <a href="#overview" aria-controls="overview" role="tab"
                       data-toggle="tab"><i class="glyphicon glyphicon-list-alt"></i> OVERVIEW</a></li>
                {% if profile_user.is_group_owner or profile_user.is_group_editor or profile_user.is_group_viewer %}
                <li role="presentation">
                    <a href="#resources" aria-controls="resources" role="tab" data-toggle="tab">
                        <i class="glyphicon glyphicon-file"></i> Resources</a>
                </li>
                {% endif %}

                {% if profile_user.is_group_owner or profile_user.is_group_editor or profile_user.is_group_viewer or group.gaccess.public%}
                <li role="presentation">
                    <a href="#members" aria-controls="members" role="tab" data-toggle="tab">
                        <i class="glyphicon glyphicon-user"></i> MEMBERS</a>
                </li>
                {% endif %}
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane fade in active" id="overview">
                    <div class="row">
                        <div class="col-sm-12">
                        {% if profile_user.is_group_owner or profile_user.is_group_editor or profile_user.is_group_viewer %}
                            <h4>Recent Activity</h4>
                            {% if group_resources %}
                                {% for res in group_resources %}
                                    <div class="group-activity-block activity-block">
                                        {% if res.grantor.userprofile.picture and res.grantor.userprofile.picture.url %}
                                            <div style="background-image: url('{{ res.grantor.userprofile.picture.url }}');"
                                                 class="profile-pic-thumbnail round-image pull-left">
                                            </div>
                                        {% else %}
                                            <div class="profile-pic-thumbnail round-image user-icon"></div>
                                        {% endif %}
                                        <div>
                                            <h5 class="text-muted pull-right">{{ res.date_granted }}</h5>
                                            <div class="shared-resource-info">
                                                <strong><a>{{ res.grantor|contact|safe }}</a></strong><span class="text-muted"> shared</span>
                                                <span><a href="{{ res.get_absolute_url }}">{{ res.metadata.title }}</a></span>
                                            </div>
                                            <h5><span class="text-muted">Resource type: </span>{{ res|resource_type }}
                                            </h5>

                                        </div>

                                        {% if res.metadata.description %}
                                            <div class="activity-description col-sm-12" style="max-height: 50px;">
                                                <p class="description"><strong>ABSTRACT: </strong>
                                                </p> {{ res.metadata.description|linebreaks }}
                                            </div>
                                            <div class="show-more-btn btn-default" title="Show less">···</div>
                                        {% endif %}
                                    </div>
                            {% endfor %}
                                {% else %}
                                <i>No recent activity.</i>
                            {% endif %}
                        {% else %}
                            {% if group.gaccess.active %}
                            <h4><i>You are not a member of this group.</i></h4>
                            {% if group.join_request_waiting_user_action %}
                                <div class="request-block pull-left">
                                    <span class="flag-joined">You have been invited to join!</span>
                                    <br><br>
                                    <div class="height-fix">
                                        <form class="act-on-request height-fix"
                                              action="/hsapi/_internal/act-on-group-membership-request/{{ group.join_request.id }}/accept/"
                                              method="POST">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success"
                                                    data-user-action="Accept">Accept
                                            </button>
                                        </form>

                                        <form class="act-on-request height-fix"
                                              action="/hsapi/_internal/act-on-group-membership-request/{{ group.join_request.id }}/reject/"
                                              method="POST">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-default">
                                                Decline
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% elif group.join_request_waiting_owner_action %}
                                <h4 class="flag-joined"><span class="glyphicon glyphicon-send"></span> Request Sent</h4>
                            {% else %}
                                <form id="join-{{ group.id }}" method="post"
                                      action="/hsapi/_internal/make-group-membership-request/{{ group.id }}/">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary" role="button">Ask to join</button>
                                </form>
                            {% endif %}
                                {% else %}
                                <h4><i>This group is currently inactive.</i></h4>
                            {% endif %}
                        {% endif %}
                        </div>
                    </div>
                </div>

                <div role="tabpanel" class="tab-pane fade" id="members">
                    <div class="row">
                        <div class="col-sm-12 col-md-3">
                            {% if profile_user.is_group_owner %}
                                {% if group.gaccess.active %}
                                    <div class="text-center">
                                        <a href="#" class="btn btn-primary" role="button" data-toggle="modal"
                                           data-target="#invite-dialog">Invite People</a></div>
                                    <br>
                                {% endif %}
                            {% endif %}
                            <table id="members-filter" class="table-user-contributions table table-hover">
                                <tbody>
                                    <tr class="active" data-filter-by="all">
                                        <td><span>All</span></td>
                                        <td><span class="badge" data-filter-by='All'>0</span></td>
                                    </tr>
                                     <tr data-filter-by="edit-user">
                                        <td><span>Owners</span></td>
                                        <td><span class="badge" data-filter-by='Owners'>0</span></td>
                                    </tr>
                                    <tr data-filter-by="pending">
                                        <td><span>Pending</span></td>
                                        <td><span class="badge" data-filter-by='Pending'>0</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-sm-12 col-md-9">
                            {#  All members #}
                            <table data-edit-count="{{ edit_users|length }}"
                                   data-view-count="{{ view_users|length }}"
                                   data-pending-count="{{ group.gaccess.group_membership_requests|length }}"
                                   id="all-members-table" class="table-members-list active">

                                {% for owner in group.gaccess.owners %}
                                    <tr data-filter-by="edit-user">
                                        <td>
                                            {% if  owner.userprofile.picture and owner.userprofile.picture.url %}
                                                <div style="background-image: url('{{ owner.userprofile.picture.url }}');"
                                                     class="profile-pic-thumbnail round-image pull-left">
                                                </div>
                                            {% else %}
                                                <div class="profile-pic-thumbnail-small round-image user-icon"></div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <h4><strong><a>{{ owner|contact|safe }}</a></strong></h4>
                                            {% if  owner.userprofile.title %}<span class="text-muted">{{ owner.userprofile.title }}</span>{% endif %}
                                        </td>

                                        <td>
                                            {% if profile_user.is_group_owner and group.gaccess.active or profile_user.is_group_editor and group.gaccess.active %}
                                                <div class="dropdown custom-dropdown">
                                                    <button class="btn btn-default dropdown-toggle" type="button"
                                                            id="roleDropDown-{{ member.id }}" data-toggle="dropdown"
                                                            aria-haspopup="true"
                                                            aria-expanded="true">
                                                        Owner
                                                        <span class="caret"></span>
                                                    </button>
                                                    <ul class="dropdown-menu"
                                                        aria-labelledby="roleDropDown-{{ member.id }}">
                                                        <li>
                                                            <form action="/hsapi/_internal/share-group-with-user/{{ group.id }}/{{ owner.id }}/owner/">
                                                                {% csrf_token %}
                                                                <a href="#" class="btn-share-group" data-role="Owner">Owner</a>
                                                            </form>
                                                        </li>
                                                        <li>
                                                            <form action="/hsapi/_internal/share-group-with-user/{{ group.id }}/{{ owner.id }}/view/">
                                                                {% csrf_token %}
                                                                <a href="#" class="btn-share-group" data-role="Member">Member</a>
                                                            </form>
                                                        </li>
                                                        <li role="separator" class="divider"></li>
                                                        <li>
                                                            <form action="/hsapi/_internal/unshare-group-with-user/{{ group.id }}/{{ owner.id }}/">
                                                                {% csrf_token %}
                                                                <a href="#" class="btn-unshare-group">Expel</a>
                                                            </form>
                                                        </li>
                                                    </ul>
                                                </div>
                                            {% else %}
                                                Owner
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}

                                {#  Template to generate subsequent rows after accepting join request   #}
                                <tr data-filter-by="view-user" id="templateRow">
                                    <td>
                                        <h4><strong><a data-id="name"></a></strong></h4>
                                        <span class="text-muted" data-id="title"></span>
                                    </td>
                                    <td>
                                        <div class="dropdown custom-dropdown">
                                            <button class="btn btn-default dropdown-toggle" type="button"
                                                    data-toggle="dropdown" aria-haspopup="true"
                                                    aria-expanded="true">
                                                Member
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <form action="/hsapi/_internal/share-group-with-user/{{ group.id }}/member_id/owner/">
                                                        {% csrf_token %}
                                                        <a href="#" class="btn-share-group"
                                                           data-role="Owner">Owner</a>
                                                    </form>
                                                </li>
                                                <li>
                                                    <form action="/hsapi/_internal/share-group-with-user/{{ group.id }}/member_id/view/">
                                                        {% csrf_token %}
                                                        <a href="#" class="btn-share-group"
                                                           data-role="Member">Member</a>
                                                    </form>
                                                </li>
                                                <li role="separator" class="divider"></li>
                                                <li>
                                                    <form action="/hsapi/_internal/unshare-group-with-user/{{ group.id }}/member_id/">
                                                        {% csrf_token %}
                                                        <a href="#" class="btn-unshare-group">Expel</a>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>

                                    </td>
                                </tr>

                                {% for member in view_users %}
                                    <tr data-filter-by="view-user">
                                        <td>
                                            {% if member.userprofile.picture and member.userprofile.picture.url %}
                                                <div style="background-image: url('{{ member.userprofile.picture.url }}');"
                                                     class="profile-pic-thumbnail round-image pull-left">
                                                </div>
                                            {% else %}
                                                <div class="profile-pic-thumbnail-small round-image user-icon"></div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <h4><strong><a>{{ member|contact|safe }}</a></strong></h4>
                                            {% if  member.userprofile.title %}
                                                <span class="text-muted">{{ member.userprofile.title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if profile_user.is_group_owner and group.gaccess.active or profile_user.is_group_editor and group.gaccess.active %}
                                            <div class="dropdown custom-dropdown">
                                                <button class="btn btn-default dropdown-toggle" type="button"
                                                        id="roleDropDown-{{ member.id }}" data-toggle="dropdown"
                                                        aria-haspopup="true"
                                                        aria-expanded="true">
                                                    Member
                                                    <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu"
                                                    aria-labelledby="roleDropDown-{{ member.id }}">
                                                    <li>
                                                        <form action="/hsapi/_internal/share-group-with-user/{{ group.id }}/{{ member.id }}/owner/">
                                                            {% csrf_token %}
                                                            <a href="#" class="btn-share-group" data-role="Owner">Owner</a>
                                                        </form>
                                                    </li>
                                                    <li>
                                                        <form action="/hsapi/_internal/share-group-with-user/{{ group.id }}/{{ member.id }}/view/">
                                                            {% csrf_token %}
                                                            <a href="#" class="btn-share-group" data-role="Member">Member</a>
                                                        </form>
                                                    </li>
                                                    <li role="separator" class="divider"></li>
                                                    <li>
                                                        <form action="/hsapi/_internal/unshare-group-with-user/{{ group.id }}/{{ member.id }}/">
                                                            {% csrf_token %}
                                                            <a href="#" class="btn-unshare-group">Expel</a>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </div>
                                            {% else %}
                                            Member
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </table>

                            {#  Pending invitation requests #}
                            <table data-filter-by="pending" class="table-members-list">
                            {% if group.gaccess.group_membership_requests %}
                                {% for pendingrequest in group.gaccess.group_membership_requests %}
                                    {% if not pendingrequest.invitation_to %}
                                    <tr>
                                        <td data-id="picture">
                                            {% if pendingrequest.request_from.userprofile and pendingrequest.request_from.userprofile.picture.url %}
                                                <div style="background-image: url('{{ pendingrequest.request_from.userprofile.picture.url }}');"
                                                     class="profile-pic-thumbnail round-image pull-left">
                                                </div>
                                            {% else %}
                                                <div class="profile-pic-thumbnail-small round-image user-icon"></div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <h4><strong><a
                                                    href="#">{{ pendingrequest.request_from|best_name }}</a></strong>
                                            </h4>
                                            {% if  pendingrequest.request_from.userprofile.title %}
                                                <span class="text-muted">{{ pendingrequest.request_from.userprofile.title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if profile_user.is_group_owner or profile_user.is_group_editor %}
                                                <form action="/hsapi/_internal/act-on-group-membership-request/{{ pendingrequest.id }}/accept/">
                                                    {% csrf_token %}
                                                    <a href="#" class="btn btn-success btn-act-on-request"
                                                       data-user-action="Accept"
                                                       data-member-id="{{ pendingrequest.request_from.id }}"
                                                       data-name="{{ pendingrequest.request_from|best_name }}"
                                                       data-title="{% if pendingrequest.request_from.userprofile.title %}{{ pendingrequest.request_from.userprofile.title }}{% endif %}"><span
                                                            class="glyphicon glyphicon-ok"></span>&nbsp;Accept</a>
                                                </form>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if profile_user.is_group_owner or profile_user.is_group_editor %}
                                                <form action="/hsapi/_internal/act-on-group-membership-request/{{ pendingrequest.id }}/reject/">
                                                    {% csrf_token %}
                                                    <a href="#" class="btn btn-default btn-act-on-request"
                                                       data-user-action="Reject"><span
                                                            class="glyphicon glyphicon-remove"></span>&nbsp;Reject</a>
                                                </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                        <tr>
                                            <td data-id="picture">
                                                {% if pendingrequest.invitation_to.userprofile and pendingrequest.invitation_to.userprofile.picture.url %}
                                                    <div style="background-image: url('{{ pendingrequest.invitation_to.userprofile.picture.url }}');"
                                                         class="profile-pic-thumbnail round-image pull-left">
                                                    </div>
                                                {% else %}
                                                    <div class="profile-pic-thumbnail-small round-image user-icon"></div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <h4><strong><a
                                                        href="#">{{ pendingrequest.invitation_to|best_name }}</a></strong>
                                                </h4>
                                                {% if  pendingrequest.invitation_to.userprofile.title %}
                                                    <span class="text-muted">{{ pendingrequest.invitation_to.userprofile.title }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if profile_user.is_group_owner or profile_user.is_group_editor %}
                                                    <form action="/hsapi/_internal/act-on-group-membership-request/{{ pendingrequest.id }}/reject/">
                                                        {% csrf_token %}
                                                        <a href="#" class="btn btn-default btn-act-on-request">Cancel Invitation</a>
                                                    </form>
                                                {% endif %}
                                            </td>
                                            <td>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                                {% else %}
                                <tr class="no-pending-requests"><td><i>No pending requests.</i></td></tr>
                            {% endif %}
                            </table>
                        </div>
                    </div>
                </div>

                {% if profile_user.is_group_owner or profile_user.is_group_editor or profile_user.is_group_viewer %}
                    <div role="tabpanel" class="tab-pane fade" id="resources">
                     <div class="row">
                        <div class="col-lg-2" id="facets">
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <span class="glyphicon glyphicon glyphicon-user"></span>
                                        <a data-toggle="collapse" class="accordion-toggle" data-parent="#accordion" href="#filter">&nbsp;Shared by</a></h4>
                                </div>
                                <div id="filter-shared-by" class="facet-list panel-collapse collapse in">
                                    <div class="panel-body">
                                        <div class="list-group">
                                            <ul class="list-group inputs-group">
                                                <h5><i>No resources have been shared with this group yet.</i></h5>
                                            </ul>
                                        </div>

                                        <div id="grantors-list">
                                            {% for res in group_resources %}
                                                <span data-grantor-id="{{ res.grantor.id }}"
                                                      data-grantor-name="{{ res.grantor|best_name }}"></span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-10" id="items">
                            <div class="row">
                                <div class="col-sm-12">
                                    <div id="search-container" class="input-group">
                                        <span class="glyphicon glyphicon-search search-icon"></span>
                                        <input id="resource-search-input" type="text" class="form-control" placeholder="Search"/>

                                        <div class="input-group-btn">
                                            <div class="btn-group" role="group">
                                                <div class="dropdown dropdown-lg">
                                                    <span id="btn-clear-search-input" class="glyphicon glyphicon-remove-sign btn-clear-search"></span>

                                                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"
                                                            aria-expanded="false"><span class="caret"></span></button>

                                                    <div class="dropdown-menu dropdown-menu-left" role="menu">
                                                        <form class="form-horizontal" role="form">
                                                            <div class="form-group">
                                                                <label for="filter">Resource Type</label>
                                                                <select id="input-resource-type" class="form-control pull-left">
                                                                    <option value="" selected>All</option>
                                                                    <option value="generic">Generic</option>
                                                                    <option value="geographic feature">Geographic Feature (ESRI Shapefiles)</option>
                                                                    <option value="geographic raster">Geographic Raster</option>
                                                                    <option value="his referenced time series">HIS Referenced Time Series</option>
                                                                    <option value="model instance resource">Model Instance</option>
                                                                    <option value="model program">Model Program</option>
                                                                    <option value="multidimensional">Multidimensional (NetCDF)</option>
                                                                    <option value="script resource">Script Resource</option>
                                                                    <option value="swat model instance resource">Swat Model Instance</option>
                                                                    <option value="time series">Time Series</option>
                                                                    <option value="web app resource">Web App</option>
                                                                    <option value="collection resource">Collection</option>
                                                                </select>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="contain">Author</label>
                                                                <input id="input-author" class="form-control" type="text"/>
                                                                <span id="btn-clear-author-input" class="glyphicon glyphicon-remove-sign btn-clear-search-inline"></span>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="contain">Subject</label>
                                                                <input id="input-subject" class="form-control" type="text"/>
                                                                <span id="btn-clear-subject-input" class="glyphicon glyphicon-remove-sign btn-clear-search-inline"></span>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                 </div>
                            </div>

                            <!-- /input-group -->
                            <table id="item-selectors" class="table-hover table-striped resource-custom-table">
                                <thead>
                                <tr>
                                    <th><input class="all-rows-selector" type="checkbox"></th>
                                    <th>Type</th>
                                    <th>Title</th>
                                    <th>Owners</th>
                                    <th>Last modified</th>
                                    <th>Subject</th>{# Used in table processing #}
                                    <th>Authors</th>{# Used in table processing #}
                                    <th>Permission Level</th>{# Used in table processing #}
                                    <th>Labels</th>{# Used in table processing #}
                                    <th>Favorite</th>{# Used in table processing #}
                                    <th>Last modified</th>{# Used in table processing #}
                                    <th>Sharing Status</th>{# Used in table processing #}
                                    <th>Grantor</th>{# Used in table processing #}
                                </tr>
                                </thead>
                                <tbody>
                                    {% for res in group_resources %}
                                        <tr data-tr-index="{{ forloop.counter0 }}">
                                            <td></td> {# Empty for now, needed for the script to run correctly #}
                                            <td>
                                                <span class="resource-type-text">{{ res|resource_type }}</span>
                                                {% if res|resource_type == "Generic" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/generic48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "Geographic Raster" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/geographicraster48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "Model Program Resource" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/modelprogram48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "Model Instance Resource" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/modelinstance48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "SWAT Model Instance Resource" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/swat48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "Multidimensional (NetCDF)" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/multidimensional48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "Time Series" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/timeseries48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "Geographic Feature (ESRI Shapefiles)" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/geographicfeature48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "Web App Resource" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/webapp48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "HIS Referenced Time Series" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/his48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "Script Resource" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/script48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}" class="table-res-type-icon"/>
                                                {% elif res|resource_type == "Collection Resource" %}
                                                    <img src="{{ STATIC_URL }}img/resource-icons/collection48x48.png"
                                                         alt="{{ res|resource_type }}" title="{{ res|resource_type }}"
                                                         class="table-res-type-icon"/>
                                                {% endif %}

                                                {#  Sharing Status icons #}
                                                <div class="access-icon-wrapper">
                                                    {% if res.raccess.published %}
                                                        <img src="{{ STATIC_URL }}img/published.png"
                                                             alt="Published Resource" title="Published"/>
                                                    {% elif res.raccess.public %}
                                                        <img src="{{ STATIC_URL }}img/public.png"
                                                             alt="Public Resource" title="Public"/>
                                                    {% elif res.raccess.discoverable %}
                                                        <img src="{{ STATIC_URL }}img/discoverable.png"
                                                             alt="Discoverable Resource" title="Discoverable"/>
                                                    {% else %}
                                                        <img src="{{ STATIC_URL }}img/private.png"
                                                             alt="Private Resource" title="Private"/>
                                                    {% endif %}

                                                    {% if res.raccess.published %}
                                                        {% if "pending" in cm.doi or "failure" in cm.doi %}
                                                            <img src="{{ STATIC_URL }}img/pending.png" alt="Pending Publication"
                                                                 title="Pending Publication. Note that the DOI will not be available until it has been registered and activated."/>
                                                        {% endif %}
                                                    {% else %}
                                                        {% if res.raccess.shareable %}
                                                            <img src="{{ STATIC_URL }}img/shareable.png" alt="Sharable Resource"
                                                                 title="Shareable"/>
                                                        {% else %}
                                                            <img src="{{ STATIC_URL }}img/non-shareable.png" alt="Non Sharable Resource"
                                                                 title="Not Shareable"/>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <strong><a href="{{ res.get_absolute_url }}">{{ res.metadata.title }}</a></strong>
                                            </td>
                                            <td>{% for owner in res.raccess.owners.all %}
                                                  {% if forloop.counter0 > 0 %} · {% endif %}
                                                <span>{{ owner|contact|safe }}</span>
                                            {% endfor %}</td>
                                            <td>{{ res.updated|date }}, {{ res.updated|time }}</td>
                                            <td>
                                                {% for kw in res.metadata.subjects.all %}
                                                   {% if forloop.counter0 > 0 %},{% endif %}{{ kw.value}}
                                                {% endfor %}
                                            </td>
                                            <td>
                                                {% for creator in res.metadata.creators.all %}
                                                    {% if forloop.counter0 != 0 %}<span> · </span>{% endif %}
                                                    {% if creator.description %}
                                                        <a href="{{ creator.description }}">{{ creator.name }}</a>
                                                    {% else %}
                                                        <span>{{ creator.name }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            </td>
                                            {% if res.owned %}
                                                <td>Owned</td>
                                            {% elif res.editable %}
                                                <td>Editable</td>
                                            {% elif res.viewable %}
                                                <td>Viewable</td>
                                            {% else %}
                                                <td></td>
                                            {% endif %}
                                            <td class="col-labels">
                                                {% for label in res.labels %}
                                                    {% if forloop.counter0 > 0 %},{% endif %}{{ label }}
                                                {% endfor %}
                                            </td>
                                            <td class="col-is-favorite">
                                                {% if res.is_favorite %}
                                                    Favorite
                                                {% endif %}
                                            </td>
                                            <td>{{ res.updated|date:"Y/m/d H:i:s" }}</td>
                                            <td>
                                                {% if res.raccess.published %}
                                                    Published
                                                {% elif res.raccess.public %}
                                                    Public
                                                {% elif res.raccess.discoverable %}
                                                    Discoverable
                                                {% else %}
                                                    Private
                                                {% endif %}
                                            </td>
                                            <td>{{ res.grantor.id }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <div class="panel-group" role="tablist">
                                <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="headingLegend">
                                        <h4 class="panel-title">
                                            <span class="glyphicon glyphicon-info-sign"></span>&nbsp;
                                            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#legend-collapse"
                                               aria-expanded="true" aria-controls="legend-collapse">
                                                Legend
                                            </a>
                                        </h4>
                                    </div>

                                    <div id="legend-collapse" class="panel-collapse collapse" role="tabpanel"
                                         aria-labelledby="headingLegend">
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="col-xs-12 col-sm-5">
                                                    <div class="row">
                                                        <div class="col-sm-12"><label>Sharing and Access</label></div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/public.png" alt="Public Resource"/>
                                                            <small>Public</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/private.png" alt="Private Resource"/>
                                                            <small>Private</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/discoverable.png" alt="Discoverable Resource"/>
                                                            <small>Discoverable</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/published.png" alt="Published Resource"/>
                                                            <small>Published</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/pending.png" alt="Pending Publication"/>
                                                            <small>Pending publication</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/shareable.png" alt="Sharable Resource"/>
                                                            <small>Shareable</small>
                                                        </div>

                                                        <div class="col-sm-8">
                                                            <img src="{{ STATIC_URL }}img/non-shareable.png" alt="Non Sharable Resource"/>
                                                            <small>Not shareable</small>
                                                        </div>

                                                    </div>
                                                </div>

                                                <div class="col-xs-12 col-sm-7">
                                                    <div class="row" id="legend-resource-type">
                                                        <div class="col-sm-12"><label>Resource types</label></div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/generic48x48.png"
                                                                 alt="Generic Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Generic</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/geographicfeature48x48.png"
                                                                 alt="Geographic Feature Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Geographic Feature</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/geographicraster48x48.png"
                                                                 alt="Geographic Raster Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Geographic Raster</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/modelinstance48x48.png"
                                                                 alt="Model Instance Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Model Instance</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/swat48x48.png"
                                                                 alt="SWAT Model Instance Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;SWAT Model Instance</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/modelprogram48x48.png"
                                                                 alt="Model Program Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Model Program</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/multidimensional48x48.png"
                                                                 alt="Multidimensional Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Multidimensional</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/timeseries48x48.png"
                                                                 alt="Time Series Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Time Series</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/his48x48.png"
                                                                 alt="HIS Referenced Time Series Resource Icon"
                                                                 class="table-res-type-icon"/>
                                                            <small>&nbsp;HIS Referenced Time Series</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/webapp48x48.png"
                                                                 alt="Web App Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Web App</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/script48x48.png"
                                                                 alt="Script Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Script</small>
                                                        </div>

                                                        <div class="col-sm-6">
                                                            <img src="{{ STATIC_URL }}img/resource-icons/collection48x48.png"
                                                                 alt="Collection Resource Icon" class="table-res-type-icon"/>
                                                            <small>&nbsp;Collection</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                     </div>
                 </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if profile_user.is_group_owner or profile_user.is_group_editor or profile_user.is_group_viewer %}
        <!-- Invite to Group Modal -->
        <div class="modal fade" id="invite-dialog" tabindex="-1" role="dialog"
             aria-labelledby="Invite">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"
                                aria-label="Close"><span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="Invite">Invite People</h4>
                    </div>
                    <form id="invite-to-group" action="/hsapi/_internal/make-group-membership-request/{{ group.id }}/">
                        <div class="modal-body">
                            <div id="div-invite-people">
                                {% csrf_token %}
                                {{ add_view_user_form.user }}
                                <form action="">
                                    <a id="btn-invite" onclick="group_invite_ajax_submit(); return false;"
                                       class="btn btn-add-access btn-success pull-left glyphicon glyphicon-send"><span
                                            class="button-label">&nbsp;&nbsp;Send Invitation</span>
                                    </a>
                                </form>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Leave Group Modal -->
        <div class="modal fade" id="leave-group-dialog" tabindex="-1" role="dialog"
             aria-labelledby="Leave">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"
                                aria-label="Close"><span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="Leave">Leave Group</h4>
                    </div>
                    <form action="/hsapi/_internal/unshare-group-with-user/{{ group.id }}/{{ user.id }}/">
                        <div class="modal-body">
                            <h5>Are you sure you want to leave this group?</h5>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Confirm</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    {% endif %}

    {% if profile_user.is_group_owner or profile_user.is_group_editor %}
        <!-- Edit Group Modal -->
        <div class="modal fade" id="edit-group-dialog" tabindex="-1" role="dialog"
             aria-labelledby="Invite">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form action="/hsapi/_internal/update-user-group/{{ group.id }}" method="POST"
                          enctype="multipart/form-data">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-label="Close"><span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title" id="myModalLabel">Edit Group Details</h4>
                        </div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="row">
                                <fieldset class="col-sm-12 pull-right">
                                    <input id="active_flag" name="active" data-toggle="toggle" data-on="Active"
                                           data-off="Inactive" type="checkbox"
                                           data-onstyle="success"
                                           {% if group.gaccess.active %}checked{% endif %} data-toggle="toggle">
                                </fieldset>

                                {# Group Name #}
                                <fieldset class="col-sm-12">
                                    <label>Group Name *</label>
                                    <small class="text-muted">150 characters or less</small>
                                    <input class="form-control" required="required" name="name" value="{{ group.name }}"
                                           maxlength="150">

                                </fieldset>

                                {# Purpose #}
                                <fieldset class="col-sm-12">
                                    <label>Purpose</label>
                                    <small class="text-muted">300 characters or less</small>
                                    <textarea class="form-control" name="purpose"
                                              maxlength="300">{{ group.gaccess.purpose }}</textarea>

                                </fieldset>

                                {# Group Description #}
                                <fieldset class="col-sm-12">
                                    <label>About this group *</label>
                                    <textarea class="form-control" required="required"
                                              name="description">{{ group.gaccess.description }}</textarea>
                                </fieldset>

                                <br>

                                {# Picture #}
                                <div class="col-sm-12">
                                    <fieldset>
                                        <label>Add a photo</label>

                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <span id="cv-custom-upload" class="btn btn-default btn-file">
                                                    Browse&hellip; <input class="upload-picture" type="file"
                                                                          name="picture">
                                                </span>
                                            </span>
                                            <input type="text" class="form-control" readonly>
                                        </div>
                                    </fieldset>
                                </div>

                                <br>

                                {# Privacy #}
                                <fieldset class="col-sm-12">
                                    <label>Privacy *</label>
                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="privacy_level" value="public"
                                                   {% if group.gaccess.public and group.gaccess.discoverable %}checked{% endif %}>Public
                                            <div class="text-muted">Other users can find the group and see who has
                                                membership.
                                            </div>
                                        </label>
                                    </div>

                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="privacy_level" value="discoverable"
                                                   {% if not group.gaccess.public and group.gaccess.discoverable %}checked{% endif %}>Discoverable
                                            <div class="text-muted">Other users can find this group, but membership
                                                information is hidden.
                                            </div>
                                        </label>
                                    </div>

                                    <div class="radio">
                                        <label>
                                            <input type="radio" name="privacy_level" value="private"
                                                   {% if not group.gaccess.public and not group.gaccess.discoverable %}checked{% endif %}>Private
                                            <div class="text-muted">Other users can not find this group.</div>
                                        </label>
                                    </div>
                                </fieldset>

                                <br>
                                <fieldset class="col-sm-12">
                                    <small class="text-muted">( * ) Required fields</small>
                                </fieldset>


                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endif %}

{% endblock %}

{% block extra_js %}
    <script type="text/javascript" charset="utf8" src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.js"></script>
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    <script>
        var colDefs = [
            {
                "targets": [0],     // Row selector and controls
                "visible": false,
            },
            {
                "targets": [1],     // Resource type
                "width": "100px"
            },
            {
                "targets": [0],     // Actions
                "orderable": false,
                "searchable": false,
                "width": "70px"
            },
            {
                "targets": [4],     // Last modified
                "iDataSort": 10
            },
            {
                "targets": [5],     // Subject
                "visible": false,
                "searchable": true
            },
            {
                "targets": [6],     // Authors
                "visible": false,
                "searchable": true
            },
            {
                "targets": [7],     // Permission level
                "visible": false,
                "searchable": true
            },
            {
                "targets": [8],     // Labels
                "visible": false,
                "searchable": true
            },
            {
                "targets": [9],     // Favorite
                "visible": false,
                "searchable": true
            },
            {
                "targets": [10],     // Last modified (for sorting)
                "visible": false,
                "searchable": true
            },
            {
                "targets": [11],     // Sharing status
                "visible": false,
                "searchable": false
            },
            {
                "targets": [12],     // Access Grantor
                "visible": false,
                "searchable": true
            }
        ];
        function group_invite_ajax_submit() {
            if (!$("#id_user-deck > .hilight").length) {
                return false; // If no user selected, ignore the request
            }
            var share_with = $("#id_user-deck > .hilight")[0].getAttribute("data-value");
            var form = $("#invite-to-group");
            var datastring = form.serialize();
            var url = form.attr('action') + share_with + "/";

            $.ajax({
                type: "POST",
                url: url,
                dataType: 'html',
                data: datastring,
                success: function (result) {
                    $(".hilight > span").click(); // Clears the search field
                    $("#invite-dialog .modal-body").prepend('<div class="alert alert-success" role="alert"><span class="glyphicon glyphicon-ok glyphicon"></span> An invitation to join has been sent.</strong></div>');

                    setTimeout(function () {
                       $("#invite-dialog .modal-body .alert").fadeOut();
                    }, 3000);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#invite-dialog .modal-body").prepend('<div class="alert alert-error" role="alert"><span class="glyphicon glyphicon-ok glyphicon"></span> This invitation could not be sent.</strong></div>');

                    setTimeout(function () {
                        $("#invite-dialog .modal-body .alert").fadeOut();
                    }, 3000);
                }
            });
            //don't submit the form
            return false;
        }

        function onRoleSelect(event) {
            var el = $(event.target);
            $("#selected_role").text(el.text());
            $("#selected_role")[0].setAttribute("data-role", el[0].getAttribute("data-role"));
        }

        function act_on_request_ajax_submit() {
            var target = $(this);
            var form = $(this).closest("form");
            var datastring = form.serialize();
            var url = form.attr('action');
            $.ajax({
                type: "POST",
                url: url,
                dataType: 'html',
                data: datastring,
                success: function (result) {
                    if (target.attr("data-user-action") == "Accept") {
                        // Get a copy of the member row template
                        var rowTemplate = $("#templateRow").clone();

                        var name = target.attr("data-name");
                        var title = target.attr("data-title");
                        var picture = target.parent().parent().parent().find("[data-id='picture']");

                        rowTemplate.find("[data-id='name']").text(name);
                        rowTemplate.find("[data-id='name']").attr("href", "/user/" + target.attr("data-member-id") + "/");
                        rowTemplate.find("[data-id='title']").text(title);
                        var forms = rowTemplate.find("form");
                        for (var i = 0; i < forms.length; i++) {
                            var newAction = $(forms[i]).attr("action").replace("member_id", target.attr("data-member-id"));
                            $(forms[i]).attr("action", newAction);
                        }
                        rowTemplate.prepend(picture);

                        $("#all-members-table tbody").append($("<tr data-filter-by='view-user' style='display: none;'>" + rowTemplate.html() + "</tr>"));
                        $(".btn-share-group").click(share_group_ajax_submit);
                        $(".btn-unshare-group").click(unshare_group_ajax_submit);
                    }

                    target.parent().parent().parent().remove();
                    updateMembersLabelCount();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("error");
                }
            });
            //don't submit the form
            return false;
        }

        function share_group_ajax_submit() {
            var target = $(this);
            var form = target.closest("form");
            var role = target.attr("data-role");
            var datastring = form.serialize();
            var url = form.attr('action');
            $.ajax({
                type: "POST",
                url: url,
                dataType: 'html',
                data: datastring,
                success: function (result) {
                    var dropdownButton = target.parent().parent().parent().parent().find(".dropdown-toggle");
                    dropdownButton.text(role);
                    dropdownButton.append('&nbsp;<span class="caret"></span>');

                    var row = target.parent().parent().parent().parent().parent().parent();
                    if (role == "Owner") {
                        row.attr("data-filter-by", "edit-user");
                    }
                    else if (role == "Member") {
                        row.attr("data-filter-by", "view-user");
                    }

                    dropdownButton.dropdown("toggle");
                    updateMembersLabelCount();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("error");
                }
            });
            //don't submit the form
            return false;
        }

        function unshare_group_ajax_submit() {
            var target = $(this);
            var form = target.closest("form");
            var datastring = form.serialize();
            var url = form.attr('action');
            $.ajax({
                type: "POST",
                url: url,
                dataType: 'html',
                data: datastring,
                success: function (result) {
                    var row = target.parent().parent().parent().parent().parent().parent();
                    row.remove();
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    console.log("error");
                }
            });
            //don't submit the form
            return false;
        }

        function updateMembersLabelCount() {
            var viewCount = $("#all-members-table tr[data-filter-by='view-user']").length - 1;  // Subtract hidden template row
            var editCount = $("#all-members-table tr[data-filter-by='edit-user']").length;
            var pendingCount = $("table[data-filter-by='pending'] tr:not('.no-pending-requests')").length;

            $("#members-filter .badge[data-filter-by='All']").text(viewCount + editCount);
            $("#members-filter .badge[data-filter-by='Owners']").text(editCount);
            $("#members-filter .badge[data-filter-by='Pending']").text(pendingCount);

            // Disable options to leave or remove for last owner item.
            if (editCount == 1) {
                $("#all-members-table tr[data-filter-by='edit-user'] .dropdown-toggle").attr("disabled", true);
            }
            else {
                $("#all-members-table tr[data-filter-by='edit-user'] .dropdown-toggle").attr("disabled", false);
            }
        }

        // Preview profile picture
        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {

                };

                reader.readAsDataURL(input.files[0]);
            }
        }

        // File name preview for picture field, change method
        $(document).on('change', '.btn-file :file', function () {
            var input = $(this);
            var numFiles = input.get(0).files ? input.get(0).files.length : 1;
            var label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
            input.trigger('fileselect', [numFiles, label]);
        });

        $(document).ready(function () {
            $("title").text($(".group-title").text() + " | HydroShare"); // Fix page title

            // Abstract collapse toggle
            $(".show-more-btn").click(function () {
                if ($(this).parent().find(".activity-description").css("max-height") == "50px") {
                    var block = $(this).parent().find(".activity-description");

                    block.css("max-height", "initial"); // Set max-height to initial temporarily.
                    var maxHeight = block.height();    // Save the max height
                    block.css("max-height", "50px");    // Restore

                    block.animate({'max-height': maxHeight}, 300); // Animate to max height
                    $(this).text("▲");
                    $(this).attr("title", "Show less");
                }
                else {
                    $(this).parent().find(".activity-description").animate({'max-height': "50px"}, 300);
                    $(this).attr("title", "Show more");
                    $(this).text("···");
                }
            });

            $("#list-roles a").click(onRoleSelect);

            $("#id_user-autocomplete").attr("placeholder", "Search by name or username");

            // Filter
            $("#members").find(".table-members-list").hide();
            $("#members").find(".table-members-list.active").show();

            $("#members-filter tr").click(function() {
                $("#members").find(".table-members-list tr").hide();
                $("table[data-filter-by='pending'] tr").hide();
                $("table[data-filter-by='pending']").hide();

                var dataFilter = $(this).attr("data-filter-by");
                if (dataFilter == "edit-user") {
                    $("#members").find(".table-members-list tr[data-filter-by='" + dataFilter + "']").fadeIn();
                    $("#members").find(".table-members-list tr[data-filter-by='" + "creator" + "']").fadeIn();
                }
                else if (dataFilter == "all") {
                    $("#members").find(".table-members-list tr").addClass("active").fadeIn();
                }
                else if(dataFilter == "pending") {
                    $("#members").find(".table-members-list tr").addClass("active").hide();
                    $("table[data-filter-by='pending'] tr").fadeIn();
                    $("table[data-filter-by='pending']").fadeIn();
                }

                $(this).parent().find("tr").removeClass("active");
                $(this).addClass("active");
            });

            $(".btn-act-on-request").click(act_on_request_ajax_submit);
            $(".btn-share-group").click(share_group_ajax_submit);
            $(".btn-unshare-group").click(unshare_group_ajax_submit);

            // Initialize filters counters
            updateMembersLabelCount();

            // Initialize Shared By filter
            var grantors = $("#grantors-list span");
            if (grantors.length)
                $("#filter-shared-by h5").remove();
            for (var i = 0; i < grantors.length; i++) {
                var id = $(grantors[i]).attr("data-grantor-id");
                if ($("#filter-shared-by .grantor[data-grantor-id='" + id + "']").length == 0) {
                    var count = $("#grantors-list span[data-grantor-id='" + id + "']").length;
                    var name = $(grantors[i]).attr("data-grantor-name").trim();

                    $("#filter-shared-by .inputs-group").append('<li class="list-group-item">' +
                                                                    '<span data-facet="owned" class="badge">' + count + '</span>' +
                                                                    '<label class="checkbox noselect">' +
                                                                    '<input type="checkbox" class="grantor" data-grantor-id="' + id + '">' + name + '</label>' +
                                                                '</li>')
                }
            }

            $("#grantors-list").remove();   // Remove temporary list

            // File name preview for picture field, file select method
            $('.btn-file :file').on('fileselect', function (event, numFiles, label) {
                var input = $(this).parents('.input-group').find(':text');
                input.val(label);
            });


        });
    </script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/hs_resource_table.js"></script>

{% endblock %}