{% extends "base.html" %}
{% load geoanalytics_tags pages_tags mezzanine_tags keyword_tags comment_tags hydroshare_tags %}
{% block title %}Discovery{% endblock %}
{% block main %}
<div class="container-fluid" id="main">
    <div class="row">
        <div class="col-lg-3" id="filter-panel">
            <div id="filter-buttons" style="margin-bottom: 10px;">
                <button class="btn btn-default" onclick="clearAllFaceted()">Show All</button>
                <button class="btn btn-info pull-right" data-toggle="popover" data-placement="right"><i class="glyphicon glyphicon-info-sign"></i></button>
            </div>
            <div id="filter-items">
                {% for key, values in facets.fields.items %}
                    {% if values and key != 'public' and key != 'discoverable' %}
                        <div class="panel-group" id="faceting-{{ key }}">
                            <div class="panel panel-primary">
                                <div class="panel-heading">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#{{ key }}">
                                            {% if key == 'author'%}
                                                &nbsp; Filter by Author
                                            {% elif key ==  'subjects'%}
                                                &nbsp; Filter by Subject
                                            {% elif key ==  'resource_type'%}
                                                &nbsp; Filter by Resource Type
                                            {% elif key ==  'public'%}
                                                &nbsp; Filter by Public
                                            {% elif key ==  'owners_names'%}
                                                &nbsp; Filter by Owner
                                            {% elif key ==  'discoverable'%}
                                                &nbsp; Filter by Discoverable
                                            {% endif %}
                                            <span
                                                {% if key == 'author' or key == 'subjects' or key == 'resource_type'%}
                                                    class="glyphicon glyphicon-minus pull-left"
                                                {% else %}
                                                    class="glyphicon glyphicon-plus pull-left"
                                                {% endif %}>
                                            </span>
                                        </a>
                                    </h4>
                                </div>
                                <div id="{{ key }}"
                                    {% if key == 'author' or key == 'subjects' or key == 'resource_type'%}
                                        class="panel-collapse collapse in"
                                    {% else %}
                                        class="panel-collapse collapse"
                                    {% endif %}>
                                    <ul class="list-group" id="list-group-{{ key }}" style="height: 200px; overflow-y: auto;">
                                    {% for item in values %}
                                        {% if item.1 > 0 %}
                                            <li class="list-group-item clearfix" rel="{{ key }},{{ item.0 }}">
                                                <input class="faceted-selections" id="{{ key }}-{{ item.0 }}" value="{{ key }},{{ item.0 }}" type="checkbox" class="pull-left"> &nbsp;&nbsp;
                                                    <a onclick="formLinkButtonURL('{{ key }}', '{{ item.0 }}')" role="button">{{ item.0 }}</a>
                                                    {% if item.1 >= 1 and item.1 < 2 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 >= 2 and item.1 <= 4 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 4 and item.1 <= 6 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 6 and item.1 <= 10 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 10 and item.1 <= 18 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 18 and item.1 <= 32 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 32 and item.1 <= 57 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 57 and item.1 <= 100 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 100 and item.1 <= 178 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 178 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% endif %}{{ item.1 }}
                                                </span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="panel-group" id="faceting-availability">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                <a data-toggle="collapse" href="#availability">
                                    &nbsp; Filter by Availability
                                    <span class="glyphicon glyphicon-plus pull-left"></span>
                                </a>
                            </h4>
                        </div>
                        <div id="availability" class="panel-collapse collapse">
                            <ul class="list-group" id="list-group-availability" style="height: 200px; overflow-y: auto;">
                                {% for key, values in facets.fields.items %}
                                    {% if key == 'public' or key == 'discoverable' %}
                                        {% for item in values %}
                                            {% if item.1 > 0 and item.0 != 'false' %}
                                                <li class="list-group-item clearfix" rel="{{ key }},{{ item.0 }}">
                                                <input class="faceted-selections" id="{{ key }}-{{ item.0 }}" value="{{ key }},{{ item.0 }}" type="checkbox" class="pull-left"> &nbsp;&nbsp;
                                                    <a onclick="formLinkButtonURL('{{ key }}', '{{ item.0 }}')" role="button">
                                                        {% if key == 'public' and item.0 == 'true' %}
                                                            Public
                                                        {% elif key == 'public' and item.0 == 'false' %}
                                                            Private
                                                        {% elif key == 'discoverable' %}
                                                            Discoverable
                                                        {% endif %}
                                                    </a>
                                                    {% if item.1 >= 1 and item.1 < 2 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-9">
                                                    {% elif item.1 >= 2 and item.1 <= 4 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-9">
                                                    {% elif item.1 > 4 and item.1 <= 6 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-8">
                                                    {% elif item.1 > 6 and item.1 <= 10 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-7">
                                                    {% elif item.1 > 10 and item.1 <= 18 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-6">
                                                    {% elif item.1 > 18 and item.1 <= 32 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-5">
                                                    {% elif item.1 > 32 and item.1 <= 57 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-4">
                                                    {% elif item.1 > 57 and item.1 <= 100 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-3">
                                                    {% elif item.1 > 100 and item.1 <= 178 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-2">
                                                    {% elif item.1 > 178 %}
                                                        <span class="label label-default label-pill pull-right badge YellowGreenBlue-colormap-band-1">
                                                    {% endif %}{{ item.1 }}
                                                </span>
                                            </li>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-9" id="items">
            <!--
            {% if not query %}
                <h4>Enter a search term to find resources on HydroShare</h4>
            {% endif %}
            -->
            <div class=resource-search>
                <form id="search-field" method="get" action=".">
                    {% for field in form %}
                        <div class="fieldWrapper">
                            {{ field }}
                        </div>
                    {% endfor %}
                </form>
            </div>
            <ul id="switch-view" class="nav nav-tabs">
                <li class="active"><a href="#list-view">List</a></li>
                <li><a href="#map-view">Map</a></li>
            </ul>
            <div class="tab-content">
                <div id="list-view" class="tab-pane fade in active">
                    <table class="table table-striped table-hover" id="items-discovered">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>First Author</th>
                                <th>Last Modified</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in page_obj.object_list %}
                                <tr>
                                    <td><a href="{{ result.object.get_absolute_url }}">{{ result.object.metadata.title.value }}</a></td>
                                    <td>{{ result.object|resource_type }}</td>
                                    {% if result.object.first_creator.description %}
                                        <td><a href="{{ result.object.first_creator.description }}">{{ result.object.first_creator.name  }}</a></td>
                                    {% else %}
                                        <td>{{ result.object.first_creator.name }}</td>
                                    {% endif %}
                                    <td>{{ result.object.updated|date }} {{ result.object.updated|time }}</td>
                                </tr>
                            {% empty %}
                                <p>No results found.</p>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if page_obj.has_previous or page_obj.has_next %}
                        <div style="float: right">
                            {% if page_obj.has_previous %}
                                <a href="{{ request.get_full_path|clean_pagination_url }}&amp;page={{ page_obj.previous_page_number }}">
                            {% endif %}&laquo; Previous
                            {% if page_obj.has_previous %}</a>{% endif %}
                            |
                            {% if page_obj.has_next %}
                                <a href="{{ request.get_full_path|clean_pagination_url }}&amp;page={{ page_obj.next_page_number }}">
                            {% endif %}Next &raquo;{% if page_obj.has_next %}</a>{% endif %}
                        </div>
                    {% endif %}
                </div>
                <div id="map-view" class="tab-pane fade">
                    <div id="discover-map" style="width:850px; height:650px"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/1.10.11/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="//cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>
    <script src="//maps.googleapis.com/maps/api/js?v=3" type="text/javascript"></script>
    <script src="//google-maps-utility-library-v3.googlecode.com/svn/tags/keydragzoom/2.0.8/src/keydragzoom_packed.js" type="text/javascript"></script>
    <script src="//googlemaps.github.io/js-marker-clusterer/src/markerclusterer.js" type="text/javascript"></script>
    <script src="//jawj.github.io/OverlappingMarkerSpiderfier/bin/oms.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        var minFloatingNumber = 0.0001;
        var gm = google.maps;
        var map = null;
        var config = {
            el: 'discover-map',
            zoom: 2,
            minZoom: 15,
            type: google.maps.MapTypeId.ROADMAP
        };

        var spiderConfig = {
            keepSpiderfied: true,
            event: 'mouseover'
        };

        var initMap = function(json_results) {

            map = new gm.Map(document.getElementById(config.el), {
                zoom: config.zoom,
                //center: new gm.LatLng(config.lat, config.lon),
                mapTypeId: config.type
            });
            map.enableKeyDragZoom({
                key: 'shift'
            });
            var bounds = new google.maps.LatLngBounds();

            var rectangle = new google.maps.Rectangle({
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map,
                bounds: {
                    north: 0,
                    south: 0,
                    east: 0,
                    west: 0
                }
            });

            var markerSpiderfier = new OverlappingMarkerSpiderfier(map, spiderConfig);

            var markers = [];

            for (var i = 0; i < json_results.length; i++) {
                var northlimit = 0;
                var southlimit = 0;
                var eastlimit = 0;
                var westlimit = 0;
                var lat = 0;
                var lng = 0;
                var icon = "//maps.google.com/intl/en_us/mapfiles/ms/micons/red-dot.png";
                if (json_results[i].coverage_type == 'point'){
                    lat = parseFloat(json_results[i].north);
                    lng = parseFloat(json_results[i].east);

                }else if (json_results[i].coverage_type == 'box'){
                    northlimit = parseFloat(json_results[i].northlimit);
                    southlimit = parseFloat(json_results[i].southlimit);
                    eastlimit = parseFloat(json_results[i].eastlimit);
                    westlimit = parseFloat(json_results[i].westlimit);
                    lat = (northlimit + southlimit) / 2;
                    lng = (eastlimit + westlimit) / 2;
                    icon = "//maps.google.com/mapfiles/dd-end.png";
                }

                var loc = new gm.LatLng(lat, lng);
                var marker = new gm.Marker({
                    position: loc,
                    title: json_results[i].title,
                    url: json_results[i].get_absolute_url,
                    northlimit : northlimit,
                    southlimit : southlimit,
                    eastlimit : eastlimit,
                    westlimit : westlimit,
                    icon: icon,
                    map: map
                });

                marker.desc = json_results[i].title;

                markers.push(marker); // Saving Markers

                markerSpiderfier.addMarker(marker);  // Adds the Marker to OverlappingMarkerSpiderfier
                bounds.extend(marker.position);
            }


            var iw = new gm.InfoWindow();

            markerSpiderfier.addListener('click', function(marker, e) {
                var info_Content = '"<a href="' + marker.url + '">' + marker.title + '</a>';
                iw.setContent(info_Content);
                iw.open(map, marker);
                var rectBounds = new google.maps.LatLngBounds(
                        new google.maps.LatLng(marker.northlimit, marker.westlimit),
                        new google.maps.LatLng(marker.southlimit, marker.eastlimit)
                );
                rectangle.set('bounds', rectBounds);
            });

            markerSpiderfier.addListener('spiderfy', function(markers) {
                iw.close();
            });


            var markerCluster = new MarkerClusterer(map, markers);
            //now fit the map to the newly inclusive bounds
            map.fitBounds(bounds);

            //(optional) restore the zoom level after the map is done scaling
            var listener = google.maps.event.addListener(map, "idle", function () {
                map.setZoom(2);
                google.maps.event.removeListener(listener);
            });
            markerCluster.setMaxZoom(config.minZoom);
        }

        var reorderDivs = function() {
            var faceted_fields = ['author', 'subjects', 'resource_type', 'owners_names', 'availability'];
            var div_ordering = [];
            faceted_fields.forEach(function(field){
                var faceting_div = "faceting-"+field;
                div_ordering.push(faceting_div);
            });
            var i;
            for (i = 1; i < div_ordering.length; i++) {
                var div0 = "#" + div_ordering[i-1];
                var div1 = "#" + div_ordering[i];
                $(div1).insertAfter(div0);
            }
        }

        var copySearchResults = function(search_results){
            search_results.forEach(function(item){
                json_results.push(item);
            });
        }
        
        var formLinkButtonURL = function(key, value){
            var textSearch = $("#id_q").val();
            var searchURL = "?q=" + textSearch;
            var windowPath = window.location.pathname;
            var requestURL =  windowPath + searchURL;
            var checkboxId =  key + "-" + value;
            var sessionStorageCheckboxId = 'search-' + checkboxId;
            sessionStorage[sessionStorageCheckboxId] = 'true';
            requestURL += buildURLOnCheckboxes();
            window.location = requestURL;
        }

        var buildURLOnCheckboxes = function () {
            var requestURL = '';
            $(".faceted-selections").each(function () {
                var checkboxId = $(this).attr("id");
                var sessionStorageCheckboxId = 'search-' + checkboxId;
                var val = sessionStorage[sessionStorageCheckboxId];
                var isChecked = val === 'true';
                if(isChecked){
                    var arr = $(this).val().split(",");
                    var key = arr[0];
                    var value = arr[1];
                    requestURL += "&selected_facets="+key+"_exact:"+value;
                }
            });
            return requestURL;
        }
        var popCheckboxes = function() {
            $(".faceted-selections").each(function () {
                var checkboxId = $(this).attr("id");
                var sessionStorageCheckboxId = 'search-' + checkboxId;
                var val = sessionStorage[sessionStorageCheckboxId];
                var isChecked = val !== undefined ? val == 'true' : false;
                $(this).prop("checked", isChecked);
            });
        }

        var clearCheckboxes = function() {
            $(".faceted-selections").each(function () {
                var checkboxId = $(this).attr("id");
                var sessionStorageCheckboxId = 'search-' + checkboxId;
                sessionStorage[sessionStorageCheckboxId] = 'false';
                sessionStorage.removeItem(sessionStorageCheckboxId);
            });
        }

        var clearAllFaceted = function() {
            clearCheckboxes();
            var clearURL = "/search/";
            window.location = clearURL;
        }


        $(document).ready(function () {

            if (window.location.search.length == 0){
                clearCheckboxes();
            }

            $('#items-discovered').DataTable({
                "paging":   false,
                "searching": false,
                "info": false,
                "order": [[ 0, "asc" ]]
            });

            popCheckboxes();

            $("ul.nav-tabs > li > a").on("shown.bs.tab", function (e) {
                var tabId = $(e.target).attr("href").substr(1);
                window.location.hash = tabId;
                if(tabId == 'map-view' && map == null){
                    var requestURL = "/searchjson/";
                    if(window.location.search.length == 0){
                        requestURL += "?q=";
                    }else{
                        requestURL += window.location.search;
                    }

                    $.ajax({
                        type: "GET",
                        url: requestURL,
                        dataType: 'json',
                        success: function(data) {
                            var json_results = [];
                            for(var j = 0; j < data.length; j++){
                                var item = $.parseJSON(data[j]);
                                json_results.push(item);
                            }
                            initMap(json_results);

                        }
                        , failure: function(data){
                            console.error("fail");
                        }
                    });
                }
            });
            $(".nav-tabs a").click(function(){
                $(this).tab('show');
            });

            // on load of the page: switch to the currently selected tab
            var hash = window.location.hash;
            $('#switch-view a[href="' + hash + '"]').tab('show');

            $("#id_q").attr('placeholder', 'Search...');
            reorderDivs();

            $('.collapse').on('shown.bs.collapse', function(){
                $(this).parent().find(".glyphicon-plus").removeClass("glyphicon-plus").addClass("glyphicon-minus");
            }).on('hidden.bs.collapse', function(){
                $(this).parent().find(".glyphicon-minus").removeClass("glyphicon-minus").addClass("glyphicon-plus");
            });

            $("#id_q").keypress(function(event) {
                if (event.which == 13) {
                    event.preventDefault();
                    clearCheckboxes();
                    $("#search-field").submit();
                }
            });

            $(".faceted-selections").click(function () {
                var tokens = $(this).val().split(",");
                var key = tokens[0];
                var value = tokens[1];
                var textSearch = $("#id_q").val();
                var searchURL = "?q=" + textSearch;
                var windowPath = window.location.pathname;
                var requestURL =  windowPath + searchURL;

                if($(this).is(":checked")) {
                    requestURL = requestURL + "&selected_facets="+key+"_exact:"+value;
                    requestURL += buildURLOnCheckboxes();
                    var checkboxId = $(this).attr("id");
                    var sessionStorageCheckboxId = 'search-' + checkboxId;
                    sessionStorage[sessionStorageCheckboxId] = 'true';

                    window.location = requestURL;
                }else{

                    var checkboxId = $(this).attr("id");
                    var sessionStorageCheckboxId = 'search-' + checkboxId;
                    sessionStorage.removeItem(sessionStorageCheckboxId);

                    var textSearch = $("#id_q").val();
                    var updateURL = "/search/?q=" + textSearch;
                    updateURL += buildURLOnCheckboxes();
                    window.location = updateURL;
                }
            });


            $('[data-toggle="popover"]').popover({
                html: true,
                container: '#body',
                content: '<p>This search box supports <a href="https://cwiki.apache.org/confluence/display/solr/Searching" target="_blank">SOLR Query syntax</a>.</p>',
                trigger: 'click'
            });
        });
    </script>
{% endblock %}