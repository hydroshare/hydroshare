{% extends 'pages/page.html' %}

{% load ratings_tags pages_tags keyword_tags hydroshare_tags crispy_forms_tags %}

{% block extra_head %}
    <link href="{{ STATIC_URL }}css/site_base_irods.css" rel="stylesheet"/>
    <link rel="stylesheet" href='//cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css'/>
    <link href="{{ STATIC_URL }}css/toolresource.css" rel="stylesheet"/>
    <link rel="stylesheet" href='https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.3.0/min/dropzone.min.css'/>
{% endblock %}

{% block main %}
    {% with page.get_content_model as cm %}
        {% keywords_for page as kws %}
        {% set_page_permissions page %}
        <input type="hidden" id="supported-file-types" value="{{ cm.get_supported_upload_file_types }}">
        <input type="hidden" id="allow-multiple-file-upload" value={{ cm.allow_multiple_file_upload }}>
        <input type="hidden" id="file-count" value={{ cm.files.all.count }}>
        <input type="hidden" id="resource-mode" value="{% if metadata_form %}Edit{% else %}View{% endif %}" >
        <input type="hidden" id="resource-type" value="{{ cm|resource_type }}" >
        <input type="hidden" id="spatial-coverage-type" value="{{ spatial_coverage.type }}" >
        <input type="hidden" id="current-user-id" value="{{ request.user.id }}" >

        <div class="container" onload="loadScroll()" onunload="saveScroll()">
            <div class="row">
                {% block error %}
                    {%  if validation_error %}
                        <div class="alert alert-danger alert-dismissible" role="alert">
                              <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                              <strong>Validation Error: {{ validation_error }}</strong>
                         </div>
                    {%  endif %}
                    {% if new_version_resource_creation_error %}
                        <div class="alert alert-danger alert-dismissible" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <strong>Failed to create a new version of this resource: {{ new_version_resource_creation_error }}</strong>
                        </div>
                    {% endif %}
                {% endblock %}

                {%  if task_id and download_path %}
                    <input type="hidden" id="task_id" name="task_id" value="{{ task_id }}">
                    <input type="hidden" id="download_path" name="download_path" value="{{ download_path }}">
                    <div class="col-sm-12">
                        <div id='download-status-info' class="alert alert-success">
                            Please wait for the resource bag to be created<span id="loading">.</span>
                        </div>
                    </div>
                {% endif %}

                {# ======= Title ======= #}
                {% include "resource-landing-page/title-section.html" %}

                {# ======= Top-right buttons ======= #}
                {% include "resource-landing-page/top-right-buttons.html" with resource_is_mine=resource_is_mine show_manage_access=show_manage_access %}

                {# ======= Title and header content ======= #}
                {% include "resource-landing-page/resource-header.html" %}

                {# ======= Abstract ======= #}
                {% include "resource-landing-page/abstract.html" %}

                {# ======= Citation ======= #}
                {% if metadata_form %}
                    {% include "resource-landing-page/citation.html" with resource_mode="edit" %}
                {% else %}
                    {% include "resource-landing-page/citation.html" with resource_mode="view" %}
                {% endif %}

                {# ======= Subject ======= #}
                {% include "resource-landing-page/subject.html" %}

                {% block content_block %}
                {# ======= Content (code moved here because django does not render blocks inside included templates) ======= #}
                {% if cm.resource_type != "ToolResource" %}
                    {# POPUP MENU - Right clicking items #}
                    <ul id="right-click-menu" class="dropdown-menu fb-dropdown selection-menu">
                        {% if cm|resource_type == "Generic" or cm|resource_type == "Model Program Resource" or cm|resource_type == "MODFLOW Model Instance Resource" or cm|resource_type == "SWAT Model Instance Resource" or cm|resource_type == "Model Instance Resource" %}
                        <li id="btn-open" data-menu-name="open">
                            <span class="fa fa-folder-open icon-blue"></span>
                            <span>Open</span>
                        </li>

                        <li id="open-separator" role="separator" class="divider"></li>
                        {% endif %}

                        {% if page.perms.change and metadata_form %}
                            {% if cm|resource_type == "Generic" %}
                                <li id="btn-cut" data-menu-name="cut">
                                    <span class="fa fa-scissors icon-blue"></span>
                                    <span>Cut</span>
                                </li>

                                <li data-menu-name="paste">
                                    <span class="fa fa-clipboard icon-blue"></span>
                                    <span>Paste</span>
                                </li>

                            {% endif %}

                            {% if cm|resource_type == "Generic" or cm|resource_type == "Time Series" %}
                                <li data-menu-name="rename" data-toggle="modal" data-target="#rename-dialog">
                                    <span class="glyphicon glyphicon-pencil icon-blue"></span>
                                    <span>Rename</span>
                                </li>
                            {% endif %}

                            <li data-menu-name="delete" class="fb-files-remove" data-toggle="modal" data-target="#confirm-delete-dialog">
                                <span class="glyphicon glyphicon-trash icon-button btn-remove"></span>
                                <span>Delete</span>
                            </li>

                            <li id="delete-separator" role="separator" class="divider"></li>

                            {% if cm|resource_type == "Generic" %}

                                <li id="btn-zip" data-menu-name="zip" data-toggle="modal"
                                    data-target="#zip-folder-dialog">
                                    <span class="glyphicon glyphicon-compressed icon-blue"></span>
                                    <span>Zip Folder...</span>
                                </li>

                                <li id="btn-unzip" data-menu-name="unzip">
                                    <span class="fa fa-file-archive-o icon-blue"></span>
                                    <span>Unzip here</span>
                                </li>

                                <li id="zip-separator" role="separator" class="divider"></li>
                            {% endif %}

                        {% endif %}
                        <li id="btn-download" data-menu-name="download">
                            <span class="glyphicon glyphicon-download icon-blue"></span>
                            <span>Download</span>
                        </li>

                        <li id="btn-get-link" data-menu-name="get-link" data-toggle="modal" data-target="#get-file-url-dialog">
                            <span class="fa fa-link icon-blue"></span>
                            <span>Get file URL</span>
                        </li>
                        {% if page.perms.change and resource_edit_mode and cm.resource_type == "CompositeResource"%}
                            <li id="btn-set-geo-file-type" data-menu-name="setgeorasterfiletype">
                                <span class="glyphicon glyphicon-check icon-blue"></span>
                                <span>Set Geo Raster File Type</span>
                            </li>
                        {%  endif %}
                    </ul>

                    {# POPUP MENU - Right clicking empty space in file browser #}
                    <ul id="right-click-container-menu" class="dropdown-menu fb-dropdown selection-menu">
                        {% if page.perms.change and metadata_form and cm|resource_type == "Generic"%}
                            <li id="btn-new-folder" data-menu-name="new-folder" data-toggle="modal"
                                data-target="#create-folder-dialog">
                                <span class="fa fa-folder icon-blue"></span>
                                <span>New Folder</span>
                            </li>

                            <li role="separator" class="divider"></li>
                        {% endif %}

                        <li data-menu-name="refresh">
                            <span class="fa fa-refresh icon-blue"></span>
                            <span>Refresh</span>
                        </li>

                        <li data-menu-name="select-all">
                            <span class="fa fa-check-square icon-blue"></span>
                            <span>Select All</span>
                        </li>
                        {% if page.perms.change and metadata_form and cm|resource_type == "Generic"%}

                            <li role="separator" class="divider"></li>

                            <li data-menu-name="paste">
                                <span class="fa fa-clipboard icon-blue"></span>
                                <span>Paste</span>
                            </li>
                        {% endif %}
                    </ul>

                    <div class="col-sm-12 content-block">
                        <h3>Content</h3>
                        {% if show_content_files %}
                            {# ======= Modal window begins =======#}
                            <div class="modal fade" id="confirm-delete-dialog" tabindex="-1" role="dialog"
                                 aria-labelledby="myModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" data-dismiss="modal"
                                                    aria-hidden="true">&times;</button>
                                            <h4 class="modal-title">Confirm files deletion</h4>
                                        </div>
                                        <div class="modal-body">
                                            <div class="warnings-list">
                                                <div>Consider saving a copy of the files before you delete it if it is
                                                    important to you.
                                                </div>
                                                <br>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel
                                            </button>
                                            <button id="btn-confirm-delete" type="button" class="btn btn-danger"
                                                    data-dismiss="modal">Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {# ======= Modal window ends =======#}

                            {% if page.perms.change and metadata_form and cm.get_supported_upload_file_types != "()" %}
                                <div id="fb-alerts">
                                    <div class="alert alert-warning alert-dismissible" role="alert">
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>

                                        <strong><i class="glyphicon glyphicon-info-sign"></i>&nbsp;&nbsp;Uploading</strong>
                                        <ul>
                                            <li><span id="file-types"></span></li>
                                            <li><span id="file-multiple"></span></li>
                                            {% block upload_message %}{% endblock %}
                                        </ul>
                                    </div>
                                </div>
                            {% endif %}

                            <div id="hs-file-browser" data-res-id="{{ cm.short_id }}" data-current-path="data/contents"
                                 {% if page.perms.change and metadata_form %}data-mode="edit"{% endif %}
                                 data-supported-files="{{ cm.get_supported_upload_file_types }}"
                                 data-allow-multiple-files="{{ cm.allow_multiple_file_upload }}"
                                 data-initial-file-count="{{ cm.files.all.count }}"
                                 {% if cm|resource_type != "Generic" %}data-refresh-on-upload="true"{% endif %}
                                 class="file-browser"
                            >

                                <div class="file-browser-container">
                                    <div id="fb-inner-controls">
                                        <div id="fb-inner-buttons">
                                            <div class="row">
                                                {% if cm|resource_type == "Generic" or cm|resource_type == "Model Program Resource" or cm|resource_type == "MODFLOW Model Instance Resource" or cm|resource_type == "SWAT Model Instance Resource" or cm|resource_type == "Model Instance Resource" %}
                                                <div class="col-xs-6 col-sm-3 col-md-3">
                                                    <button id="fb-move-back"
                                                            class="btn btn-default fb-control-round disabled"
                                                            title="Click to go back"><span
                                                            class="glyphicon glyphicon-arrow-left"></span>
                                                    </button>

                                                    <button id="fb-move-forward"
                                                            class="btn btn-default fb-control-round disabled"
                                                            title="Click to go forward"><span
                                                            class="glyphicon glyphicon-arrow-right"></span>
                                                    </button>

                                                    <button id="fb-move-up"
                                                            class="btn btn-default fb-control-squared disabled"
                                                            title="Click to go to parent directory"><span
                                                            class="fa fa-level-up"></span></button>
                                                </div>
                                                {% endif %}

                                                <div class="{% if cm|resource_type == "Generic" %}col-xs-6{% else %}col-xs-12{% endif %} col-sm-4 col-md-3 pull-right text-right">
                                                    <div id="btn-group-view" class="btn-group" role="group">
                                                        <button data-view="list" data-toggle="tooltip"
                                                                data-placement="auto"
                                                                title='List'
                                                                type="button"
                                                                class="btn btn-default"><i class='fa fa-list' aria-hidden='true'></i>
                                                        </button>

                                                        <button data-view="grid" data-toggle="tooltip"
                                                                data-placement="auto" type="button"
                                                                title='Grid'
                                                                class="btn btn-default active"><i class='glyphicon glyphicon-th-large' aria-hidden='true'></i>
                                                        </button>
                                                    </div>

                                                    <div id="fb-sort" class="btn-group">
                                                        <button type="button"
                                                                class="btn btn-default dropdown-toggle"
                                                                data-toggle="dropdown" aria-haspopup="true"
                                                                aria-expanded="false">
                                                            <span class="glyphicon glyphicon-sort"></span>&nbsp;<span>Sort By</span>&nbsp;<span
                                                                class="caret"></span>
                                                        </button>

                                                        <ul class="dropdown-menu text-left">
                                                            <li data-method="type" class="active"><a>Type</a></li>
                                                            <li data-method="name"><a>Name</a></li>
                                                            <li data-method="size"><a>Size</a></li>
                                                            <li role="separator" class="divider"></li>
                                                            <li data-order="asc" class="active"><a><i
                                                                    class="fa fa-sort-amount-asc"></i>&nbsp;&nbsp;Ascending</a>
                                                            </li>
                                                            <li data-order="desc"><a><i
                                                                    class="fa fa-sort-amount-desc"></i>&nbsp;&nbsp;Descending</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>

                                                <div class="col-xs-12 col-sm-5 col-md-6 height-fix">
                                                    <div class="input-group file-browser-search">
                                                        <span class="glyphicon glyphicon-search search-icon"></span>
                                                    <span id="btn-clear-search-input"
                                                          class="glyphicon glyphicon-remove-sign btn-clear-search"
                                                          data-toggle="tooltip"
                                                          data-placement="auto"
                                                          title="Clear search"></span>
                                                        <input type="text" id="txtDirSearch"
                                                               class="form-control fb-input-search"
                                                               placeholder="Search current directory">
                                                    </div>
                                                </div>

                                            </div>
                                            <div class="row">
                                                <div id="fb-file-operations-controls" class="col-xs-12 col-sm-12 height-fix">
                                                    {% if page.perms.change and metadata_form %}
                                                        {% if cm|resource_type == "Generic" or cm|resource_type == "Model Program Resource" or cm|resource_type == "MODFLOW Model Instance Resource" or cm|resource_type == "SWAT Model Instance Resource" or cm|resource_type == "Model Instance Resource" or cm|resource_type == "Composite"  %}
                                                            <button id="fb-create-folder" class="fb-space-right"
                                                                    data-toggle="modal"
                                                                    data-target="#create-folder-dialog"
                                                                title="Create new folder">
                                                            <span class="fa fa-folder icon-blue"></span>
                                                        </button>
                                                        {% endif %}

                                                        {% if cm|resource_type == "Generic" or cm|resource_type == "Model Program Resource" or cm|resource_type == "MODFLOW Model Instance Resource" or cm|resource_type == "SWAT Model Instance Resource" or cm|resource_type == "Model Instance Resource" %}
                                                            <button id="fb-cut"
                                                                    class="disabled"
                                                                    title="Cut">
                                                                <span class="fa fa-scissors icon-blue"></span>
                                                            </button>
                                                            <button id="fb-paste"
                                                                    class="disabled fb-space-right"
                                                                    title="Paste">
                                                                <span class="fa fa-clipboard icon-blue"></span>
                                                            </button>
                                                        {% endif %}

                                                        {% if cm|resource_type != "Web App Resource" and cm|resource_type != "Geographic Raster"  and cm|resource_type != "HIS Referenced Time Series"  and cm|resource_type != "Geographic Feature (ESRI Shapefiles)" %}
                                                            <button id="fb-rename"
                                                                    class="disabled fb-space-right"
                                                                    title="Rename" data-toggle="modal"
                                                                    data-target="#rename-dialog">
                                                                <span class="glyphicon glyphicon-pencil icon-blue"></span>
                                                            </button>
                                                        {% endif %}

                                                        {% if cm|resource_type == "Generic" or cm|resource_type == "Model Program Resource" or cm|resource_type == "MODFLOW Model Instance Resource" or cm|resource_type == "SWAT Model Instance Resource" or cm|resource_type == "Model Instance Resource" %}
                                                            <button id="fb-zip"
                                                                    class="disabled"
                                                                    title="Zip Folder" data-toggle="modal"
                                                                    data-target="#zip-folder-dialog">
                                                                <span class="glyphicon glyphicon-compressed icon-blue"></span>
                                                            </button>

                                                            <button id="fb-unzip"
                                                                    class="disabled fb-space-right"
                                                                    title="Unzip here">
                                                                <span class="fa fa-file-archive-o icon-blue"></span>
                                                            </button>
                                                        {% endif %}
                                                    {% endif %}

                                                    <button id="fb-select-all"
                                                            title="Select All">
                                                        <span class="fa fa-check-square icon-blue"></span>
                                                    </button>

                                                    <button id="fb-refresh" class="fb-space-right"
                                                            title="Refresh">
                                                        <span class="fa fa-refresh icon-blue"></span>
                                                    </button>

                                                    <button id="fb-download"
                                                            class="disabled"
                                                            title="Download">
                                                        <span class="glyphicon glyphicon-download icon-blue"></span>
                                                    </button>

                                                    <button id="fb-get-link" data-toggle="modal"
                                                            class="disabled" data-target="#get-file-url-dialog"
                                                            title="Get file URL">
                                                        <span class="fa fa-link icon-blue"></span>
                                                    </button>
                                                    {% if page.perms.change and resource_edit_mode %}
                                                        <button id="fb-set-geo-file-type"
                                                                class="disabled"
                                                                title="Set Geo Raster File Type">
                                                            <span class="glyphicon glyphicon-check icon-blue"></span>
                                                        </button>
                                                     {% endif %}

                                                    {% if page.perms.change and metadata_form %}
                                                        <button id="fb-delete"
                                                                class="disabled"
                                                                title="Delete" data-toggle="modal"
                                                                data-target="#confirm-delete-dialog">
                                                            <span class="glyphicon glyphicon-trash btn-remove"></span>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="file-browser-breadcrumb height-fix">
                                            <ol id="fb-bread-crumbs" class="breadcrumb">

                                            </ol>
                                        </div>
                                    </div>
                                    <form id="hsDropzone"
                                          class="files-container ui-widget-content {% if page.perms.change and metadata_form %}dropzone{% endif %}"
                                          action="/hsapi/_internal/{{ cm.short_id }}/add-files-to-resource/"
                                          method="POST">
                                        {% csrf_token %}

                                        <div id="flag-uploading" class="hidden">
                                            <i class="fa fa-circle-o-notch fa-spin fa-fw"></i>
                                            <small class="uploading-message">
                                                <strong>Uploading files to:</strong>&nbsp;data/contents<strong>
                                                &nbsp;&nbsp;Progress:&nbsp;</strong>
                                                <span id="upload-progress"></span></small>
                                        </div>

                                        <div class="fb-drag-flag">
                                            <span class="fa fa-plus-square fa-5x"></span>
                                        </div>

                                        <ul id="fb-files-container" class="selectable fb-view-grid height-fix">
                                            <li class="fb-loading-spinner">
                                                <i class="fa fa-spinner fa-pulse fa-2x fa-fw  icon-blue"></i>
                                            </li>
                                        </ul>
                                    </form>

                                    <form id="fb-delete-files-form" class="hidden"
                                          action="/hsapi/_internal/{{ cm.short_id }}/delete-multiple-files/"
                                          method="POST" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        <input type="hidden" name="file_ids" value=""/>
                                    </form>
                                </div>

                                {% if page.perms.change and metadata_form and cm.get_supported_upload_file_types != "()" %}
                                    <div class="fb-upload-caption {% if cm.files.all.count > 0 and cm.allow_multiple_file_upload != "True" %}hidden{% endif %}">
                                        <span><i class="fa fa-upload" aria-hidden="true"></i>&nbsp;&nbsp;Upload
                                            files smaller than 1GB in size by dragging & dropping, or click <a
                                                    id="upload-toggle" class="dz-clickable">here</a> to select them.
                                        </span>
                                        <a id="btn-select-irods-file" type="button"
                                           class="btn btn-success row-selector hidden-form" data-toggle="modal"
                                           data-target="#irodsContent">
                                            <span class="glyphicon glyphicon-plus"><span class="button-label"> Add files from iRODS...</span></span>
                                        </a>

                                        <span id="log-into-irods">To add files from an iRODS server,
                                        <a id="btn-signin-irods" type="button" class="btn-link"
                                           data-toggle="modal"
                                           data-target="#irodsSignin">Log in to iRODS</a></span>
                                        <span id="sign-in-info"></span>
                                        <a id="btn-signout-irods" type="button" class="btn-link hidden-form">Log out of
                                            iRODS</a>
                                    </div>
                                {% endif %}
                            </div>

                            {% if page.perms.change and metadata_form %}
                                {% if file_type_error %}
                                    <div class="alert alert-danger alert-dismissible" role="alert">
                                        <button id="validation-error-close" type="button" class="close"
                                                data-dismiss="alert"
                                                aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                        <strong>Uploaded File Type Validation Error: {{ file_type_error }}</strong>
                                    </div>
                                {% endif %}
                            {% endif %}

                            <div class="files" id="previews"></div>
                                {% block download_bag %}
                            <div>
                            {% if user_zone_account_exist %}
                                <a id="rep-res-bag" type="button" class="btn btn-default row-selector" data-toggle="modal" data-target="#rep-resource-to-irods-dialog">
                                    <span class="glyphicon">
                                       <span title='Replicate Resource Bag to iRODS User Zone' class="button-label">Replicate Resource Bag to iRODS User Zone</span>
                                    </span>
                                </a>
                            {% endif %}
                            {% for b in cm.bags.all %}
                                <div>
                                    <a id="btn-download-all" type="button" class="btn btn-default row-selector"
                                       href="{{ bag_url }}">
                                    <span class="glyphicon glyphicon-download-alt">
                                        <span title='Download All Content as Zipped BagIt Archive'
                                              class="button-label">Download All Content as Zipped BagIt Archive</span>
                                    </span>
                                    </a>
                                </div>
                                <div>
                                    <a target="_blank" href="http://en.wikipedia.org/wiki/BagIt">Learn more about the Bagit archive format</a>
                                </div>
                            {% endfor %}
                            {% if user_zone_account_exist %}
                                <div id='rep-alert-success' class="alert alert-success alert-dismissible" role="alert" style="display:none">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                    <span id="rep-status-success"></span>
                                </div>
                                <div id='rep-alert-error' class="alert alert-danger alert-dismissible" role="alert" style="display:none">
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                    <span id="rep-status-error"></span>
                                </div>
                            {% endif %}
                            </div>
                            {% endblock %} {#  download_bag #}
                        {% else %}
                            <i class="glyphicon glyphicon-eye-close text-danger no-access-icon"></i>&nbsp;
                            <span>You do not have permission to see these content files. Please contact the Authors if you wish to obtain access.</span>
                        {% endif %}
                    </div>
                {% endif %}
                {% endblock %} {# content_block #}

                {# ======= Content tabs (code moved here because django does not render blocks inside included templates) ======= #}
                <div class="col-sm-12">
                    <!-- === Tabs begin === -->
                    <div class="tab-elements">
                        <div class="panel-tabs">
                            <ul class="nav nav-tabs">
                                {% if not is_resource_specific_tab_active %}
                                    <li class="active col-xs-2 col-md-2">
                                {% else %}
                                   <li class="col-xs-2 col-md-2">
                                {%  endif %}
                                    <a href="#contactTab" data-toggle="tab" title="Contact">
                                        <span class="glyphicon glyphicon-user"> </span>
                                        &nbspAuthorship
                                    </a>
                                </li>
                                {% if spatial_coverage.north or spatial_coverage.northlimit or temporal_coverage or metadata_form %}
                                    <li class="col-xs-2 col-md-2">
                                        <a id="coverageTabBtn" href="#coverageTab" data-toggle="tab" title="Coverage">
                                            <span class="glyphicon glyphicon-map-marker"></span>
                                            &nbspCoverage
                                        </a>
                                    </li>
                                {% endif %}
                                {% if sources or show_relations_section or belongs_to_collections or metadata_form %}
                                    <li class="col-xs-2 col-md-2">
                                        <a href="#relatedResourcesTab" data-toggle="tab" title="Related resources">
                                            <span class="glyphicon glyphicon-book"></span>
                                            &nbspRelated Resources
                                        </a>
                                    </li>
                                {% endif %}
                                {% if extended_metadata_exists or metadata_form %}
                                    {#  Resource specific metadata can't be edited for HIS Referenced Time Series #}
                                    {% if cm|resource_type != "HIS Referenced Time Series" or not metadata_form %}
                                        {% if  cm|resource_type != "Generic" and cm.resource_type != "CompositeResource"%}
                                            {% if  cm|resource_type|lower != "collection resource" %}
                                                {% if is_resource_specific_tab_active %}
                                                    <li class="active col-xs-2 col-md-2">
                                                {% else %}
                                                    <li class="col-xs-2 col-md-2">
                                                {% endif %}
                                                    <a href="#resourceSpecificTab" data-toggle="tab" title="Resource specific">
                                                        <span class="glyphicon glyphicon-folder-close"></span>
                                                        &nbspResource Specific
                                                    </a>
                                                </li>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                                {% if relevant_tools  %}
                                    <li class="col-xs-2 col-md-2">
                                        <a href="#relevantTools" data-toggle="tab" title="Relevant tools">
                                            <span class="glyphicon glyphicon-wrench"></span>
                                            &nbsp; Web Apps
                                        </a>
                                    </li>
                                {% endif %}
                                {% if metadata_form or page.get_content_model.extra_metadata.items|length > 0 %}
                                    <li class="col-xs-2 col-md-2">
                                        <a href="#extraMetaTab" data-toggle="tab" title="Extended Metadata">
                                            <span class="glyphicon glyphicon-paperclip"> </span>
                                            &nbspExtended Metadata
                                        </a>
                                     </li>
                                {% endif %}
                                {% if connections %}
                                    <li class="col-xs-2 col-md-2">
                                        <a href="#connectionsTab" data-toggle="tab" title="Connections">
                                            <span class="glyphicon glyphicon-fullscreen"> </span>
                                            &nbspConnections
                                        </a>
                                     </li>
                                {% endif %}
                                {% if cm.resource_type == "CompositeResource" %}
                                    <li class="col-xs-2 col-md-2">
                                        <a href="#fileTypeMetaDataTab" data-toggle="tab" title="File Metadata">
                                            <span class="glyphicon glyphicon-list-alt"> </span>
                                            &nbspFile Metadata
                                        </a>
                                     </li>
                                {% endif %}

                            </ul>
                        </div>
                        <div class="tabs-body">
                            <!-- Tab panes -->
                            <div class="tab-content">
                                <!-- ========= CONTACT TAB ========= -->
                                {% if not is_resource_specific_tab_active %}
                                    <div class="tab-pane active" id="contactTab">
                                {% else %}
                                    <div class="tab-pane" id="contactTab">
                                {% endif %}
                                    {% if not metadata_form %}
                                        <table class="table table-striped">
                                            <tbody>
                                            <tr>
                                                <th class="division-title" colspan="5"><span>Authors </span>
                                                    <div>
                                                        <small class="text-muted division-title-caption">The people
                                                            or organizations that created the intellectual content
                                                            of the resource.
                                                        </small>
                                                    </div>
                                                </th>
                                            </tr>
                                            <tr class="header-row">
                                                <th>Name</th>
                                                <th>Organization</th>
                                                <th>Address</th>
                                                <th>Phone</th>
                                            </tr>
                                            {% for cr in creators %}
                                                <tr>
                                                    <td>{% if cr.description %}
                                                        <a href="{{ cr.description }}">{{ cr.name }}</a>{% else %}
                                                        {{ cr.name }}{% endif %}</td>
                                                    <td>{% if cr.organization %} {{ cr.organization }}{% endif %}</td>
                                                    <td>{% if cr.address %} {{ cr.address }}{% endif %}</td>
                                                    <td>{% if cr.phone %} {{ cr.phone }}{% endif %}</td>
                                                </tr>
                                            {% endfor %}
                                            {% if contributors %}
                                                <tr>
                                                    <th class="division-title" colspan="5"><span>Contributors</span>
                                                        <div>
                                                            <small class="text-muted division-title-caption">People or
                                                                organizations that contributed technically, materially,
                                                                financially, or provided general support for the
                                                                creation of the resource's content but are not
                                                                considered authors.
                                                            </small>
                                                        </div>
                                                    </th>
                                                </tr>
                                                <tr class="header-row">
                                                    <th>Name</th>
                                                    <th>Organization</th>
                                                    <th>Address</th>
                                                    <th>Phone</th>
                                                </tr>

                                                {% for cont in contributors %}
                                                    <tr>
                                                        <td>{% if cont.description %}
                                                            <a href="{{ cont.description }}">{{ cont.name }}</a>{% else %}
                                                            {{ cont.name }}{% endif %}</td>
                                                        <td>{% if cont.organization %} {{ cont.organization }}{% endif %}</td>
                                                        <td>{% if cont.address %} {{ cont.address }}{% endif %}</td>
                                                        <td>{% if cont.phone %} {{ cont.phone }}{% endif %}</td>
                                                    </tr>
                                                {% endfor %}
                                            {% endif %}
                                            </tbody>
                                        </table>
                                    {% else %}
                                        <div class="tab-pane active" id="contactTab">
                                            <table id="contact-table" class="table table-striped">
                                                <tbody>
                                                <tr>
                                                    <th class="division-title" colspan="5"><span>Authors</span>
                                                        <div>
                                                            <small class="text-muted division-title-caption">The people
                                                                or organizations that created the intellectual content
                                                                of the resource.
                                                            </small>
                                                        </div>
                                                    </th>
                                                </tr>
                                                <tr class="header-row">
                                                    <th>Name</th>
                                                    <th>Organization</th>
                                                    <th>Address</th>
                                                    <th>Phone</th>
                                                    <th></th>
                                                </tr>
                                                {% for author in creator_formset.initial %}
                                                    <tr>
                                                        <td>{% if author.description %}
                                                            <a href="{{ author.description }}">{{ author.name }}</a>{% else %}
                                                            {{ author.name }}{% endif %}</td>
                                                        <td>{% if  author.organization %}{{ author.organization }}{% endif %}</td>
                                                        <td>{% if  author.address %}{{ author.address }}{% endif %}</td>
                                                        <td>{% if  author.phone %}{{ author.phone }}{% endif %}</td>
                                                        <td>
                                                            <a data-toggle="modal" data-placement="auto" title="Edit"
                                                               class="glyphicon glyphicon-pencil icon-button icon-blue"
                                                               data-target="#edit-creator-dialog{{ author.id }}"
                                                                    ></a>

                                                            {# Prevent deletion of last creator#}
                                                            {% if creator_formset.initial|length > 1 %}
                                                                <a data-toggle="modal" data-placement="auto" title="Remove"
                                                                   class="glyphicon glyphicon-trash icon-button btn-remove"
                                                                   data-target="#delete-creator-dialog{{ author.id }}"></a>
                                                            {% endif %}
                                                        </td>
                                                    </tr>

                                                {% endfor %}
                                                <tr>
                                                    <th class="division-title" colspan="5">
                                                        <a type="button" class="btn btn-success" data-toggle="modal"
                                                           data-target="#add-creator-dialog" multiple="multiple">
                                                                <span class="glyphicon glyphicon-plus"><span
                                                                        class="button-label"> Add Author</span></span>
                                                        </a>
                                                    </th>
                                                </tr>
                                                <tr>
                                                    <th class="division-title" colspan="5"><span>Contributors</span>
                                                        <div>
                                                            <small class="text-muted division-title-caption">People or
                                                                organizations that contributed technically, materially,
                                                                financially, or provided general support for the
                                                                creation of the resource's content but are not
                                                                considered authors.
                                                            </small>
                                                        </div>
                                                    </th>
                                                </tr>
                                                <tr class="header-row">
                                                    <th>Name</th>
                                                    <th>Organization</th>
                                                    <th>Address</th>
                                                    <th>Phone</th>
                                                    <th></th>
                                                </tr>
                                                {% for contributor in contributor_formset.initial %}
                                                    <tr>
                                                        <td>{% if contributor.description %}
                                                            <a href="{{ contributor.description }}">{{ contributor.name }}</a>{% else %}
                                                            {{ contributor.name }}{% endif %}</td>
                                                        <td>{% if  contributor.organization %}
                                                            {{ contributor.organization }}{% endif %}</td>
                                                        <td>{% if  contributor.address %}{{ contributor.address }}{% endif %}</td>
                                                        <td>{% if  contributor.phone %}{{ contributor.phone }}{% endif %}</td>
                                                        <td>
                                                            <a data-toggle="modal" data-placement="auto" title="Edit"
                                                               class="glyphicon glyphicon-pencil icon-button icon-blue"
                                                               data-target="#edit-contributor-dialog{{ contributor.id }}"
                                                                    ></a>
                                                            <a data-toggle="modal" data-placement="auto" title="Remove"
                                                               class="glyphicon glyphicon-trash icon-button btn-remove"
                                                               data-target="#delete-contributor-dialog{{ contributor.id }}"
                                                                    ></a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}

                                                <tr>
                                                    <th class="division-title" colspan="5">
                                                        <a type="button" class="btn btn-success" data-toggle="modal"
                                                           data-target="#add-contributor-dialog" multiple="multiple">
                                                            <span class="glyphicon glyphicon-plus"><span class="button-label"> Add Contributor</span></span>
                                                        </a>
                                                    </th>
                                                </tr>

                                                </tbody>
                                            </table>
                                        </div>
                                    {% endif %}
                                </div>
                                <!-- ========= COVERAGE TAB ========= -->
                                {% if spatial_coverage.north or spatial_coverage.northlimit or temporal_coverage or metadata_form %}
                                    <div class="tab-pane" id="coverageTab">
                                        <div class="row">
                                            {% if not metadata_form %}
                                            <div class="{% if temporal_coverage %}col-md-8{% endif %} col-sm-12 col-xs-12" id="coverage-spatial">
                                                <div class="row">
                                                <div class="col-sm-12">
                                                    <legend>Spatial</legend>
                                                    <div class="coverage-container">
                                                        <table class="info-table">
                                                            <tbody>
                                                                {% if spatial_coverage.name %}
                                                                <tr>
                                                                    <th class="text-muted">Place/Area Name</th>
                                                                    <td>{{ spatial_coverage.name }}</td>
                                                                </tr>
                                                                {% endif %}
                                                                {% if spatial_coverage.projection %}
                                                                <tr>
                                                                    <th class="text-muted">Coordinate System/Geographic Projection
                                                                    </th>
                                                                    <td>WGS 84 EPSG:4326</td>
                                                                </tr>
                                                                {% endif %}
                                                                {% if spatial_coverage.units %}
                                                                <tr>
                                                                    <th class="text-muted">Coordinate Units</th>
                                                                    <td>Decimal degrees</td>
                                                                </tr>
                                                                {% endif %}

                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>

                                                <div class="col-sm-8">
                                                    <div id="coverageMap" data-shape-type="{{ spatial_coverage.type }}"></div>
                                                    <i id="resetZoomBtn" class="glyphicon glyphicon-record" data-toggle="tooltip"
                                                       data-placement="left" title="Recenter on selected area/point"></i>
                                                </div>

                                                <div class="col-sm-4">
                                                    {% if spatial_coverage.north or spatial_coverage.northlimit %}
                                                        <ul class="list-group">
                                                            {% if spatial_coverage.type == 'point' %}
                                                                {% if spatial_coverage.east %}
                                                                    <li class="list-group-item"><strong>Longitude</strong>
                                                                        <div id="cov_east">{{ spatial_coverage.east }}</div>
                                                                    </li>
                                                                {% endif %}
                                                                {% if spatial_coverage.north %}
                                                                    <li class="list-group-item"><strong>Latitude</strong>
                                                                        <div id="cov_north">{{ spatial_coverage.north }}</div>
                                                                    </li>
                                                                {% endif %}
                                                            {% else %}
                                                                {% if spatial_coverage.northlimit %}
                                                                    <li class="list-group-item"><strong>North Latitude</strong>
                                                                        <div id="cov_northlimit">{{ spatial_coverage.northlimit }}</div>
                                                                    </li>
                                                                {% endif %}
                                                                {% if spatial_coverage.eastlimit %}
                                                                    <li class="list-group-item"><strong>East Longitude</strong>
                                                                        <div id="cov_eastlimit">{{ spatial_coverage.eastlimit }}</div>
                                                                    </li>
                                                                {% endif %}
                                                                {% if spatial_coverage.southlimit %}
                                                                    <li class="list-group-item"><strong>South Latitude</strong>
                                                                        <div id="cov_southlimit">{{ spatial_coverage.southlimit }}</div>
                                                                    </li>
                                                                {% endif %}
                                                                {% if spatial_coverage.westlimit %}
                                                                    <li class="list-group-item"><strong>West Longitude</strong>
                                                                        <div id="cov_westlimit">{{ spatial_coverage.westlimit }}</div>
                                                                    </li>
                                                                {% endif %}
                                                            {% endif %}
                                                        </ul>
                                                        <div class="text-muted" style="margin-top:20px;">WGS 84 decimal degrees</div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            </div>
                                            {% if temporal_coverage %}
                                                <div class="col-sm-4">
                                                    <legend>Temporal</legend>
                                                    <div class="row">
                                                        <div class="col-sm-4"><strong class="text-muted">Start Date</strong></div>
                                                        <div class="col-sm-8">{{ temporal_coverage.start_date }}</div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-sm-4"><strong class="text-muted">End Date</strong></div>
                                                        <div class="col-sm-8">{{ temporal_coverage.end_date }}</div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            {% else %}
                                                <div class="form-group">
                                                     <div id="readonly-coverage-notice" class="col-sm-12 alert alert-warning alert-dismissible" style="display: none;">
                                                        <label>Spatial coverage for time series resources should be set by editing the coordinates of the monitoring sites on the "Resource Specific" metadata tab. </label>
                                                    </div>
                                                    <div class="col-md-8 col-sm-12 col-xs-12" id="coverage-spatial">
                                                        <div class="row">
                                                            <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/{% if not coverage_spatial_form.initial.north and not coverage_spatial_form.initial.northlimit %}add-metadata/{% else %}{{ coverage_spatial_form.initial.id }}/update-metadata/{% endif %}"
                                                                  id="id-coverage-spatial" method="post">
                                                                {% csrf_token %}
                                                                 <div class="col-sm-12">
                                                                    <legend>Spatial</legend>
                                                                    <div class="coverage-container">
                                                                         <table class="info-table" >
                                                                             <tbody>
                                                                                 <tr>
                                                                                     <th class="text-muted">Coordinate System/Geographic Projection</th>
                                                                                     <td>WGS 84 EPSG:4326</td>
                                                                                 </tr>
                                                                                 <tr>
                                                                                     <th class="text-muted">Coordinate Units</th>
                                                                                     <td>Decimal degrees</td>
                                                                                 </tr>
                                                                             </tbody>
                                                                         </table>
                                                                     </div>

                                                                    <div id="div_id_name" class="control-group">
                                                                        <label for="id_name" class="control-label">Place/Area Name</label>

                                                                        <div class="controls">
                                                                            <input class="form-control input-sm textinput textInput"
                                                                                   id="id_name" maxlength="200" name="name" type="text"
                                                                                   value="{% if coverage_spatial_form.initial.name %}{{ coverage_spatial_form.initial.name }}{% endif %}">
                                                                        </div>
                                                                    </div>

                                                                     <input id="id_projection" maxlength="100" name="projection"
                                                                            type="text" style="display:none"
                                                                            value="{% if coverage_spatial_form.initial.projection %}{{ coverage_spatial_form.initial.projection }}{% else %}WGS 84 EPSG:4326{% endif %}">
                                                                     <input id="id_units" maxlength="50" name="units"
                                                                            style="display:none"
                                                                            type="text" value="{% if coverage_spatial_form.initial.units %}{{ coverage_spatial_form.initial.units }}{% endif %}">

                                                                     <div id="div_id_type">
                                                                         <label class="radio-inline">
                                                                             <input type="radio"
                                                                                    {% if coverage_spatial_form.initial.type == "box" %}checked="checked"{% endif %}
                                                                                    name="type" id="id_type_1"
                                                                                    value="box">Box</label>

                                                                         <label class="radio-inline">
                                                                             <input type="radio"
                                                                                    {% if coverage_spatial_form.initial.type == "point" %}checked="checked"{% endif %}
                                                                                    name="type" id="id_type_2"
                                                                                    value="point">Point</label>
                                                                     </div>
                                                                 </div>

                                                                <fieldset>
                                                                    <div class="col-sm-8">
                                                                        <div id="coverageMap"></div>
                                                                        <i id="resetZoomBtn" class="glyphicon glyphicon-record" data-toggle="tooltip"
                                                                            data-placement="left" title="Recenter on selected area/point"></i>
                                                                    </div>

                                                                    <div class="col-sm-4">
                                                                        <div id="div_id_north" class="control-group" style="margin-bottom: 10px;">
                                                                            <label for="id_north" class="control-label requiredField">
                                                                                Latitude<span class="asteriskField">*</span>
                                                                            </label>

                                                                            <div class="input-group">
                                                                                <input type="text" class="form-control" placeholder="-90 to 90"
                                                                                     id="id_north" name="north"
                                                                                     value="{% if coverage_spatial_form.initial.north %}{{ coverage_spatial_form.initial.north }}{% endif %}">
                                                                                <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                                      class="input-group-addon"></span>
                                                                            </div>
                                                                        </div>
                                                                        <div id="div_id_east" class="control-group" style="margin-bottom: 10px;">
                                                                            <label for="id_east" class="control-label requiredField">
                                                                                Longitude<span class="asteriskField">*</span>
                                                                            </label>

                                                                            <div class="input-group">
                                                                                <input type="text" class="form-control" placeholder="-180 to 180"
                                                                                     id="id_east" name="east"
                                                                                     value="{% if coverage_spatial_form.initial.east %}{{ coverage_spatial_form.initial.east }}{% endif %}">
                                                                                <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                                      class="input-group-addon"></span>
                                                                            </div>
                                                                        </div>
                                                                        <div id="div_id_northlimit" class="control-group" style="margin-bottom: 10px;">
                                                                            <label for="id_northlimit" class="control-label requiredField">
                                                                                North Latitude<span class="asteriskField">*</span>
                                                                            </label>

                                                                            <div class="input-group">
                                                                                <input type="text" class="form-control" placeholder="-90 to 90"
                                                                                     id="id_northlimit" name="northlimit"
                                                                                     value="{% if coverage_spatial_form.initial.northlimit %}{{ coverage_spatial_form.initial.northlimit }}{% endif %}">
                                                                                <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                                      class="input-group-addon"></span>
                                                                            </div>
                                                                        </div>
                                                                        <div id="div_id_eastlimit" class="control-group" style="margin-bottom: 10px;">
                                                                            <label for="id_eastlimit" class="control-label requiredField">
                                                                                East Longitude<span class="asteriskField">*</span>
                                                                            </label>

                                                                            <div class="input-group">
                                                                                <input type="text" class="form-control" placeholder="-180 to 180"
                                                                                     id="id_eastlimit" name="eastlimit"
                                                                                     value="{% if coverage_spatial_form.initial.eastlimit %}{{ coverage_spatial_form.initial.eastlimit }}{% endif %}">
                                                                                <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                                      class="input-group-addon"></span>
                                                                            </div>
                                                                        </div>
                                                                        <div id="div_id_southlimit" class="control-group" style="margin-bottom: 10px;">
                                                                            <label for="id_southlimit" class="control-label requiredField">
                                                                                South Latitude<span class="asteriskField">*</span>
                                                                            </label>

                                                                            <div class="input-group">
                                                                                <input type="text" class="form-control" placeholder="-90 to 90"
                                                                                     id="id_southlimit" name="southlimit"
                                                                                     value="{% if coverage_spatial_form.initial.southlimit %}{{ coverage_spatial_form.initial.southlimit }}{% endif %}">
                                                                                <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                                      class="input-group-addon"></span>
                                                                            </div>
                                                                        </div>
                                                                        <div id="div_id_westlimit" class="control-group" style="margin-bottom: 10px;">
                                                                            <label for="id_westlimit" class="control-label requiredField">
                                                                                West Longitude<span class="asteriskField">*</span>
                                                                            </label>

                                                                            <div class="input-group">
                                                                                <input type="text" class="form-control" placeholder="-180 to 180"
                                                                                     id="id_westlimit" name="westlimit"
                                                                                     value="{% if coverage_spatial_form.initial.westlimit %}{{ coverage_spatial_form.initial.westlimit }}{% endif %}">
                                                                                <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                                      class="input-group-addon"></span>
                                                                            </div>
                                                                        </div>

                                                                    <button type="button" class="btn btn-primary pull-right"
                                                                                onclick="metadata_update_ajax_submit('id-coverage-spatial'); return false;"
                                                                                style="display: none;">Save changes
                                                                        </button>

                                                                    </div>
                                                                </fieldset>
                                                            </form>
                                                        </div>
                                                    </div>

                                                    <div class="form-group col-md-4 col-sm-12 col-xs-12" id="coverage-temporal">
                                                        {% if not coverage_temporal_form.initial.start %}
                                                        <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/add-metadata/"
                                                              id="id-coverage-temporal" method="post">
                                                            {% csrf_token %}
                                                            <fieldset>
                                                                <legend>Temporal</legend>
                                                                <div id="div_id_start" class="control-group">
                                                                    <label for="id_start" class="control-label requiredField">
                                                                        Start Date<span class="asteriskField">*</span></label>

                                                                    <div class="controls">
                                                                        <input class="form-control input-sm dateinput" id="id_start"
                                                                               name="start" type="text">
                                                                    </div>
                                                                </div>
                                                                <div id="div_id_end" class="control-group">
                                                                    <label for="id_end" class="control-label requiredField">End
                                                                        Date<span class="asteriskField">*</span></label>

                                                                    <div class="controls">
                                                                        <input class="form-control input-sm dateinput" id="id_end"
                                                                               name="end" type="text">
                                                                    </div>
                                                                </div>
                                                                <div style="margin-top:10px">
                                                                    <button type="button" class="btn btn-primary pull-right"
                                                                            onclick="metadata_update_ajax_submit('id-coverage-temporal'); return false;">
                                                                        Save changes
                                                                    </button>
                                                                </div>
                                                            </fieldset>
                                                        </form>
                                                    {% else %}
                                                        <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/{{ coverage_temporal_form.initial.id }}/update-metadata/"
                                                              id="id-coverage-temporal" method="post">
                                                            {% csrf_token %}
                                                            <fieldset>
                                                                <legend>Temporal</legend>
                                                                <div id="div_id_start" class="control-group">
                                                                    <label for="id_start" class="control-label requiredField">
                                                                        Start Date<span class="asteriskField">*</span></label>

                                                                    <div class="controls">
                                                                        <input class="form-control input-sm dateinput" id="id_start"
                                                                               name="start" type="text"
                                                                               value="{{ coverage_temporal_form.initial.start }}">
                                                                    </div>
                                                                </div>
                                                                <div id="div_id_end" class="control-group">
                                                                    <label for="id_end" class="control-label requiredField">End
                                                                        Date<span class="asteriskField">*</span></label>

                                                                    <div class="controls">
                                                                        <input class="form-control input-sm dateinput" id="id_end"
                                                                               name="end" type="text"
                                                                               value="{{ coverage_temporal_form.initial.end }}">
                                                                    </div>
                                                                </div>
                                                                <div style="margin-top:10px">
                                                                    <button type="button" class="btn btn-primary pull-right"
                                                                            onclick="metadata_update_ajax_submit('id-coverage-temporal'); return false;"
                                                                            style="display: none;">Save changes
                                                                    </button>
                                                                </div>
                                                            </fieldset>
                                                        </form>
                                                    {% endif %}
                                                    </div>
                                                </div>

                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                                <!-- ========= RELATED RESOURCES TAB ========= -->
                                {% if sources or show_relations_section or belongs_to_collections or metadata_form %}
                                    <div class="tab-pane" id="relatedResourcesTab">
                                        {% if not metadata_form %}
                                            {% if sources %}
                                                <h4><strong>Sources</strong></h4>
                                                <hr style="margin-top: 0px;margin-bottom: 2px">
                                                {% for source in sources %}
                                                    <div class="row">
                                                        <div class="col-sm-4"><strong>Derived From:</strong></div>
                                                        <div class="col-sm-8">{{ source.derived_from }}</div>
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                            {% if show_relations_section %}
                                                <hr style="border: 0;">
                                                <h4><strong>Relations</strong></h4>
                                                <hr style="margin-top: 0;margin-bottom: 2px">
                                                {% for relation in relations %}
                                                    {% if  relation.type|lower != "haspart"%}
                                                        <div class="row">
                                                            <div class="col-sm-4"><strong>{{ relation.type }}:</strong></div>
                                                            <div class="col-sm-8">{{ relation.value }}</div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        {% else %}
                                            <div>
                                                <table class="table" style="margin-bottom: 0;">
                                                    <tbody>
                                                    <legend>Sources</legend>
                                                    {% for source in source_formset.initial %}
                                                        <tr>
                                                            <th scope="row" class="dataset-label">Derived From:</th>
                                                            <td class="dataset-details">{{ source.derived_from }}</td>
                                                            <td>
                                                                <a data-toggle="modal" data-placement="auto" title="Edit"
                                                                   class="glyphicon glyphicon-pencil icon-button icon-blue"
                                                                   data-target="#edit-source-dialog{{ source.id }}"
                                                                   style="top: -5px; "></a>
                                                            </td>
                                                            <td>
                                                                <a data-toggle="modal" data-placement="auto"
                                                                   title="Remove"
                                                                   class="glyphicon glyphicon-trash icon-button btn-remove"
                                                                   data-target="#delete-source-element-dialog{{ source.id }}"
                                                                   style="top: -5px; right:20px;"></a>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                                <a id="add-source" class="btn btn-success" data-toggle="modal"
                                                   data-target="#add-source-dialog"><i
                                                        class="fa fa-plus"></i> Add source</a>
                                            <span data-toggle="tooltip" data-placement="auto"
                                                  title='If this resource was derived from another resource, click this button to create a link to the source resource from which this resource was derived. If the source resource is a HydroShare resource, you should paste in the URL to the source resource in HydroShare. If the source resource is something outside of HydroShare, you can paste in a URL or a full text citation to the external resource.'
                                                  class="glyphicon glyphicon-info-sign text-muted"></span>
                                            </div>
                                            <hr style="border: 0;">
                                            <div>
                                                <table class="table" style="margin-bottom: 0;">
                                                    <tbody>
                                                    <legend>Relations</legend>
                                                    {% for relation in relation_formset.initial %}
                                                        {% if  relation.type|lower != "haspart"%}
                                                            <tr>
                                                                <th scope="row" class="dataset-label">{{ relation.type }}:</th>
                                                                <td class="dataset-details">{{ relation.value }}</td>
                                                                <td>
                                                                    <a data-toggle="modal" data-placement="auto" title="Edit"
                                                                       class="glyphicon glyphicon-pencil icon-button icon-blue"
                                                                       data-target="#edit-relation-dialog_{{ relation.id }}"
                                                                       style="top: -5px; "></a>
                                                                </td>
                                                                <td>
                                                                    <a data-toggle="modal" data-placement="auto"
                                                                       title="Remove"
                                                                       class="glyphicon glyphicon-trash icon-button btn-remove"
                                                                       data-target="#delete-relation-element-dialog{{ relation.id }}"
                                                                       style="top: -5px; right:20px;"></a>
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}

                                                    </tbody>
                                                </table>
                                                <a id="add-relation" class="btn btn-success" data-toggle="modal"
                                                   data-target="#add-relation-dialog"><i class="fa fa-plus"></i> Add relation</a>
                                                <span data-toggle="tooltip" data-placement="auto"
                                                      title='Click this button to add a relationship to another resource, external website, or document. You can express the type of relationship and then enter a URL to the resource or website. If the related resource does not have a URL, you can paste in a full text citation.'
                                                      class="glyphicon glyphicon-info-sign text-muted"></span>
                                                <hr style="border: 0;">
                                            </div>
                                        {% endif %}
                                        {% if belongs_to_collections %}
                                            <legend>This resource belongs to the following collections:</legend>
                                            <table id="collected-by-table" class="table-hover table-striped resource-custom-table" width="100%">
                                                <thead>
                                                    <tr>
                                                        <th>Title</th>
                                                        <th>Owners</th>
                                                        <th>Sharing Status</th>
                                                        <th>My Permission</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                {% for res in belongs_to_collections %}
                                                    <tr id="{{ res.short_id }}">
                                                        <td>
                                                            {% if res|user_permission:request.user.pk|lower == "none" %}
                                                                <strong>{{ res.metadata.title }}</strong>
                                                            {% else %}
                                                                <strong><a href="{{ res.get_absolute_url }}"
                                                                           target="_blank">{{ res.metadata.title }}</a></strong>
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% for owner in res.raccess.owners.all %}
                                                                {% if forloop.counter0 > 0 %}  {% endif %}
                                                                {% if owner.first_name %}
                                                                    <a href='/user/{{ owner.pk }}/'
                                                                               target="_blank">{{ owner.first_name }} {{ owner.last_name }}</a>
                                                                {% else %}
                                                                    <a href='/user/{{ owner.pk }}/'
                                                                               target="_blank">{{ owner.username }}</a>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </td>
                                                        <td>
                                                            {% if res.raccess.published %}
                                                                <strong class="label-public">&nbsp;Published</strong>
                                                            {% elif res.raccess.public %}
                                                                <strong class="label-public">&nbsp;Public</strong>
                                                            {% elif res.raccess.discoverable %}
                                                                <strong class="label-discoverable">
                                                                    &nbsp;Discoverable</strong>
                                                            {% else %}
                                                                <strong class="label-private">&nbsp;Private</strong>
                                                            {% endif %}
                                                            {% if res.raccess.published %}
                                                                {% if "pending" in cm.doi or "failure" in cm.doi %}
                                                                    &#8210; Note that the DOI will not be available
                                                                    until
                                                                    it has been registered and activated.{% endif %}
                                                            {% else %}
                                                                &{% if res.raccess.shareable %}
                                                                <strong style="color:#5cb85c">&nbsp;Shareable</strong>
                                                            {% else %}<strong style="color:#d9534f">&nbsp;Not
                                                                    Shareable</strong>{% endif %}
                                                            {% endif %}
                                                        </td>
                                                        <td>
                                                            {% if res|user_permission:request.user.pk|lower == "none" %}
                                                                <strong class="label-private">{{ res|user_permission:request.user.pk }}</strong>
                                                            {% elif res|user_permission:request.user.pk|lower == "open access" %}
                                                                <strong class="label-public">{{ res|user_permission:request.user.pk }}</strong>
                                                            {% else %}
                                                                {{ res|user_permission:request.user.pk }}
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}

                                            </tbody>
                                        </table>
                                        {% endif%}
                                    </div>

                                {% endif %}
                                <!-- ========= RESOURCE SPECIFIC TAB ========= -->
                                {% if site or extended_metadata_exists or res_add_metadata or metadata_form %}
                                    {#  Resource specific metadata can't be edited for HIS Referenced Time Series #}
                                    {% if cm|resource_type != "HIS Referenced Time Series" or not metadata_form %}
                                        {% if  cm|resource_type != "Generic" and cm.resource_type != "CompositeResource" %}
                                            {% if  cm|resource_type|lower != "collection resource" %}
                                                {% if not is_resource_specific_tab_active %}
                                                    <div class="tab-pane" id="resourceSpecificTab">
                                                {% else %}
                                                    <div class="tab-pane active" id="resourceSpecificTab">
                                                {%  endif %}
                                                    {% if not metadata_form %}

                                                        {% block extended_metadata %}

                                                        {% endblock %}

                                                    {% else %}
                                                        {% crispy metadata_form %}
                                                    {% endif %}
                                                    {% block extra_section %} {# add extra section for resource landing page #}
                                                    {% endblock %}
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                                    <!-- ========= RELEVANT TOOLS TAB ========= -->
                                {% if relevant_tools %}
                                    <div class="tab-pane" id="relevantTools">
                                        {% if not metadata_form %}
                                            {% for tool in relevant_tools %}
                                                <div title="{{ tool.title }}" id="web-app-item">
                                                    <a href="{{ tool.url }}" target="_blank">
                                                        {% if tool.title|length > 20 %}
                                                            <h4>{{ tool.title|slice:":21"|add:"..." }}</h4>
                                                        {% else %}
                                                            <h4>{{ tool.title }}</h4>
                                                        {% endif %}
                                                        <img class="user-webapp-icon" src="{{ tool.icon_url }}">
                                                    </a>
                                                </div>
                                            {% endfor %}
                                        {% else %}
                                            ------- Relevant tools form here -------
                                        {%  endif %}
                                    </div>
                                {% endif %}

                                <!-- ========= EXTRA METADATA TAB ========= -->
                                {% if metadata_form or page.get_content_model.extra_metadata.items|length > 0 %}
                                    <div class="tab-pane" id="extraMetaTab">
                                        {% if metadata_form %}
                                            <a type="button" class="btn btn-success" onclick="showAddEditExtraMetaPopup(false, '')">
                                                                    <span class="glyphicon glyphicon-plus"><span class="button-label"> Add new entry...</span></span>
                                            </a>
                                        {% endif %}
                                        <table id="extraMetaTable" class="table-hover table-striped" width="100%">
                                            <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Value</th>
                                                {% if metadata_form %}
                                                    <th>Edit/Remove</th>
                                                {% endif %}
                                            </tr>
                                            </thead>
                                            <tbody>
                                                {% for extra_meta_name, extra_meta_value in page.get_content_model.extra_metadata.items %}
                                                    <tr id="{{ forloop.counter0 }}">
                                                        <td>
                                                            {{ extra_meta_name }}
                                                        </td>
                                                        <td>
                                                            {{ extra_meta_value }}
                                                        </td>
                                                        {% if metadata_form %}
                                                            <td>
                                                                <span onclick="showAddEditExtraMetaPopup(true, '{{ forloop.counter0 }}')" data-form-type="toggle-favorite"
                                                          class="glyphicon glyphicon-edit btn-inline-favorite"></span>
                                                                <span onclick="removeExtraMetadataFromTable('{{ forloop.counter0 }}')" data-form-type="toggle-favorite"
                                                          class="glyphicon glyphicon-remove btn-inline-favorite"></span>
                                                            </td>
                                                        {% endif %}
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    {% if metadata_form %}
                                        <input class="btn btn-primary" type="button" id="save-extra-meta-btn" onclick="saveExtraMetadata();" value="Save Changes" style="display: none"/>
                                    {% endif %}

                                </div>
                                {% endif %}
                                {# ===========   File Type Metadata Tab ================== #}
                                {% if cm.resource_type == "CompositeResource" %}
                                    <div class="tab-pane" id="fileTypeMetaDataTab">
                                        <div class="alert alert-warning alert-dismissible" role="alert">
                                            <h4>Select a file to see file type metadata.</h4>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- ==== Tabs end ==== -->
                </div>

                {# ======= Credits ======= #}
                {% include "resource-landing-page/credits.html" %}

                {# ======= Ratings ======= #}
                {% include "resource-landing-page/ratings.html" %}

                {# ======= Comments ======= #}
                {% include "resource-landing-page/comments.html" %}

                {%  block modal %}
                    {% include "resource-landing-page/modals.html" %}
                {%  endblock %}
            </div>
        </div>
    {% endwith %}
{% endblock %}

{% block extra_js %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/coverageMap.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?libraries=drawing"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/dropzone.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/hs_file_browser.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/resourceLandingAjax.js"></script>
    <script type="text/javascript" src='//cdn.datatables.net/1.10.10/js/jquery.dataTables.js'></script>
    <script type="text/javascript">
        function onRoleSelect(event) {
            var el = $(event.target);
            $("#selected_role").text(el.text());
            $("#selected_role")[0].setAttribute("data-role", el[0].getAttribute("data-role"));
        }

        function onRowRemove(event) {
            var el = $(event.target);
            var pk = el[0].getAttribute("data-pk");
            el.closest("tr").remove();
            var form = $(event.target).closest("form");
            form.submit();
        }

        // Toggles pointer events on and off for the access control interface
        function setPointerEvents(flag) {
            if (!flag) {
                // Disable pointer events
                $(".access-table").css("pointer-events", "none");
                $("#manage-access .modal-content").css("pointer-events", "none");
            }
            else {
                // Enable pointer events
                $(".access-table").css("pointer-events", "auto");
                $("#manage-access .modal-content").css("pointer-events", "auto");
            }
        }

        // Enables and disables granting access buttons accordingly to the current access level
        function updateActionsState(privilege){
            // Set the state of dropdown menu items and remove buttons to false by default
            $("form[data-access-type]").parent().addClass("disabled");
            $("#list-roles a[data-role]").parent().addClass("disabled");
            $(".access-table li.active[data-access-type]").closest("tr").addClass("hide-actions");

            if (privilege == "view") {
                // Dropdown menu items
                $("form[data-access-type='Can view']").parent().removeClass("disabled");
                $("#list-roles a[data-role='view']").parent().removeClass("disabled");

                // Remove buttons
                $(".access-table li.active[data-access-type='Can view']").closest("tr").removeClass("hide-actions");
            }
            else if(privilege == "change") {
                // Dropdown menu items
                $("form[data-access-type='Can view']").parent().removeClass("disabled");
                $("#list-roles a[data-role='view']").parent().removeClass("disabled");

                $("form[data-access-type='Can edit']").parent().removeClass("disabled");
                $("#list-roles a[data-role='edit']").parent().removeClass("disabled");

                // Remove buttons
                $(".access-table li.active[data-access-type='Can view']").closest("tr").removeClass("hide-actions");
                $(".access-table li.active[data-access-type='Can edit']").closest("tr").removeClass("hide-actions");
            }
            else if(privilege == "owner") {
                // Dropdown menu items
                $("form[data-access-type='Can view']").parent().removeClass("disabled");
                $("#list-roles a[data-role='view']").parent().removeClass("disabled");

                $("form[data-access-type='Can edit']").parent().removeClass("disabled");
                $("#list-roles a[data-role='edit']").parent().removeClass("disabled");

                $("form[data-access-type='Is owner']").parent().removeClass("disabled");
                $("#list-roles a[data-role='owner']").parent().removeClass("disabled");

                // Remove buttons
                $(".access-table li.active[data-access-type='Can view']").closest("tr").removeClass("hide-actions");
                $(".access-table li.active[data-access-type='Can edit']").closest("tr").removeClass("hide-actions");
                if ($(".access-table li.active[data-access-type='Is owner']").length > 1) {     // At least one owner constrain
                    $(".access-table li.active[data-access-type='Is owner']").closest("tr").removeClass("hide-actions");
                }
            }
        }

        function onRemoveKeyword(event) {
            $(event.target).closest(".tag").remove();
            updateKeywords();
            metadata_update_ajax_submit('id-subject');
        }

        function onAddKeyword(event) {
            var keyword = $("#txt-keyword").val();
            keyword = keyword.split(",");

            for (var i = 0; i < keyword.length; i++) {
                keyword[i] = keyword[i].trim(); // Remove leading and trailing whitespace
                var exists = false;
                // Check if the keyword already exists
                for (var x = 0; x < $("#lst-tags").find(".tag > span").length; x++) {
                    if ($($("#lst-tags").find(".tag > span")[x]).text() == keyword[i]) {
                        exists = true;
                    }
                }

                // If does not exist, add it
                if (!exists && keyword[i] != "") {
                    var li = $("<li class='tag'><span></span></li>");
                    li.find('span').text(keyword[i]);
                    li.append('&nbsp;<a><span class="glyphicon glyphicon-remove-circle icon-remove"></span></a>')
                    $("#lst-tags").append(li);

                    $(".icon-remove").click(onRemoveKeyword);
                    updateKeywords();
                }
            }

            $("#txt-keyword").val("");  // Clear text input
            metadata_update_ajax_submit('id-subject');
        }

        function updateKeywords() {
            var keywords = "";
            var count = $("#lst-tags").find(".tag > span").length;
            for (var x = 0; x < count; x++) {
                keywords += $($("#lst-tags").find(".tag > span")[x]).text();
                if (x != count - 1) {
                    keywords += ",";
                }
            }

            $("#id-subject").find("#id_value").val(keywords);
        }

        function customAlert(msg, duration) {
            var el = document.createElement("div");
            var top = 200;
            var left = ($(window).width() / 2) - 150;
            var style = "top:" + top + "px;left:" + left + "px";
            el.setAttribute("style", style);
            el.setAttribute("class", "custom-alert");
            el.innerHTML = msg;
            setTimeout(function () {
                $(el).fadeOut(300, function () {
                    $(this).remove();
                });
            }, duration);
            document.body.appendChild(el);
            $(el).hide().fadeIn(400);
        }

        function showAddEditExtraMetaPopup(edit, row_id_str) {
            $("#edit_extra_meta_row_id").val('');
            $("#old_extra_meta_name").val('');
            $("#extra_meta_name_input").val('');
            $("#extra_meta_value_input").val('');
            if (edit) {
                var t = $('#extraMetaTable').DataTable();
                var row_to_edit = t.row("#" + row_id_str);
                var oldname = row_to_edit.data()[0];
                var oldvalue = row_to_edit.data()[1];
                $("#edit_extra_meta_row_id").val(row_id_str);
                $("#old_extra_meta_name").val(oldname);
                $("#extra_meta_name_input").val(oldname);
                $("#extra_meta_value_input").val(oldvalue);
                $("#extra_meta_title").text("Edit Extended Metadata");
            }
            else {
                $("#extra_meta_title").text("Add Extended Metadata");
            }
            $('#extraMetaDialog').modal('show');
        }

        function addEditExtraMeta2Table() {
            $("#extra_meta_msg").hide();
            var t = $('#extraMetaTable').DataTable();
            var extra_meta_name = $("#extra_meta_name_input").val().trim();
            var extra_meta_value = $("#extra_meta_value_input").val().trim();
            var edit_extra_meta_row_id = $("#edit_extra_meta_row_id").val().trim();

            if(extra_meta_name.length==0 || extra_meta_value.length==0) {
                $("#extra_meta_msg").html("<font color='red'>Both name and value are required fields that cannot be left blank.</font>");
                $("#extra_meta_msg").show();
                return;
            }

            if(foundDuplicatedName(t, extra_meta_name, edit_extra_meta_row_id)) {
                $("#extra_meta_msg").html("<font color='red'>The name already exists. Please input a different name.</font>");
                $("#extra_meta_msg").show();
                return;
            }

            if (edit_extra_meta_row_id == "") {
                // add new
                var new_row_id_0_base = findMaxRowID(t) + 1;
                var edit_icon_str = '<span onclick="showAddEditExtraMetaPopup(true,' + "'" + new_row_id_0_base + "'" + ')"' + ' data-form-type="toggle-favorite" class="glyphicon glyphicon-edit btn-inline-favorite"></span>';
                var remove_icon_str = '<span onclick="removeExtraMetadataFromTable(' + "'" + new_row_id_0_base + "'" + ')"' + ' data-form-type="toggle-favorite" class="glyphicon glyphicon-remove btn-inline-favorite"></span>';
                var row_ele = t.row.add( [extra_meta_name,extra_meta_value, edit_icon_str+" "+remove_icon_str]).node();
                $(row_ele).attr( 'id', new_row_id_0_base);
            }
            else {
                // edit existing
                var row_to_edit = t.row("#" + edit_extra_meta_row_id);
                var updated_data_array = row_to_edit.data();
                updated_data_array[0] = extra_meta_name;
                updated_data_array[1] = extra_meta_value;
                row_to_edit.data(updated_data_array);
            }
            t.rows().invalidate().draw();
            $('#extraMetaDialog').modal('hide');
            $('#save-extra-meta-btn').show();
        }

        function findMaxRowID(table)
        {
            var max_id = -1;
            table.rows(). every(function ( rowIdx, tableLoop, rowLoop ) {
                if(parseInt(this.node().id) > max_id)
                {
                   max_id = parseInt(this.node().id);
                }
            });
            return max_id;
        }

        function foundDuplicatedName(table, newName, except_row_id)
        {
            var found_first_duplicated = false;
            var first_duplicated_row_id = -1;

            table.rows(). every(function ( rowIdx, tableLoop, rowLoop ) {
                if(this.node().id != except_row_id) {
                    if (this.data()[0]==newName) {
                       found_first_duplicated = true;
                       first_duplicated_row_id = this.node().id;
                    }
                }
            });
            return found_first_duplicated;
        }

        function saveExtraMetadata()
        {
            $alert_success_extra_meta = "<i class='glyphicon glyphicon-flag custom-alert-icon'></i><strong>Success:</strong> Extended metadata updated";
            $alert_error_extra_meta = "<i class='glyphicon glyphicon-flag custom-alert-icon'></i><strong>Error:</strong> Extended metadata failed to update";

            var json_obj = {};
            var t = $('#extraMetaTable').DataTable();
            t.rows(). every(function ( rowIdx, tableLoop, rowLoop ) {
                var extra_meta_name = this.data()[0].trim();
                var extra_meta_value = this.data()[1].trim();
                json_obj[extra_meta_name] = extra_meta_value;
            });

            var json_str = JSON.stringify(json_obj);
            json_obj = JSON.parse(json_str);
            var update_key_value_metadata_url = "/hsapi/_internal/" + '{{ page.get_content_model.short_id }}' + "/update-key-value-metadata/";
            $.ajax({
                type: "POST",
                url: update_key_value_metadata_url,
                dataType: "json",
                data: json_obj,

                success: function(result) {
                    json_response = result;
                    if (json_response.status === 'success') {
                         $('#save-extra-meta-btn').hide();
                         customAlert($alert_success_extra_meta, 3000);
                    }
                    else {
                         customAlert($alert_error_extra_meta, 3000);
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    customAlert($alert_error_extra_meta, 3000);
                }
            });
        } // function saveExtraMetadata()

        function removeExtraMetadataFromTable(row_id)
        {
            var removed_row = $('#extraMetaTable').DataTable().row('#' + row_id);
            removed_row.remove().draw(false);
            $('#save-extra-meta-btn').show();
        }

        function update_download_status(task_id, download_path) {
            download_status_timeout_id=-1;
            // disable download button to prevent it from being clicked again
            $('#btn-download-all').attr('disabled', 'disabled');
            $.ajax({
                dataType: "json",
                cache: false,
                timeout: 60000,
                type: "POST",
                url: '/django_irods/check_task_status/',
                data: {
                    task_id: task_id
                },
                success: function(data) {
                    if(data.status) {
                        $("#loading").html('');
                        if(download_status_timeout_id > -1)
                            clearTimeout(download_status_timeout_id);
                        $("#btn-download-all").removeAttr('disabled');
                        $("#download-status-info").html(
                                "If your download does not start automatically, " +
                                "please click <a href='" + download_path + "'>here</a>.");
                        window.location.href = download_path;
                    }
                    // only check status again in 3 seconds when $("#loading") is not
                    // cleared up by success status above
                    else if($("#loading").html()) {
                        $("#loading").html($("#loading").html() + ".");
                        download_status_timeout_id = setTimeout(function () {
                            update_download_status(task_id, download_path);
                        }, 3000);
                    }
                },
                error: function (xhr, errmsg, err) {
                    if(download_status_timeout_id > -1)
                        clearTimeout(download_status_timeout_id);
                    $("#btn-download-all").removeAttr('disabled');
                    console.log(errmsg);
                    alert("Resource bag cannot be generated due to download poll errors: " + errmsg);
                }
            });
        }

        $(document).ready(function () {
            var task_id = $('#task_id').val();
            var download_path = $('#download_path').val();
            resID = $("#hs-file-browser").attr("data-res-id");
            if (task_id)
                update_download_status(task_id, download_path);

            $("#agree-chk").on('click', function(e) {
                e.stopImmediatePropagation();
                if (e.currentTarget.checked)
                    $('#publish-btn').removeAttr('disabled');
                else
                    $('#publish-btn').attr('disabled', 'disabled');
            });
            // add input element to each of the comment/rating forms to track resource mode (edit or view)
            var resourceMode = $("#resource-mode").val().toLowerCase();
            var inputElementToAdd = '<input type="hidden" name="resource-mode" value="mode_to_replace" />';
            inputElementToAdd = inputElementToAdd.replace('mode_to_replace', resourceMode);
            $("[id^=comment-]").find('form').each(function () {
                $(this).append(inputElementToAdd);
            });
            // new comment form
            $("#comment").append(inputElementToAdd);

            // On manage access interface, prevent form submission when pressing the enter key on the search box.
            $('#id_user-autocomplete').keypress(function (e) {
                e = e || event;
                var txtArea = /textarea/i.test((e.target || e.srcElement).tagName);
                return txtArea || (e.keyCode || e.which || e.charCode || 0) !== 13;
            });

            // Display toggle for Add Author/Contributor radio buttons
            function onAddContributorTypeChange() {
                var type = $(this).val();
                $("div[data-hs-user-type]").hide();
                $("div[data-hs-user-type='" + type + "']").show();
            }
            $("input[name='add_author_user_type']").click(onAddContributorTypeChange);
            $("input[name='add_contributor_user_type']").click(onAddContributorTypeChange);

            // Display toggle for author type radio buttons ('person' or 'organization')
            function onOrgTypeChange() {
                var type = $(this).val();
                $("div[data-hs-org-type]").hide();
                $("div[data-hs-org-type='" + type + "']").show();
            }
            $("input[name='choose_org_type']").click(onOrgTypeChange);

            // Display toggle for author type radio buttons ('person' or 'organization')
            function onPersonTypeChange() {
                var type = $(this).val();
                $("div[data-hs-person-type]").hide();
                $("div[data-hs-person-type='" + type + "']").show();
            }
            $("input[name='add_author_person']").click(onPersonTypeChange);


            $("#citation-text").on("click", function (e) {
                // document.selection logic is added in for IE 8 and lower
                if (document.selection) {
                    document.selection.empty();
                    var range = document.body.createTextRange();
                    range.moveToElementText(this);
                    range.select();
                }
                else if (window.getSelection) {
                    // Get the selection object
                    var selection = window.getSelection();
                    selection.removeAllRanges();
                    var range = document.createRange();
                    range.selectNode(this);
                    selection.addRange(range);
                }
            });

            $("#btn-shareable").on("change", shareable_ajax_submit);
            $("#btnMyResources").click(label_ajax_submit);

            if ($("#coverageMap").length) {
                google.maps.event.addDomListener(window, "load", initMap);

                $("#coverageTabBtn").click(function () {
                    setTimeout(function () {
                        // Call resize to re-render the map since it wasn't visible during load.
                        google.maps.event.trigger(coverageMap, "resize");
                        // This field is populated if the page is in view mode
                        var shapeType = $("#coverageMap")[0].getAttribute("data-shape-type");

                        var resourceType = $("#resource-type").val();
                        var spatialCoverageType = $("#spatial-coverage-type").val();
                        // Center the map
                        if (shapeType || resourceType === "Time Series" || resourceType === "Composite") {
                            deleteAllShapes();
                            if (shapeType == "point" || (resourceType === "Time Series" && spatialCoverageType == "point") || (resourceType === "Composite" && spatialCoverageType === "point")) {
                                var myLatLng;
                                if (shapeType == "point") {
                                    // resource view mode
                                    myLatLng = {
                                        lat: parseFloat($("#cov_north").text()),
                                        lng: parseFloat($("#cov_east").text())
                                    };
                                }
                                else {
                                    // time series resource/composite resource in edit mode
                                    myLatLng = {
                                        lat: parseFloat($("#id_north").val()),
                                        lng: parseFloat($("#id_east").val())
                                    };
                                    if (resourceType === "Time Series"){
                                        if ($('#id_north').val()) {
                                            $("#id_name").prop('readonly', false);
                                        }
                                    }
                                }

                                if (!myLatLng.lat || !myLatLng.lng) {
                                    return;
                                }
                                // Define the rectangle and set its editable property to true.
                                var marker = new google.maps.Marker({
                                    position: myLatLng,
                                    map: coverageMap
                                });
                                allShapes.push(marker);
                                // Center map at new market
                                coverageMap.setCenter(marker.getPosition());
                                $("#resetZoomBtn").click(function () {
                                    coverageMap.setCenter(marker.getPosition());
                                });
                            }
                            else if (shapeType == "box" || (resourceType === "Time Series" && spatialCoverageType == "box") || (resourceType === "Composite" && spatialCoverageType === "box")) {
                                var bounds;
                                if (shapeType == "box") {
                                    //resource view mode
                                    bounds = {
                                        north: parseFloat($("#cov_northlimit").text()),
                                        south: parseFloat($("#cov_southlimit").text()),
                                        east: parseFloat($("#cov_eastlimit").text()),
                                        west: parseFloat($("#cov_westlimit").text())
                                    };
                                }
                                else {
                                    // time series resource/composite resource edit mode
                                    bounds = {
                                        north: parseFloat($("#id_northlimit").val()),
                                        south: parseFloat($("#id_southlimit").val()),
                                        east: parseFloat($("#id_eastlimit").val()),
                                        west: parseFloat($("#id_westlimit").val())
                                    };
                                    if (resourceType === "Time Series"){
                                        if ($('#id_northlimit').val()) {
                                            $("#id_name").prop('readonly', false);
                                        }
                                    }

                                }

                                if (!bounds.north || !bounds.south || !bounds.east || !bounds.west) {
                                    return;
                                }
                                // Define the rectangle and set its editable property to true.
                                var rectangle = new google.maps.Rectangle({
                                    bounds: bounds,
                                    editable: false,
                                    draggable: false
                                });
                                rectangle.setMap(coverageMap);
                                allShapes.push(rectangle);
                                zoomCoverageMap(bounds);
                                $("#resetZoomBtn").click(function () {
                                    zoomCoverageMap(bounds);
                                });
                            }
                        }
                        else {
                            if ($("#id_type_1").is(":checked")) {
                                drawRectangleOnTextChange();
                            }
                            else {
                                drawMarkerOnTextChange();
                            }
                        }
                    }, 200);   // Gives container enough time to be rendered before the map is rendered.
                });
                $("#id-coverage-spatial input:radio").change(function () {
                    if ($(this).val() == "point") {
                        $("#div_id_north").show();
                        $("#div_id_east").show();
                        $("#div_id_elevation").show();
                        $("#div_id_northlimit").hide();
                        $("#div_id_eastlimit").hide();
                        $("#div_id_southlimit").hide();
                        $("#div_id_westlimit").hide();
                        $("#div_id_uplimit").hide();
                        $("#div_id_downlimit").hide();
                        drawMarkerOnTextChange();
                        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
                    }
                    else {
                        $("#div_id_north").hide();
                        $("#div_id_east").hide();
                        $("#div_id_elevation").hide();
                        $("#div_id_northlimit").show();
                        $("#div_id_eastlimit").show();
                        $("#div_id_southlimit").show();
                        $("#div_id_westlimit").show();
                        $("#div_id_uplimit").show();
                        $("#div_id_downlimit").show();
                        drawRectangleOnTextChange();
                        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.RECTANGLE);
                    }
                    // Show save changes button
                    $("#coverage-spatial").find(".btn-primary").show();
                });
                if (sessionStorage.signininfo) {
                    $("#sign-in-info").text(sessionStorage.signininfo);
                    $("#btn-select-irods-file").show();
                }
            }

            // Apply theme to comment's submit button
            $("#comment input[type='submit']").removeClass();
            $("#comment input[type='submit']").addClass("btn btn-default");

            $(".list-separator").parent().hover(function(){
                $(this).css("text-decoration", "none");
                $(this).css("pointer-events", "none");
            });

            var keywordString = "{% for k, v in subjects_form.initial.iteritems  %}{{ v }}{% endfor %}";
            $("#id-subject").find("#id_value").val(keywordString);

            // Populate keywords field
            var keywords = keywordString.split(",");
            $("#lst-tags").empty();
            for (var i = 0; i < keywords.length; i++) {
                if (keywords[i] != "") {
                    var li = $("<li class='tag'><span></span></li>");
                    li.find('span').text(keywords[i]);
                    li.append('&nbsp;<a><span class="glyphicon glyphicon-remove-circle icon-remove"></span></a>')
                    $("#lst-tags").append(li);
                }
            }

            $(".icon-remove").click(onRemoveKeyword);
            $("#btn-add-keyword").click(onAddKeyword);
            $("#txt-keyword").keyup(function (e) {
                e.which = e.which || e.keyCode;
                if (e.which == 13) {
                    onAddKeyword();
                }
            });

            $("#list-roles a").click(onRoleSelect);
            $("#id_user-autocomplete").attr("placeholder", "Search by name or username");
            $("#id_group-autocomplete").attr("placeholder", "Search by group name");

            var file_types = $("#supported-file-types").attr('value');
            if (file_types != ".*") {
                var display_file_types = file_types.substring(0, file_types.length - 1) + ').';
                display_file_types = display_file_types.replace(/'/g, '');
                $("#file-types").text("Only the listed file types can be uploaded: " + display_file_types);
                $("#file-types-irods").text("Only the listed file types can be uploaded: " + display_file_types);
            }
            else {
                $("#file-types").text("Any file type can be uploaded.");
            }
            var file_count = $("#file-count").attr('value');

            // set if multiple file can be uploaded
            var allow_multiple_file_upload = $("#allow-multiple-file-upload").attr('value');
            if (allow_multiple_file_upload === "True") {
                $("#file-multiple").text("Multiple file upload is allowed.");
                $("#file-multiple-irods").text("Multiple file upload is allowed.");
            }
            else {
                $("#file-multiple").text("Only one file can be uploaded.");
                $("#file-multiple-irods").text("Only one file can be uploaded.");

                if (file_count > 0) {
                    $("#log-into-irods").hide();
                    $("#sign-in-info").hide();
                    $("#btn-select-irods-file").hide();
                }
            }

            if ($("#id_type_1").is(':checked')) { //box type coverage
                $("#div_id_north").hide();
                $("#div_id_east").hide();
                $("#div_id_elevation").hide();
            }
            if ($("#id_type_2").is(':checked')) { // point type coverage
                $("#div_id_northlimit").hide();
                $("#div_id_eastlimit").hide();
                $("#div_id_southlimit").hide();
                $("#div_id_westlimit").hide();
                $("#div_id_uplimit").hide();
                $("#div_id_downlimit").hide();
            }
            if ($("input:button[value='Delete creator']").length == 1) {
                $("input:button[value='Delete creator']").first().hide();
            }
            // disable all save changes button on load
            $("form").each(function () {
                $save_button = $(this).find("button").first();
                if ($save_button.text() === "Save changes") {
                    $save_button.hide();
                }
            });

            $("#select_license").on('change', function () {
                var value = this.value;
                if (value === "other") {
                    $(this).closest("form").find("#id_statement").first().text("");
                    $(this).closest("form").find("#id_url").first().attr('value', "");
                    $(this).closest("form").find("#id_statement").first().attr('readonly', false);
                    $(this).closest("form").find("#id_url").first().attr('readonly', false);
                    $("#img-badge").first().hide();
                }
                else {
                    var text = $(this).find('option:selected').text();
                    text = "This resource is shared under the " + text + ".";
                    $(this).closest("form").find("#id_statement").first().text(text);
                    $(this).closest("form").find("#id_url").first().attr('value', value);
                    $(this).closest("form").find("#id_statement").first().attr('readonly', true);
                    $(this).closest("form").find("#id_url").first().attr('readonly', true);
                    $("#img-badge").first().show();
                    if (text == "This resource is shared under the Creative Commons Attribution CC BY.") {
                        $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY.png");
                        $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY");
                    }
                    else if (text == "This resource is shared under the Creative Commons Attribution-ShareAlike CC BY-SA.") {
                        $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-SA.png");
                        $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-SA");
                    }
                    else if (text == "This resource is shared under the Creative Commons Attribution-NoDerivs CC BY-ND.") {
                        $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-ND.png");
                        $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-ND");
                    }
                    else if (text == "This resource is shared under the Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA.") {
                        $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-NC-SA.png");
                        $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-NC-SA");
                    }
                    else if (text == "This resource is shared under the Creative Commons Attribution-NoCommercial CC BY-NC.") {
                        $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-NC.png");
                        $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-NC");
                    }
                    else if (text == "This resource is shared under the Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND.") {
                        $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-NC-ND.png");
                        $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-NC-ND");
                    }
                }
            });

            // set the selected license in the select license dropdown
            var value_exists = false;
            $("#select_license option").each(function () {
                if (this.value == $("#id_url").attr('value')) {
                    $("#select_license").val($("#id_url").attr('value'));
                    value_exists = true;
                    return;
                }
            });

            if (value_exists == false) {
                // set the selected license type to 'other'
                $("#select_license").val('other');
                if ($("#select_license").attr('readonly') == undefined) {
                    $("#select_license").closest("form").find("#id_statement").first().attr('readonly', false);
                    $("#select_license").closest("form").find("#id_url").first().attr('readonly', false);
                    $("#img-badge").first().hide();
                }
                else {
                    $("#select_license").attr('style', "background-color:white;");
                    $("#select_license").closest("form").find("#id_statement").first().attr('readonly', true);
                    $("#select_license").closest("form").find("#id_url").first().attr('readonly', true);
                }
            }

            // show "Save changes" button when form editing starts
            showMetadataFormSaveChangesButton();

            // Initialize date pickers
            initializeDatePickers();

            // init ExtraMetadata Table
            extraMetaTable = $("#extraMetaTable").DataTable({
                "paging": false,
                "bSort": false,
                "bLengthChange": false,
                "info": false,
                "bFilter": false,
                "bInfo": false,
                "language": {"emptyTable": "No Extended Metadata"}
            });

            // Toggle visibility for invite users or groups
            $(".add-view-group-form").hide();

            // Toggle invite user or group form
            $("#invite-flag button").click(function () {
                var form = $("#add-access-form");
                var action = form.attr("action");
                if ($(this).attr("data-value") == "users") {
                    $(".add-view-user-form").show();
                    $(".add-view-group-form").hide();
                    action = action.replace("share-resource-with-group", "share-resource-with-user");
                    form.attr("action", action);
                    $("#list-roles li:nth-child(3)").show();

                    $("#invite-flag button[data-value='groups']").removeClass("btn-primary");
                    $("#invite-flag button[data-value='groups']").addClass("btn-default");
                    $("#invite-flag button[data-value='users']").removeClass("btn-default");
                    $("#invite-flag button[data-value='users']").addClass("btn-primary");

                }
                else {
                    $(".add-view-group-form").show();
                    $(".add-view-user-form").hide();
                    action = action.replace("share-resource-with-user", "share-resource-with-group");
                    form.attr("action", action);
                    if ($("#selected_role").attr("data-role") == "owner") {
                        $("#selected_role").attr("data-role", "view");
                        $("#selected_role").text("Can view");
                    }
                    $("#list-roles li:nth-child(3)").hide();
                    $("#invite-flag button[data-value='users']").disabled = true;
                    $("#invite-flag button[data-value='groups']").disabled = false;


                    $("#invite-flag button[data-value='users']").removeClass("btn-primary");
                    $("#invite-flag button[data-value='users']").addClass("btn-default");
                    $("#invite-flag button[data-value='groups']").removeClass("btn-default");
                    $("#invite-flag button[data-value='groups']").addClass("btn-primary");
                }
            });
        });
    </script>

    {% if relevant_tools %}
        <script type="text/javascript" src="{{ STATIC_URL }}js/toolresource.js"></script>
    {% endif %}
{% endblock %}

