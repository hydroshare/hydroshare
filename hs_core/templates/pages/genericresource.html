{% extends 'pages/page.html' %}

{% load geoanalytics_tags pages_tags mezzanine_tags comment_tags keyword_tags hydroshare_tags crispy_forms_tags %}

{% block main %}

    {% with page.get_content_model as cm %}
        {% keywords_for page as kws %}
        {% set_page_permissions page %}

        {% if not metadata_form %}
            {% if not keywords or not abstract %}
                <div class="alert alert-danger alert-dismissible" role="alert">
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                  <strong>Data for the following required elements are missing:</strong>
                    <ul>
                    {% if not abstract %}
                       <li>Abstract</li>
                    {% endif %}
                    {% if not keywords %}
                       <li>Keywords</li>
                    {% endif %}
                    {% if title|stringformat:"s" == "Untitled resource" %}
                       <li>Title: needs to be changed</li>
                    {% endif %}
                </ul>
             </div>
            {% endif %}
            {% if page.perms.change %}
                <div class="custom-btn-toolbar">
                    <form class="inline" action="{{ cm.get_absolute_url }}" method="post">
                        {% csrf_token %}
                        <a id="delete" data-toggle="modal" data-target="#delete-resource-dialog">
                        <span data-toggle="tooltip" data-placement="auto" title="Delete"
                              class="glyphicon glyphicon-trash icon-button btn-remove"></span>
                        </a>
                        <input name="resource-mode" type="hidden" value="edit"/>
                        <button id="edit-metadata" type="submit" data-toggle="tooltip" data-placement="auto"
                                title="Edit" class="glyphicon glyphicon-pencil icon-button btn-edit"></button>
                    </form>
                </div>
            {% endif %}

            <h2 class="page-title">{{ title }}</h2>
            <div class="info-group">
                <table>
                    <tr><th>Authors:</th><td>
                        <span id="authors">
                            {% for cr in creators %}
                                {{ cr.name }},&nbsp
                            {% endfor %}
                        </span>
                    </td></tr>
                    <tr><th>Owner:</th><td>{{ cm.user|contact|safe }}</td></tr>
                    <tr><th>Resource type:</th><td>{{ cm|resource_type }}</td></tr>
                    <tr><th>Created:</th><td>{{ cm.created|date }}</td></tr>
                    <tr><th>Last updated:</th><td> {{ cm.updated|date }}</td></tr>
                </table>
            </div>

            {% if abstract %}
                <div class="content-block">
                    <h3>Abstract</h3>
                    <span class="abstract">{{ abstract }}</span>
                </div>
            {% endif %}

            <div class="content-block">
                <h3>How to cite</h3>
                <span id="citation-text">{{ citation }}</span>
            </div>

            <div class="content-block">
                <h3>Sharing</h3>

                <div id="sharing-status">
                    <span class="pull-left">Sharing status:</span>
                    {% if page.perms.change %}
                        <form id="form-sharing" class="pull-left"
                              action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST">
                            {% csrf_token %}
                            {% if cm.public %}
                                <input name="t" type="hidden" value="make_private"/>
                                <div class="btn-group" role="group" aria-label="...">
                                    <button id="btn-public" data-toggle="tooltip" data-placement="auto"
                                            title='Can be viewed and downloaded by anyone.' type="button"
                                            class="btn btn-default active">Public
                                    </button>
                                    <button id="btn-private" data-toggle="tooltip" data-placement="auto"
                                            title='Can be viewed and downloaded only by designated users or research groups.'
                                            type="submit" class="btn btn-default">Private
                                    </button>
                                </div>
                            {% else %}
                                <input name="t" type="hidden" value="make_public"/>
                                <div class="btn-group" role="group" aria-label="...">
                                    <button id="btn-public" data-toggle="tooltip" data-placement="auto"
                                            title='Can be viewed and downloaded by anyone.' type="submit"
                                            class="btn btn-default">Public
                                    </button>
                                    <button id="btn-private" data-toggle="tooltip" data-placement="auto"
                                            title='Can be viewed and downloaded only by designated users or research groups.'
                                            type="button" class="btn btn-default active">Private
                                    </button>
                                </div>
                            {% endif %}
                        </form>
                    {% else %}
                        {% if cm.public %}
                            <strong>&nbspPublic</strong>
                        {% else %}
                            <strong>&nbspPrivate</strong>
                        {% endif %}
                    {% endif %}
                </div>

                {% if rights.statement or rights.url %}
                    <div id="rights">
                        {% if rights.statement %}
                            <span class="rights-text">{{ rights.statement }} </span>
                        {% endif %}

                        {% if rights.url %}
                            <span class="rights-url"><a href="{{ rights.url }}">&nbsp{{ rights.url }}</a></span>
                        {% endif %}
                    </div>
                    {% if rights.statement == "This resource is shared under the Creative Commons Attribution CC BY." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY.png" alt="CC-BY"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-ShareAlike CC BY-SA." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-SA.png" alt="CC-BY-SA"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoDerivs CC BY-ND." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-ND.png" alt="CC-BY-ND"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-SA.png" alt="CC-BY-NC-SA"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial CC BY-NC." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC.png" alt="CC-BY-NC"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-ND.png" alt="CC-BY-NC-ND"/>
                    {% endif %}
                {% endif %}

                <div id="permission-panel">
                {% if user == cm.user %}
                    <p>You are the owner of this resource.</p>
                {% elif is_edit_user %}
                    <p>You have been given specific permission to edit this resource.</p>
                {% elif in_edit_group %}
                    Your research group(s) have been given specific permission to edit this resource.</p>
                {% elif is_view_user %}
                    <p>You have been given specific permission to view this resource.</p>
                {% elif in_view_group %}
                    <p>Your research group(s) have been given specific permission to view this resource.</p>
                {% endif %}

                {% if page.perms.change %}

                    <div class="panel panel-default panel-faq">
                    <div class="panel-heading">
                        <a data-toggle="collapse" data-parent="#accordion-cat-1" href="#faq-cat-1-sub-1">
                            <h4 class="panel-title">
                                Manage access
                                <span class="pull-right"><i class="glyphicon glyphicon-plus"></i></span>
                            </h4>
                        </a>
                    </div>
                    <div id="faq-cat-1-sub-1" class="panel-collapse collapse" style="height: auto;">
                        <div class="panel-body">
                            <div class="col-md-4">
                                <div class="custom-well">
                                    <h5 class="access-panel-title"><strong>Users with full read/write permissions on this resource</strong></h5>

                                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST">
                                        {% csrf_token %}
                                        <select name="designees" id="owners-select" multiple class="form-control"
                                                size="{{ owners.count }}">
                                            {% for u in owners %}
                                                <option value="{{ u.pk }}" selected>{{ u|best_name }}
                                                    ({{ u.username }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <input name="t" value="owners" type="hidden"/>
                                        <button type="submit"
                                                class="btn btn-update-list pull-left btn-default glyphicon"><span
                                                class="button-label">&nbspUpdate access list</span></button>
                                                <span data-toggle="tooltip" data-placement="auto"
                                                      title='Hold down "Control", or "Command" on a Mac, to select more than one.'
                                                      class="pull-right glyphicon glyphicon-info-sign info-icon"></span>
                                    </form>
                                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST" style="padding-top:0.3em">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            <button type="submit"
                                                    class="btn btn-add-access btn-default pull-left glyphicon glyphicon-plus"><span
                                                    class="button-label">&nbspAdd user</span></button>
                                            {{ add_owner_user_form.user }}
                                            <input name="t" value="add_owner" type="hidden"/>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="custom-well">
                                    <h5 class="access-panel-title"><strong>Users who can edit the content of this resource</strong></h5>

                                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST">
                                        {% csrf_token %}
                                        <select name="designees" id="edit_users-select" multiple
                                                class="form-control" size="{{ edit_users.count }}">
                                            {% for u in edit_users %}
                                                <option value="{{ u.pk }}" selected>{{ u|best_name }}
                                                    ({{ u.username }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <input name="t" value="edit_users" type="hidden"/>
                                        <button type="submit"
                                                class="btn btn-update-list pull-left btn-default glyphicon"><span
                                                class="button-label">&nbspUpdate access list</span></button>
                                                <span data-toggle="tooltip" data-placement="auto"
                                                      title='Hold down "Control", or "Command" on a Mac, to select more than one.'
                                                      class="pull-right glyphicon glyphicon-info-sign info-icon"></span>
                                    </form>
                                    <form class="form-inline"
                                          action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST" style="padding-top:0.3em">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            <button type="submit"
                                                    class="btn btn-add-access btn-default pull-left glyphicon glyphicon-plus"><span
                                                    class="button-label">&nbspAdd user</span></button>
                                            {{ add_edit_user_form.user }}
                                            <input name="t" value="add_edit_user" type="hidden"/>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="custom-well">
                                    <h5 class="access-panel-title"><strong>Research groups that can edit the content of this resource</strong>
                                    </h5>

                                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST">
                                        {% csrf_token %}
                                        <select name="designees" id="edit_groups-select" multiple
                                                class="form-control" size="{{ edit_groups.count }}">
                                            {% for u in edit_groups %}
                                                <option value="{{ u.pk }}"
                                                        {% if u in edit_groups %}selected{% endif %}>{{ u }}</option>
                                            {% endfor %}
                                        </select>
                                        <input name="t" value="edit_groups" type="hidden"/>
                                        <button type="submit"
                                                class="btn btn-update-list pull-left btn-default glyphicon"><span
                                                class="button-label">&nbspUpdate access list</span></button>
                                                <span data-toggle="tooltip" data-placement="auto"
                                                      title='Hold down "Control", or "Command" on a Mac, to select more than one.'
                                                      class="pull-right glyphicon glyphicon-info-sign info-icon"></span>
                                    </form>
                                    <form class="form-inline"
                                          action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST" style="padding-top:0.3em">
                                        {% csrf_token %}
                                        <div class="form-group">


                                            <button type="submit"
                                                    class="btn btn-default btn-add-access pull-left glyphicon glyphicon-plus"><span
                                                    class="button-label">&nbspAdd group</span></button>
                                            {{ add_edit_group_form.user }}
                                            <input name="t" value="add_edit_group" type="hidden"/>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            {% if not cm.public %}
                                <div class="col-md-4">
                                    <div class="custom-well">
                                        <h5 class="access-panel-title"><strong>Users who can view and download the resource</strong></h5>

                                        <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                              method="POST">
                                            {% csrf_token %}
                                            <select name="designees" id="view_users-select" multiple
                                                    class="form-control" size="{{ view_users.count }}">
                                                {% for u in view_users %}
                                                    <option value="{{ u.pk }}"
                                                            {% if u in view_users %}selected{% endif %}>{{ u|best_name }}</option>
                                                {% endfor %}
                                            </select>
                                            <input name="t" value="view_users" type="hidden"/>
                                            <button type="submit"
                                                    class="btn btn-update-list pull-left btn-default glyphicon">
                                                <span class="button-label">&nbspUpdate access list</span></button>
                                                    <span data-toggle="tooltip" data-placement="auto"
                                                          title='Hold down "Control", or "Command" on a Mac, to select more than one.'
                                                          class="pull-right glyphicon glyphicon-info-sign info-icon"></span>
                                        </form>
                                        <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                              method="POST" style="padding-top:0.3em">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <button type="submit"
                                                        class="btn btn-add-access btn-default pull-left glyphicon glyphicon-plus"><span
                                                        class="button-label">&nbspAdd user</span></button>
                                                {{ add_view_user_form.user }}
                                                <input name="t" value="add_view_user" type="hidden"/>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="custom-well">
                                        <h5 class="access-panel-title"><strong>Research groups that can view and download the resource</strong>
                                        </h5>

                                        <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                              method="POST">
                                            {% csrf_token %}
                                            <select name="designees" id="view_groups-select" multiple
                                                    class="form-control" size="{{ view_groups.count }}">
                                                {% for u in view_groups %}
                                                    <option value="{{ u.pk }}"
                                                            {% if u in view_groups %}selected{% endif %}>{{ u }}</option>
                                                {% endfor %}
                                            </select>
                                            <input name="t" value="view_groups" type="hidden"/>
                                            <button type="submit"
                                                    class="btn btn-update-list pull-left btn-default glyphicon">
                                                <span class="button-label">&nbspUpdate access list</span></button>
                                                    <span data-toggle="tooltip" data-placement="auto"
                                                          title='Hold down "Control", or "Command" on a Mac, to select more than one.'
                                                          class="pull-right glyphicon glyphicon-info-sign info-icon"></span>
                                        </form>
                                        <form class="form-inline"
                                              action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                              method="POST" style="padding-top:0.3em">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <button type="submit"
                                                        class="btn btn-default btn-add-access pull-left glyphicon glyphicon-plus">
                                                    <span class="button-label">&nbspAdd group</span></button>
                                                {{ add_view_group_form.user }}
                                                <input name="t" value="add_view_group" type="hidden"/>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    </div>
                    <div>

                    </div>
                {% endif %}
                </div>
            </div>


            {% if keywords %}
                <div class="content-block">
                    <h3>Keywords</h3>

                    <p id="keywords">{{ keywords }}</p>

                    <div class="tags">
                        <ul id="list-keywords" class="tag-list custom-well">
                        </ul>
                    </div>
                </div>
            {% endif %}


            <div>
                <h3>Content</h3>
                <div class="custom-well">
                    {#            {% block extra_content %}#}
                    {#            {% endblock %}#}
                    {% if cm.files.all %}
                    <div class="table-container">
                        <table class="table-plain table-striped">
                            {% for f in cm.files.all %}
                                {#======= Modal window begins =======#}
                                <div class="modal fade" id="delete-resource-file-{{ f.pk }}" tabindex="-1" role="dialog"
                                     aria-labelledby="myModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true">&times;</button>
                                                <h4 class="modal-title">Confirm file deletion</h4>
                                            </div>
                                            <div class="modal-body">
                                                This will delete the file from the resource. Consider saving a copy if
                                                it is important to you.
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-default" data-dismiss="modal">
                                                    Cancel
                                                </button>
                                                <a type="button" class="btn btn-danger"
                                                   href="/hsapi/_internal/{{ cm.short_id }}/delete-resource-file/{{ f.pk }}/">Delete</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {#======= Modal window ends =======#}
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-file file-icon"></span>
                                <span>
                                    <span class="label-file-name">{{ f.resource_file.name|slice:"33:" }}</span>
                                    <p class="label-file-size">{{ f.resource_file.size|filesizeformat }}</p>
                                </span>
                                    </td>
                                    {#                    <td>{% if preview %}<a class="btn btn-info btn-block" href="{{ preview }}">Preview</a>{% endif %}</td>#}
                                    <td>
                                        {% if page.perms.change %}
                                            <a href="{{ f.resource_file.url }}"><span data-toggle="modal"
                                                                                      data-target="#delete-resource-file-{{ f.pk }}"
                                                                                      data-placement="auto"
                                                                                      title="Delete"
                                                                                      class="glyphicon glyphicon-trash icon-button btn-remove"></span></a>
                                        {% endif %}
                                        <a href="{{ f.resource_file.url }}"><span data-toggle="tooltip"
                                                                                  data-placement="auto" title="Download"
                                                                                  class="glyphicon glyphicon-download icon-button btn-download"></span></a>
                                        {% if preview %}
                                            <a href="{{ f.resource_file.url }}"><span data-toggle="tooltip"
                                                                                      data-placement="auto"
                                                                                      title="Preview"
                                                                                      class="glyphicon glyphicon-eye-open icon-button"></span></a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}

                        </table>
                    </div>
                    {% endif %}
                    <!-- Buttons -->
                    {% for b in cm.bags.all %}
                        <a id="btn-download-all" type="button" class="btn btn-default" href="{{ bag.bag.url }}">
                            <span class="glyphicon glyphicon-download-alt">
                                <span class="button-label">Download All ({{ b.bag.size|filesizeformat }})</span>
                            </span>
                        </a>
                    {% endfor %}

                    {#                      {% if page.perms.change and resource_type != "Geographic Raster Resource" %}#}
                    {% if page.perms.change %}
                        {#                        <td><button class="btn btn-success"  data-toggle="modal" data-target="#add-file-dialog" multiple="multiple">Add file</button></td>#}
                        <td><a id="btn-add-file" type="button" class="btn btn-success" data-toggle="modal" data-target="#add-file-dialog"
                               multiple="multiple">
                            <span class="glyphicon glyphicon-plus"><span class="button-label"> Add file...</span></span>
                        </a></td>
                    {% endif %}
                </div>
            </div>

            <!-- === Tabs begin === -->
            <div class="tab-elements">
            <div class="panel-tabs">
                <ul class="nav nav-tabs">
                    <li class="active col-md-3 col-sm-3 col-xs-12">
                        <a href="#contactTab" data-toggle="tab">
                            <span class="glyphicon glyphicon-user"> </span>
                            &nbspContact
                        </a>
                    </li>
                    {% if spatial_coverage.north or spatial_coverage.northlimit or temporal_coverage %}
                        <li class="col-md-3 col-sm-3 col-xs-12">
                            <a href="#coveragelTab" data-toggle="tab">
                                <span class="glyphicon glyphicon-globe"></span>
                                &nbspCoverage
                            </a>
                        </li>
                    {% endif %}
                    {% if sources or relations %}
                        <li class="col-md-3 col-sm-3 col-xs-12">
                            <a href="#relatedResourcesTab" data-toggle="tab">
                                <span class="glyphicon glyphicon-book"></span>
                                &nbspRelated Resources
                            </a>
                        </li>
                    {% endif %}
                    {% if site or extended_metadata_exists or res_add_metadata %}
                        <li class="col-md-3 col-sm-3 col-xs-12">
                            <a href="#resourceSpecificTab" data-toggle="tab">
                                <span class="glyphicon glyphicon-folder-close"></span>
                                &nbspResource Specific
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
            <div class="tabs-body">
            <!-- Tab panes -->
            <div class="tab-content">
            <!-- ========= CONTACT TAB ========= -->
            <div class="tab-pane active" id="contactTab">
                <div>
                    <table class="table table-striped">
                        <tbody>
                        <tr>
                            <th class="division-title">Authors</th>
                        </tr>
                        <tr class="header-row">
                            <th>Name</th>
                            <th>Organization</th>
                            <th>Address</th>
                            <th>Phone</th>
                        </tr>
                        {% for cr in creators %}
                            <tr>
                                <td>{% if cr.description %} <a href="{{ cr.description }}">{{ cr.name }}</a>{% else %}{{ cr.name }}{% endif %}</td>
                                <td>{% if cr.organization %} {{ cr.organization }}{% endif %}</td>
                                <td>{% if cr.address %} {{ cr.address }}{% endif %}</td>
                                <td>{% if cr.phone %} {{ cr.phone }}{% endif %}</td>
                            </tr>
                        {% endfor %}
                        {% if contributors %}
                            <tr>
                                <th class="division-title">Contributors</th>
                            </tr>
                            <tr class="header-row">
                                <th>Name</th>
                                <th>Organization</th>
                                <th>Address</th>
                                <th>Phone</th>
                            </tr>

                            {% for cont in contributors %}
                                <tr>
                                    <td>{{ cont.name }}</td>
                                    <td>{{ cont.organization }}</td>
                                    <td>{{ cont.address }}</td>
                                    <td>{{ cont.phone }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        </tbody>
                    </table>

                </div>
            </div>
            <!-- ========= COVERAGE TAB ========= -->
            {% if spatial_coverage.north or spatial_coverage.northlimit or temporal_coverage %}
                <div class="tab-pane" id="coveragelTab">
                    <h4><strong>Spatial:</strong></h4>
                    <hr style="margin-top: 0px;margin-bottom: 2px">

                    {% if spatial_coverage.type == 'point' %}
                        {#                                TODO: find a place for doi field#}
                        {#                                {% if cm.doi %}#}
                        {#                                <tr>#}
                        {#								    <th scope="row" class="dataset-label">DOI:</th>#}
                        {#								    <td class="dataset-details"><a id="permalink" href="http://{{ request.get_host }}/r/doi/{{ cm.doi }}/">{{ cm.doi }}</a></td>#}
                        {#							    </tr>#}
                        {#                                {% endif %}#}
                        {% if spatial_coverage.name %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Place/Area Name:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.name }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.projection %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Coordinate System/Geographic
                                    Projection:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.projection }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.east %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Longitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.east }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.north %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Latitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.north }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.units %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Coordinate Units:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.units }}</div>
                            </div>
                        {% endif %}
                    {% else %}
                        {% if spatial_coverage.name %}
                            <div class="row">
                                <div class="col-sm-4"><strong>CPlace/Area Name:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.name }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.projection %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Coordinate System/Geographic
                                    Projection:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.projection }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.northlimit %}
                            <div class="row">
                                <div class="col-sm-4"><strong>North Latitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.northlimit }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.eastlimit %}
                            <div class="row">
                                <div class="col-sm-4"><strong>East Longitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.eastlimit }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.southlimit %}
                            <div class="row">
                                <div class="col-sm-4"><strong>South Latitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.southlimit }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.westlimit %}
                            <div class="row">
                                <div class="col-sm-4"><strong>West Longitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.westlimit }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.units %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Coordinate Units:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.units }}</div>
                            </div>
                        {% endif %}
                    {% endif %}

                    {% if temporal_coverage %}
                        <hr style="border: 0;">
                        <h4><strong>Temporal:</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        <div class="row">
                            <div class="col-sm-4"><strong>Start Date:</strong></div>
                            <div class="col-sm-8">{{ temporal_coverage.start_date }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>End Date:</strong></div>
                            <div class="col-sm-8">{{ temporal_coverage.end_date }}</div>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
            <!-- ========= RELATED RESOURCES TAB ========= -->
            {% if sources or relations %}
                <div class="tab-pane" id="relatedResourcesTab">
                {% if sources %}
                    <h4><strong>Sources:</strong></h4>
                    <hr style="margin-top: 0px;margin-bottom: 2px">
                    {% for source in sources %}
                        <div class="row">
                            <div class="col-sm-4"><strong>Derived From:</strong></div>
                            <div class="col-sm-8">{{ source.derived_from }}</div>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if relations %}
                    <hr style="border: 0;">
                    <h4><strong>Relations:</strong></h4>
                    <hr style="margin-top: 0px;margin-bottom: 2px">
                    {% for relation in relations %}
                        <div class="row">
                            <div class="col-sm-4"><strong>{{ relation.type }}:</strong></div>
                            <div class="col-sm-8">{{ relation.value }}</div>
                        </div>
                    {% endfor %}
                {% endif %}
                </div>
            {% endif %}


            <!-- ========= RESOURCE SPECIFIC TAB ========= -->
            {% if site or extended_metadata_exists or res_add_metadata %}
                <div class="tab-pane" id="resourceSpecificTab">
                {% if extended_metadata_exists %}
                    <div>
                        {% if model_output %}
                            <h4><strong>Model Output:</strong></h4>
                            <hr style="margin-top: 0px;margin-bottom: 2px">
                            <div class="row">
                                <div class="col-sm-4"><strong>Includes output files?</strong></div>
                                {% if model_output.includes_output == True %}
                                    <div class="col-sm-8">Yes</div>
                                {% else %}
                                    <div class="col-sm-8">No</div>
                                {% endif %}

                            </div>
                            <hr style="border: 0;">
                        {% endif %}
                    </div>
                    <div>
                    {% if executed_by.name %}
                        <h4><strong>Executed By:</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        <div class="row">
                            <div class="col-sm-4"><strong>Model Program used for execution:</strong></div>
                            <div class="col-sm-8">{{ executed_by.name }}</div>
                        </div>
                        <hr style="border: 0;">
                    {% endif %}
                {% endif %}
                <div>
                    {% if cellInformation %}
                        <h4><strong>Cell Information:</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        <div class="row">
                            <div class="col-sm-4"><strong>Rows:</strong></div>
                            <div class="col-sm-8">{{ cellInformation.rows }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Columns:</strong></div>
                            <div class="col-sm-8">{{ cellInformation.columns }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>CellSizeXValue:</strong></div>
                            <div class="col-sm-8">{{ cellInformation.cellSizeXValue }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>CellSizeYValue:</strong></div>
                            <div class="col-sm-8">{{ cellInformation.cellSizeYValue }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>CellSizeUnit:</strong></div>
                            <div class="col-sm-8">{{ cellInformation.cellSizeUnit }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>CellDataType:</strong></div>
                            <div class="col-sm-8">{{ cellInformation.cellDataType }}</div>
                        </div>
                        {% if cellInformation.noDataValue %}
                            <div class="row">
                                <div class="col-sm-4"><strong>NoDataValue:</strong></div>
                                <div class="col-sm-8">{{ cellInformation.noDataValue }}</div>
                            </div>
                        {% endif %}
                    <hr style="border: 0;">
                    {% endif %}
                </div>

                <div>
                    {% if bandInformation %}
                        <h4><strong>Band Information:</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        {% for band in bandInformation %}
                            <div class="row">
                                <div class="col-sm-4"><strong>BandName:</strong></div>
                                <div class="col-sm-8">{{ band.name }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>VariableName:</strong></div>
                                <div class="col-sm-8">{{ band.variableName }}</div>
                            </div>
                            <div class="row">
                                <div class="col-sm-4"><strong>VariableUnit:</strong></div>
                                <div class="col-sm-8">{{ band.variableUnit }}</div>
                            </div>
                            {% if band.method %}
                                <div class="row">
                                    <div class="col-sm-4"><strong>Method:</strong></div>
                                    <div class="col-sm-8">{{ band.method }}</div>
                                </div>
                            {% endif %}
                            {% if band.comment %}
                                <div class="row">
                                    <div class="col-sm-4"><strong>Comment:</strong></div>
                                    <div class="col-sm-8">{{ band.comment }}</div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    <hr style="border: 0;">
                    {% endif %}
                </div>

                <div>
                    {% if site %}
                        <h4><strong>Site:</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        <div class="row">
                            <div class="col-sm-4"><strong>Code:</strong></div>
                            <div class="col-sm-8">{{ site.site_code }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Name:</strong></div>
                            <div class="col-sm-8">{{ site.site_name }}</div>
                        </div>
                        {% if site.elevation_m %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Elevation M:</strong></div>
                                <div class="col-sm-8">{{ site.elevation_m }}</div>
                            </div>
                        {% endif %}
                        {% if site.elevation_datum %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Elevation Datum:</strong></div>
                                <div class="col-sm-8">{{ site.elevation_datum }}</div>
                            </div>
                        {% endif %}
                        {% if site.site_type %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Site Type:</strong></div>
                                <div class="col-sm-8">{{ site.site_type }}</div>
                            </div>
                        {% endif %}
                        <hr style="border: 0;">
                    {% endif %}
                </div>
                <div>
                    {% if variable %}
                        <h4><strong>Variable:</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        <div class="row">
                            <div class="col-sm-4"><strong>Code:</strong></div>
                            <div class="col-sm-8">{{ variable.variable_code }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Name:</strong></div>
                            <div class="col-sm-8">{{ variable.variable_name }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Type:</strong></div>
                            <div class="col-sm-8">{{ variable.variable_type }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>No Data Value:</strong></div>
                            <div class="col-sm-8">{{ variable.no_data_value }}</div>
                        </div>
                        {% if variable.variable_definition %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Definition:</strong></div>
                                <div class="col-sm-8">{{ variable.variable_definition }}</div>
                            </div>
                        {% endif %}
                        {% if variable.speciation %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Speciation:</strong></div>
                                <div class="col-sm-8">{{ variable.speciation }}</div>
                            </div>
                        {% endif %}
                        <hr style="border: 0;">
                    {% endif %}
                </div>
                <div>
                    {% if method %}
                        <h4><strong>Method:</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        <div class="row">
                            <div class="col-sm-4"><strong>Code:</strong></div>
                            <div class="col-sm-8">{{ method.method_code }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Name:</strong></div>
                            <div class="col-sm-8">{{ method.method_name }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Type:</strong></div>
                            <div class="col-sm-8">{{ method.method_type }}</div>
                        </div>
                        {% if method.method_description %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Description:</strong></div>
                                <div class="col-sm-8">{{ method.method_description }}</div>
                            </div>
                        {% endif %}
                        {% if method.method_link %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Link:</strong></div>
                                <div class="col-sm-8">{{ method.method_link }}</div>
                            </div>
                        {% endif %}
                        <hr style="border: 0;">
                    {% endif %}
                </div>
                <div>
                    {% if processing_level %}
                        <h4><strong>Processing Level:</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        <div class="row">
                            <div class="col-sm-4"><strong>Code:</strong></div>
                            <div class="col-sm-8">{{ processing_level.processing_level_code }}</div>
                        </div>
                        {% if processing_level.definition %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Definition:</strong></div>
                                <div class="col-sm-8">{{ processing_level.definition }}</div>
                            </div>
                        {% endif %}
                        {% if processing_level.explanation %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Explanation:</strong></div>
                                <div class="col-sm-8">{{ processing_level.explanation }}</div>
                            </div>
                        {% endif %}
                        <hr style="border: 0;">
                    {% endif %}
                </div>
                <div>
                    {% if timeseries_result %}
                        <h4><strong>Time Series Result:</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        <div class="row">
                            <div class="col-sm-4"><strong>Units Type:</strong></div>
                            <div class="col-sm-8">{{ timeseries_result.units_type }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Units Name:</strong></div>
                            <div class="col-sm-8">{{ timeseries_result.units_name }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Units Abbreviation:</strong></div>
                            <div class="col-sm-8">{{ timeseries_result.units_abbreviation }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Status:</strong></div>
                            <div class="col-sm-8">{{ timeseries_result.status }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Sample Medium:</strong></div>
                            <div class="col-sm-8">{{ timeseries_result.sample_medium }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Value Count:</strong></div>
                            <div class="col-sm-8">{{ timeseries_result.value_count }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>Aggregation Statistics:</strong></div>
                            <div class="col-sm-8">{{ timeseries_result.aggregation_statistics }}</div>
                        </div>
                        <hr style="border: 0;">
                    {% endif %}
                </div>

                </div>
                </div>
            {% endif %}
            </div>
            </div>
            </div>
        {% endif %}
        <!-- ==== Tabs end ==== -->

        {% if not metadata_form %}
            {% comments_for cm %}
        {% endif %}

        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    {% if metadata_form %}
                        <button id="metadata-show-toggle" type="button" class="btn btn-primary"
                                onclick="toggle_metadata_display()">Collapse All
                        </button>
                        {% crispy metadata_form %}
                    {% endif %}

                    <div>
                        {# TODO: Pabitra to check if this for loop code is relevant #}
                        {% for attr, val_dict in core_metadata.items %}
                            <h5>{{ attr }}</h5>
                            <table class="table table-condensed">
                                {% for subattr, subval in val_dict.items %}
                                    <tr>
                                        <th>{{ subattr }}</th>
                                        <td>{{ subval }}</td>
                                    </tr>
                                {% endfor %}
                            </table>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        {#                #}
        {# dialogs follow #}
        {#                #}

        <!-- Modal -->
        <div class="modal fade" id="submit-for-publication-dialog" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="submit-for-publication-title">Submit resource for publication</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            Once you submit the resource for publication it cannot be changed again. This will assign a
                            DOI to the
                            resource as it stands now and mark it as permanent. To make any changes after this, you
                            <strong>must</strong>
                            create a brand new resource. Click "Publish" if you really intend to do this.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger" href="/hsapi/_internal/{{ cm.short_id }}/publish/">Publish</a>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="delete-resource-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="delete-resource-title">Delete Resource</h4>
                    </div>
                    <div class="modal-body">
                        <strong>THIS IS A PERMANENT ACTION. </strong>
                        <ul>
                            <li>This will delete the resource file.</li>
                            <li>A copy of your resource file will not be retained by Hydroshare.</li>
                            <li>We highly recommend that you download the latest copy of your resource file before
                                confirming this action.
                            </li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger"
                           href="/hsapi/_internal/{{ cm.short_id }}/delete-resource/">Delete</a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="add-dcterm-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/add-metadata/">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Add metadata term</h4>
                        </div>
                        <div class="modal-body">
                            {% csrf_token %}

                            {{ dcterm_frm|crispy }}

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="add-reference-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/add-citation/">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Add reference</h4>
                        </div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="add-citation-input">Citation text:</label>
                                <textarea class="form-control" name="content" id="add-citation-input" cols="30"
                                          rows="10"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="add-file-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/add-file-to-resource/" method="POST"
                          enctype="multipart/form-data">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Add file to resource</h4>
                        </div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="add-citation-input">Select files:</label>
                                <input type="file" name="files" id="add-file-input" multiple/>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


    {% endwith %}

    {% block extra_js %}
        <script type="text/javascript">
        $(function () {
        });

        function toggle_metadata_display() {
            if ($("#metadata-show-toggle").text() === 'Show All') {
                $("#metadata-show-toggle").text('Collapse All');
                $('.accordion-body:not(".in")').collapse('show');
            }
            else {
                $("#metadata-show-toggle").text('Show All');
                $('.accordion-body.in').collapse('hide');
            }
        }

        function metadata_update_ajax_submit(form_id) {
            $alert_success = '<div class="alert alert-success" id="success-alert"> \
                <button type="button" class="close" data-dismiss="alert">x</button> \
                <strong>Success! </strong> \
                Metadata updated.\
            </div>'

            $alert_error = '<div class="alert alert-danger" id="error-alert"> \
                <button type="button" class="close" data-dismiss="alert">x</button> \
                <strong>Error! </strong> \
                Metadata updated failed.\
            </div>'

            $form = $('#' + form_id);
            var datastring = $form.serialize();
            $.ajax({
                type: "POST",
                url: $form.attr('action'),
                dataType: 'html',
                data: datastring,
                success: function (result) {
                    /* The div contains now the updated form */
                    //$('#' + form_id).html(result);
                    console.log(result);
                    json_response = JSON.parse(result);
                    console.log(json_response);
                    if (json_response.status === 'success') {
                        $form.find("button").hide();
                        if (json_response.hasOwnProperty('element_id')) {
                            form_update_action = $form.attr('action');
                            res_short_id = form_update_action.split('/')[3];
                            update_url = "/hsapi/_internal/" + res_short_id + "/" + json_response.element_name + "/" + json_response.element_id + "/update-metadata/"
                            $form.attr('action', update_url);

                        }
                        if (json_response.hasOwnProperty('element_name')) {
                            if (json_response.element_name === 'title') {
                                $res_title = $(".section-header").find("span").first();
                                field_name_value = $res_title.text();
                                console.log(field_name_value);
                                updated_title = $form.find("#id_value").val();
                                $res_title.text(updated_title);
                            }
                        }

                        if (json_response.hasOwnProperty('metadata_status')) {
                            if (json_response.metadata_status !== $('#metadata-status').text()) {
                                $('#metadata-status').text(json_response.metadata_status);
                                if (json_response.metadata_status == "Sufficient to make public") {
                                    customAlert("Metadata Status:Sufficient to make public", 3000);
                                    $('#metadata-status').removeClass('text-danger');
                                    $('#metadata-status').addClass('text-success');
                                    $('#id_sharing #make-public').remove();
                                    $('#id_sharing').append('<input name="t" type="hidden" value="make_public"/><button id="make-public" type="submit" class="btn btn-danger">Make public</button>');
                                }
                                else {
                                    $('#metadata-status').removeClass('text-success');
                                    $('#metadata-status').addClass('text-danger');
                                    $('#id_sharing #make-public').hide();
                                    $('#id_sharing #make-private').hide();
                                    $('#sharing-status').text('Private');
                                }
                            }
                        }

                        $('#' + form_id).before($alert_success);
                        $('#' + form_id).closest('div').find('#error-alert').each(function () {
                            this.remove();
                        });
                        $(".alert-success").fadeTo(2000, 500).slideUp(1000, function () {

                            $(".alert-success").alert('close');
                        });
                    }
                    else {
                        $('#' + form_id).before($alert_error);

                    }
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $('#' + form_id).before($alert_error)
                    $(".alert-error").fadeTo(2000, 500).slideUp(1000, function () {
                        $(".alert-error").alert('close');
                    });
                }
            });

            //don't submit the form
            return false;
        }

        function customAlert(msg, duration) {
            var el = document.createElement("div");
            var top = ($(window).height() / 2) - 25;
            var left = ($(window).width() / 2) - 150;
            var style = "position:fixed;top:" + top + "px;left:" + left + "px;background-color:lightgreen; width:300px; height:50px; text-align:center; line-height:50px";
            el.setAttribute("style", style);
            el.innerHTML = msg;
            setTimeout(function () {
                el.parentNode.removeChild(el);
            }, duration);
            document.body.appendChild(el);
        }

        $(document).ready(function () {
            if ($("#id_type_1").is(':checked')) { //box type coverage
                $("#div_id_north").hide();
                $("#div_id_east").hide();
                $("#div_id_elevation").hide();
            }
            if ($("#id_type_2").is(':checked')) { // point type coverage
                $("#div_id_northlimit").hide();
                $("#div_id_eastlimit").hide();
                $("#div_id_southlimit").hide();
                $("#div_id_westlimit").hide();
                $("#div_id_uplimit").hide();
                $("#div_id_downlimit").hide();
            }
            if ($("input:button[value='Delete creator']").length == 1) {
                $("input:button[value='Delete creator']").first().hide();
            }
            // disable all save changes button on load
            $("form").each(function () {
                $save_button = $(this).find("button").first();
                if ($save_button.text() === "Save changes") {
                    $save_button.hide();
                }
            })

            // open all metadata collasible elements on page load
            $('.accordion-body:not(".in")').collapse('show');


            $("#select_license").on('change', function () {
                var value = this.value;
                if (value === "other") {
                    $(this).closest("form").find("#id_statement").first().text("");
                    $(this).closest("form").find("#id_url").first().attr('value', "");
                    $(this).closest("form").find("#id_statement").first().attr('readonly', false);
                    $(this).closest("form").find("#id_url").first().attr('readonly', false);
                }
                else {
                    var text = $(this).find('option:selected').text();
                    text = "This resource is shared under the " + text + ".";
                    $(this).closest("form").find("#id_statement").first().text(text);
                    $(this).closest("form").find("#id_url").first().attr('value', value);
                    $(this).closest("form").find("#id_statement").first().attr('readonly', true);
                    $(this).closest("form").find("#id_url").first().attr('readonly', true);
                }

            });

            // set the selected license in the select license dropdown
            var value_exists = false;
            $("#select_license option").each(function () {
                if (this.value == $("#id_url").attr('value')) {
                    $("#select_license").val($("#id_url").attr('value'));
                    value_exists = true;
                    return;
                }
            })

            if (value_exists == false) {
                // set the selected license type to 'other'
                $("#select_license").val('other');
                console.log($("#select_license").attr('readonly'));
                if ($("#select_license").attr('readonly') == undefined) {
                    $("#select_license").closest("form").find("#id_statement").first().attr('readonly', false);
                    $("#select_license").closest("form").find("#id_url").first().attr('readonly', false);
                }
                else {
                    $("#select_license").attr('style', "background-color:white;");
                    $("#select_license").closest("form").find("#id_statement").first().attr('readonly', true);
                    $("#select_license").closest("form").find("#id_url").first().attr('readonly', true);
                }
            }

            // show "Save changes" button when form editing starts
            $(".form-control").each(function () {
                $(this).on('input', function (e) {
                    //$(this).css('border-color', 'gray');
                    $(this).closest("form").find("button").show();
                });
                $(this).on('change', function (e) {
                    //$(this).css('border-color', 'gray');
                    $(this).closest("form").find("button").show();
                });
            })
            $(".dateinput").each(function () {
                $(this).datepicker({
                    format: 'mm-dd-yyyy',
                    changeMonth: true,
                    changeYear: true
                });

                $(this).on('change', function () {
                    $(this).closest("form").find("button").show();
                });
            })
            // Code adapted from http://djangosnippets.org/snippets/1389/
            function updateElementIndex(el, prefix, ndx) {
                var id_regex = new RegExp('(' + prefix + '-\\d+-)');
                var replacement = prefix + '-' + ndx + '-';
                if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex,
                        replacement));
                if (el.id) el.id = el.id.replace(id_regex, replacement);
                if (el.name) el.name = el.name.replace(id_regex, replacement);
            }

            function deleteForm(btn, prefix) {
                var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
                if (formCount > 1) {
                    // Delete the item/form
                    $(btn).parents('.item').slideUp(300);
                    $(btn).parents('.item').remove();
                    var forms = $("#" + prefix + ' .item'); // Get all the forms
                    // Update the total number of forms (1 less than before)
                    $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
                    var i = 0;
                    // Go through the forms and set their indices, names and IDs
                    for (formCount = forms.length; i < formCount; i++) {
                        $(forms.get(i)).children().children().each(function () {
                            if ($(this).attr('type') == 'text') updateElementIndex(this, prefix, i);
                            if ($(this).is('input')) updateElementIndex(this, prefix, i);
                        });
                        $(forms.get(i)).find('input').each(function () {
                            updateElementIndex(this, prefix, i);
                        })
                    }
                } // End if
                else {
                    if (prefix == 'creators') {
                        alert("Resource needs to have at least one creator!");
                    }
                }
                return false;
            }

            function addForm(btn, prefix) {
                var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
                // You can only submit a maximum of 10 todo items
                if (formCount < 10) {
                    // Clone a form (without event handlers) from the first form
                    var row = $("#" + prefix + " .item:first").clone(false).get(0);
                    // Insert it after the last form
                    $(row).removeAttr('id').hide().insertAfter("#" + prefix + " .item:last").slideDown(300);
                    // Remove the bits we don't want in the new row/form
                    // e.g. error messages
                    $(".errorlist", row).remove();
                    $(row).children().removeClass("error");
                    $(row).find(".item_link:not(:first)").remove();
                    // Relabel or rename all the relevant bits of the main form
                    $(row).children().children().each(function () {
                        updateElementIndex(this, prefix, formCount);
                        $(this).val("");
                    });
                    // Relabel or rename all the relevant bits of the child form
                    var link_prefix = prefix + '_links'
                    $(row).find("*").each(function () {
                        updateElementIndex(this, link_prefix, formCount);
                        if ($(this).attr("id")) {
                            if ($(this).attr("id").substr(-6) !== "_FORMS") {
                                $(this).val("");
                            }
                            else {
                                if ($(this).attr("id").substr(-11) === "TOTAL_FORMS") {
                                    $(this).val("1");
                                }
                            }
                        }
                        else {
                            $(this).val("");
                        }
                    });
                    $(row).find('input').each(function () {
                        updateElementIndex(this, prefix, formCount);
                        if ($(this).attr('type') == 'button') {
                            if (prefix === 'creator') {
                                $(this).attr('value', 'Delete creator');
                            }
                            else if (prefix === 'contributor') {
                                $(this).attr('value', 'Delete contributor');
                            }
                            else {
                                $(this).attr('value', 'Delete');
                            }
                        }
                        if ($(this).attr('type') == 'submit') {
                            $(this).attr('value', 'Save');
                        }
                    })
                    // Add an event handler for the delete item/form link
                    $(row).find(".delete-creator").click(function () {
                        return deleteForm(this, prefix);
                    });
                    $(row).find(".delete-contributor").click(function () {
                        return deleteForm(this, prefix);
                    });
                    $(row).find("#addLinkCreator").click(function () {
                        return addLink(this, "creator");
                    });
                    // Add an event handler for the delete item/form link
                    $(row).find(".delete-link-creator").click(function () {
                        return deleteLink(this, prefix);
                    });
                    $(row).find(".delete-link-contributor").click(function () {
                        return deleteLink(this, prefix);
                    });
                    // Update the total form count
                    $("#id_" + prefix + "-TOTAL_FORMS").val(formCount + 1);
                } // End if
                else {
                    alert("Sorry, you can only enter a maximum of ten items.");
                }
                return false;
            }

            function deleteLink(btn, prefix) {
                var link_form_input = $(btn).parents('.item').children('input:first');
                var id = $(link_form_input).attr('id');
                var link_formset_index = id.split("-")[1];
                var formCount = parseInt($('#id_' + prefix + '_links-' + link_formset_index + '-TOTAL_FORMS').val());
                if (formCount > 1) {
                    // Delete the item/form
                    $(btn).parents('.item_link').slideUp(300);
                    $(btn).parents('.item_link').remove();
                    var forms = $("#" + prefix + ' .item_link'); // Get all the forms
                    // Update the total number of forms (1 less than before)
                    var update_prefix = prefix + '_links-' + link_formset_index;
                    $('#id_' + update_prefix + '-TOTAL_FORMS').val(forms.length);
                    var i = 0;
                    // Go through the forms and set their indices, names and IDs
                    for (formCount = forms.length; i < formCount; i++) {
                        $(forms.get(i)).children().children().each(function () {
                            if ($(this).attr('type') == 'text') updateElementIndex(this, update_prefix, i);
                            if ($(this).is('input')) updateElementIndex(this, update_prefix, i);
                        });
                        $(forms.get(i)).find('input').each(function () {
                            updateElementIndex(this, update_prefix, i);
                        })
                    }
                } // End if

                return false;
            }

            function addLink(btn, prefix) {
                var link_form_input = $(btn).parents('.item').children('input:first');
                var id = $(link_form_input).attr('id');
                var link_formset_index = id.split("-")[1];
                var formCount = parseInt($('#id_' + prefix + '_links-' + link_formset_index + '-TOTAL_FORMS').val());
                // You can only submit a maximum of 10 todo items
                if (formCount < 10) {
                    // Clone a form (without event handlers) from the first form
                    //var row = $("#" + prefix + " .item_link:first").clone(false).get(0);
                    var row = $(btn).parents(".item").find(".item_link:last").clone(false).get(0);
                    // Insert it after the last form
                    $(row).removeAttr('id').hide().insertAfter("#" + prefix + " .item_link:last").slideDown(300);
                    // Remove the bits we don't want in the new row/form
                    // e.g. error messages
                    $(".errorlist", row).remove();
                    $(row).children().removeClass("error");
                    var update_prefix = prefix + '_links-' + link_formset_index;
                    // Relabel or rename all the relevant bits
                    $(row).find('*').each(function () {
                        updateElementIndex(this, update_prefix, formCount);
                        $(this).val("");
                    })

                    $(row).find('button').each(function () {
                        updateElementIndex(this, update_prefix, formCount);
                        if ($(this).attr('type') == 'button') {
                            $(this).text('Delete Link');
                        }

                    })
                    // Add an event handler for the delete item/form link
                    $(row).find(".delete-link-creator").click(function () {
                        return deleteLink(this, prefix);
                    });
                    $(row).find(".delete-link-contributor").click(function () {
                        return deleteLink(this, prefix);
                    });
                    // Update the total form count
                    $("#id_" + update_prefix + "-TOTAL_FORMS").val(formCount + 1);
                } // End if
                else {
                    alert("Sorry, you can only enter a maximum of ten links.");
                }
                return false;
            }


            // Register the click event handlers
            $("#addCreator").click(function () {
                return addForm(this, "creator");
            });
            $(".delete-creator").click(function () {
                return deleteForm(this, "creator");
            });
            $("#addContributor").click(function () {
                return addForm(this, "contributor");
            });
            $("#addLinkCreator").click(function () {
                return addLink(this, "creator");
            });
            $(".delete-contributor").click(function () {
                return deleteForm(this, "contributors");
            });
            $(".delete-link-contributor").click(function () {
                return deleteLink(this, "contributors");
            });
            $(".delete-link-creator").click(function () {
                return deleteLink(this, "creator");
            });

            $("#addSource").click(function () {
                return addForm(this, "source");
            });

            $("form input:radio").change(function () {
                if ($(this).val() == "point") {
                    //alert('you select the point radio button');
                    $("#div_id_north").show();
                    $("#div_id_east").show();
                    $("#div_id_elevation").show();
                    $("#div_id_northlimit").hide();
                    $("#div_id_eastlimit").hide();
                    $("#div_id_southlimit").hide();
                    $("#div_id_westlimit").hide();
                    $("#div_id_uplimit").hide();
                    $("#div_id_downlimit").hide();
                }
                else {
                    //alert('you select the box radio button');
                    $("#div_id_north").hide();
                    $("#div_id_east").hide();
                    $("#div_id_elevation").hide();
                    $("#div_id_northlimit").show();
                    $("#div_id_eastlimit").show();
                    $("#div_id_southlimit").show();
                    $("#div_id_westlimit").show();
                    $("#div_id_uplimit").show();
                    $("#div_id_downlimit").show();
                }
            });
        });
        </script>
    {% endblock %}

{% endblock %}
