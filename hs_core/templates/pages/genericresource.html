{% extends 'pages/page.html' %}

{% load geoanalytics_tags ratings_tags pages_tags mezzanine_tags comments_tags keyword_tags hydroshare_tags crispy_forms_tags inplace_edit %}

{% block extra_head %}
      <link href="{{ STATIC_URL }}css/site_base_irods.css" rel="stylesheet"/>
{% endblock %}

{% block main %}
    {% with page.get_content_model as cm %}
        {% keywords_for page as kws %}
        {% set_page_permissions page %}
        <input type="hidden" id="supported-file-types" value="{{ cm.get_supported_upload_file_types }}">
        <input type="hidden" id="allow-multiple-file-upload" value={{ cm.can_have_multiple_files }}>
        <input type="hidden" id="file-count" value={{ cm.files.all.count }}>

        {% block error %}
            {%  if validation_error %}
                <div class="alert alert-danger alert-dismissible" role="alert">
                      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <strong>Validation Error: {{ validation_error }}</strong>
                 </div>
            {%  endif %}
        {% endblock %}

        {# ======= Missing fields notification =======#}
        {% if not metadata_form and page.perms.change %}
            {% if missing_metadata_elements or title|stringformat:"s" == "Untitled resource" or not cm.has_required_content_files %}
                <div class="col-sm-12">
                    <div class="alert {% if just_created %}alert-success{% else %}alert-warning{% endif %} alert-dismissible" role="alert">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        {% if missing_metadata_elements  %}
                            {% if just_created %}
                                <strong>Congratulations! </strong>
                                <span>Now that your resource has been created the following metadata are still required to make it public or discoverable:</span>
                            {% else %}
                                <span>The following metadata are still required to make the resource public or discoverable:</span>
                            {% endif %}
                            <ul>
                                {% for element in missing_metadata_elements %}
                                    <li>{{ element }}</li>
                                {% endfor %}
                                {% if title|stringformat:"s" == "Untitled resource" %}
                                   <li>Title: needs to be changed</li>
                                {% endif %}
                            </ul>
                        {%  endif %}
                        {%  if not cm.has_required_content_files %}
                                <br>
                                <span>Content files are required to make the resource public or discoverable.</span>
                        {% endif %}
                        <hr>
                        <span class="glyphicon glyphicon-question-sign"></span>
                        <small> Click on the edit button ( <span class="glyphicon glyphicon-pencil"></span> ) below to edit this resource.</small>
                     </div>
                </div>
                {% endif %}
            {% endif %}

        {# ======= Title ======= #}
        <div class="col-sm-12">
            {% if not metadata_form %}
                <h2 id="resource-title">{{ title }}</h2>
                {% if relevant_tools %}
                    <span id="apps-dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Open with...
                        <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        {% for tool in relevant_tools %}
                            <li title="{{ tool.title }}">
                                <a href="{{ tool.url }}" target="_blank">
                                    <img class="dropdown-user-webapp-icon" src="{{ tool.icon_url }}">
                                    {% if tool.title|length > 20 %}
                                        <span>{{ tool.title|slice:":21"|add:"..." }}</span>
                                    {% else %}
                                        <span>{{ tool.title }}</span>
                                    {% endif %}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% else %}
                <form action="/hsapi/_internal/{{ cm.short_id }}/title/{{ cm.metadata.title.id }}/update-metadata/"
                      id="id-title"
                      method="post">
                    {% csrf_token %}
                    <fieldset>
                        <div id="div_id_value" class="control-group">
                            <div class="controls"><input class="form-control input-sm textinput textInput"
                                                         id="txt-title"
                                                         maxlength="300" name="value" type="text"
                                                         value="{{ cm.metadata.title }}"></div>
                        </div>
                        <div>
                            <button type="button" class="btn btn-primary pull-right"
                                    onclick="metadata_update_ajax_submit('id-title'); return false;"
                                    style="display: none;">
                                Save changes
                            </button>
                        </div>
                    </fieldset>
                </form>
            {% endif %}
        </div>
        {#        ======= Top right buttons =======#}
        <div class="col-sm-12">
            <div class="lined-wrapper"></div>
            {% if not metadata_form %}
                <div class="custom-btn-toolbar">
                    {% if not is_owner_user and not is_edit_user and not is_view_user %}
                        {% if is_mine %}
                            <form class="pull-right" data-id="form-add-to-my-resources"
                                  action="/hsapi/_internal/{{ cm.short_id }}/label-resource-action/"
                                  method="post">
                                {% csrf_token %}
                                <input type="hidden" name="label_type" value="MINE">
                                <input type="hidden" name="action" value="DELETE">
                                <button id="btnMyResources" data-toggle="tooltip" data-placement="auto"
                                        title="Remove from my resources" data-form-id="form-add-to-my-resources"
                                        class="glyphicon glyphicon-inbox icon-button btn-resource-remove"></button>
                            </form>
                        {% else %}
                            <form class="pull-right" data-id="form-add-to-my-resources"
                                  action="/hsapi/_internal/{{ cm.short_id }}/label-resource-action/"
                                  method="post">
                                {% csrf_token %}
                                <input type="hidden" name="label_type" value="MINE">
                                <input type="hidden" name="action" value="CREATE">
                                <button id="btnMyResources" data-toggle="tooltip" data-placement="auto"
                                        title="Add to my resources" data-form-id="form-add-to-my-resources"
                                        class="glyphicon glyphicon-inbox icon-button btn-resource-add"></button>
                            </form>
                        {% endif %}
                    {% endif %}
                    {% if page.perms.change %}
                            <form class="inline pull-right" action="{{ cm.get_absolute_url }}" method="post">
                                {% csrf_token %}
                                {% if page.perms.delete %}
                                    <a id="delete" data-toggle="modal" data-target="#delete-resource-dialog">
                                        <span data-toggle="tooltip" data-placement="auto" title="Delete this resource"
                                              class="glyphicon glyphicon-trash icon-button btn-remove"></span>
                                    </a>
                                {% endif %}
                                <input name="resource-mode" type="hidden" value="edit"/>
                                <button id="edit-metadata" type="submit" data-toggle="tooltip" data-placement="auto"
                                        title="Edit this resource"
                                        class="glyphicon glyphicon-pencil icon-button btn-edit"></button>
                            </form>

                    {% endif %}
                </div>
            {% else %}
                <div class="custom-btn-toolbar">
                    <a href="{{ cm.get_absolute_url }}">
                            <span data-toggle="tooltip" data-placement="auto" title="View resource"
                                  class="glyphicon glyphicon-circle-arrow-left icon-button btn-edit"></span>
                    </a>
                </div>
            {% endif %}
        </div>


        {#        ======= Authors =======#}
        {% if not metadata_form %}
        <div class="info-group col-sm-12">
            <table>
                <tr><th>Authors:</th><td id="authors">
                    {% for cr in creators %}
                        {% if forloop.counter0 != 0 %} <span>Â·</span> {% endif %}
                        {% if cr.description %}<a href="{{ cr.description }}">{{ cr.name }}</a>
                        {% else %}<span>{{ cr.name }}</span>{% endif %}
                    {% endfor %}
                </td></tr>
                <tr><th>Owners:</th><td>
                    {% for u in owners %}
                        {% if forloop.counter0 != 0 %} <span class="list-separator">Â·</span> {% endif %}
                        <span>{{ u|contact|safe }}</span>
                    {% endfor %}
                </td></tr>
                <tr><th>Resource type:</th><td>{{ cm|resource_type }}</td></tr>
                <tr><th>Created:</th><td>{{ cm.created }}</td></tr>
                <tr><th>Last updated:</th><td> {{ cm.updated }} by {% if cm.last_changed_by %}{{ cm.last_changed_by|contact|safe }}{% endif %}</td></tr>
            </table>
        </div>
        {% else %}
            <div class="info-group col-sm-12">
                <table>
                    <tr>
                        <th>Authors:</th>
                        <td><span id="authors">

                                {% for author in creator_formset.initial %}
                                    {% if forloop.counter0 != 0 %} <span class="list-separator">Â·</span> {% endif %}
                                    {% if author.description %}
                                        <a href="{{ author.description }}">{{ author.name }}</a>
                                    {% else %}
                                        <span>{{ author.name }}</span>
                                    {% endif %}
                                {% endfor %}
                            </span>
                        </td>
                    </tr>
                    <tr><th>Owners:</th><td>
                        {% for u in owners %}
                            {% if forloop.counter0 != 0 %} <span class="list-separator">Â·</span> {% endif %}
                            <span>{{ u|contact|safe }}</span>
                        {% endfor %}
                    </td></tr>
                    <tr><th>Resource type:</th><td>{{ cm|resource_type }}</td></tr>
                    <tr><th>Created:</th><td>{{ cm.created }}</td></tr>
                    <tr><th>Last updated:</th><td> {{ cm.updated }} by {% if cm.last_changed_by %}{{ cm.last_changed_by|contact|safe }}{% endif %}</td></tr>
                </table>
            </div>
        {% endif %}

        {#        ======= Abstract =======#}
        {% if not metadata_form %}
            {% if abstract %}
                <div class="col-sm-12 content-block">
                    <h3>Abstract</h3>
                    <span class="abstract">{{ abstract|linebreaks }}</span>
                </div>
            {% endif %}
        {% else %}
            <div class="col-sm-12 content-block">
                <h3>Abstract</h3>
                {% if cm.metadata.description %}
                <form action="/hsapi/_internal/{{ cm.short_id }}/description/{{ cm.metadata.description.id }}/update-metadata/"
                      id="id-description" method="post">
                    {% csrf_token %}
                    <fieldset>
                        <div id="div_id_abstract" class="control-group">
                            <div class="controls"><textarea class="form-control input-sm textarea" cols="40"
                                                            id="id_abstract" name="abstract"
                                                            rows="10">{{ cm.metadata.description }}</textarea></div>
                        </div>
                        <div style="margin-top:10px">
                            <button type="button" class="btn btn-primary pull-right"
                                    onclick="metadata_update_ajax_submit('id-description'); return false;"
                                    style="display: none;">Save changes
                            </button>
                        </div>
                    </fieldset>
                </form>
                {% else %}
                <form action="/hsapi/_internal/{{ cm.short_id }}/description/add-metadata/"
                      id="id-description" method="post">
                    {% csrf_token %}
                    <fieldset>
                        <div id="div_id_abstract" class="control-group">
                            <div class="controls"><textarea class="form-control input-sm textarea" cols="40"
                                                            id="id_abstract" name="abstract" rows="10"></textarea></div>
                        </div>
                        <div style="margin-top:10px">
                            <button type="button" class="btn btn-primary pull-right"
                                    onclick="metadata_update_ajax_submit('id-description'); return false;"
                                    style="display: none;">Save changes
                            </button>
                        </div>
                    </fieldset>
                </form>
                {% endif %}
            </div>
        {% endif %}

        {#        ======= Subject =======#}
        {% if not metadata_form %}
            {% if keywords %}
            <div class="col-sm-12 content-block">
                <h3>Subject</h3>

                <p id="keywords">{{ keywords }}</p>

                <div class="tags">
                    <ul id="list-keywords" class="tag-list custom-well">
                    </ul>
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="col-sm-12 content-block">
                <h3>Subject</h3>
                <form action="/hsapi/_internal/{{ cm.short_id }}/subject/add-metadata/" id="id-subject"
                      method="post">
                    {% csrf_token %}
                    <div class="tags">
                        <div id="add-keyword-wrapper" class="input-group">
                            <input id="txt-keyword" type="text" class="form-control" placeholder="Keyword">
                        <span class="input-group-btn">
                            <a id="btn-add-keyword" class="btn btn-success" type="button">Add</a>
                        </span>
                        </div>
                        <ul id="lst-tags" class="custom-well tag-list">
                        </ul>
                    </div>

                    <fieldset>
                        <div id="div_id_value" class="control-group">
                            <div class="controls"><input class="form-control input-sm textInput" id="id_value"
                                                         maxlength="500" name="value" type="text"
                                                         style="display: none;">{{ cm.keywords_string }}</div>
                        </div>
                        <div style="margin-top:10px">
                            <button type="button" class="btn btn-primary pull-right"
                                    onclick="metadata_update_ajax_submit('id-subject'); return false;"
                                    style="display: none;">Save changes
                            </button>
                        </div>
                    </fieldset>
                </form>
            </div>
        {% endif %}

        {#        ======= Citation =======#}
        <div class="col-sm-12 content-block">
            <h3>How to cite</h3>

            <div class="input-group" style="margin-bottom: 30px">
                <span id="citation-text">{{ citation }}</span>
                <span class="input-group-addon"><span class="glyphicon glyphicon-book"
                        data-toggle="tooltip" data-placement="bottom" title="Click on the text to select all"></span></span>
            </div>

            {#        ======= Sharing =======#}
            {% if not metadata_form %}
            {% if rights.statement or rights.url %}
            <div id="rights">
                {% if rights.statement %}
                    <span class="rights-text">{{ rights.statement }} </span>
                {% endif %}

                {% if rights.url %}
                    <span class="rights-url"><a href="{{ rights.url }}">&nbsp{{ rights.url }}</a></span>
                {% endif %}
            </div>
            {% if rights.statement == "This resource is shared under the Creative Commons Attribution CC BY." %}
                <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY.png" alt="CC-BY"/>
            {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-ShareAlike CC BY-SA." %}
                <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-SA.png" alt="CC-BY-SA"/>
            {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoDerivs CC BY-ND." %}
                <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-ND.png" alt="CC-BY-ND"/>
            {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA." %}
                <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-SA.png" alt="CC-BY-NC-SA"/>
            {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial CC BY-NC." %}
                <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC.png" alt="CC-BY-NC"/>
            {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND." %}
                <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-ND.png" alt="CC-BY-NC-ND"/>
            {% endif %}
            {% endif %}
            {% else %}
            <div class="row">
            <form action="/hsapi/_internal/{{ cm.short_id }}/rights/{{ cm.metadata.rights.id }}/update-metadata/"#}
                  id="id-rights" method="post">
                {% csrf_token %}
                <fieldset>
                    <div class="col-md-6">
                        <span for="select_license"> Select a license </span>
                                <span data-toggle="tooltip" data-placement="auto"
                                      title='Information about rights held in and over the HydroShare resource. (e.g. Creative commons Attribution License)'
                                      class="glyphicon glyphicon-info-sign text-muted"></span>
                        <select id="select_license" class="form-control">
                            <option value="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution CC BY</option>
                            <option value="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike CC BY-SA</option>
                            <option value="http://creativecommons.org/licenses/by-nd/4.0/">Creative Commons Attribution-NoDerivs CC BY-ND</option>
                            <option value="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA</option>
                            <option value="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NoCommercial CC BY-NC</option>
                            <option value="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND</option>
                            <option value="other">Other</option>
                        </select>
                        <img id="img-badge" class="cc-image"
                                {% if cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution CC BY." %}
                             src="{{ STATIC_URL }}img/cc-badges/CC-BY.png" alt="CC-BY"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-ShareAlike CC BY-SA." %}
                             src="{{ STATIC_URL }}img/cc-badges/CC-BY-SA.png" alt="CC-BY-SA"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-NoDerivs CC BY-ND." %}
                             src="{{ STATIC_URL }}img/cc-badges/CC-BY-ND.png" alt="CC-BY-ND"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA." %}
                             src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-SA.png" alt="CC-BY-NC-SA"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial CC BY-NC." %}
                             src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC.png" alt="CC-BY-NC"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND." %}
                             src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-ND.png" alt="CC-BY-NC-ND"
                                {% endif %}/>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_statement" class="control-group">
                            <span for="id_statement"> Statement</span>

                            <div class="controls">
                                    <textarea class="form-control input-sm textarea" cols="40"
                                              id="id_statement" name="statement" readonly="True">{{ cm.metadata.rights.statement }}</textarea>
                            </div>
                        </div>
                        <div id="div_id_url" class="control-group">
                            <span for="id_url">Url</span>

                            <div class="controls">
                                <input class="form-control input-sm urlinput" id="id_url"
                                       maxlength="200" name="url" readonly="True" type="url"
                                       value={{ cm.metadata.rights.url }}>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary pull-right"
                                onclick="metadata_update_ajax_submit('id-rights'); return false;"
                                style="display: none;">Save changes
                        </button>
                    </div>

                </fieldset>
            </form>
             </div>
            {% endif %}

            <div id="permission-panel">
                <div id="sharing-status">
                <span class="pull-left">Sharing status:</span>
                {% if page.perms.change and metadata_form and can_change_resource_flags%}
                    <div id="status-btn-group" class="btn-group" role="group" aria-label="...">
                        {# -------- PUBLIC -------- #}
                        {% if cm.raccess.public %}
                            <button id="btn-public" data-toggle="tooltip" data-placement="auto"
                                    title='Can be viewed and downloaded by anyone.' type="button"
                                    class="btn btn-default active">Public
                            </button>
                        {% else %}
                            <form class="pull-left"
                                  action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                  method="POST">
                                {% csrf_token %}
                                <input name="t" type="hidden" value="make_public"/>
                                <button {% if not cm.can_be_public_or_discoverable %} disabled {% endif %}
                                        id="btn-public" data-toggle="tooltip" data-placement="auto"
                                        title='Can be viewed and downloaded by anyone.' type="submit"
                                        class="btn btn-default">Public
                                </button>
                            </form>
                        {% endif %}

                        {# -------- DISCOVERABLE -------- #}
                        {% if not cm.raccess.public and discoverable %}
                            <button id="btn-discoverable" data-toggle="tooltip" data-placement="auto"
                                    title='Metadata is public but data is protected.' type="button"
                                    class="btn btn-default active">Discoverable
                            </button>
                        {% else %}
                            <form class="pull-left"
                                  action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                  method="POST">
                                <input name="t" type="hidden" value="make_discoverable"/>
                                {% csrf_token %}
                                <button {% if not cm.can_be_public_or_discoverable %} disabled {% endif %}
                                        id="btn-discoverable" data-toggle="tooltip" data-placement="auto"
                                        title='Metadata is public but data is protected.' type="submit"
                                        class="btn btn-default">Discoverable
                                </button>
                            </form>
                        {% endif %}

                        {# -------- PRIVATE -------- #}
                        {% if not cm.raccess.public and not discoverable %}
                            <button id="btn-private" data-toggle="tooltip" data-placement="auto"
                                    title='Can be viewed and downloaded only by designated users or research groups.'
                                    type="button" class="btn btn-default active">Private
                            </button>
                        {% else %}
                            <form class="pull-left"
                                  action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                  method="POST">
                                <input name="t" type="hidden" value="make_private"/>
                                {% csrf_token %}
                                <button id="btn-private" data-toggle="tooltip" data-placement="auto"
                                        title='Can be viewed and downloaded only by designated users or research groups.' type="submit"
                                        class="btn btn-default">Private
                                </button>
                            </form>
                        {% endif %}
                    </div>

                    {% if is_owner_user %}
                        <div class="clear-fix" id="shareable-container">
                            {#   Shareable flag    #}
                            <form class="pull-left" action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                  method="POST">
                                {% csrf_token %}

                                <input name="t" type="hidden" {% if cm.raccess.shareable %}value="make_not_shareable"
                                       {% else %}value="make_shareable"{% endif %}/>

                                <div class="checkbox" data-toggle="tooltip"
                                     title="When checked, users other than owners may grant access to the resource.">
                                    <label><input id="btn-shareable" type="checkbox"
                                                  {% if cm.raccess.shareable %}checked{% endif %}>Shareable</label>
                                </div>
                            </form>
                        </div>
                    {% endif %}
                {% else %}
                    {% if cm.raccess.public %}
                        <strong class="label-public">&nbspPublic</strong>
                    {% elif cm.raccess.discoverable %}
                        <strong class="label-discoverable">&nbspDiscoverable</strong>
                    {% else %}
                        <strong class="label-private">&nbspPrivate</strong>
                    {% endif %}
                    &{% if cm.raccess.shareable %}<strong style="color:#5cb85c">&nbspShareable</strong>{% else %}<strong style="color:#d9534f">&nbspNot Shareable</strong>{% endif %}
                {% endif %}
            </div>

            <div id="user-permission-msg">
                {% if is_owner_user %}
                    <div class="clear-fix"><i>You are the owner of this resource.</i></div>
                {% elif is_edit_user %}
                     <div class="clear-fix"><i>You have been given specific permission to edit this resource.</i></div>
                {% elif is_view_user %}
                     <div class="clear-fix"><i>You have been given specific permission to view this resource.</i></div>
                {% endif %}
            </div>
            {% if is_owner_user or cm.raccess.shareable and is_view_user or cm.raccess.shareable and is_edit_user %}
            <a type="button" class="btn btn-default" data-toggle="modal" data-target="#manage-access">
                    <span class="glyphicon glyphicon-lock"><span
                            class="button-label"> Manage access</span></span>
            </a>
            {#======= Manage access modal window begins =======#}
            <div class="modal fade" id="manage-access">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-hidden="true">&times;</button>
                            <h4 class="modal-title">Manage access</h4>
                        </div>
                        <div class="modal-body first-modal">
                            <p>Who has access</p>
                            <table class="table access-table">
                                    <tbody>
                                    {# Empty row used as template to generate subsequent rows #}
                                    <tr id="templateRow">
                                        <td>
                                            <div class="profile-pic-thumbnail round-image user-icon"></div>
                                            <div class="user-scope">
                                                <span data-col="name" class="user-name"></span>
                                                <span class="text-muted you-flag">(You)</span>
                                                <br>
                                                <span data-col="user-name"
                                                      class="user-username-content"></span>
                                            </div>
                                        </td>

                                        <td class="user-roles">
                                            <span class="dropdown role-dropdown">
                                                <span class="dropdown-toggle" data-col="current-access"
                                                      id="roles-menu" data-toggle="dropdown"
                                                      aria-haspopup="true" aria-expanded="true">
                                                    <span class="caret"></span>
                                                </span>
                                                <ul class="dropdown-menu" aria-labelledby="roles-menu">
                                                    <li data-access-type="Can view">
                                                        <form class="share-form-view" data-access-type="Can view"
                                                              method="POST">
                                                            {% csrf_token %}
                                                            <a>Can view</a>
                                                        </form>
                                                    </li>
                                                    <li data-access-type="Can edit">
                                                        <form class="share-form-edit" data-access-type="Can edit"
                                                              method="POST">
                                                            {% csrf_token %}
                                                            <a>Can edit</a>
                                                        </form>
                                                    </li>
                                                    <li data-access-type="Is owner">
                                                        <form class="share-form-owner" data-access-type="Is owner"
                                                              method="POST">
                                                            {% csrf_token %}
                                                            <a>Is owner</a>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </span>
                                        </td>

                                        <td class="user-actions">
                                            <form class="remove-user-form" method="POST">
                                                {% csrf_token %}
                                                <span class="glyphicon glyphicon-remove btn-remove-row"></span>
                                            </form>
                                        </td>
                                    </tr>

                                    {# Owners with full permissions to do anything on this resource #}
                                    {% for u in owners %}
                                        <tr id="row-id-{{ u.pk }}" {% if owners|length == 1 or not is_owner_user %}class="hide-actions"{% endif %}>
                                            <td>
                                                <div class="user-scope">

                                                    {% if u.userprofile.picture %}
                                                        <div style="background-image: url('{{ u.userprofile.picture.url }}');"
                                                        class="profile-pic-thumbnail round-image"></div>
                                                    {% else %}
                                                         <div class="profile-pic-thumbnail round-image user-icon"></div>
                                                    {% endif %}

                                                    <span data-col="name"
                                                          class="user-name">{{ u|best_name }}</span>
                                                    {% if u.pk == current_user.pk %}
                                                        <span class="text-muted you-flag">(You)</span>
                                                    {% endif %}
                                                    <br>
                                                    <span data-col="user-name"
                                                          class="user-username-content">{{ u.username }}</span>
                                                </div>
                                            </td>

                                            <td class="user-roles">
                                                    <span class="dropdown role-dropdown">
                                                        <span class="dropdown-toggle" data-col="current-access"
                                                              id="roles-menu"
                                                              data-toggle="dropdown"
                                                              aria-haspopup="true" aria-expanded="true">
                                                            Is owner
                                                            <span class="caret"></span>
                                                        </span>
                                                        <ul class="dropdown-menu" aria-labelledby="roles-menu">
                                                            <li data-access-type="Can view">
                                                                <form id="share-view-{{ u.pk }}"
                                                                      class="share-form-view"
                                                                      data-access-type="Can view"
                                                                      action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/view/{{ u.pk }}/"
                                                                      method="POST">
                                                                    {% csrf_token %}
                                                                    <a onclick="change_share_permission_ajax_submit('share-view-{{ u.pk }}')">Can
                                                                        view</a>
                                                                </form>
                                                            </li>
                                                            <li data-access-type="Can edit">
                                                                <form id="share-edit-{{ u.pk }}"
                                                                      class="share-form-edit"
                                                                      data-access-type="Can edit"
                                                                      action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/edit/{{ u.pk }}/"
                                                                      method="POST">
                                                                    {% csrf_token %}
                                                                    <a onclick="change_share_permission_ajax_submit('share-edit-{{ u.pk }}')">Can
                                                                        edit</a>
                                                                </form>
                                                            </li>
                                                            <li class="active {% if not can_change_resource_flags %}disabled{% endif %}" data-access-type="Is owner">
                                                                <form id="share-owner-{{ u.pk }}"
                                                                      class="share-form-owner"
                                                                      data-access-type="Is owner"
                                                                      action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/owner/{{ u.pk }}/"
                                                                      method="POST">
                                                                    {% csrf_token %}
                                                                    <a onclick="change_share_permission_ajax_submit('share-owner-{{ u.pk }}')">Is
                                                                        owner</a>
                                                                </form>
                                                            </li>
                                                        </ul>
                                                    </span>
                                            </td>

                                            <td class="user-actions">
                                                <form id="form-remove-user-{{ u.pk }}"
                                                      class="remove-user-form"
                                                      action="/hsapi/_internal/{{ cm.short_id }}/unshare-resource-with-user/{{ u.pk }}/"
                                                      method="POST">
                                                    {% csrf_token %}
                                                    <span onclick="unshare_resource_ajax_submit('form-remove-user-{{ u.pk }}')"
                                                          class="glyphicon glyphicon-remove btn-remove-row"></span>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}

                                    {# Users who can edit the content of this resource #}
                                    {% for u in edit_users %}
                                        <tr id="row-id-{{ u.pk }}">
                                            <td>
                                                <div class="user-scope">
                                                    <div
                                                    {% if u.userprofile.picture %}
                                                        style="background-image: url('{{ u.userprofile.picture.url }}');"
                                                        class="profile-pic-thumbnail round-image"
                                                    {% else %}
                                                         class="profile-pic-thumbnail round-image user-icon"
                                                    {% endif %}
                                                    >
                                                    </div>
                                                    <span value="{{ u.pk }}" class="user-name">{{ u|best_name }}</span>
                                                    {% if u.pk == current_user.pk %}
                                                        <span class="text-muted">(You)</span>
                                                    {% endif %}
                                                    <br>
                                                    <span class="user-username-content">{{ u.username }}</span>
                                                </div>
                                            </td>

                                            <td class="user-roles">
                                                <span class="dropdown role-dropdown">
                                                    <span class="dropdown-toggle" data-col="current-access"
                                                          id="roles-menu" data-toggle="dropdown"
                                                          aria-haspopup="true" aria-expanded="true">
                                                        Can edit
                                                        <span class="caret"></span>
                                                    </span>
                                                    <ul class="dropdown-menu" aria-labelledby="roles-menu">
                                                        <li data-access-type="Can view">
                                                            <form id="share-view-{{ u.pk }}" class="share-form-view" data-access-type="Can view"
                                                                  action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/view/{{ u.pk }}/"
                                                                  method="POST">
                                                                {% csrf_token %}
                                                                <a onclick="change_share_permission_ajax_submit('share-view-{{ u.pk }}')">Can view</a>
                                                            </form>
                                                        </li>
                                                        <li class="active" data-access-type="Can edit" {% if not is_owner_user and not is_edit_user %}class="disabled"{% endif %}>
                                                            <form id="share-edit-{{ u.pk }}" class="share-form-edit" data-access-type="Can edit"
                                                                  action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/edit/{{ u.pk }}/"
                                                                  method="POST">
                                                                {% csrf_token %}
                                                                <a onclick="change_share_permission_ajax_submit('share-edit-{{ u.pk }}')">Can edit</a>
                                                            </form>
                                                        </li>
                                                        <li data-access-type="Is owner" {% if not is_owner_user %}class="disabled"{% endif %}>
                                                            <form id="share-owner-{{ u.pk }}" class="share-form-owner" data-access-type="Is owner"
                                                                  action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/owner/{{ u.pk }}/"
                                                                  method="POST">
                                                                {% csrf_token %}
                                                                <a onclick="change_share_permission_ajax_submit('share-owner-{{ u.pk }}')">Is owner</a>
                                                            </form>
                                                        </li>
                                                    </ul>
                                                </span>
                                            </td>
                                            <td class="user-actions">
                                                <form id="form-remove-user-{{ u.pk }}" class="remove-user-form"
                                                      action="/hsapi/_internal/{{ cm.short_id }}/unshare-resource-with-user/{{ u.pk }}/"
                                                      method="POST">
                                                    {% csrf_token %}
                                                    <span onclick="unshare_resource_ajax_submit('form-remove-user-{{ u.pk }}')"
                                                          class="glyphicon glyphicon-remove btn-remove-row"></span>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}

                                    {# Users who can view the content of this resource #}
                                    {% for u in view_users %}
                                        <tr id="row-id-{{ u.pk }}">
                                            <td>
                                                <div class="user-scope">
                                                    <div
                                                        {% if u.userprofile.picture %}
                                                            style="background-image: url('{{ u.userprofile.picture.url }}');"
                                                            class="profile-pic-thumbnail round-image"
                                                        {% else %}
                                                            class="profile-pic-thumbnail round-image user-icon"
                                                        {% endif %}
                                                        >
                                                    </div>
                                                    <span value="{{ u.pk }}" class="user-name">{{ u|best_name }}</span>
                                                    {% if u.pk == current_user.pk %}
                                                        <span class="text-muted">(You)</span>
                                                    {% endif %}
                                                    <br>
                                                    <span class="user-username-content">{{ u.username }}</span>
                                                </div>
                                            </td>

                                            <td class="user-roles">
                                                <span class="dropdown role-dropdown">
                                                    <span class="dropdown-toggle" data-col="current-access"
                                                          id="roles-menu" data-toggle="dropdown"
                                                          aria-haspopup="true" aria-expanded="true">
                                                        Can view
                                                        <span class="caret"></span>
                                                    </span>
                                                    <ul class="dropdown-menu" aria-labelledby="roles-menu">
                                                        <li class="active" data-access-type="Can view">
                                                            <form id="share-view-{{ u.pk }}" class="share-form-view" data-access-type="Can view"
                                                                  action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/view/{{ u.pk }}/"
                                                                  method="POST">
                                                                {% csrf_token %}
                                                                <a onclick="change_share_permission_ajax_submit('share-view-{{ u.pk }}')">Can view</a>
                                                            </form>
                                                        </li>
                                                        <li data-access-type="Can edit" {% if not is_owner_user and not is_edit_user %}class="disabled"{% endif %}>
                                                            <form id="share-edit-{{ u.pk }}" class="share-form-edit" data-access-type="Can edit"
                                                                  action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/edit/{{ u.pk }}/"
                                                                  method="POST">
                                                                {% csrf_token %}
                                                                <a onclick="change_share_permission_ajax_submit('share-edit-{{ u.pk }}')">Can edit</a>
                                                            </form>
                                                        </li>
                                                        <li data-access-type="Is owner" {% if not is_owner_user %}class="disabled"{% endif %}>
                                                            <form id="share-owner-{{ u.pk }}" class="share-form-owner" data-access-type="Is owner"
                                                                  action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/owner/{{ u.pk }}/"
                                                                  method="POST">
                                                                {% csrf_token %}
                                                                <a onclick="change_share_permission_ajax_submit('share-owner-{{ u.pk }}')">Is owner</a>
                                                            </form>
                                                        </li>
                                                    </ul>
                                                </span>
                                            </td>

                                            <td class="user-actions">
                                                <form id="form-remove-user-{{ u.pk }}" class="remove-user-form"
                                                      action="/hsapi/_internal/{{ cm.short_id }}/unshare-resource-with-user/{{ u.pk }}/"
                                                      method="POST">
                                                    {% csrf_token %}
                                                    <span onclick="unshare_resource_ajax_submit('form-remove-user-{{ u.pk }}')"
                                                          class="glyphicon glyphicon-remove btn-remove-row"></span>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                        </div>

                        <div class="modal-body">
                            <div id="div-invite-people">
                                <p>Invite people:</p>

                                <div class="input-group" style="width:100%">
                                    <form id="add-access-form"
                                          action="/hsapi/_internal/{{ cm.short_id }}/share-resource-with-user/"
                                          method="POST">
                                        {% csrf_token %}

                                        {{ add_view_user_form.user }}

                                        <div class="dropdown">
                                            <button class="btn btn-default dropdown-toggle" type="button"
                                                    id="roles_list" data-toggle="dropdown"
                                                    aria-haspopup="true">
                                                <span id="selected_role" data-role="view">Can view</span>
                                                <span class="caret"></span>
                                            </button>

                                            <ul id="list-roles" class="dropdown-menu"
                                                aria-labelledby="roles_list">
                                                <li {% if not is_view_user and not is_edit_user and not is_owner_user %}class="disabled"{% endif %}><a data-role="view">Can view</a></li>
                                                <li {% if not is_edit_user and not is_owner_user %}class="disabled"{% endif %}><a data-role="edit">Can edit</a></li>
                                                <li {% if not is_owner_user %}class="disabled"{% endif %}><a data-role="owner">Is owner</a></li>
                                            </ul>
                                        </div>

                                        <a id="btn-invite" onclick="share_resource_ajax_submit('add-access-form'); return false;"
                                                class="btn btn-add-access btn-success pull-left glyphicon glyphicon-plus"><span
                                                class="button-label">&nbspAdd</span></a>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <a type="button" data-dismiss="modal" class="btn btn-primary">Close</a>
                        </div>
                    </div>
                </div>
            </div>
            {#======= Manage access modal  window ends =======#}
            {% endif %}
        </div>
        </div>

        {#        ======= Content =======#}

        {% if cm.resource_type != "ToolResource" %}
        <div class="col-sm-12 content-block">
            <h3>Content</h3>

            {% if show_content_files %}
                <div class="custom-well">
                    {% if cm.files.all %}
                    <div class="table-container">
                        <table class="table-plain table-striped">
                            {% for f in cm.files.all %}
                                {% if f.resource_file %}
                                    {#======= Modal window begins =======#}
                                    {% if page.perms.change and metadata_form %}
                                        <div class="modal fade" id="delete-resource-file-{{ f.pk }}" tabindex="-1"
                                             role="dialog"
                                             aria-labelledby="myModalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal"
                                                                aria-hidden="true">&times;</button>
                                                        <h4 class="modal-title">Confirm file deletion</h4>
                                                    </div>
                                                    <div class="modal-body">
                                                        Consider saving a copy of the file before you delete it if
                                                        it is
                                                        important to you.
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-default"
                                                                data-dismiss="modal">
                                                            Cancel
                                                        </button>
                                                        <a type="button" class="btn btn-danger"
                                                           href="/hsapi/_internal/{{ cm.short_id }}/delete-resource-file/{{ f.pk }}/">Delete</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {#======= Modal window ends =======#}
                                    <tr>
                                        <td>
                                            <span class="glyphicon glyphicon-file file-icon"></span>
                                    <span>
                                        <span class="label-file-name">{{ f.resource_file.name|slice:"33:" }}</span>
                                        <p class="label-file-size">{{ f.resource_file.size|filesizeformat }}</p>
                                    </span>
                                        </td>
                                        {#                    <td>{% if preview %}<a class="btn btn-info btn-block" href="{{ preview }}">Preview</a>{% endif %}</td>#}
                                        <td>
                                            {% if page.perms.change and metadata_form %}

                                                <a href="{{ f.resource_file.url }}"><span data-toggle="modal"
                                                                                          data-target="#delete-resource-file-{{ f.pk }}"
                                                                                          data-placement="auto"
                                                                                          title="Delete"
                                                                                          class="glyphicon glyphicon-trash icon-button btn-remove"></span></a>

                                            {% endif %}

                                            <a href="{{ f.resource_file.url }}"><span data-toggle="tooltip"
                                                                                      data-placement="auto"
                                                                                      title="Download"
                                                                                      class="glyphicon glyphicon-download icon-button btn-download"></span></a>

                                            {% if preview %}
                                                <a href="{{ preview }}"><span data-toggle="tooltip"
                                                                              data-placement="auto"
                                                                              title="Preview"
                                                                              class="glyphicon glyphicon-eye-open icon-button"></span></a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </table>
                    </div>
                    {% else %}
                        <i>No files have been uploaded.</i>
                    {% endif %}

                    {% if page.perms.change and metadata_form %}
                        <a id="btn-add-file" type="button" class="btn btn-success row-selector" data-toggle="modal"
                           data-target="#add-file-dialog"
                           multiple="multiple">
                            <span class="glyphicon glyphicon-plus"><span class="button-label"> Add file...</span></span>
                        </a>

                        <a id="btn-select-irods-file" type="button" class="btn btn-success row-selector hidden-form" data-toggle="modal" data-target="#irodsContent" >
                            <span class="glyphicon glyphicon-plus"><span class="button-label"> Add file from iRODS...</span></span>
                        </a>

                        <span id="log-into-irods">To add files from an iRODS server,
                            <a id="btn-signin-irods" type="button" class="btn-link" data-toggle="modal" data-target="#irodsSignin">log in to iRODS</a>
                        </span>
                        <span id="sign-in-info"></span>
                        <a id="btn-signout-irods" type="button" class="btn-link hidden-form">log out of iRODS</a>

                        {% if file_type_error %}
                          <div class="alert alert-danger alert-dismissible" role="alert">
                            <button id="validation-error-close" type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <strong>Uploaded File Type Validation Error: {{ file_type_error }}</strong>
                          </div>
                        {% endif %}
                    {% endif %}

                </div>
                <!-- Buttons -->
                {% block download_bag %}
                <div>
                    {% for b in cm.bags.all %}
                        <a id="btn-download-all" type="button" class="btn btn-default row-selector" href="{{ bag_url }}">
                            <span class="glyphicon glyphicon-download-alt">
                                <span title='Download All Content as Zipped BagIt Archive' class="button-label">Download All Content as Zipped BagIt Archive</span>
                            </span>
                            <a target="_blank" href="http://en.wikipedia.org/wiki/BagIt">Learn more about the Bagit archive format</a>
                        </a>
                    {% endfor %}
                </div>
                {% endblock %}

            {% else %}
                <i class="glyphicon glyphicon-eye-close text-danger no-access-icon"></i>&nbsp;
                <span>You do not have permission to see these content files. Please contact the Authors if you wish to obtain access.</span>
            {% endif %}
        </div>
        {% endif %}

        <div class="col-sm-12">
            <!-- === Tabs begin === -->
            <div class="tab-elements">
                <div class="panel-tabs">
                    <ul class="nav nav-tabs">
                        <li class="active col-xs-2 col-md-2">
                            <a href="#contactTab" data-toggle="tab" title="Contact">
                                <span class="glyphicon glyphicon-user"> </span>
                                &nbspContact
                            </a>
                        </li>
                        {% if spatial_coverage.north or spatial_coverage.northlimit or temporal_coverage or metadata_form %}
                            <li class="col-xs-2 col-md-2">
                                <a id="coverageTabBtn" href="#coverageTab" data-toggle="tab" title="Coverage">
                                    <span class="glyphicon glyphicon-globe"></span>
                                    &nbspCoverage
                                </a>
                            </li>
                        {% endif %}
                        {% if sources or relations or metadata_form %}
                            <li class="col-xs-2 col-md-2">
                                <a href="#relatedResourcesTab" data-toggle="tab" title="Related resources">
                                    <span class="glyphicon glyphicon-book"></span>
                                    &nbspRelated Resources
                                </a>
                            </li>
                        {% endif %}
                        {% if extended_metadata_exists or metadata_form %}
                            {#  Resource specific metadata can't be edited for HIS Referenced Time Series #}
                            {% if cm|resource_type != "HIS Referenced Time Series" or not metadata_form %}
                                {% if  cm|resource_type != "Generic" %}
                                    <li class="col-xs-2 col-md-2">
                                        <a href="#resourceSpecificTab" data-toggle="tab" title="Resource specific">
                                            <span class="glyphicon glyphicon-folder-close"></span>
                                            &nbspResource Specific
                                        </a>
                                    </li>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                        {% if relevant_tools  %}
                            <li class="col-xs-2 col-md-2">
                                <a href="#relevantTools" data-toggle="tab" title="Relevant tools">
                                    <span class="glyphicon glyphicon-wrench"></span>
                                    &nbsp; Web Apps
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="tabs-body">
                    <!-- Tab panes -->
                    <div class="tab-content">
                        <!-- ========= CONTACT TAB ========= -->
                        <div class="tab-pane active" id="contactTab">
                            {% if not metadata_form %}
                                <table class="table table-striped">
                                    <tbody>
                                    <tr>
                                        <th class="division-title">Authors</th>
                                    </tr>
                                    <tr class="header-row">
                                        <th>Name</th>
                                        <th>Organization</th>
                                        <th>Address</th>
                                        <th>Phone</th>
                                    </tr>
                                    {% for cr in creators %}
                                        <tr>
                                            <td>{% if cr.description %}
                                                <a href="{{ cr.description }}">{{ cr.name }}</a>{% else %}
                                                {{ cr.name }}{% endif %}</td>
                                            <td>{% if cr.organization %} {{ cr.organization }}{% endif %}</td>
                                            <td>{% if cr.address %} {{ cr.address }}{% endif %}</td>
                                            <td>{% if cr.phone %} {{ cr.phone }}{% endif %}</td>
                                        </tr>
                                    {% endfor %}
                                    {% if contributors %}
                                        <tr>
                                            <th class="division-title">Contributors</th>
                                        </tr>
                                        <tr class="header-row">
                                            <th>Name</th>
                                            <th>Organization</th>
                                            <th>Address</th>
                                            <th>Phone</th>
                                        </tr>

                                        {% for cont in contributors %}
                                            <tr>
                                                <td>{% if cont.description %}
                                                    <a href="{{ cont.description }}">{{ cont.name }}</a>{% else %}
                                                    {{ cont.name }}{% endif %}</td>
                                                <td>{% if cont.organization %} {{ cont.organization }}{% endif %}</td>
                                                <td>{% if cont.address %} {{ cont.address }}{% endif %}</td>
                                                <td>{% if cont.phone %} {{ cont.phone }}{% endif %}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                    </tbody>
                                </table>
                            {% else %}
                                <div class="tab-pane active" id="contactTab">
                                    <table id="contact-table" class="table table-striped">
                                        <tbody>
                                        <tr>
                                            <th class="division-title">Authors</th>
                                        </tr>
                                        <tr class="header-row">
                                            <th>Name</th>
                                            <th>Organization</th>
                                            <th>Address</th>
                                            <th>Phone</th>
                                            <th>Actions</th>
                                        </tr>
                                        {% for author in creator_formset.initial %}
                                            <tr>
                                                <td>{% if author.description %}
                                                    <a href="{{ author.description }}">{{ author.name }}</a>{% else %}
                                                    {{ author.name }}{% endif %}</td>
                                                <td>{% if  author.organization %}{{ author.organization }}{% endif %}</td>
                                                <td>{% if  author.address %}{{ author.address }}{% endif %}</td>
                                                <td>{% if  author.phone %}{{ author.phone }}{% endif %}</td>
                                                <td>
                                                    <a data-toggle="modal" data-placement="auto" title="Edit"
                                                       class="glyphicon glyphicon-pencil icon-button btn-edit"
                                                       data-target="#edit-creator-dialog{{ author.id }}"
                                                            ></a>

                                                    {# Prevent deletion of last creator#}
                                                    {% if creator_formset.initial|length > 1 %}
                                                        <a data-toggle="modal" data-placement="auto" title="Remove"
                                                           class="glyphicon glyphicon-trash icon-button btn-remove"
                                                           data-target="#delete-creator-dialog{{ author.id }}"></a>
                                                    {% endif %}
                                                </td>
                                            </tr>

                                        {% endfor %}
                                        <tr>
                                            <th class="division-title">
                                                <a type="button" class="btn btn-success" data-toggle="modal"
                                                   data-target="#add-creator-dialog" multiple="multiple">
                                                        <span class="glyphicon glyphicon-plus"><span
                                                                class="button-label"> Add author...</span></span>
                                                </a>
                                            </th>
                                        </tr>
                                        <tr>
                                            <th class="division-title">Contributors</th>
                                        </tr>
                                        <tr class="header-row">
                                            <th>Name</th>
                                            <th>Organization</th>
                                            <th>Address</th>
                                            <th>Phone</th>
                                            <th>Actions</th>
                                        </tr>
                                        {% for contributor in contributor_formset.initial %}
                                            <tr>
                                                <td>{% if contributor.description %}
                                                    <a href="{{ contributor.description }}">{{ contributor.name }}</a>{% else %}
                                                    {{ contributor.name }}{% endif %}</td>
                                                <td>{% if  contributor.organization %}
                                                    {{ contributor.organization }}{% endif %}</td>
                                                <td>{% if  contributor.address %}{{ contributor.address }}{% endif %}</td>
                                                <td>{% if  contributor.phone %}{{ contributor.phone }}{% endif %}</td>
                                                <td>
                                                    <a data-toggle="modal" data-placement="auto" title="Edit"
                                                       class="glyphicon glyphicon-pencil icon-button btn-edit"
                                                       data-target="#edit-contributor-dialog{{ contributor.id }}"
                                                            ></a>
                                                    <a data-toggle="modal" data-placement="auto" title="Remove"
                                                       class="glyphicon glyphicon-trash icon-button btn-remove"
                                                       data-target="#delete-contributor-dialog{{ contributor.id }}"
                                                            ></a>
                                                </td>
                                            </tr>
                                        {% endfor %}

                                        <tr>
                                            <th class="division-title">
                                                <a type="button" class="btn btn-success" data-toggle="modal"
                                                   data-target="#add-contributor-dialog" multiple="multiple">
                                                    <span class="glyphicon glyphicon-plus"><span class="button-label"> Add contributor...</span></span>
                                                </a>
                                            </th>
                                        </tr>

                                        </tbody>
                                    </table>
                                </div>
                            {% endif %}
                        </div>
                        <!-- ========= COVERAGE TAB ========= -->
                        {% if spatial_coverage.north or spatial_coverage.northlimit or temporal_coverage or metadata_form %}
                            <div class="tab-pane" id="coverageTab">
                                <div class="row">
                                    {% if not metadata_form %}
                                    <div class="{% if temporal_coverage %}col-md-8{% endif %} col-sm-12 col-xs-12" id="coverage-spatial">
                                        <div class="row">
                                        <div class="col-sm-12">
                                            <legend>Spatial</legend>
                                            <div class="info-group" style="margin-top: -20px; margin-bottom:20px;">
                                                <table>
                                                    <tbody>
                                                        {% if spatial_coverage.name %}
                                                        <tr>
                                                            <th class="text-muted">Place/Area Name</th>
                                                            <td>{{ spatial_coverage.name }}</td>
                                                        </tr>
                                                        {% endif %}
                                                        {% if spatial_coverage.projection %}
                                                        <tr>
                                                            <th class="text-muted">Coordinate System/Geographic Projection
                                                            </th>
                                                            <td>WGS 84 EPSG:4326</td>
                                                        </tr>
                                                        {% endif %}
                                                        {% if spatial_coverage.units %}
                                                        <tr>
                                                            <th class="text-muted">Coordinate Units</th>
                                                            <td>Decimal degrees</td>
                                                        </tr>
                                                        {% endif %}

                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <div class="col-sm-8">
                                            <div id="coverageMap" data-shape-type="{{ spatial_coverage.type }}"></div>
                                            <i id="resetZoomBtn" class="glyphicon glyphicon-record" data-toggle="tooltip"
                                               data-placement="left" title="Recenter on selected area/point"></i>
                                        </div>

                                        <div class="col-sm-4">
                                            {% if spatial_coverage.north or spatial_coverage.northlimit %}
                                                <ul class="list-group">
                                                    {% if spatial_coverage.type == 'point' %}
                                                        {% if spatial_coverage.east %}
                                                            <li class="list-group-item"><strong>Longitude</strong>
                                                                <div id="cov_east">{{ spatial_coverage.east }}Â°</div>
                                                            </li>
                                                        {% endif %}
                                                        {% if spatial_coverage.north %}
                                                            <li class="list-group-item"><strong>Latitude</strong>
                                                                <div id="cov_north">{{ spatial_coverage.north }}Â°</div>
                                                            </li>
                                                        {% endif %}
                                                    {% else %}
                                                        {% if spatial_coverage.northlimit %}
                                                            <li class="list-group-item"><strong>North Latitude</strong>
                                                                <div id="cov_northlimit">{{ spatial_coverage.northlimit }}Â°</div>
                                                            </li>
                                                        {% endif %}
                                                        {% if spatial_coverage.eastlimit %}
                                                            <li class="list-group-item"><strong>East Longitude</strong>
                                                                <div id="cov_eastlimit">{{ spatial_coverage.eastlimit }}Â°</div>
                                                            </li>
                                                        {% endif %}
                                                        {% if spatial_coverage.southlimit %}
                                                            <li class="list-group-item"><strong>South Latitude</strong>
                                                                <div id="cov_southlimit">{{ spatial_coverage.southlimit }}Â°</div>
                                                            </li>
                                                        {% endif %}
                                                        {% if spatial_coverage.westlimit %}
                                                            <li class="list-group-item"><strong>West Longitude</strong>
                                                                <div id="cov_westlimit">{{ spatial_coverage.westlimit }}Â°</div>
                                                            </li>
                                                        {% endif %}
                                                    {% endif %}
                                                </ul>
                                                <div class="text-muted" style="margin-top:20px;">WGS 84 decimal degrees</div>
                                            {% endif %}
                                        </div>

                                    </div>
                                    </div>
                                    {% if temporal_coverage %}
                                        <div class="col-sm-4">
                                            <legend>Temporal</legend>
                                            <div class="row">
                                                <div class="col-sm-4"><strong class="text-muted">Start Date</strong></div>
                                                <div class="col-sm-8">{{ temporal_coverage.start_date }}</div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-4"><strong class="text-muted">End Date</strong></div>
                                                <div class="col-sm-8">{{ temporal_coverage.end_date }}</div>
                                            </div>
                                        </div>
                                        {% endif %}

                                    {% else %}
                                        <div class="form-group">
                                            <div class="col-md-8 col-sm-12 col-xs-12" id="coverage-spatial">
                                                <div class="row">
                                                    <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/{% if not coverage_spatial_form.initial.north and not coverage_spatial_form.initial.northlimit %}add-metadata/{% else %}{{ coverage_spatial_form.initial.id }}/update-metadata/{% endif %}"
                                                          id="id-coverage-spatial" method="post">
                                                        {% csrf_token %}
                                                         <div class="col-sm-12">
                                                            <legend>Spatial</legend>
                                                            <div class="info-group" style="margin-top: -20px; margin-bottom:20px;">
                                                                 <table>
                                                                     <tbody>
                                                                         <tr>
                                                                             <th class="text-muted">Coordinate System/Geographic Projection</th>
                                                                             <td>WGS 84 EPSG:4326</td>
                                                                         </tr>
                                                                         <tr>
                                                                             <th class="text-muted">Coordinate Units</th>
                                                                             <td>Decimal degrees</td>
                                                                         </tr>
                                                                     </tbody>
                                                                 </table>
                                                             </div>

                                                            <div id="div_id_name" class="control-group">
                                                                <label for="id_name" class="control-label">Place/Area Name</label>

                                                                <div class="controls">
                                                                    <input class="form-control input-sm textinput textInput"
                                                                           id="id_name" maxlength="200" name="name" type="text"
                                                                           value="{% if coverage_spatial_form.initial.name %}{{ coverage_spatial_form.initial.name }}{% endif %}">
                                                                </div>
                                                            </div>

                                                             <input id="id_projection" maxlength="100" name="projection"
                                                                    type="text" style="display:none"
                                                                    value="{% if coverage_spatial_form.initial.projection %}{{ coverage_spatial_form.initial.projection }}{% else %}WGS 84 EPSG:4326{% endif %}">
                                                             <input id="id_units" maxlength="50" name="units"
                                                                    style="display:none"
                                                                    type="text" value="{% if coverage_spatial_form.initial.units %}{{ coverage_spatial_form.initial.units }}{% endif %}">

                                                             <div id="div_id_type">
                                                                 <label class="radio-inline">
                                                                     <input type="radio"
                                                                            {% if coverage_spatial_form.initial.type == "box" %}checked="checked"{% endif %}
                                                                            name="type" id="id_type_1"
                                                                            value="box">Box</label>

                                                                 <label class="radio-inline">
                                                                     <input type="radio"
                                                                            {% if coverage_spatial_form.initial.type == "point" %}checked="checked"{% endif %}
                                                                            name="type" id="id_type_2"
                                                                            value="point">Point</label>
                                                             </div>
                                                         </div>

                                                        <fieldset>
                                                            <div class="col-sm-8">
                                                                <div id="coverageMap"></div>
                                                                <i id="resetZoomBtn" class="glyphicon glyphicon-record" data-toggle="tooltip"
                                                                    data-placement="left" title="Recenter on selected area/point"></i>
                                                            </div>

                                                            <div class="col-sm-4">
                                                                <div id="div_id_north" class="control-group" style="margin-bottom: 10px;">
                                                                    <label for="id_north" class="control-label requiredField">
                                                                        Latitude<span class="asteriskField">*</span>
                                                                    </label>

                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" placeholder="-90 to 90"
                                                                             id="id_north" name="north"
                                                                             value="{% if coverage_spatial_form.initial.north %}{{ coverage_spatial_form.initial.north }}{% endif %}">
                                                                        <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                              class="input-group-addon">Â°</span>
                                                                    </div>
                                                                </div>
                                                                <div id="div_id_east" class="control-group" style="margin-bottom: 10px;">
                                                                    <label for="id_east" class="control-label requiredField">
                                                                        Longitude<span class="asteriskField">*</span>
                                                                    </label>

                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" placeholder="-180 to 180"
                                                                             id="id_east" name="east"
                                                                             value="{% if coverage_spatial_form.initial.east %}{{ coverage_spatial_form.initial.east }}{% endif %}">
                                                                        <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                              class="input-group-addon">Â°</span>
                                                                    </div>
                                                                </div>
                                                                <div id="div_id_northlimit" class="control-group" style="margin-bottom: 10px;">
                                                                    <label for="id_northlimit" class="control-label requiredField">
                                                                        North Latitude<span class="asteriskField">*</span>
                                                                    </label>

                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" placeholder="-90 to 90"
                                                                             id="id_northlimit" name="northlimit"
                                                                             value="{% if coverage_spatial_form.initial.northlimit %}{{ coverage_spatial_form.initial.northlimit }}{% endif %}">
                                                                        <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                              class="input-group-addon">Â°</span>
                                                                    </div>
                                                                </div>
                                                                <div id="div_id_eastlimit" class="control-group" style="margin-bottom: 10px;">
                                                                    <label for="id_eastlimit" class="control-label requiredField">
                                                                        East Longitude<span class="asteriskField">*</span>
                                                                    </label>

                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" placeholder="-180 to 180"
                                                                             id="id_eastlimit" name="eastlimit"
                                                                             value="{% if coverage_spatial_form.initial.eastlimit %}{{ coverage_spatial_form.initial.eastlimit }}{% endif %}">
                                                                        <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                              class="input-group-addon">Â°</span>
                                                                    </div>
                                                                </div>
                                                                <div id="div_id_southlimit" class="control-group" style="margin-bottom: 10px;">
                                                                    <label for="id_southlimit" class="control-label requiredField">
                                                                        South Latitude<span class="asteriskField">*</span>
                                                                    </label>

                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" placeholder="-90 to 90"
                                                                             id="id_southlimit" name="southlimit"
                                                                             value="{% if coverage_spatial_form.initial.southlimit %}{{ coverage_spatial_form.initial.southlimit }}{% endif %}">
                                                                        <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                              class="input-group-addon">Â°</span>
                                                                    </div>
                                                                </div>
                                                                <div id="div_id_westlimit" class="control-group" style="margin-bottom: 10px;">
                                                                    <label for="id_westlimit" class="control-label requiredField">
                                                                        West Longitude<span class="asteriskField">*</span>
                                                                    </label>

                                                                    <div class="input-group">
                                                                        <input type="text" class="form-control" placeholder="-180 to 180"
                                                                             id="id_westlimit" name="westlimit"
                                                                             value="{% if coverage_spatial_form.initial.westlimit %}{{ coverage_spatial_form.initial.westlimit }}{% endif %}">
                                                                        <span data-toggle="tooltip" data-placement="auto" title="WGS 84 decimal degrees"
                                                                              class="input-group-addon">Â°</span>
                                                                    </div>
                                                                </div>

                                                            <button type="button" class="btn btn-primary pull-right"
                                                                        onclick="metadata_update_ajax_submit('id-coverage-spatial'); return false;"
                                                                        style="display: none;">Save changes
                                                                </button>

                                                            </div>
                                                        </fieldset>
                                                    </form>

                                                </div>
                                            </div>

                                            <div class="form-group col-md-4 col-sm-12 col-xs-12" id="coverage-temporal">
                                                {% if not coverage_temporal_form.initial.start %}
                                                <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/add-metadata/"
                                                      id="id-coverage-temporal" method="post">
                                                    {% csrf_token %}
                                                    <fieldset>
                                                        <legend>Temporal</legend>
                                                        <div id="div_id_start" class="control-group">
                                                            <label for="id_start" class="control-label requiredField">
                                                                Start Date<span class="asteriskField">*</span></label>

                                                            <div class="controls">
                                                                <input class="form-control input-sm dateinput" id="id_start"
                                                                       name="start" type="text">
                                                            </div>
                                                        </div>
                                                        <div id="div_id_end" class="control-group">
                                                            <label for="id_end" class="control-label requiredField">End
                                                                Date<span class="asteriskField">*</span></label>

                                                            <div class="controls">
                                                                <input class="form-control input-sm dateinput" id="id_end"
                                                                       name="end" type="text">
                                                            </div>
                                                        </div>
                                                        <div style="margin-top:10px">
                                                            <button type="button" class="btn btn-primary pull-right"
                                                                    onclick="metadata_update_ajax_submit('id-coverage-temporal'); return false;">
                                                                Save changes
                                                            </button>
                                                        </div>
                                                    </fieldset>
                                                </form>
                                            {% else %}
                                                <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/{{ coverage_temporal_form.initial.id }}/update-metadata/"
                                                      id="id-coverage-temporal" method="post">
                                                    {% csrf_token %}
                                                    <fieldset>
                                                        <legend>Temporal</legend>
                                                        <div id="div_id_start" class="control-group">
                                                            <label for="id_start" class="control-label requiredField">
                                                                Start Date<span class="asteriskField">*</span></label>

                                                            <div class="controls">
                                                                <input class="form-control input-sm dateinput" id="id_start"
                                                                       name="start" type="text"
                                                                       value="{{ coverage_temporal_form.initial.start }}">
                                                            </div>
                                                        </div>
                                                        <div id="div_id_end" class="control-group">
                                                            <label for="id_end" class="control-label requiredField">End
                                                                Date<span class="asteriskField">*</span></label>

                                                            <div class="controls">
                                                                <input class="form-control input-sm dateinput" id="id_end"
                                                                       name="end" type="text"
                                                                       value="{{ coverage_temporal_form.initial.end }}">
                                                            </div>
                                                        </div>
                                                        <div style="margin-top:10px">
                                                            <button type="button" class="btn btn-primary pull-right"
                                                                    onclick="metadata_update_ajax_submit('id-coverage-temporal'); return false;"
                                                                    style="display: none;">Save changes
                                                            </button>
                                                        </div>
                                                    </fieldset>
                                                </form>
                                            {% endif %}
                                            </div>
                                        </div>

                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                        <!-- ========= RELATED RESOURCES TAB ========= -->
                        {% if sources or relations or metadata_form %}
                            <div class="tab-pane" id="relatedResourcesTab">
                                {% if not metadata_form %}
                                    {% if sources %}
                                        <h4><strong>Sources</strong></h4>
                                        <hr style="margin-top: 0px;margin-bottom: 2px">
                                        {% for source in sources %}
                                            <div class="row">
                                                <div class="col-sm-4"><strong>Derived From:</strong></div>
                                                <div class="col-sm-8">{{ source.derived_from }}</div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                    {% if relations %}
                                        <hr style="border: 0;">
                                        <h4><strong>Relations</strong></h4>
                                        <hr style="margin-top: 0;margin-bottom: 2px">
                                        {% for relation in relations %}
                                            <div class="row">
                                                <div class="col-sm-4"><strong>{{ relation.type }}:</strong></div>
                                                <div class="col-sm-8">{{ relation.value }}</div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                {% else %}
                                    <div>
                                        <table class="table" style="margin-bottom: 0;">
                                            <tbody>
                                            <legend>Sources</legend>
                                            {% for source in source_formset.initial %}
                                                <tr>
                                                    <th scope="row" class="dataset-label">Derived From:</th>
                                                    <td class="dataset-details">{{ source.derived_from }}</td>
                                                    <td>
                                                        <a data-toggle="modal" data-placement="auto" title="Edit"
                                                           class="glyphicon glyphicon-pencil icon-button btn-edit"
                                                           data-target="#edit-source-dialog{{ source.id }}"
                                                           style="top: -5px; "></a>
                                                    </td>
                                                    <td>
                                                        <a data-toggle="modal" data-placement="auto"
                                                           title="Remove"
                                                           class="glyphicon glyphicon-trash icon-button btn-remove"
                                                           data-target="#delete-source-element-dialog{{ source.id }}"
                                                           style="top: -5px; right:20px;"></a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                        <a id="add-source" class="btn btn-success" data-toggle="modal"
                                           data-target="#add-source-dialog"><i
                                                class="fa fa-plus"></i> Add source</a>
                                    </div>
                                    <hr style="border: 0;">
                                    <div>
                                        <table class="table" style="margin-bottom: 0;">
                                            <tbody>
                                            <legend>Relations</legend>
                                            {% for relation in relation_formset.initial %}
                                                <tr>
                                                    <th scope="row" class="dataset-label">{{ relation.type }}:</th>
                                                    <td class="dataset-details">{{ relation.value }}</td>
                                                    <td>
                                                        <a data-toggle="modal" data-placement="auto" title="Edit"
                                                           class="glyphicon glyphicon-pencil icon-button btn-edit"
                                                           data-target="#edit-relation-dialog_{{ relation.id }}"
                                                           style="top: -5px; "></a>
                                                    </td>
                                                    <td>
                                                        <a data-toggle="modal" data-placement="auto"
                                                           title="Remove"
                                                           class="glyphicon glyphicon-trash icon-button btn-remove"
                                                           data-target="#delete-relation-element-dialog{{ relation.id }}"
                                                           style="top: -5px; right:20px;"></a>
                                                    </td>
                                                </tr>
                                            {% endfor %}

                                            </tbody>
                                        </table>

                                        <a id="add-relation" class="btn btn-success" data-toggle="modal"
                                           data-target="#add-relation-dialog"><i class="fa fa-plus"></i> Add relation</a>

                                        <div>
                                            <small class="text-muted">Click the button above to add a relationship to
                                                another resource, external website, or document. You can express the
                                                type of
                                                relationship and then enter a URL to the resource or website. If the
                                                related
                                                resource does not have a URL, you can paste in a full text citation.
                                            </small>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                        <!-- ========= RESOURCE SPECIFIC TAB ========= -->
                        {% if site or extended_metadata_exists or res_add_metadata or metadata_form %}
                            {#  Resource specific metadata can't be edited for HIS Referenced Time Series #}
                            {% if cm|resource_type != "HIS Referenced Time Series" or not metadata_form %}
                                {% if  cm|resource_type != "Generic" %}
                                    <div class="tab-pane" id="resourceSpecificTab">
                                        {% if not metadata_form %}

                                            {% block extended_metadata %}

                                            {% endblock %}

                                        {% else %}
                                            {% crispy metadata_form %}
                                        {% endif %}
                                        {% block extra_section %} {# add extra section for resource landing page #}
                                        {% endblock %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                            <!-- ========= RELEVANT TOOLS TAB ========= -->
                        {% if relevant_tools %}
                            <div class="tab-pane" id="relevantTools">
                                {% if not metadata_form %}
                                    {% for tool in relevant_tools %}
                                        <div title="{{ tool.title }}" id="web-app-item">
                                            <a href="{{ tool.url }}" target="_blank">
                                                {% if tool.title|length > 20 %}
                                                    <h4>{{ tool.title|slice:":21"|add:"..." }}</h4>
                                                {% else %}
                                                    <h4>{{ tool.title }}</h4>
                                                {% endif %}
                                                <img class="user-webapp-icon" src="{{ tool.icon_url }}">
                                            </a>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    ------- Relevant tools form here -------
                                {%  endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- ==== Tabs end ==== -->
        </div>

        <div class="rating col-sm-12 content-block">
            {% rating_for cm %}
        </div>

        <div class="rating col-sm-12 content-block">
            {% comments_for cm %}
        </div>

        {#                #}
        {# dialogs follow #}
        {#                #}
        {%  block modal %}

        {% for source in source_formset.initial %}
        <div class="modal fade in" id="delete-source-element-dialog{{ source.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                        <h4 class="modal-title" id="myModalLabel">Delete metadata element</h4></div>
                    <div class="modal-body"><strong>Are you sure you want to delete this metadata element?</strong>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger"
                           href="/hsapi/_internal/{{ cm.short_id }}/source/{{ source.id }}/delete-metadata/">Delete</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade in" id="edit-source-dialog{{ source.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="id_source_{{ source.id }}" action="/hsapi/_internal/{{ cm.short_id }}/source/{{ source.id }}/update-metadata/"
                          method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                            <h4 class="modal-title" id="myModalLabel"> Edit Source </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <legend>Source</legend>
                                    <div id="div_id_derived_from" class="control-group">
                                        <label for="id_derived_from" class="control-label requiredField">
                                        Derived from<span class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_source-{{ forloop.counter0 }}-derived_from" maxlength="300" name="source-{{ forloop.counter0 }}-derived_from"
                                                type="text" value="{{ source.derived_from }}"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

        {% for relation in relation_formset.initial %}
        <div class="modal fade in" id="delete-relation-element-dialog{{ relation.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                        <h4 class="modal-title" id="myModalLabel">Delete metadata element</h4></div>
                    <div class="modal-body"><strong>Are you sure you want to delete this metadata element?</strong>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger"
                           href="/hsapi/_internal/{{ cm.short_id }}/relation/{{ relation.id }}/delete-metadata/">Delete</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade in" id="edit-relation-dialog_{{ relation.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/relation/{{ relation.id }}/update-metadata/"
                          method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                            <h4 class="modal-title" id="myModalLabel"> Edit Relation </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}

                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <legend>Relation</legend>
                                    <div id="div_id_type" class="control-group">
                                        <label for="id_type" class="control-label requiredField">
                                        Relation type<span class="asteriskField">*</span></label>

                                        <div class="controls">
                                            <select class="form-control input-sm select" id="id_relation-{{ forloop.counter0 }}-type" name="relation-{{ forloop.counter0 }}-type">
                                                <option value="">---------</option>
                                                {% for type_value, type_display in relation_source_types %}
                                                    <option value={{ type_value }} {% if relation.type == type_value %}selected="selected"{% endif %}>{{ type_display }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div id="div_id_value" class="control-group">
                                        <label for="id_value" class="control-label requiredField">
                                        Related to<span class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput" id="id_relation-{{ forloop.counter0 }}-value"
                                                maxlength="500" name="relation-{{ forloop.counter0 }}-value" type="text"
                                                value="{{ relation.value }}"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

        {% for contributor in contributor_formset.initial %}
        <div class="modal fade" id="edit-contributor-dialog{{ contributor.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="id_contributor_{{ contributor.id }}" action="/hsapi/_internal/{{ cm.short_id }}/contributor/{{ contributor.id }}/update-metadata/"
                          method="POST"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-hidden="true">Ã
                            </button>
                            <h4 class="modal-title" id="myModalLabel"> Edit contributor </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <div id="div_id_name" class="control-group">
                                        <label class="control-label requiredField">Name<span
                                                class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_contributor-{{ contributor.order|add:"- 1" }}-name" maxlength="100" name="contributor-{{ contributor.order|add:"- 1" }}-name"
                                                required="required" type="text" value="{% if contributor.name %}{{ contributor.name }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_description" class="control-group">
                                        <label class="control-label">HydroShare User Identifier (URL)</label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_contributor-{{ contributor.order|add:"- 1" }}-description" maxlength="200"
                                                name="contributor-{{ contributor.order|add:"- 1" }}-description" type="url"
                                                value="{% if contributor.description %}{{ contributor.description }}{% endif %}"
                                                {% if contributor.description %} readonly {% endif %}></div>
                                    </div>
                                    <div id="div_id_organization" class="control-group">
                                        <label class="control-label">Organization</label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_contributor-{{ contributor.order|add:"- 1" }}-organization" maxlength="200"
                                                name="contributor-{{ contributor.order|add:"- 1" }}-organization" type="text" value="{% if contributor.organization %}{{ contributor.organization }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_email" class="control-group">
                                        <label class="control-label">Email</label>

                                        <div class="controls">
                                            <input class="form-control input-sm emailinput"
                                                   id="id_contributor-{{ contributor.order|add:"- 1" }}-email" maxlength="75" name="contributor-{{ contributor.order|add:"- 1" }}-email"
                                                   type="email" value="{% if contributor.email %}{{ contributor.email }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_address" class="control-group">
                                        <label class="control-label">Address</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                   id="id_contributor-{{ contributor.order|add:"- 1" }}-address" maxlength="250"
                                                   name="contributor-{{ contributor.order|add:"- 1" }}-address"
                                                   type="text" value="{% if contributor.address %}{{ contributor.address }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_phone" class="control-group">
                                        <label class="control-label">Phone</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                   id="id_contributor-{{ contributor.order|add:"- 1" }}-phone" maxlength="25" name="contributor-{{ contributor.order|add:"- 1" }}-phone"
                                                   type="text" value="{% if contributor.phone %}{{ contributor.phone }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_homepage" class="control-group">
                                        <label class="control-label">Homepage</label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_contributor-{{ contributor.order|add:"- 1" }}-homepage" maxlength="200" name="contributor-{{ contributor.order|add:"- 1" }}-homepage"
                                                type="url" value="{% if contributor.homepage %}{{ contributor.homepage }}{% endif %}"></div>
                                    </div>

                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="delete-contributor-dialog{{ contributor.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                        <h4 class="modal-title" id="myModalLabel">Delete metadata element</h4></div>
                    <div class="modal-body"><strong>Are you sure you want to delete this metadata element?</strong>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger"
                           href="/hsapi/_internal/{{ cm.short_id }}/contributor/{{ contributor.id }}/delete-metadata/">Delete</a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% for author in creator_formset.initial %}
        <div class="modal fade" id="edit-creator-dialog{{ author.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="id_creator_{{ author.id }}" action="/hsapi/_internal/{{ cm.short_id }}/creator/{{ author.id }}/update-metadata/"
                          method="POST"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-hidden="true">Ã
                            </button>
                            <h4 class="modal-title" id="myModalLabel"> Edit author </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <div id="div_id_name" class="control-group">
                                        <label class="control-label requiredField">Name<span
                                                class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-name" maxlength="100" name="creator-{{ author.order|add:"- 1" }}-name"
                                                required="required" type="text" value="{% if author.name %}{{ author.name }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_description" class="control-group">
                                        <label class="control-label">HydroShare User Identifier (URL)</label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-description" maxlength="200"
                                                name="creator-{{ author.order|add:"- 1" }}-description" type="url"
                                                value="{% if author.description %}{{ author.description }}{% endif %}"
                                                {% if author.description %} readonly {% endif %}></div>
                                    </div>
                                    <div id="div_id_organization" class="control-group">
                                        <label class="control-label">Organization</label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-organization" maxlength="200"
                                                name="creator-{{ author.order|add:"- 1" }}-organization" type="text" value="{% if author.organization %}{{ author.organization }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_email" class="control-group">
                                        <label class="control-label">Email</label>

                                        <div class="controls">
                                            <input class="form-control input-sm emailinput"
                                                   id="id_creator-{{ author.order|add:"- 1" }}-email" maxlength="75" name="creator-{{ author.order|add:"- 1" }}-email"
                                                   type="email" value="{% if author.email %}{{ author.email }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_address" class="control-group">
                                        <label class="control-label">Address</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                   id="id_creator-{{ author.order|add:"- 1" }}-address" maxlength="250"
                                                   name="creator-{{ author.order|add:"- 1" }}-address"
                                                   type="text" value="{% if author.address %}{{ author.address }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_phone" class="control-group">
                                        <label class="control-label">Phone</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                   id="id_creator-{{ author.order|add:"- 1" }}-phone" maxlength="25" name="creator-{{ author.order|add:"- 1" }}-phone"
                                                   type="text" value="{% if author.phone %}{{ author.phone }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_homepage" class="control-group">
                                        <label class="control-label">Homepage</label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-homepage" maxlength="200" name="creator-{{ author.order|add:"- 1" }}-homepage"
                                                type="url" value="{% if author.homepage %}{{ author.homepage }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_order" class="control-group">
                                        <label class="control-label">Order<span class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-order" name="creator-{{ author.order|add:"- 1" }}-order" required="required"
                                                type="number" value="{% if author.order %}{{ author.order }}{% endif %}"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="delete-creator-dialog{{ author.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                        <h4 class="modal-title" id="myModalLabel">Delete metadata element</h4></div>
                    <div class="modal-body"><strong>Are you sure you want to delete this metadata element?</strong>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger"
                           href="/hsapi/_internal/{{ cm.short_id }}/creator/{{ author.id }}/delete-metadata/">Delete</a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

            {% include "irods_signin.html" %}
            {% include "irods_upload_add.html" %}
        {%  block modal_publish_resource %}
            <div class="modal fade" id="submit-for-publication-dialog" tabindex="-1" role="dialog"
                 aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="submit-for-publication-title">Submit resource for publication</h4>
                        </div>
                        <div class="modal-body">
                            <p>
                                Once you submit the resource for publication it cannot be changed again. This will assign a
                                DOI to the
                                resource as it stands now and mark it as permanent. To make any changes after this, you
                                <strong>must</strong>
                                create a brand new resource. Click "Publish" if you really intend to do this.
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <a type="button" class="btn btn-danger" href="/hsapi/_internal/{{ cm.short_id }}/publish/">Publish</a>
                        </div>
                    </div>
                </div>
            </div>
        {%  endblock %}

        <div class="modal fade" id="add-source-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/source/add-metadata/" method="POST"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                            <h4 class="modal-title" id="myModalLabel">Add Source</h4></div>
                        <div class="modal-body">
                            {% csrf_token %}

                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <legend>Source</legend>
                                    <div id="div_id_derived_from" class="control-group">
                                        <label for="id_derived_from" class="control-label requiredField">Derived from<span class="asteriskField">*</span></label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_derived_from" maxlength="300"
                                                                     name="derived_from" type="text">
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="add-relation-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/relation/add-metadata/"
                          method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                            <h4 class="modal-title" id="myModalLabel"> Add Relation </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}

                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <legend>Relation</legend>
                                    <div id="div_id_type" class="control-group"><label for="id_type"
                                                                                       class="control-label requiredField">
                                        Relation type<span class="asteriskField">*</span></label>

                                        <div class="controls"><select class="form-control input-sm select" id="id_type" name="type">
                                            <option value="" selected="selected">---------</option>
                                            {% for type_value, type_display in relation_source_types %}
                                                <option value={{ type_value }}>{{ type_display }}</option>
                                            {% endfor %}
                                        </select></div>
                                    </div>
                                    <div id="div_id_value" class="control-group"><label for="id_value"
                                                                                        class="control-label requiredField">
                                        Related to<span class="asteriskField">*</span></label>

                                        <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                     id="id_value" maxlength="500" name="value"
                                                                     type="text"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% block modal_delete_resource %}
            <div class="modal fade" id="delete-resource-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="delete-resource-title">Delete Resource</h4>
                        </div>
                        <div class="modal-body">
                            <strong>THIS IS A PERMANENT ACTION. </strong>
                            <ul>
                                <li>This will delete the resource file.</li>
                                <li>A copy of your resource file will not be retained by Hydroshare.</li>
                                <li>We highly recommend that you download the latest copy of your resource file before
                                    confirming this action.
                                </li>
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <a type="button" class="btn btn-danger"
                               href="/hsapi/_internal/{{ cm.short_id }}/delete-resource/">Delete</a>
                        </div>
                    </div>
                </div>
            </div>
        {%  endblock %}

        <div class="modal fade" id="add-dcterm-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/add-metadata/">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Add metadata term</h4>
                        </div>
                        <div class="modal-body">
                            {% csrf_token %}

                            {{ dcterm_frm|crispy }}

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="add-reference-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/add-citation/">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Add reference</h4>
                        </div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="add-citation-input">Citation text:</label>
                                <textarea class="form-control" name="content" id="add-citation-input" cols="30"
                                          rows="10"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="add-creator-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/creator/add-metadata/" method="POST"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                            <h4 class="modal-title" id="myModalLabel"> Add author </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <div id="div_id_name" class="control-group">
                                        <label for="id_name" class="control-label requiredField">Name<span class="asteriskField">*</span></label>

                                        <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                     id="id_name" maxlength="100" name="name"
                                                                     required="required" type="text"></div>
                                    </div>
                                    <div id="div_id_description" class="control-group">
                                        <label for="id_description" class="control-label">HydroShare User Identifier (URL)</label>
                                        <div class="controls"><input class="form-control input-sm urlinput"
                                                                     id="id_description" maxlength="200"
                                                                     name="description" type="url"></div>
                                    </div>
                                    <div id="div_id_organization" class="control-group">
                                        <label for="id_organization" class="control-label">Organization</label>
                                        <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                     id="id_organization" maxlength="200"
                                                                     name="organization" type="text"></div>
                                    </div>
                                    <div id="div_id_email" class="control-group">
                                        <label for="id_email" class="control-label">Email</label>

                                        <div class="controls">
                                            <input class="form-control input-sm emailinput"
                                                                     id="id_email" maxlength="75" name="email"
                                                                     type="email">
                                        </div>
                                    </div>
                                    <div id="div_id_address" class="control-group">
                                        <label for="id_address" class="control-label">Address</label>
                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_address" maxlength="250" name="address"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_phone" class="control-group">
                                        <label for="id_phone"class="control-label">Phone</label>
                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_phone" maxlength="25" name="phone"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_homepage" class="control-group">
                                        <label for="id_homepage" class="control-label">Homepage</label>
                                        <div class="controls"><input class="form-control input-sm urlinput"
                                                                     id="id_homepage" maxlength="200" name="homepage"
                                                                     type="url"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade in" id="add-contributor-dialog" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/contributor/add-metadata/"
                          method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã</button>
                            <h4 class="modal-title" id="myModalLabel"> Add Contributor </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <div id="div_id_name" class="control-group">
                                        <label for="id_name" class="control-label requiredField">Name<span class="asteriskField">*</span></label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_name" maxlength="100" name="name"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_description" class="control-group">
                                        <label for="id_description" class="control-label">HydroShare User Identifier (URL)</label>

                                        <div class="controls">
                                            <input class="form-control input-sm urlinput"
                                                                     id="id_description" maxlength="200"
                                                                     name="description" type="url">
                                        </div>
                                    </div>
                                    <div id="div_id_organization" class="control-group">
                                        <label for="id_organization" class="control-label">Organization</label>

                                        <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                     id="id_organization" maxlength="200"
                                                                     name="organization" type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_email" class="control-group">
                                        <label for="id_email" class="control-label">Email</label>

                                        <div class="controls">
                                            <input class="form-control input-sm emailinput"
                                                                     id="id_email" maxlength="75" name="email"
                                                                     type="email">
                                        </div>
                                    </div>
                                    <div id="div_id_address" class="control-group">
                                        <label for="id_address" class="control-label">Address</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_address" maxlength="250" name="address"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_phone" class="control-group">
                                        <label for="id_phone" class="control-label">Phone</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_phone" maxlength="25" name="phone"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_homepage" class="control-group">
                                        <label for="id_homepage" class="control-label">Homepage</label>

                                        <div class="controls">
                                            <input class="form-control input-sm urlinput"
                                                                     id="id_homepage" maxlength="200" name="homepage"
                                                                     type="url">
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal -->
        {%  block modal_add_file %}
            <div class="modal fade" id="add-file-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="/hsapi/_internal/{{ cm.short_id }}/add-file-to-resource/" method="POST"
                              enctype="multipart/form-data">

                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="myModalLabel">Add file to resource</h4>
                            </div>
                            <div class="modal-body">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="add-file-input">Select files:</label>
                                    <input type="file" name="files" id="add-file-input" multiple/>
                                </div>
                                <div id="file-types">Any file type can be uploaded.</div>
                                <div id="file-multiple">Multiple file upload is allowed.</div>
                                <br>
                                <h3 style="color: red" id="file-type-error"></h3>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Save changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {%  endblock %}
        {%  endblock %}
    {% endwith %}
    {% endblock %}

    {% block extra_js %}
        <script type="text/javascript" src="{{ STATIC_URL }}js/irods.js"></script>
        <script type="text/javascript">
            function label_ajax_submit() {
                var el = $(this);
                var dataFormID = el.attr("data-form-id")
                var formID = $("form[data-id='" + dataFormID + "']");
                var form = $(formID);
                var datastring = form.serialize();
                var url = form.attr('action');

                $.ajax({
                    type: "POST",
                    url: url,
                    dataType: 'html',
                    data: datastring,
                    success: function (result) {
                        var json_response = JSON.parse(result);
                        if (json_response.status == "success") {

                            var action = form.find("input[name='action']");
                            if (json_response.action == "CREATE") {
                                action.val("DELETE");
                                $("#btnMyResources").removeClass("btn-resource-add");
                                $("#btnMyResources").addClass("btn-resource-remove");
                            }
                            else {
                                action.val("CREATE");
                                $("#btnMyResources").addClass("btn-resource-add");
                                $("#btnMyResources").removeClass("btn-resource-remove");
                            }
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {

                    }
                });
                //don't submit the form
                return false;
            }

            // Prevents form submission when pressing the enter key on the search box.
            $('#id_user-autocomplete').keypress(function(e){
                e = e || event;
                var txtArea = /textarea/i.test((e.target || e.srcElement).tagName);
                return txtArea || (e.keyCode || e.which || e.charCode || 0) !== 13;
            });

            function onRoleSelect(event) {
                var el = $(event.target);
                $("#selected_role").text(el.text());
                $("#selected_role")[0].setAttribute("data-role", el[0].getAttribute("data-role"));
            }

            function onRowRemove(event) {
                var el = $(event.target);
                var pk = el[0].getAttribute("data-pk");
                el.closest("tr").remove();
                var form = $(event.target).closest("form");
                form.submit();
            }

            // Toggles pointer events on and off for the access control interface
            function setPointerEvents(flag) {
                if (!flag) {
                    // Disable pointer events
                    $(".access-table").css("pointer-events", "none");
                    $("#manage-access .modal-content").css("pointer-events", "none");
                }
                else {
                    // Enable pointer events
                    $(".access-table").css("pointer-events", "auto");
                    $("#manage-access .modal-content").css("pointer-events", "auto");
                }
            }

            function shareable_ajax_submit(event) {
                var form = $(this).closest("form");
                var datastring = form.serialize();
                var url = form.attr('action');
                var element = $(this);
                var action = $(this).closest("form").find("input[name='t']").val();
                element.attr("disabled", true);


                $.ajax({
                    type: "POST",
                    url: url,
                    dataType: 'html',
                    data: datastring,
                    success: function () {
                        element.attr("disabled", false);
                        if (action == "make_not_shareable") {
                            element.closest("form").find("input[name='t']").val("make_shareable");
                        }
                        else {
                            element.closest("form").find("input[name='t']").val("make_not_shareable");
                        }
                    },
                    error: function () {
                        element.attr("disabled", false);
                    }
                });
                //don't submit the form
                return false;
            }

            function unshare_resource_ajax_submit(form_id) {
                $form = $('#' + form_id);
                var datastring = $form.serialize();
                var url = $form.attr('action');
                setPointerEvents(false);
                $form.parent().closest("tr").addClass("loading");
                $.ajax({
                    type: "POST",
                    url: url,
                    dataType: 'html',
                    data: datastring,
                    success: function (result) {
                        $form.parent().closest("tr").remove();
                        if ($(".access-table li.active[data-access-type='Is owner']").length == 1) {
                            $(".access-table li.active[data-access-type='Is owner']").closest("tr").addClass("hide-actions");
                        }
                        setPointerEvents(true);
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        $("#div-invite-people").find(".label-danger").remove(); // Remove previous alerts
                        $("#div-invite-people").append("<span class='label label-danger'><strong>Error: </strong>" + errorThrown + "</span>");
                        setPointerEvents(true);
                    }
                });
                //don't submit the form
                return false;
            }

            // Enables and disables granting access buttons accordingly to the current access level
            function updateActionsState(privilege){
                // Set the state of dropdown menu items and remove buttons to false by default
                $("form[data-access-type]").parent().addClass("disabled");
                $("#list-roles a[data-role]").parent().addClass("disabled");
                $(".access-table li.active[data-access-type]").closest("tr").addClass("hide-actions");

                if (privilege == "view") {
                    // Dropdown menu items
                    $("form[data-access-type='Can view']").parent().removeClass("disabled");
                    $("#list-roles a[data-role='view']").parent().removeClass("disabled");

                    // Remove buttons
                    $(".access-table li.active[data-access-type='Can view']").closest("tr").removeClass("hide-actions");
                }
                else if(privilege == "change") {
                    // Dropdown menu items
                    $("form[data-access-type='Can view']").parent().removeClass("disabled");
                    $("#list-roles a[data-role='view']").parent().removeClass("disabled");

                    $("form[data-access-type='Can edit']").parent().removeClass("disabled");
                    $("#list-roles a[data-role='edit']").parent().removeClass("disabled");

                    // Remove buttons
                    $(".access-table li.active[data-access-type='Can view']").closest("tr").removeClass("hide-actions");
                    $(".access-table li.active[data-access-type='Can edit']").closest("tr").removeClass("hide-actions");
                }
                else if(privilege == "owner") {
                    // Dropdown menu items
                    $("form[data-access-type='Can view']").parent().removeClass("disabled");
                    $("#list-roles a[data-role='view']").parent().removeClass("disabled");

                    $("form[data-access-type='Can edit']").parent().removeClass("disabled");
                    $("#list-roles a[data-role='edit']").parent().removeClass("disabled");

                    $("form[data-access-type='Is owner']").parent().removeClass("disabled");
                    $("#list-roles a[data-role='owner']").parent().removeClass("disabled");

                    // Remove buttons
                    $(".access-table li.active[data-access-type='Can view']").closest("tr").removeClass("hide-actions");
                    $(".access-table li.active[data-access-type='Can edit']").closest("tr").removeClass("hide-actions");
                    if ($(".access-table li.active[data-access-type='Is owner']").length > 1) {     // At least one owner constrain
                        $(".access-table li.active[data-access-type='Is owner']").closest("tr").removeClass("hide-actions");
                    }
                }
            }

            function change_share_permission_ajax_submit(form_id) {
                $form = $('#' + form_id);
                var datastring = $form.serialize();
                var url = $form.attr('action');
                $form.parent().closest(".user-roles").find("li[data-access-type='" + $form.attr("data-access-type") + "']").addClass("loading");
                setPointerEvents(false);
                $.ajax({
                    type: "POST",
                    url: url,
                    dataType: 'html',
                    data: datastring,
                    success: function (result) {
                        $("#div-invite-people").find(".label-danger").remove(); // Remove previous alerts
                        json_response = JSON.parse(result);

                        if (json_response.status == "success") {
                            $form.parent().closest(".user-roles").find(".dropdown-toggle").text($form.attr("data-access-type"));
                            $form.parent().closest(".user-roles").find(".dropdown-toggle").append(" <span class='caret'></span>");
                            $form.parent().closest(".user-roles").find("li").removeClass("active");

                            $form.parent().closest(".user-roles").find("li[data-access-type='" + $form.attr("data-access-type") + "']").addClass("active");
                            $(".role-dropdown").removeClass("open");
                            $form.parent().closest(".user-roles").find("li").removeClass("loading");

                            updateActionsState(json_response.current_user_privilege);

                            setPointerEvents(true);
                        }
                        else if (json_response.status == "error") {
                            $("#div-invite-people").append("<span class='label label-danger'><strong>Error: </strong>" + json_response.error_msg + "</span>");
                            $form.parent().closest(".user-roles").find("li").removeClass("loading");
                            setPointerEvents(true);
                        }
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        $("#div-invite-people").find(".label-danger").remove(); // Remove previous alerts
                        $("#div-invite-people").append("<span class='label label-danger'><strong>Error: </strong>" + errorThrown + "</span>");
                        setPointerEvents(true);
                    }
                });
            }

            function share_resource_ajax_submit(form_id) {
                if (!$("#id_user-deck > .hilight").length) {
                    return false; // If no user selected, ignore the request
                }
                $form = $('#' + form_id);

                var datastring = $form.serialize();
                var share_with = $("#id_user-deck > .hilight")[0].getAttribute("data-value");
                var access_type = $("#selected_role")[0].getAttribute("data-role");
                var url = $form.attr('action') + access_type + "/" + share_with + "/";
                setPointerEvents(false);
                $.ajax({
                    type: "POST",
                    url: url,
                    dataType: 'html',
                    data: datastring,
                    success: function (result) {
                        $("#div-invite-people").find(".label-danger").remove(); // Remove previous alerts
                        json_response = JSON.parse(result);
                        if (json_response.status == "success") {
                            $(".access-table #row-id-" + share_with).remove(); // Remove previous entry if it exists
                            $(".hilight > span").click(); // Clears the search field

                            // Get a copy of the user row template
                            var rowTemplate = $("#templateRow").clone();

                            // Form actions
                            var unshareUrl = $form.attr('action').replace("share-resource-with-user", "unshare-resource-with-user") + share_with + "/";
                            var viewUrl = $form.attr('action') + "view" + "/" + share_with + "/";
                            var changeUrl = $form.attr('action') + "edit" + "/" + share_with + "/";
                            var ownerUrl = $form.attr('action') + "owner" + "/" + share_with + "/";
                            rowTemplate.find(".remove-user-form").attr('action', unshareUrl);
                            rowTemplate.find(".remove-user-form").attr('id', 'form-remove-user-' + share_with);
                            rowTemplate.find(".remove-user-form .btn-remove-row").attr("onclick", "unshare_resource_ajax_submit('form-remove-user-" + share_with + "')")
                            // Set form urls, ids, and onclick methods
                            rowTemplate.find(".share-form-view").attr('action', viewUrl);
                            rowTemplate.find(".share-form-view").attr("id", "share-view-" + share_with);
                            rowTemplate.find(".share-form-view").attr("data-access-type", "Can view");
                            rowTemplate.find(".share-form-view a").attr("onclick", "change_share_permission_ajax_submit('share-view-" + share_with + "')");
                            rowTemplate.find(".share-form-edit").attr('action', changeUrl);
                            rowTemplate.find(".share-form-edit").attr("id", "share-edit-" + share_with);
                            rowTemplate.find(".share-form-edit").attr("data-access-type", "Can edit");
                            rowTemplate.find(".share-form-edit a").attr("onclick", "change_share_permission_ajax_submit('share-edit-" + share_with + "')");
                            rowTemplate.find(".share-form-owner").attr('action', ownerUrl);
                            rowTemplate.find(".share-form-owner").attr("id", "share-owner-" + share_with);
                            rowTemplate.find(".share-form-owner").attr("data-access-type", "Is owner");
                            rowTemplate.find(".share-form-owner a").attr("onclick", "change_share_permission_ajax_submit('share-owner-" + share_with + "')");
                            if (json_response.name) {
                                rowTemplate.find("span[data-col='name']").text(json_response.name);
                            }
                            else {
                                rowTemplate.find("span[data-col='name']").text(json_response.username);
                            }

                            if (!json_response.is_current_user) {
                                rowTemplate.find(".you-flag").hide();
                            }
                            rowTemplate.find("span[data-col='user-name']").text(json_response.username);

                            if (json_response.profile_pic != "No picture provided") {
                                rowTemplate.find(".profile-pic-thumbnail").attr("style", "background-image: url('" + json_response.profile_pic + "')");
                                rowTemplate.find(".profile-pic-thumbnail").removeClass("user-icon");
                            }

                            if (access_type == "view") {
                                rowTemplate.find("span[data-col='current-access']").text("Can view");
                                rowTemplate.find("span[data-col='current-access']").append(" <span class='caret'></span>");
                                rowTemplate.find(".share-form-view").parent().addClass("active");
                            }
                            else if (access_type == "edit") {
                                rowTemplate.find("span[data-col='current-access']").text("Can edit");
                                rowTemplate.find("span[data-col='current-access']").append(" <span class='caret'></span>");
                                rowTemplate.find(".share-form-edit").parent().addClass("active");
                            }
                            else if (access_type == "owner") {
                                rowTemplate.find("span[data-col='current-access']").text("Is owner");
                                rowTemplate.find("span[data-col='current-access']").append(" <span class='caret'></span>");
                                rowTemplate.find(".share-form-owner").parent().addClass("active");
                            }
                            $(".access-table tbody").append($("<tr id='row-id-" + share_with + "'>" + rowTemplate.html() + "</tr>"));

                            updateActionsState(json_response.current_user_privilege);
                        }
                        else if (json_response.status == "error") {
                            $("#div-invite-people").append("<span class='label label-danger'><strong>Error: </strong>" + json_response.error_msg + "</span>");
                        }
                        setPointerEvents(true);
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown){
                        $("#div-invite-people").find(".label-danger").remove(); // Remove previous alerts
                        $("#div-invite-people").append("<span class='label label-danger'><strong>Error: </strong>" + errorThrown + "</span>");
                        setPointerEvents(true);
                    }

                });
                //don't submit the form
                return false;
            }

            function onRemoveKeyword(event) {
                $($(this).closest(".tags").parent().find(".btn-primary")[0]).show();    // Show save button
                $(event.target).closest(".tag").remove();
                updateKeywords();
                return false;
            }

            function onAddKeyword(event) {
                var keyword = $("#txt-keyword").val();
                keyword = keyword.split(",");

                for (var i = 0; i < keyword.length; i++) {
                    keyword[i] = keyword[i].trim(); // Remove leading and trailing whitespace
                    var exists = false;
                    // Check if the keyword already exists
                    for (var x = 0; x < $("#lst-tags").find(".tag > span").length; x++) {
                        if ($($("#lst-tags").find(".tag > span")[x]).text() == keyword[i]) {
                            exists = true;
                        }
                    }

                    // If does not exist, add it
                    if (!exists && keyword[i] != "") {
                        var li = $("<li class='tag'><span></span></li>");
                        li.find('span').text(keyword[i]);
                        li.append('&nbsp;<a><span class="glyphicon glyphicon-remove-circle icon-remove"></span></a>')
                        $("#lst-tags").append(li);

                        $(".icon-remove").click(onRemoveKeyword);
                        $(this).closest("form-control").find("button").show();
                        updateKeywords();
                    }
                }

                $("#txt-keyword").val("");  // Clear text input
                return false;
            }

            function updateKeywords() {
                var keywords = "";
                var count = $("#lst-tags").find(".tag > span").length;
                for (var x = 0; x < count; x++) {
                    keywords += $($("#lst-tags").find(".tag > span")[x]).text();
                    if (x != count - 1) {
                        keywords += ",";
                    }
                }

                $("#id-subject").find("#id_value").val(keywords);
            }

            function metadata_update_ajax_submit(form_id){
                $alert_success = '<div class="alert alert-success" id="success-alert"> \
                    <button type="button" class="close" data-dismiss="alert">x</button> \
                    <strong>Success! </strong> \
                    Metadata updated.\
                </div>'
                $alert_error = '<div class="alert alert-danger" id="error-alert"> \
                    <button type="button" class="close" data-dismiss="alert">x</button> \
                    <strong>Error! </strong> \
                    Metadata failed to update.\
                </div>'
                $form=$('#' + form_id);
                var datastring = $form.serialize();
                $.ajax({
                    type: "POST",
                    url: $form.attr('action'),
                    dataType: 'html',
                    data: datastring,
                    success: function(result)
                    {
                        /* The div contains now the updated form */
                        //$('#' + form_id).html(result);
                        json_response = JSON.parse(result);
                        if (json_response.status === 'success')
                        {
                            $(document).trigger("submit-success");
                            $form.find("button.btn-primary").hide();
                            if (json_response.hasOwnProperty('element_id')){
                                form_update_action = $form.attr('action');
                                res_short_id = form_update_action.split('/')[3];
                                update_url = "/hsapi/_internal/" + res_short_id + "/" + json_response.element_name +"/" + json_response.element_id + "/update-metadata/"
                                $form.attr('action', update_url);
                            }
                            if (json_response.hasOwnProperty('element_name')){
                                if(json_response.element_name === 'title'){
                                    $res_title = $(".section-header").find("span").first();
                                    field_name_value = $res_title.text();
                                    updated_title = $form.find("#id_value").val();
                                    $res_title.text(updated_title);
                                }
                            }
                            if (json_response.hasOwnProperty('metadata_status')) {
                                if (json_response.metadata_status !== $('#metadata-status').text()) {
                                    $('#metadata-status').text(json_response.metadata_status);
                                    if (json_response.metadata_status == "Sufficient to make public") {
                                        customAlert("<i class='glyphicon glyphicon-flag custom-alert-icon'></i><strong>Metadata Status:</strong> sufficient to make public", 3000);
                                        $("#btn-public").prop("disabled", false);
                                        $("#btn-discoverable").prop("disabled", false);
                                    }
                                }
                            }
                            $('body > .container').append($alert_success);
                            $('#error-alert').each(function(){
                                this.remove();
                            });
                            $(".alert-success").fadeTo(2000, 500).fadeOut(1000, function(){
                                $(document).trigger("submit-success");
                                $(".alert-success").alert('close');
                            });
                        }
                        else{
                            $('body > .container').append($alert_error);
                            $(".alert-danger").fadeTo(3000, 500).fadeOut(1000, function(){
                                $(document).trigger("submit-error");
                                $(".alert-danger").alert('close');
                            });
                        }
                    },
                    error: function(XMLHttpRequest, textStatus, errorThrown)
                    {
                        $('#' + form_id).before($alert_error);
                        $(".alert-error").fadeTo(2000, 500).slideUp(1000, function(){
                            $(".alert-error").alert('close');
                        });
                    }
                });
                //don't submit the form
                return false;
            }

            // Map js
            var coverageMap;
            var allOverlays = [];
            var allShapes = []; // Keeps track of shapes added by text change events
            var drawingManager;
            function initMap() {
                var shapeType;
                if ($("#coverageMap")[0]) {
                    shapeType = $("#coverageMap")[0].getAttribute("data-shape-type");
                }
                coverageMap = new google.maps.Map(document.getElementById('coverageMap'), {
                    color:"#DDD",
                    zoom: 3,
                    streetViewControl: false,
                    center: {lat: 41.850033, lng: -87.6500523}, // Default center
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                        mapTypeIds: [
                            google.maps.MapTypeId.ROADMAP,
                            google.maps.MapTypeId.SATELLITE
                        ]
                    }
                });
                if (!shapeType) {
                    drawingManager = new google.maps.drawing.DrawingManager({
                        drawingControl: true,
                        drawingControlOptions: {
                            position: google.maps.ControlPosition.TOP_CENTER,
                            drawingModes: [
                                google.maps.drawing.OverlayType.MARKER,
                                google.maps.drawing.OverlayType.RECTANGLE
                            ]
                        },
                        rectangleOptions: {
                            editable: true,
                            draggable: true
                        }
                    });
                    drawingManager.setMap(coverageMap);
                    google.maps.event.addListener(drawingManager, 'rectanglecomplete', function (rectangle) {
                        var coordinates = (rectangle.getBounds());
                        processDrawing(coordinates, "rectangle");
                        rectangle.addListener('bounds_changed', function () {
                            var coordinates = (rectangle.getBounds());
                            processDrawing(coordinates, "rectangle");
                        });
                    });
                    google.maps.event.addListener(drawingManager, 'markercomplete', function (marker) {
                        var coordinates = (marker.getPosition());
                        // Set onClick event for recenter button
                        processDrawing(coordinates, "marker");
                    });
                    google.maps.event.addListener(drawingManager, 'overlaycomplete', function (e) {
                        allOverlays.push(e);
                    });
                }
            }
            // Draw marker on text change
            $("#id_east").bind('input', drawMarkerOnTextChange);
            $("#id_north").bind('input', drawMarkerOnTextChange);
            function drawMarkerOnTextChange(){
                var myLatLng = {lat: parseFloat($("#id_north").val()), lng: parseFloat($("#id_east").val())};
                // Delete previous drawings
                deleteAllShapes();
                deleteAllOverlays();
                // Bounds validation
                var badInput = false;
                // Lat
                if (myLatLng.lat > 90 || myLatLng.lat < -90) {
                    $("#id_north").addClass("invalid-input");
                    badInput = true;
                }
                else {
                    $("#id_north").removeClass("invalid-input");
                }
                if (myLatLng.lng > 180 || myLatLng.lng < -180) {
                    $("#id_east").addClass("invalid-input");
                    badInput = true;
                }
                else {
                    $("#id_east").removeClass("invalid-input");
                }
                if (badInput || isNaN(myLatLng.lat) || isNaN(myLatLng.lng)) {
                    return;
                }
                // Define the rectangle and set its editable property to true.
                var marker = new google.maps.Marker({
                    position: myLatLng,
                    map: coverageMap
                });
                // Center map at new market
                coverageMap.setCenter(marker.getPosition());
                // Set onClick event for recenter button
                $("#resetZoomBtn").click(function(){
                    coverageMap.setCenter(marker.getPosition());
                });
                allShapes.push(marker);
            }
            // Draw rectangle on text change
            $("#id_northlimit").bind('input', drawRectangleOnTextChange);
            $("#id_eastlimit").bind('input', drawRectangleOnTextChange);
            $("#id_southlimit").bind('input', drawRectangleOnTextChange);
            $("#id_westlimit").bind('input', drawRectangleOnTextChange);
            function drawRectangleOnTextChange(){
                var bounds = {
                    north: parseFloat($("#id_northlimit").val()),
                    south: parseFloat($("#id_southlimit").val()),
                    east: parseFloat($("#id_eastlimit").val()),
                    west: parseFloat($("#id_westlimit").val())
                };
                // Delete previous drawings
                deleteAllShapes();
                deleteAllOverlays();
                // Bounds validation
                var badInput = false;
                // North
                if (bounds.north > 90 || bounds.north < -90) {
                    $("#id_northlimit").addClass("invalid-input");
                    badInput = true;
                }
                else {
                    $("#id_northlimit").removeClass("invalid-input");
                }
                // East
                if (bounds.east > 180 || bounds.east < -180) {
                    badInput = true;
                    $("#id_eastlimit").addClass("invalid-input");
                }
                else {
                    $("#id_eastlimit").removeClass("invalid-input");
                }
                // South
                if (bounds.south < -90 || bounds.south > 90) {
                    badInput = true;
                    $("#id_southlimit").addClass("invalid-input");
                }
                else {
                    $("#id_southlimit").removeClass("invalid-input");
                }
                // West
                if (bounds.west < -180 || bounds.west > 180) {
                    badInput = true;
                    $("#id_westlimit").addClass("invalid-input");
                }
                else {
                    $("#id_westlimit").removeClass("invalid-input");
                }
                if (badInput || isNaN(bounds.north) || isNaN(bounds.south) || isNaN(bounds.east) || isNaN(bounds.west)) {
                    return;
                }
                // Define the rectangle and set its editable property to true.
                var rectangle = new google.maps.Rectangle({
                    bounds: bounds,
                    editable: true,
                    draggable: true
                });
                rectangle.setMap(coverageMap);
                rectangle.addListener('bounds_changed', function () {
                    var coordinates = (rectangle.getBounds());
                    processDrawing(coordinates, "rectangle");
                });
                zoomCoverageMap(bounds);
                $("#resetZoomBtn").click(function(){
                    zoomCoverageMap(bounds);
                });
                allShapes.push(rectangle);
            }
            function processDrawing (coordinates, shape) {
                // Delete previous drawings
                if (allOverlays.length > 1){
                    for (var i = 1; i < allOverlays.length; i++){
                        allOverlays[i-1].overlay.setMap(null);
                    }
                    allOverlays.shift();
                }
                if (allOverlays.length > 0) {
                    deleteAllShapes();
                }
                // Show save changes button
                $("#coverage-spatial").find(".btn-primary").show();
                if (shape == "rectangle"){
                    document.getElementById("id_type_1").checked = true;
                    $("#div_id_north").hide();
                    $("#div_id_east").hide();
                    $("#div_id_elevation").hide();
                    $("#div_id_northlimit").show();
                    $("#div_id_eastlimit").show();
                    $("#div_id_southlimit").show();
                    $("#div_id_westlimit").show();
                    $("#div_id_uplimit").show();
                    $("#div_id_downlimit").show();
                    var bounds = {
                        north: parseFloat(coordinates.getNorthEast().lat()),
                        south: parseFloat(coordinates.getSouthWest().lat()),
                        east: parseFloat(coordinates.getNorthEast().lng()),
                        west: parseFloat(coordinates.getSouthWest().lng())
                    };
                    // Update fields
                    $("#id_northlimit").val(bounds.north);
                    $("#id_eastlimit").val(bounds.east);
                    $("#id_southlimit").val(bounds.south);
                    $("#id_westlimit").val(bounds.west);
                    // Remove red borders
                    $("#id_northlimit").removeClass("invalid-input");
                    $("#id_eastlimit").removeClass("invalid-input");
                    $("#id_southlimit").removeClass("invalid-input");
                    $("#id_westlimit").removeClass("invalid-input");
                    $("#resetZoomBtn").click(function(){
                        zoomCoverageMap(bounds);
                    });
                }
                else {
                    document.getElementById("id_type_2").checked = true;
                    $("#div_id_north").show();
                    $("#div_id_east").show();
                    $("#div_id_elevation").show();
                    $("#div_id_northlimit").hide();
                    $("#div_id_eastlimit").hide();
                    $("#div_id_southlimit").hide();
                    $("#div_id_westlimit").hide();
                    $("#div_id_uplimit").hide();
                    $("#div_id_downlimit").hide();
                    $("#id_east").val(coordinates.lng());
                    $("#id_north").val(coordinates.lat());
                    // Remove red borders
                    $("#id_east").removeClass("invalid-input");
                    $("#id_north").removeClass("invalid-input");
                    $("#resetZoomBtn").click(function () {
                        coverageMap.setCenter(coordinates);
                    });
                }
            }
            function deleteAllOverlays() {
                for (var i = 0; i < allOverlays.length; i++) {
                    allOverlays[i].overlay.setMap(null);
                }
                allOverlays = [];
            }
            function deleteAllShapes(){
                for (var i = 0; i < allShapes.length; i++) {
                    allShapes[i].setMap(null);
                }
                allShapes = [];
            }
            function zoomCoverageMap(bounds) {
                // Zoom in on the shape
                var GLOBE_WIDTH = 256; // a constant in Google maps projection
                var c_west = bounds.west * 8;    // Zooms out on the shape a little so that we can see it
                var c_east = bounds.east * 8;
                var angle = c_east - c_west;
                var pixelWidth = parseInt($("#coverageMap").width());
                if (angle < 0) {
                    angle += 360;
                }
                var zoom = Math.round(Math.log(pixelWidth * 360 / angle / GLOBE_WIDTH) / Math.LN2);
                if (!isNaN(zoom)){
                    coverageMap.setZoom(Math.max(3, zoom)); // Allow minumum zoom level of 3
                }
                else{
                    return;
                }
                // Center map at new rectangle
                var latCenter = (bounds.north + bounds.south) / 2;
                var lngCenter = (bounds.west + bounds.east) / 2;
                coverageMap.setCenter(new google.maps.LatLng(latCenter, lngCenter));
            }

            function customAlert(msg, duration) {
                var el = document.createElement("div");
                var top = 200;
                var left = ($(window).width() / 2) - 150;
                var style = "top:" + top + "px;left:" + left + "px";
                el.setAttribute("style", style);
                el.setAttribute("class", "custom-alert");
                el.innerHTML = msg;
                setTimeout(function () {
                    $(el).fadeOut(300, function () {
                        $(this).remove();
                    });
                }, duration);
                document.body.appendChild(el);
                $(el).hide().fadeIn(400);
            }

            $(document).ready(function () {
                $("#citation-text").on("click", function (e) {
                    // document.selection logic is added in for IE 8 and lower
                    if (document.selection) {
                        document.selection.empty();
                        var range = document.body.createTextRange();
                        range.moveToElementText(this);
                        range.select();
                    }
                    else if (window.getSelection) {
                        // Get the selection object
                        var selection = window.getSelection();
                        selection.removeAllRanges();
                        var range = document.createRange();
                        range.selectNode(this);
                        selection.addRange(range);
                    }
                });

                $("#btn-shareable").on("change", shareable_ajax_submit);
                $("#btnMyResources").click(label_ajax_submit);
                $("#coverageTabBtn").click(function () {
                    setTimeout( function(){
                        // Call resize to re-render the map since it wasn't visible during load.
                        google.maps.event.trigger(coverageMap, "resize");
                        // This field is populated if the page is in view mode
                        var shapeType = $("#coverageMap")[0].getAttribute("data-shape-type");
                        // Center the map
                        if (shapeType) {
                            deleteAllShapes();
                            if (shapeType == "point") {
                                var myLatLng = {
                                    lat: parseFloat($("#cov_north").text()),
                                    lng: parseFloat($("#cov_east").text())
                                };
                                if (!myLatLng.lat || !myLatLng.lng) {
                                    return;
                                }
                                // Define the rectangle and set its editable property to true.
                                var marker = new google.maps.Marker({
                                    position: myLatLng,
                                    map: coverageMap
                                });
                                allShapes.push(marker);
                                // Center map at new market
                                coverageMap.setCenter(marker.getPosition());
                                $("#resetZoomBtn").click(function () {
                                    coverageMap.setCenter(marker.getPosition());
                                });
                            }
                            else if (shapeType == "box") {
                                var bounds = {
                                    north: parseFloat($("#cov_northlimit").text()),
                                    south: parseFloat($("#cov_southlimit").text()),
                                    east: parseFloat($("#cov_eastlimit").text()),
                                    west: parseFloat($("#cov_westlimit").text())
                                };
                                if (!bounds.north || !bounds.south || !bounds.east || !bounds.west) {
                                    return;
                                }
                                // Define the rectangle and set its editable property to true.
                                var rectangle = new google.maps.Rectangle({
                                    bounds: bounds,
                                    editable: false,
                                    draggable: false
                                });
                                rectangle.setMap(coverageMap);
                                allShapes.push(rectangle);
                                zoomCoverageMap(bounds);
                                $("#resetZoomBtn").click(function () {
                                    zoomCoverageMap(bounds);
                                });
                            }
                        }
                        else {
                            if ($("#id_type_1").is(":checked")) {
                                drawRectangleOnTextChange();
                            }
                            else {
                                drawMarkerOnTextChange();
                            }
                        }
                    }, 200 );   // Gives container enough time to be rendered before the map is rendered.
                });
                $("#id-coverage-spatial input:radio").change(function () {
                    if ($(this).val() == "point") {
                        $("#div_id_north").show();
                        $("#div_id_east").show();
                        $("#div_id_elevation").show();
                        $("#div_id_northlimit").hide();
                        $("#div_id_eastlimit").hide();
                        $("#div_id_southlimit").hide();
                        $("#div_id_westlimit").hide();
                        $("#div_id_uplimit").hide();
                        $("#div_id_downlimit").hide();
                        drawMarkerOnTextChange();
                        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
                    }
                    else {
                        $("#div_id_north").hide();
                        $("#div_id_east").hide();
                        $("#div_id_elevation").hide();
                        $("#div_id_northlimit").show();
                        $("#div_id_eastlimit").show();
                        $("#div_id_southlimit").show();
                        $("#div_id_westlimit").show();
                        $("#div_id_uplimit").show();
                        $("#div_id_downlimit").show();
                        drawRectangleOnTextChange();
                        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.RECTANGLE);
                    }
                    // Show save changes button
                    $("#coverage-spatial").find(".btn-primary").show();
                });
                if (sessionStorage.signininfo) {
                    $("#sign-in-info").text(sessionStorage.signininfo);
                    $("#btn-select-irods-file").show();
                }

                // Apply theme to comment's submit button
                $("#comment input[type='submit']").removeClass()
                $("#comment input[type='submit']").addClass("btn btn-default");

                $(".list-separator").parent().hover(function(){
                    $(this).css("text-decoration", "none");
                    $(this).css("pointer-events", "none");
                });

                var keywordString = "{% for k, v in subjects_form.initial.iteritems  %}{{ v }}{% endfor %}";
                $("#id-subject").find("#id_value").val(keywordString);

                // Populate keywords field
                var keywords = keywordString.split(",");
                $("#lst-tags").empty();
                for (var i = 0; i < keywords.length; i++) {
                    if (keywords[i] != "") {
                        var li = $("<li class='tag'><span></span></li>");
                        li.find('span').text(keywords[i]);
                        li.append('&nbsp;<a><span class="glyphicon glyphicon-remove-circle icon-remove"></span></a>')
                        $("#lst-tags").append(li);
                    }
                }

                $(".icon-remove").click(onRemoveKeyword);
                $("#btn-add-keyword").click(onAddKeyword);
                $("#txt-keyword").keyup(function (e) {
                    e.which = e.which || e.keyCode;
                    if (e.which == 13) {
                        onAddKeyword();
                    }
                });

                $("#list-roles a").click(onRoleSelect);
                $("#id_user-autocomplete").attr("placeholder", "Search by name or username")

                // hide add file button if necessary
                var file_count = $("#file-count").attr('value');
                //set allowed file types
                var file_types = $("#supported-file-types").attr('value');
                if (file_types != ".*") {
                    var display_file_types = file_types.substring(0, file_types.length - 2) + ').';
                    $("#file-types").text("Only the listed file types can be uploaded: " + display_file_types);
                    $("#file-types-irods").text("Only the listed file types can be uploaded: " + display_file_types);
                }
                else {
                    $("#file-types").text("Any file type can be uploaded.");
                    $("#file-types-irods").text("Any file type can be uploaded.");
                }
                // set if multiple file can be uploaded
                var allow_multiple_file_upload = $("#allow-multiple-file-upload").attr('value');
                if (allow_multiple_file_upload === "True") {
                    $("#file-multiple").text("Multiple file upload is allowed.");
                    $("#file-multiple-irods").text("Multiple file upload is allowed.");
                    $("#btn-add-file").attr('multiple', 'multiple');
                    $("#add-file-input").attr('multiple', 'multiple');
                }
                else {
                    $("#file-multiple").text("Only one file can be uploaded.");
                    $("#file-multiple-irods").text("Only one file can be uploaded.");
                    $("#btn-add-file").removeAttr('multiple');
                    $("#add-file-input").removeAttr('multiple');
                    if (file_count > 0) {
                        $("#btn-add-file").hide();
                        $("#log-into-irods").hide();
                        $("#sign-in-info").hide();
                        $("#btn-select-irods-file").hide();
                    }
                }
                // hide add file button if file upload is not allowed for the resource type
                if (file_types == "()") {
                    $("#btn-add-file").hide();
                    $("#log-into-irods").hide();
                    $("#sign-in-info").hide();
                    $("#btn-select-irods-file").hide();
                }

                // file upload validation when file is selected for upload
                $('#add-file-input').on('change', function () {
                    var file_types = $("#supported-file-types").attr('value');
                    if (file_types != ".*") {
                        file_types = file_types.substring(1, file_types.length - 1).split(",");
                    }
                    else {
                        $("#file-types").text("Any file type can be uploaded.");
                        return;
                    }
                    var fileList = this.files || []
                    var ext = ".*";
                    for (var i = 0; i < fileList.length; i++) {
                        ext = fileList[i].name.match(/\.([^\.]+)$/)[1];
                        ext = "'." + ext.toLowerCase() + "'";
                        var ext_found = false;
                        if (ext === file_types) {
                            ext_found = true;
                        }
                        else {
                            var index;
                            for (index = 0; index < file_types.length; index++) {
                                if (ext === file_types[index].trim()) {
                                    ext_found = true;
                                    break;
                                }
                            }
                        }
                        if (!ext_found) {
                            //remove user selected files
                            this.value = '';
                            var err_msg = 'Invalid file type: ' + ext;
                            $('#file-type-error').text(err_msg);
                            //alert('Invalid file type:' + ext)
                        }
                        else {
                            $('#file-type-error').text('');
                        }
                    }
                });
                if ($("#id_type_1").is(':checked')) { //box type coverage
                    $("#div_id_north").hide();
                    $("#div_id_east").hide();
                    $("#div_id_elevation").hide();
                }
                if ($("#id_type_2").is(':checked')) { // point type coverage
                    $("#div_id_northlimit").hide();
                    $("#div_id_eastlimit").hide();
                    $("#div_id_southlimit").hide();
                    $("#div_id_westlimit").hide();
                    $("#div_id_uplimit").hide();
                    $("#div_id_downlimit").hide();
                }
                if ($("input:button[value='Delete creator']").length == 1) {
                    $("input:button[value='Delete creator']").first().hide();
                }
                // disable all save changes button on load
                $("form").each(function () {
                    $save_button = $(this).find("button").first();
                    if ($save_button.text() === "Save changes") {
                        $save_button.hide();
                    }
                });

                $("#select_license").on('change', function () {
                    var value = this.value;
                    if (value === "other") {
                        $(this).closest("form").find("#id_statement").first().text("");
                        $(this).closest("form").find("#id_url").first().attr('value', "");
                        $(this).closest("form").find("#id_statement").first().attr('readonly', false);
                        $(this).closest("form").find("#id_url").first().attr('readonly', false);
                        $("#img-badge").first().hide();
                    }
                    else {
                        var text = $(this).find('option:selected').text();
                        text = "This resource is shared under the " + text + ".";
                        $(this).closest("form").find("#id_statement").first().text(text);
                        $(this).closest("form").find("#id_url").first().attr('value', value);
                        $(this).closest("form").find("#id_statement").first().attr('readonly', true);
                        $(this).closest("form").find("#id_url").first().attr('readonly', true);
                        $("#img-badge").first().show();
                        if (text == "This resource is shared under the Creative Commons Attribution CC BY.") {
                            $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY.png");
                            $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY");
                        }
                        else if (text == "This resource is shared under the Creative Commons Attribution-ShareAlike CC BY-SA.") {
                            $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-SA.png");
                            $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-SA");
                        }
                        else if (text == "This resource is shared under the Creative Commons Attribution-NoDerivs CC BY-ND.") {
                            $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-ND.png");
                            $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-ND");
                        }
                        else if (text == "This resource is shared under the Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA.") {
                            $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-NC-SA.png");
                            $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-NC-SA");
                        }
                        else if (text == "This resource is shared under the Creative Commons Attribution-NoCommercial CC BY-NC.") {
                            $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-NC.png");
                            $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-NC");
                        }
                        else if (text == "This resource is shared under the Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND.") {
                            $(this).closest("form").find("#img-badge").first().attr('src', "{{ STATIC_URL }}img/cc-badges/CC-BY-NC-ND.png");
                            $(this).closest("form").find("#img-badge").first().attr('alt', "CC-BY-NC-ND");
                        }
                    }
                });
                // set the selected license in the select license dropdown
                var value_exists = false;
                $("#select_license option").each(function () {
                    if (this.value == $("#id_url").attr('value')) {
                        $("#select_license").val($("#id_url").attr('value'));
                        value_exists = true;
                        return;
                    }
                })
                if (value_exists == false) {
                    // set the selected license type to 'other'
                    $("#select_license").val('other');
                    if ($("#select_license").attr('readonly') == undefined) {
                        $("#select_license").closest("form").find("#id_statement").first().attr('readonly', false);
                        $("#select_license").closest("form").find("#id_url").first().attr('readonly', false);
                        $("#img-badge").first().hide();
                    }
                    else {
                        $("#select_license").attr('style', "background-color:white;");
                        $("#select_license").closest("form").find("#id_statement").first().attr('readonly', true);
                        $("#select_license").closest("form").find("#id_url").first().attr('readonly', true);
                    }
                }
                // show "Save changes" button when form editing starts
                $(".form-control").each(function () {
                    $(this).on('input', function (e) {
                        //$(this).css('border-color', 'gray');
                        $(this).closest("form").find("button").show();
                    });
                    $(this).on('change', function (e) {
                        //$(this).css('border-color', 'gray');
                        $(this).closest("form").find("button").show();
                    });
                });
                $(".dateinput").each(function () {
                    $(this).datepicker({
                        format: 'mm-dd-yyyy',
                        yearRange: "-1000:+1000",
                        changeMonth: true,
                        changeYear: true
                    });
                    $(this).on('change', function () {
                        $(this).closest("form").find("button").show();
                    });
                });
            });
        </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?libraries=drawing&callback=initMap"></script>
        {% if relevant_tools %}
            <script type="text/javascript" src="{{ STATIC_URL }}js/toolresource.js"></script>
        {% endif %}
    {% endblock %}


    {% block extra_css %}
        {{ block.super }}
        {% if relevant_tools %}
            <link href="{{ STATIC_URL }}css/toolresource.css" rel="stylesheet"/>
        {% endif %}
    {%  endblock %}
