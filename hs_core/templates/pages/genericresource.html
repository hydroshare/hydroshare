{% extends 'pages/page.html' %}

{% load geoanalytics_tags ratings_tags pages_tags mezzanine_tags comments_tags keyword_tags hydroshare_tags crispy_forms_tags inplace_edit %}

{% block main %}

    {% with page.get_content_model as cm %}
        {% keywords_for page as kws %}
        {% set_page_permissions page %}
        <input type="hidden" id="supported-file-types" value="{{ cm.get_supported_upload_file_types }}">
        <input type="hidden" id="allow-multiple-file-upload" value={{ cm.can_have_multiple_files }}>
        <input type="hidden" id="file-count" value={{ cm.files.all.count }}>

        {% block error %}
            {%  if file_validation_error %}
                <div class="alert alert-danger alert-dismissible" role="alert">
                      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <strong>Uploaded File Validation Error:{{ file_validation_error }}</strong>
                 </div>
            {%  endif %}
        {% endblock %}
{#        ======= Missing fields notification =======#}

            {% if not metadata_form and page.perms.change %}
                {% if missing_metadata_elements or title|stringformat:"s" == "Untitled resource" %}
                    <div class="alert alert-success alert-dismissible" role="alert">
                      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                      <strong>Congratulations!</strong> Now that your resource has been created please take some time to add data for:
                        <ul>
                        {% for element in missing_metadata_elements %}
                            <li>{{ element }}</li>
                        {% endfor %}
                        {% if title|stringformat:"s" == "Untitled resource" %}
                           <li>Title: needs to be changed</li>
                        {% endif %}
                    </ul>
                    <form class="inline" action="{{ cm.get_absolute_url }}" method="post">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit"/>
                        <button id="alert-edit-button" type="submit" data-toggle="tooltip" data-placement="auto"
                                title="Edit this resource" class="btn-edit"> Edit this resource
                        </button>
                    </form>
                 </div>
                {% endif %}
            {% endif %}

            {#        ======= Title =======#}
            {% if not metadata_form %}
            <h2>{{ title }}</h2>
            {% else %}
            <form action="/hsapi/_internal/{{ cm.short_id }}/title/{{ cm.metadata.title.id }}/update-metadata/"
                  id="id-title"
                  method="post">
                {% csrf_token %}
                <fieldset>
                    <div id="div_id_value" class="control-group">
                        <div class="controls"><input class="form-control input-sm textinput textInput"
                                                     id="txt-title"
                                                     maxlength="300" name="value" type="text"
                                                     value="{{ cm.metadata.title }}"></div>
                    </div>
                    <div>
                        <button type="button" class="btn btn-primary pull-right"
                                onclick="metadata_update_ajax_submit('id-title'); return false;"
                                style="display: none;">
                            Save changes
                        </button>
                    </div>
                </fieldset>
            </form>
            {% endif %}
            {#        ======= Top right buttons =======#}
            {% if not metadata_form %}
                {% if page.perms.change %}
                    <div class="lined-wrapper">
                    <div class="custom-btn-toolbar">
                        <form class="inline" action="{{ cm.get_absolute_url }}" method="post">
                            {% csrf_token %}
                            {% if page.perms.delete %}
                            <a id="delete" data-toggle="modal" data-target="#delete-resource-dialog">
                            <span data-toggle="tooltip" data-placement="auto" title="Delete this resource"
                                  class="glyphicon glyphicon-trash icon-button btn-remove"></span>
                            </a>
                            {% endif %}
                            <input name="resource-mode" type="hidden" value="edit"/>
                            <button id="edit-metadata" type="submit" data-toggle="tooltip" data-placement="auto"
                                    title="Edit this resource" class="glyphicon glyphicon-pencil icon-button btn-edit"></button>
                        </form>
                    </div>
                    </div>
                {% endif %}
            {% else %}
                <div class="lined-wrapper">
                <div class="custom-btn-toolbar">
                    <a href="{{ cm.get_absolute_url }}">
                        <span data-toggle="tooltip" data-placement="auto" title="View resource"
                              class="glyphicon glyphicon-circle-arrow-left icon-button btn-edit"></span>
                    </a>
                </div>
                </div>
            {% endif %}

            {#        ======= Authors =======#}
            {% if not metadata_form %}
            <div class="info-group">
                <table>
                    <tr><th>Authors:</th><td id="authors">
                        {% for cr in creators %}
                            {% if cr.description %}<a href="{{ cr.description }}">{{ cr.name }}</a><span class="comma">,&nbsp;</span>
                            {% else %}<span>{{ cr.name }}</span><span class="comma">,&nbsp;</span>{% endif %}
                        {% endfor %}
                    </td></tr>
                    <tr><th>Owners:</th><td>
                        {% for u in owners %}
                            <span>{{ u|contact|safe }}</span>&nbsp;&nbsp;
                        {% endfor %}
                    </td></tr>
                    <tr><th>Resource type:</th><td>{{ cm|resource_type }}</td></tr>
                    <tr><th>Created:</th><td>{{ cm.created }}</td></tr>
                    <tr><th>Last updated:</th><td> {{ cm.updated }} by {%  if cm.last_changed_by %}{{ cm.last_changed_by|contact|safe }}{% endif %}</td></tr>
                </table>
            </div>
            {% else %}
                <div class="info-group">
                    <table>
                        <tr>
                            <th>Authors:</th>
                            <td><span id="authors">
                                    {% for author in creator_formset.initial %}
                                        {% if author.description %}<a href="{{ author.description }}">
                                            {{ author.name }}</a><span class="comma">,&nbsp</span>
                                            {% else %}<span>{{ author.name }}</span>
                                            <span class="comma">,&nbsp</span>{% endif %}
                                    {% endfor %}
                                </span>
                            </td>
                        </tr>
                        <tr><th>Owners:</th><td>
                            {% for u in owners %}
                                <span>{{ u|contact|safe }}</span>&nbsp;&nbsp;
                            {% endfor %}
                        </td></tr>
                        </tr><tr><th>Resource type:</th><td>{{ cm|resource_type }}</td></tr>
                        <tr><th>Created:</th><td>{{ cm.created }}</td></tr>
                        <tr><th>Last updated:</th><td> {{ cm.updated }} by {%  if cm.last_changed_by %}{{ cm.last_changed_by|contact|safe }}{% endif %}</td></tr>
                    </table>
                </div>
            {% endif %}

            {#        ======= Abstract =======#}
            {% if not metadata_form %}
                {% if abstract %}
                    <div class="content-block">
                        <h3>Abstract</h3>
                        <span class="abstract">{{ abstract }}</span>
                    </div>
                {% endif %}
            {% else %}
                <h3>Abstract</h3>
                {% if cm.metadata.description %}
                <form action="/hsapi/_internal/{{ cm.short_id }}/description/{{ cm.metadata.description.id }}/update-metadata/"
                      id="id-description" method="post">
                    {% csrf_token %}
                    <fieldset>
                        <div id="div_id_abstract" class="control-group">
                            <div class="controls"><textarea class="form-control input-sm textarea" cols="40"
                                                            id="id_abstract" name="abstract"
                                                            rows="10">{{ cm.metadata.description }}</textarea></div>
                        </div>
                        <div style="margin-top:10px">
                            <button type="button" class="btn btn-primary pull-right"
                                    onclick="metadata_update_ajax_submit('id-description'); return false;"
                                    style="display: none;">Save changes
                            </button>
                        </div>
                    </fieldset>
                </form>
                {% else %}
                <form action="/hsapi/_internal/{{ cm.short_id }}/description/add-metadata/"
                      id="id-description" method="post">
                    {% csrf_token %}
                    <fieldset>
                        <div id="div_id_abstract" class="control-group">
                            <div class="controls"><textarea class="form-control input-sm textarea" cols="40"
                                                            id="id_abstract" name="abstract" rows="10"></textarea></div>
                        </div>
                        <div style="margin-top:10px">
                            <button type="button" class="btn btn-primary pull-right"
                                    onclick="metadata_update_ajax_submit('id-description'); return false;"
                                    style="display: none;">Save changes
                            </button>
                        </div>
                    </fieldset>
                </form>
                {% endif %}
            {% endif %}

            {#        ======= Citation =======#}
            <div class="content-block">
                <h3>How to cite</h3>
                <span id="citation-text">{{ citation }}</span>
            </div>

            {#        ======= Sharing =======#}
            <div class="content-block">
                <h3>Sharing</h3>

                <div id="sharing-status">
                    <span class="pull-left">Sharing status:</span>
                    {% if page.perms.change %}
                        <form id="form-sharing" class="pull-left"
                              action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/" method="POST">
                            {% csrf_token %}
                            {% if cm.public %}
                                <input name="t" type="hidden" value="make_private"/>
                                <div class="btn-group" role="group" aria-label="...">
                                    <button id="btn-public" data-toggle="tooltip" data-placement="auto"
                                            title='Can be viewed and downloaded by anyone.' type="button"
                                            class="btn btn-default active">Public
                                    </button>
                                    <button id="btn-private" data-toggle="tooltip" data-placement="auto"
                                            title='Can be viewed and downloaded only by designated users or research groups.'
                                            type="submit" class="btn btn-default">Private
                                    </button>
                                </div>
                            {% else %}
                                <input name="t" type="hidden" value="make_public"/>
                                <div class="btn-group" role="group" aria-label="...">
                                    <button id="btn-public" data-toggle="tooltip" data-placement="auto"
                                            title='Can be viewed and downloaded by anyone.' type="submit"
                                            class="btn btn-default">Public
                                    </button>
                                    <button id="btn-private" data-toggle="tooltip" data-placement="auto"
                                            title='Can be viewed and downloaded only by designated users or research groups.'
                                            type="button" class="btn btn-default active">Private
                                    </button>
                                </div>
                            {% endif %}
                        </form>
                    {% else %}
                        {% if cm.public %}
                            <strong>&nbspPublic</strong>
                        {% else %}
                            <strong>&nbspPrivate</strong>
                        {% endif %}
                    {% endif %}
                </div>
                {% if not metadata_form %}
                {% if rights.statement or rights.url %}
                    <div id="rights">
                        {% if rights.statement %}
                            <span class="rights-text">{{ rights.statement }} </span>
                        {% endif %}

                        {% if rights.url %}
                            <span class="rights-url"><a href="{{ rights.url }}">&nbsp{{ rights.url }}</a></span>
                        {% endif %}
                    </div>
                    {% if rights.statement == "This resource is shared under the Creative Commons Attribution CC BY." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY.png" alt="CC-BY"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-ShareAlike CC BY-SA." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-SA.png" alt="CC-BY-SA"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoDerivs CC BY-ND." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-ND.png" alt="CC-BY-ND"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-SA.png" alt="CC-BY-NC-SA"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial CC BY-NC." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC.png" alt="CC-BY-NC"/>
                    {% elif rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND." %}
                        <img class="cc-image" src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-ND.png" alt="CC-BY-NC-ND"/>
                    {% endif %}
                {% endif %}
                {% else %}
                    <form action="/hsapi/_internal/{{ cm.short_id }}/rights/{{ cm.metadata.rights.id }}/update-metadata/"#}
                          id="id-rights" method="post">
                        {% csrf_token %}
                        <fieldset>
                            <p></p>
                            <div class="col-md-6">
                                <label class="control-label" for="select_license"> Select a license </label>
                                <span data-toggle="tooltip" data-placement="auto" title='Information about rights held in and over the HydroShare resource. (e.g. Creative commons Attribution License)'
                                      class="glyphicon glyphicon-info-sign"></span>
                                <select id="select_license" class="form-control">
                                    <option value="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution CC BY</option>
                                    <option value="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike CC BY-SA</option>
                                    <option value="http://creativecommons.org/licenses/by-nd/4.0/">Creative Commons Attribution-NoDerivs CC BY-ND</option>
                                    <option value="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA</option>
                                    <option value="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NoCommercial CC BY-NC</option>
                                    <option value="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <div id="div_id_statement" class="control-group">
                                    <label for="id_statement" class="control-label"> Statement</label>
                                    <div class="controls">
                                        <textarea class="form-control input-sm textarea" cols="40"
                                                                    id="id_statement" name="statement" readonly="True"
                                                                    rows="3" style="background-color:white;">{{ cm.metadata.rights.statement }}</textarea>
                                    </div>
                                </div>
                                <div id="div_id_url" class="control-group">
                                    <label for="id_url" class="control-label">Url</label>

                                    <div class="controls">
                                        <input class="form-control input-sm urlinput" id="id_url"
                                                 maxlength="200" name="url" readonly="True"
                                                 style="background-color:white;" type="url"
                                                 value={{ cm.metadata.rights.url }}>
                                    </div>
                                </div>
                                <img id="img-badge" class="cc-image"
                                {% if cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution CC BY." %}
                                    src="{{ STATIC_URL }}img/cc-badges/CC-BY.png" alt="CC-BY"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-ShareAlike CC BY-SA." %}
                                    src="{{ STATIC_URL }}img/cc-badges/CC-BY-SA.png" alt="CC-BY-SA"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-NoDerivs CC BY-ND." %}
                                    src="{{ STATIC_URL }}img/cc-badges/CC-BY-ND.png" alt="CC-BY-ND"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA." %}
                                    src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-SA.png" alt="CC-BY-NC-SA"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial CC BY-NC." %}
                                   src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC.png" alt="CC-BY-NC"
                                {% elif cm.metadata.rights.statement == "This resource is shared under the Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND." %}
                                    src="{{ STATIC_URL }}img/cc-badges/CC-BY-NC-ND.png" alt="CC-BY-NC-ND"
                                {% endif %}
                                />
                            </div>

                            <div style="margin-top:10px">
                                <button type="button" class="btn btn-primary pull-right"
                                        onclick="metadata_update_ajax_submit('id-rights'); return false;"
                                        style="display: none;">Save changes
                                </button>
                            </div>
                        </fieldset>
                    </form>
                {% endif %}
                <div id="permission-panel">
                {% if user == cm.user %}
                    <p>You are the owner of this resource.</p>
                {% elif is_edit_user %}
                    <p>You have been given specific permission to edit this resource.</p>
                {% elif in_edit_group %}
                    Your research group(s) have been given specific permission to edit this resource.</p>
                {% elif is_view_user %}
                    <p>You have been given specific permission to view this resource.</p>
                {% elif in_view_group %}
                    <p>Your research group(s) have been given specific permission to view this resource.</p>
                {% endif %}

                {% if page.perms.change %}

                    <div class="panel panel-default panel-faq">
                    <div class="panel-heading">
                        <a data-toggle="collapse" data-parent="#accordion-cat-1" href="#faq-cat-1-sub-1">
                            <h4 class="panel-title">
                                Manage access
                                <span class="pull-right"><i class="glyphicon glyphicon-plus"></i></span>
                            </h4>
                        </a>
                    </div>
                    <div id="faq-cat-1-sub-1" class="panel-collapse collapse" style="height: auto;">
                        <div class="panel-body">
                            <div class="col-md-4">
                                <div class="custom-well">
                                    <h5 class="access-panel-title"><strong>Users with full read/write permissions on this resource</strong></h5>

                                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST">
                                        {% csrf_token %}
                                        <select name="designees" id="owners-select" multiple class="form-control"
                                                size="{{ owners.count }}">
                                            {% for u in owners %}
                                                <option value="{{ u.pk }}" selected>{{ u|best_name }}
                                                    ({{ u.username }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <input name="t" value="owners" type="hidden"/>
                                        <button type="submit"
                                                class="btn btn-update-list pull-left btn-default glyphicon"><span
                                                class="button-label">&nbspUpdate access list</span></button>
                                                <span data-toggle="tooltip" data-placement="auto"
                                                      title='Hold down "Control", or "Command" on a Mac, to select more than one.'
                                                      class="pull-right glyphicon glyphicon-info-sign info-icon"></span>
                                    </form>
                                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST" style="padding-top:0.3em">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            <button type="submit"
                                                    class="btn btn-add-access btn-success pull-left glyphicon glyphicon-plus"><span
                                                    class="button-label">&nbspAdd user</span></button>
                                            {{ add_owner_user_form.user }}
                                            <input name="t" value="add_owner" type="hidden"/>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="custom-well">
                                    <h5 class="access-panel-title"><strong>Users who can edit the content of this resource</strong></h5>

                                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST">
                                        {% csrf_token %}
                                        <select name="designees" id="edit_users-select" multiple
                                                class="form-control" size="{{ edit_users.count }}">
                                            {% for u in edit_users %}
                                                <option value="{{ u.pk }}" selected>{{ u|best_name }}
                                                    ({{ u.username }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <input name="t" value="edit_users" type="hidden"/>
                                        <button type="submit"
                                                class="btn btn-update-list pull-left btn-default glyphicon"><span
                                                class="button-label">&nbspUpdate access list</span></button>
                                                <span data-toggle="tooltip" data-placement="auto"
                                                      title='Hold down "Control", or "Command" on a Mac, to select more than one.'
                                                      class="pull-right glyphicon glyphicon-info-sign info-icon"></span>
                                    </form>
                                    <form class="form-inline"
                                          action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                          method="POST" style="padding-top:0.3em">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            <button type="submit"
                                                    class="btn btn-add-access btn-success pull-left glyphicon glyphicon-plus"><span
                                                    class="button-label">&nbspAdd user</span></button>
                                            {{ add_edit_user_form.user }}
                                            <input name="t" value="add_edit_user" type="hidden"/>
                                        </div>
                                    </form>
                                </div>
                            </div>

{#                            <div class="col-md-4">#}
{#                                <div class="custom-well">#}
{#                                    <h5 class="access-panel-title"><strong>Research groups that can edit the content of this resource</strong>#}
{#                                    </h5>#}
{##}
{#                                    <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"#}
{#                                          method="POST">#}
{#                                        {% csrf_token %}#}
{#                                        <select name="designees" id="edit_groups-select" multiple#}
{#                                                class="form-control" size="{{ edit_groups.count }}">#}
{#                                            {% for u in edit_groups %}#}
{#                                                <option value="{{ u.pk }}"#}
{#                                                        {% if u in edit_groups %}selected{% endif %}>{{ u }}</option>#}
{#                                            {% endfor %}#}
{#                                        </select>#}
{#                                        <input name="t" value="edit_groups" type="hidden"/>#}
{#                                        <button type="submit"#}
{#                                                class="btn btn-update-list pull-left btn-default glyphicon"><span#}
{#                                                class="button-label">&nbspUpdate access list</span></button>#}
{#                                                <span data-toggle="tooltip" data-placement="auto"#}
{#                                                      title='Hold down "Control", or "Command" on a Mac, to select more than one.'#}
{#                                                      class="pull-right glyphicon glyphicon-info-sign info-icon"></span>#}
{#                                    </form>#}
{#                                    <form class="form-inline"#}
{#                                          action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"#}
{#                                          method="POST" style="padding-top:0.3em">#}
{#                                        {% csrf_token %}#}
{#                                        <div class="form-group">#}
{##}
{##}
{#                                            <button type="submit"#}
{#                                                    class="btn btn-default btn-add-access pull-left glyphicon glyphicon-plus"><span#}
{#                                                    class="button-label">&nbspAdd group</span></button>#}
{#                                            {{ add_edit_group_form.user }}#}
{#                                            <input name="t" value="add_edit_group" type="hidden"/>#}
{#                                        </div>#}
{#                                    </form>#}
{#                                </div>#}
{#                            </div>#}

                            {% if not cm.public %}
                                <div class="col-md-4">
                                    <div class="custom-well">
                                        <h5 class="access-panel-title"><strong>Users who can view and download the resource</strong></h5>

                                        <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                              method="POST">
                                            {% csrf_token %}
                                            <select name="designees" id="view_users-select" multiple
                                                    class="form-control" size="{{ view_users.count }}">
                                                {% for u in view_users %}
                                                    <option value="{{ u.pk }}"
                                                            {% if u in view_users %}selected{% endif %}>{{ u|best_name }}</option>
                                                {% endfor %}
                                            </select>
                                            <input name="t" value="view_users" type="hidden"/>
                                            <button type="submit"
                                                    class="btn btn-update-list pull-left btn-default glyphicon">
                                                <span class="button-label">&nbspUpdate access list</span></button>
                                                    <span data-toggle="tooltip" data-placement="auto"
                                                          title='Hold down "Control", or "Command" on a Mac, to select more than one.'
                                                          class="pull-right glyphicon glyphicon-info-sign info-icon"></span>
                                        </form>
                                        <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"
                                              method="POST" style="padding-top:0.3em">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <button type="submit"
                                                        class="btn btn-add-access btn-success pull-left glyphicon glyphicon-plus"><span
                                                        class="button-label">&nbspAdd user</span></button>
                                                {{ add_view_user_form.user }}
                                                <input name="t" value="add_view_user" type="hidden"/>
                                            </div>
                                        </form>
                                    </div>
                                </div>

{#                                <div class="col-md-4">#}
{#                                    <div class="custom-well">#}
{#                                        <h5 class="access-panel-title"><strong>Research groups that can view and download the resource</strong>#}
{#                                        </h5>#}
{##}
{#                                        <form action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"#}
{#                                              method="POST">#}
{#                                            {% csrf_token %}#}
{#                                            <select name="designees" id="view_groups-select" multiple#}
{#                                                    class="form-control" size="{{ view_groups.count }}">#}
{#                                                {% for u in view_groups %}#}
{#                                                    <option value="{{ u.pk }}"#}
{#                                                            {% if u in view_groups %}selected{% endif %}>{{ u }}</option>#}
{#                                                {% endfor %}#}
{#                                            </select>#}
{#                                            <input name="t" value="view_groups" type="hidden"/>#}
{#                                            <button type="submit"#}
{#                                                    class="btn btn-update-list pull-left btn-default glyphicon">#}
{#                                                <span class="button-label">&nbspUpdate access list</span></button>#}
{#                                                    <span data-toggle="tooltip" data-placement="auto"#}
{#                                                          title='Hold down "Control", or "Command" on a Mac, to select more than one.'#}
{#                                                          class="pull-right glyphicon glyphicon-info-sign info-icon"></span>#}
{#                                        </form>#}
{#                                        <form class="form-inline"#}
{#                                              action="/hsapi/_internal/{{ cm.short_id }}/change-permissions/"#}
{#                                              method="POST" style="padding-top:0.3em">#}
{#                                            {% csrf_token %}#}
{#                                            <div class="form-group">#}
{#                                                <button type="submit"#}
{#                                                        class="btn btn-default btn-add-access pull-left glyphicon glyphicon-plus">#}
{#                                                    <span class="button-label">&nbspAdd group</span></button>#}
{#                                                {{ add_view_group_form.user }}#}
{#                                                <input name="t" value="add_view_group" type="hidden"/>#}
{#                                            </div>#}
{#                                        </form>#}
{#                                    </div>#}
{#                                </div>#}
                            {% endif %}
                        </div>
                    </div>
                    </div>
                    <div>

                    </div>
                {% endif %}
                </div>
            </div>

            {#        ======= Keywords =======#}
            {% if not metadata_form %}
                {% if keywords %}
                <div class="content-block">
                    <h3>Keywords</h3>

                    <p id="keywords">{{ keywords }}</p>

                    <div class="tags">
                        <ul id="list-keywords" class="tag-list custom-well">
                        </ul>
                    </div>
                </div>
                {% endif %}
            {% else %}
                <h3>Keywords</h3>
                <form action="/hsapi/_internal/{{ cm.short_id }}/subject/add-metadata/" id="id-subject"
                      method="post">
                    {% csrf_token %}
                    <div class="tags">
                        <div id="add-keyword-wrapper" class="input-group">
                            <input id="txt-keyword" type="text" class="form-control" placeholder="Keyword">
                        <span class="input-group-btn">
                            <a id="btn-add-keyword" class="btn btn-success" type="button">Add</a>
                        </span>
                        </div>
                        <ul id="lst-tags" class="custom-well tag-list">
                        </ul>
                    </div>

                    <fieldset>
                        <div id="div_id_value" class="control-group">
                            <div class="controls"><input class="form-control input-sm textInput" id="id_value"
                                                         maxlength="500" name="value" type="text"
                                                         style="display: none;">{{ cm.keywords_string }}</div>
                        </div>
                        <div style="margin-top:10px">
                            <button type="button" class="btn btn-primary pull-right"
                                    onclick="metadata_update_ajax_submit('id-subject'); return false;"
                                    style="display: none;">Save changes
                            </button>
                        </div>
                    </fieldset>
                </form>
            {% endif %}

            {#        ======= Content =======#}
            <div>
                <h3>Content</h3>
                <div class="custom-well">
                    {#            {% block extra_content %}#}
                    {#            {% endblock %}#}
                    {% if cm.files.all %}
                    <div class="table-container">
                        <table class="table-plain table-striped">
                            {% for f in cm.files.all %}
                                {% if f.resource_file %}
                                {#======= Modal window begins =======#}
                                <div class="modal fade" id="delete-resource-file-{{ f.pk }}" tabindex="-1" role="dialog"
                                     aria-labelledby="myModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true">&times;</button>
                                                <h4 class="modal-title">Confirm file deletion</h4>
                                            </div>
                                            <div class="modal-body">
                                                Consider saving a copy of the file before you delete it if it is important to you.
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-default" data-dismiss="modal">
                                                    Cancel
                                                </button>
                                                <a type="button" class="btn btn-danger"
                                                   href="/hsapi/_internal/{{ cm.short_id }}/delete-resource-file/{{ f.pk }}/">Delete</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {#======= Modal window ends =======#}
                                <tr>
                                    <td>
                                        <span class="glyphicon glyphicon-file file-icon"></span>
                                        <span>
                                            <span class="label-file-name">{{ f.resource_file.name|slice:"33:" }}</span>
                                            <p class="label-file-size">{{ f.resource_file.size|filesizeformat }}</p>
                                        </span>
                                    </td>
                                    {#                    <td>{% if preview %}<a class="btn btn-info btn-block" href="{{ preview }}">Preview</a>{% endif %}</td>#}
                                    <td>
                                        {% if page.perms.change %}

                                            <a href="{{ f.resource_file.url }}"><span data-toggle="modal"
                                                                                  data-target="#delete-resource-file-{{ f.pk }}"
                                                                                  data-placement="auto"
                                                                                  title="Delete"
                                                                                  class="glyphicon glyphicon-trash icon-button btn-remove"></span></a>

                                        {% endif %}

                                        <a href="{{ f.resource_file.url }}"><span data-toggle="tooltip"
                                                                                  data-placement="auto" title="Download"
                                                                                  class="glyphicon glyphicon-download icon-button btn-download"></span></a>

                                        {% if preview  %}
                                            <a href="{{ preview }}"><span data-toggle="tooltip"
                                                                                      data-placement="auto"
                                                                                      title="Preview"
                                                                                            class="glyphicon glyphicon-eye-open icon-button"></span></a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </table>
                    </div>
                    {% endif %}
                    <!-- Buttons -->
                    {% for b in cm.bags.all %}
                        <a id="btn-download-all" type="button" class="btn btn-default" href="{{ cm.bags.first.bag.url }}">
                            <span class="glyphicon glyphicon-download-alt">
                                <span class="button-label">Download All ({{ b.bag.size|filesizeformat }})</span>
                            </span>
                        </a>
                    {% endfor %}

                    {% if page.perms.change %}
                        <td><a id="btn-add-file" type="button" class="btn btn-success" data-toggle="modal" data-target="#add-file-dialog"
                               multiple="multiple">
                            <span class="glyphicon glyphicon-plus"><span class="button-label"> Add file...</span></span>
                        </a></td>
                    {% endif %}
                </div>
            </div>

            <!-- === Tabs begin === -->
            <div class="tab-elements">
            <div class="panel-tabs">
                <ul class="nav nav-tabs">
                    <li class="active col-xs-2 col-md-2">
                        <a href="#contactTab" data-toggle="tab">
                            <span class="glyphicon glyphicon-user"> </span>
                            &nbspContact
                        </a>
                    </li>
                    {% if spatial_coverage.north or spatial_coverage.northlimit or temporal_coverage or metadata_form %}
                        <li class="col-xs-2 col-md-2">
                            <a href="#coverageTab" data-toggle="tab">
                                <span class="glyphicon glyphicon-globe"></span>
                                &nbspCoverage
                            </a>
                        </li>
                    {% endif %}
                    {% if sources or relations or metadata_form %}
                        <li class="col-xs-2 col-md-2">
                            <a href="#relatedResourcesTab" data-toggle="tab">
                                <span class="glyphicon glyphicon-book"></span>
                                &nbspRelated Resources
                            </a>
                        </li>
                    {% endif %}
                    {% if extended_metadata_exists or metadata_form  %}
                        {#  Resource specific metadata can't be edited for HIS Referenced Time Series #}
                        {% if cm|resource_type != "HIS Referenced Time Series" or not metadata_form %}
                            {% if  cm|resource_type != "Generic" %}
                            <li class="col-xs-2 col-md-2">
                                <a href="#resourceSpecificTab" data-toggle="tab">
                                    <span class="glyphicon glyphicon-folder-close"></span>
                                    &nbspResource Specific
                                </a>
                            </li>
                            {% endif %}
                        {% endif %}
                    {% endif %}
{#                    {% if relevant_tools or metadata_form %}#}
{#                        <li class="col-xs-2 col-md-2">#}
{#                            <a href="#relevantTools" data-toggle="tab">#}
{#                                <span class="glyphicon glyphicon-wrench"></span>#}
{#                                &nbsp;Relevant Tools#}
{#                            </a>#}
{#                        </li>#}
{#                    {% endif %}#}
                </ul>
            </div>
            <div class="tabs-body">
            <!-- Tab panes -->
            <div class="tab-content">
                <!-- ========= CONTACT TAB ========= -->
                <div class="tab-pane active" id="contactTab">
                    {% if not metadata_form %}
                    <table class="table table-striped">
                        <tbody>
                        <tr>
                            <th class="division-title">Authors</th>
                        </tr>
                        <tr class="header-row">
                            <th>Name</th>
                            <th>Organization</th>
                            <th>Address</th>
                            <th>Phone</th>
                        </tr>
                        {% for cr in creators %}
                            <tr>
                                <td>{% if cr.description %} <a href="{{ cr.description }}">{{ cr.name }}</a>{% else %}{{ cr.name }}{% endif %}</td>
                                <td>{% if cr.organization %} {{ cr.organization }}{% endif %}</td>
                                <td>{% if cr.address %} {{ cr.address }}{% endif %}</td>
                                <td>{% if cr.phone %} {{ cr.phone }}{% endif %}</td>
                            </tr>
                        {% endfor %}
                        {% if contributors %}
                            <tr>
                                <th class="division-title">Contributors</th>
                            </tr>
                            <tr class="header-row">
                                <th>Name</th>
                                <th>Organization</th>
                                <th>Address</th>
                                <th>Phone</th>
                            </tr>

                            {% for cont in contributors %}
                                <tr>
                                    <td>{% if cont.description %} <a href="{{ cont.description }}">{{ cont.name }}</a>{% else %}{{ cont.name }}{% endif %}</td>
                                    <td>{% if cont.organization %} {{ cont.organization }}{% endif %}</td>
                                    <td>{% if cont.address %} {{ cont.address }}{% endif %}</td>
                                    <td>{% if cont.phone %} {{ cont.phone }}{% endif %}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        </tbody>
                    </table>
                    {% else %}
                     <div class="tab-pane active" id="contactTab">
                        <table id="contact-table" class="table table-striped">
                            <tbody>
                            <tr>
                                <th class="division-title">Authors</th>
                            </tr>
                            <tr class="header-row">
                                <th>Name</th>
                                <th>Organization</th>
                                <th>Address</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                            {% for author in creator_formset.initial %}
                            <tr>
                                <td>{% if author.description %} <a href="{{ author.description }}">{{ author.name }}</a>{% else %}{{ author.name }}{% endif %}</td>
                                <td>{%  if  author.organization %}{{ author.organization }}{% endif %}</td>
                                <td>{%  if  author.address %}{{ author.address }}{% endif %}</td>
                                <td>{%  if  author.phone %}{{ author.phone }}{% endif %}</td>
                                <td>
                                    <a data-toggle="modal" data-placement="auto" title="Edit"
                                            class="glyphicon glyphicon-pencil icon-button btn-edit"
                                            data-target="#edit-creator-dialog{{ author.id }}"
                                            ></a>

                                    {# Prevent deletion of last creator#}
                                    {% if creator_formset.initial|length > 1 %}
                                    <a data-toggle="modal" data-placement="auto" title="Remove"
                                            class="glyphicon glyphicon-trash icon-button btn-remove"
                                            data-target="#delete-creator-dialog{{ author.id }}"></a>
                                    {% endif %}
                                </td>
                            </tr>

                            {% endfor %}
                            <tr>
                                <th class="division-title">
                                    <a type="button" class="btn btn-success" data-toggle="modal"
                                       data-target="#add-creator-dialog" multiple="multiple">
                                                    <span class="glyphicon glyphicon-plus"><span
                                                            class="button-label"> Add author...</span></span>
                                    </a>
                                </th>
                            </tr>
                            <tr>
                                <th class="division-title">Contributors</th>
                            </tr>
                            <tr class="header-row">
                                <th>Name</th>
                                <th>Organization</th>
                                <th>Address</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                            {% for contributor in contributor_formset.initial %}
                            <tr>
                                <td>{% if contributor.description %} <a href="{{ contributor.description }}">{{ contributor.name }}</a>{% else %}{{ contributor.name }}{% endif %}</td>
                                <td>{%  if  contributor.organization %}{{ contributor.organization }}{% endif %}</td>
                                <td>{%  if  contributor.address %}{{ contributor.address }}{% endif %}</td>
                                <td>{%  if  contributor.phone %}{{ contributor.phone }}{% endif %}</td>
                                <td>
                                    <a data-toggle="modal" data-placement="auto" title="Edit"
                                            class="glyphicon glyphicon-pencil icon-button btn-edit"
                                            data-target="#edit-contributor-dialog{{ contributor.id }}"
                                            ></a>
                                    <a data-toggle="modal" data-placement="auto" title="Remove"
                                            class="glyphicon glyphicon-trash icon-button btn-remove"
                                            data-target="#delete-contributor-dialog{{ contributor.id }}"
                                            ></a>
                                </td>
                            </tr>
                            {% endfor %}

                            <tr>
                                <th class="division-title">
                                    <a type="button" class="btn btn-success" data-toggle="modal"
                                       data-target="#add-contributor-dialog" multiple="multiple">
                                        <span class="glyphicon glyphicon-plus"><span class="button-label"> Add contributor...</span></span>
                                    </a>
                                </th>
                            </tr>

                            </tbody>
                        </table>
                     </div>
                    {% endif %}
            </div>
                <!-- ========= COVERAGE TAB ========= -->
                {% if spatial_coverage.north or spatial_coverage.northlimit or temporal_coverage or metadata_form %}
                <div class="tab-pane" id="coverageTab">
                    {% if not metadata_form %}
                    {% if spatial_coverage.north or spatial_coverage.northlimit %}
                        <h4><strong>Spatial</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">


                    {% if spatial_coverage.type == 'point' %}
                        {#                                TODO: find a place for doi field#}
                        {#                                {% if cm.doi %}#}
                        {#                                <tr>#}
                        {#								    <th scope="row" class="dataset-label">DOI:</th>#}
                        {#								    <td class="dataset-details"><a id="permalink" href="http://{{ request.get_host }}/r/doi/{{ cm.doi }}/">{{ cm.doi }}</a></td>#}
                        {#							    </tr>#}
                        {#                                {% endif %}#}
                        {% if spatial_coverage.name %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Place/Area Name:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.name }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.projection %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Coordinate System/Geographic
                                    Projection:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.projection }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.east %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Longitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.east }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.north %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Latitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.north }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.units %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Coordinate Units:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.units }}</div>
                            </div>
                        {% endif %}
                    {% else %}
                        {% if spatial_coverage.name %}
                            <div class="row">
                                <div class="col-sm-4"><strong>CPlace/Area Name:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.name }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.projection %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Coordinate System/Geographic
                                    Projection:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.projection }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.northlimit %}
                            <div class="row">
                                <div class="col-sm-4"><strong>North Latitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.northlimit }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.eastlimit %}
                            <div class="row">
                                <div class="col-sm-4"><strong>East Longitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.eastlimit }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.southlimit %}
                            <div class="row">
                                <div class="col-sm-4"><strong>South Latitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.southlimit }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.westlimit %}
                            <div class="row">
                                <div class="col-sm-4"><strong>West Longitude:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.westlimit }}</div>
                            </div>
                        {% endif %}
                        {% if spatial_coverage.units %}
                            <div class="row">
                                <div class="col-sm-4"><strong>Coordinate Units:</strong></div>
                                <div class="col-sm-8">{{ spatial_coverage.units }}</div>
                            </div>
                        {% endif %}

                    {% endif %}
                    <hr style="border: 0;">
                    {% endif %}

                    {% if temporal_coverage %}
                        <h4><strong>Temporal</strong></h4>
                        <hr style="margin-top: 0px;margin-bottom: 2px">
                        <div class="row">
                            <div class="col-sm-4"><strong>Start Date:</strong></div>
                            <div class="col-sm-8">{{ temporal_coverage.start_date }}</div>
                        </div>
                        <div class="row">
                            <div class="col-sm-4"><strong>End Date:</strong></div>
                            <div class="col-sm-8">{{ temporal_coverage.end_date }}</div>
                        </div>
                    {% endif %}
                    {% else %}
                    <div class="form-group col-md-6 col-sm-12 col-xs-12" id="coverage-spatial">
                        {% if not coverage_spatial_form.initial.north and not coverage_spatial_form.initial.northlimit %}
                        <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/add-metadata/"
                              id="id-coverage-spatial" method="post">
                            {% csrf_token %}
                            <fieldset>
                                <legend>Spatial</legend>
                                <div id="div_id_type" class="control-group">
                                    <div class="controls">
                                        <label class="radio control-label">
                                            <input type="radio" name="type" id="id_type_1" value="box">Box
                                        </label>
                                        <label class="radio control-label"><input type="radio" checked="checked" name="type" id="id_type_2" value="point">Point</label>
                                    </div>
                                </div>
                                <div id="div_id_name" class="control-group">
                                    <label for="id_name" class="control-label">Place/Area Name</label>
                                    <div class="controls">
                                        <input class="form-control input-sm textinput textInput"
                                                                 id="id_name" maxlength="200" name="name" type="text">
                                    </div>
                                </div>
                                <div id="div_id_projection" class="control-group">
                                    <label for="id_projection" class="control-label">Coordinate System/Geographic Projection</label>

                                    <div class="controls">
                                        <input class="form-control input-sm textinput textInput"
                                                                 id="id_projection" maxlength="100" name="projection"
                                                                 readonly="True" style="background-color:white;"
                                                                 type="text" value="WGS 84 EPSG:4326">
                                    </div>
                                </div>
                                <div id="div_id_east" class="control-group">
                                    <label for="id_east" class="control-label requiredField">
                                    Latitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls">
                                        <input class="form-control input-sm textinput textInput" id="id_east" name="east" type="text">
                                    </div>
                                </div>
                                <div id="div_id_north" class="control-group">
                                    <label for="id_north" class="control-label requiredField">
                                    Longitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_north" name="north" type="text"></div>
                                </div>
                                <div id="div_id_northlimit" class="control-group" style="display: none;"><label
                                        for="id_northlimit" class="control-label requiredField">
                                    North Longitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_northlimit" name="northlimit" type="text"></div>
                                </div>
                                <div id="div_id_eastlimit" class="control-group" style="display: none;"><label
                                        for="id_eastlimit" class="control-label requiredField">
                                    East Latitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_eastlimit" name="eastlimit" type="text"></div>
                                </div>
                                <div id="div_id_southlimit" class="control-group" style="display: none;"><label
                                        for="id_southlimit" class="control-label requiredField">
                                    South Longitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_southlimit" name="southlimit" type="text"></div>
                                </div>
                                <div id="div_id_westlimit" class="control-group" style="display: none;"><label
                                        for="id_westlimit" class="control-label requiredField">
                                    West Latitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_westlimit" name="westlimit" type="text"></div>
                                </div>
                                <div id="div_id_units" class="control-group"><label for="id_units"
                                                                                    class="control-label requiredField">
                                    Coordinate Units<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_units" maxlength="50" name="units"
                                                                 readonly="True" style="background-color:white;"
                                                                 type="text" value="Decimal degrees"></div>
                                </div>
                                <div style="margin-top:10px">
                                    <button type="button" class="btn btn-primary pull-right"
                                            onclick="metadata_update_ajax_submit('id-coverage-spatial'); return false;"
                                            style="display: none;">Save changes
                                    </button>
                                </div>
                            </fieldset>
                        </form>
                        {% else %}
                        <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/{{ coverage_spatial_form.initial.id }}/update-metadata/"
                              id="id-coverage-spatial" method="post">
                            {% csrf_token %}
                            <fieldset>
                                <legend>Spatial</legend>
                                <div id="div_id_type" class="control-group">
                                    <div class="controls">
                                        <label class="radio control-label">
                                            <input type="radio"
                                                   {% if coverage_spatial_form.initial.type == "box" %}
                                                   checked="checked"
                                                   {% endif %}
                                                   name="type" id="id_type_1" value="box">Box
                                        </label>
                                        <label class="radio control-label">
                                            <input type="radio"
                                                   {% if coverage_spatial_form.initial.type == "point" %}
                                                   checked="checked"
                                                   {% endif %}
                                                   name="type" id="id_type_2" value="point">Point
                                        </label>
                                    </div>
                                </div>
                                <div id="div_id_name" class="control-group">
                                    <label for="id_name" class="control-label">Place/Area Name</label>
                                    <div class="controls">
                                        <input class="form-control input-sm textinput textInput"
                                                                 id="id_name" maxlength="200" name="name" type="text"
                                                                 value="{% if coverage_spatial_form.initial.name %}{{ coverage_spatial_form.initial.name }}{% endif %}">
                                    </div>
                                </div>
                                <div id="div_id_projection" class="control-group">
                                    <label for="id_projection" class="control-label">Coordinate System/Geographic Projection</label>

                                    <div class="controls">
                                        <input class="form-control input-sm textinput textInput"
                                                                 id="id_projection" maxlength="100" name="projection"
                                                                 readonly="True" style="background-color:white;"
                                                                 type="text" value="WGS 84 EPSG:4326"
                                                value="{% if coverage_spatial_form.initial.projection %}{{ coverage_spatial_form.initial.projection }}{% endif %}">
                                    </div>
                                </div>
                                <div id="div_id_east" class="control-group">
                                    <label for="id_east" class="control-label requiredField">
                                    Latitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls">
                                        <input class="form-control input-sm textinput textInput" id="id_east" name="east" type="text"
                                                value="{% if coverage_spatial_form.initial.east %}{{ coverage_spatial_form.initial.east }}{% endif %}">
                                    </div>
                                </div>
                                <div id="div_id_north" class="control-group">
                                    <label for="id_north" class="control-label requiredField">
                                    Longitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_north" name="north" type="text"
                                            value="{% if coverage_spatial_form.initial.north %}{{ coverage_spatial_form.initial.north }}{% endif %}">
                                    </div>
                                </div>
                                <div id="div_id_northlimit" class="control-group"><label
                                        for="id_northlimit" class="control-label requiredField">
                                    North Longitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_northlimit" name="northlimit" type="text"
                                                                 value="{% if coverage_spatial_form.initial.northlimit %}{{ coverage_spatial_form.initial.northlimit }}{% endif %}"
                                            >
                                    </div>
                                </div>
                                <div id="div_id_eastlimit" class="control-group"><label
                                        for="id_eastlimit" class="control-label requiredField">
                                    East Latitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_eastlimit" name="eastlimit" type="text"
                                            value="{% if coverage_spatial_form.initial.eastlimit %}{{ coverage_spatial_form.initial.eastlimit }}{% endif %}">
                                    </div>
                                </div>
                                <div id="div_id_southlimit" class="control-group"><label
                                        for="id_southlimit" class="control-label requiredField">
                                    South Longitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_southlimit" name="southlimit" type="text"
                                            value="{% if coverage_spatial_form.initial.southlimit %}{{ coverage_spatial_form.initial.southlimit }}{% endif %}">
                                    </div>
                                </div>
                                <div id="div_id_westlimit" class="control-group"><label
                                        for="id_westlimit" class="control-label requiredField">
                                    West Latitude (WGS 84 decimal degrees)<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_westlimit" name="westlimit" type="text"
                                            value="{% if coverage_spatial_form.initial.westlimit %}{{ coverage_spatial_form.initial.westlimit }}{% endif %}">
                                    </div>
                                </div>
                                <div id="div_id_units" class="control-group">
                                    <label for="id_units" class="control-label requiredField">
                                    Coordinate Units<span class="asteriskField">*</span></label>

                                    <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                 id="id_units" maxlength="50" name="units"
                                                                 readonly="True" style="background-color:white;"
                                                                 type="text" value="{% if coverage_spatial_form.initial.units %}{{ coverage_spatial_form.initial.units }}{% endif %}">
                                    </div>
                                </div>
                                <div style="margin-top:10px">
                                    <button type="button" class="btn btn-primary pull-right"
                                            onclick="metadata_update_ajax_submit('id-coverage-spatial'); return false;"
                                            style="display: none;">Save changes
                                    </button>
                                </div>
                            </fieldset>
                        </form>
                        {% endif %}
                    </div>

{#                   Add new temporal coverage#}
                    <div class="form-group col-md-6 col-sm-12 col-xs-12" id="coverage-temporal">
                        {% if not coverage_temporal_form.initial.start %}
                        <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/add-metadata/"
                              id="id-coverage-temporal" method="post">
                             {% csrf_token %}
                            <fieldset>
                                <legend>Temporal</legend>
                                <div id="div_id_start" class="control-group">
                                    <label for="id_start" class="control-label requiredField">
                                    Start Date<span class="asteriskField">*</span></label>

                                    <div class="controls">
                                        <input class="form-control input-sm dateinput" id="id_start"
                                            name="start" type="text">
                                    </div>
                                </div>
                                <div id="div_id_end" class="control-group">
                                    <label for="id_end" class="control-label requiredField">End Date<span class="asteriskField">*</span></label>

                                    <div class="controls">
                                        <input class="form-control input-sm dateinput" id="id_end"
                                            name="end" type="text">
                                    </div>
                                </div>
                                <div style="margin-top:10px">
                                    <button type="button" class="btn btn-primary pull-right"
                                            onclick="metadata_update_ajax_submit('id-coverage-temporal'); return false;">
                                        Save changes
                                    </button>
                                </div>
                            </fieldset>
                        </form>
                            {% else %}

                        <form action="/hsapi/_internal/{{ cm.short_id }}/coverage/{{ coverage_temporal_form.initial.id }}/update-metadata/"
                              id="id-coverage-temporal" method="post">
                             {% csrf_token %}
                            <fieldset>
                                <legend>Temporal</legend>
                                <div id="div_id_start" class="control-group">
                                    <label for="id_start" class="control-label requiredField">
                                    Start Date<span class="asteriskField">*</span></label>

                                    <div class="controls">
                                        <input class="form-control input-sm dateinput" id="id_start"
                                            name="start" type="text" value="{{ coverage_temporal_form.initial.start }}">
                                    </div>
                                </div>
                                <div id="div_id_end" class="control-group">
                                    <label for="id_end" class="control-label requiredField">End Date<span class="asteriskField">*</span></label>

                                    <div class="controls">
                                        <input class="form-control input-sm dateinput" id="id_end"
                                            name="end" type="text" value="{{ coverage_temporal_form.initial.end }}">
                                    </div>
                                </div>
                                <div style="margin-top:10px">
                                    <button type="button" class="btn btn-primary pull-right"
                                            onclick="metadata_update_ajax_submit('id-coverage-temporal'); return false;"
                                            style="display: none;">Save changes
                                    </button>
                                </div>
                            </fieldset>
                        </form>
                        {% endif %}
                            </div>
                    {% endif %}
                </div>
            {% endif %}
                <!-- ========= RELATED RESOURCES TAB ========= -->
            {% if sources or relations or metadata_form %}
            <div class="tab-pane" id="relatedResourcesTab">
                {% if not metadata_form %}
                {% if sources %}
                    <h4><strong>Sources</strong></h4>
                    <hr style="margin-top: 0px;margin-bottom: 2px">
                    {% for source in sources %}
                        <div class="row">
                            <div class="col-sm-4"><strong>Derived From:</strong></div>
                            <div class="col-sm-8">{{ source.derived_from }}</div>
                        </div>
                    {% endfor %}
                {% endif %}
                {% if relations %}
                    <hr style="border: 0;">
                    <h4><strong>Relations</strong></h4>
                    <hr style="margin-top: 0px;margin-bottom: 2px">
                    {% for relation in relations %}
                        <div class="row">
                            <div class="col-sm-4"><strong>{{ relation.type }}:</strong></div>
                            <div class="col-sm-8">{{ relation.value }}</div>
                        </div>
                    {% endfor %}
                {% endif %}
                {% else %}
                    <div>
                        <table class="table" style="margin-bottom: 0;">
                            <tbody>
                            <legend>Sources</legend>
                            {% for source in source_formset.initial %}
                                <tr>
                                    <th scope="row" class="dataset-label">Derived From:</th>
                                    <td class="dataset-details">{{ source.derived_from }}</td>
                                    <td>
                                        <a data-toggle="modal" data-placement="auto" title="Edit"
                                           class="glyphicon glyphicon-pencil icon-button btn-edit"
                                           data-target="#edit-source-dialog{{ source.id }}"
                                           style="top: -5px; "></a>
                                    </td>
                                    <td>
                                        <a data-toggle="modal" data-placement="auto"
                                           title="Remove" class="glyphicon glyphicon-trash icon-button btn-remove"
                                           data-target="#delete-source-element-dialog{{ source.id }}"
                                           style="top: -5px; right:20px;"></a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <a id="add-source" class="btn btn-success" data-toggle="modal" data-target="#add-source-dialog"><i
                                    class="fa fa-plus"></i> Add source</a>
                    </div>
                    <hr style="border: 0;">
                    <div>
                    <table class="table" style="margin-bottom: 0;">
                        <tbody>
                        <legend>Relations</legend>
                        {% for relation in relation_formset.initial %}
                            <tr>
                                <th scope="row" class="dataset-label">{{ relation.type }}:</th>
                                <td class="dataset-details">{{ relation.value }}</td>
                                <td>
                                    <a data-toggle="modal" data-placement="auto" title="Edit"
                                       class="glyphicon glyphicon-pencil icon-button btn-edit"
                                       data-target="#edit-relation-dialog_{{ relation.id }}"
                                       style="top: -5px; "></a>
                                </td>
                                <td>
                                    <a data-toggle="modal" data-placement="auto"
                                       title="Remove" class="glyphicon glyphicon-trash icon-button btn-remove"
                                       data-target="#delete-relation-element-dialog{{ relation.id }}"
                                       style="top: -5px; right:20px;"></a>
                                </td>
                            </tr>
                        {% endfor %}

                        </tbody>
                    </table>
                    <a id="add-relation" class="btn btn-success" data-toggle="modal" data-target="#add-relation-dialog"><i
                            class="fa fa-plus"></i> Add relation</a>
                    </div>
                {% endif %}
            </div>
            {% endif %}
                <!-- ========= RESOURCE SPECIFIC TAB ========= -->
            {% if site or extended_metadata_exists or res_add_metadata or metadata_form %}
                {#  Resource specific metadata can't be edited for HIS Referenced Time Series #}
                {% if cm|resource_type != "HIS Referenced Time Series" or not metadata_form %}
                    {% if  cm|resource_type != "Generic" %}
                    <div class="tab-pane" id="resourceSpecificTab">
                    {% if not metadata_form %}

                        {% block extended_metadata %}

                        {%  endblock %}

                    {%  else %}
                       {%  crispy metadata_form  %}
                    {%  endif %}
                    </div>
                    {%  endif %}
                {%  endif %}
            {%  endif %}
{#                <!-- ========= RELEVANT TOOLS TAB ========= -->#}
{#            {% if relevant_tools or metadata_form %}#}
{#                <div class="tab-pane" id="relevantTools">#}
{#                {% if not metadata_form %}#}
{#                    {% for tool in relevant_tools %}#}
{#                        <h4>{{ tool.title }}</h4>#}
{#                        <a href="{{ tool.url }}" target="_blank"><button class="btn btn-primary">Launch Tool</button></a>#}
{#                        <hr>#}
{#                    {% endfor %}#}
{#                {% else %}#}
{#                    ------- Relevant tools form here -------#}
{#                {%  endif %}#}
{#                </div>#}
{#            {% endif %}#}
            </div>
            </div>
            </div>
        <!-- ==== Tabs end ==== -->
        {% comments_for cm %}
        {#                #}
        {# dialogs follow #}
        {#                #}
        {%  block modal %}

        {% for source in source_formset.initial %}
        <div class="modal fade in" id="delete-source-element-dialog{{ source.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                        <h4 class="modal-title" id="myModalLabel">Delete metadata element</h4></div>
                    <div class="modal-body"><strong>Are you sure you want to delete this metadata element?</strong>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger"
                           href="/hsapi/_internal/{{ cm.short_id }}/source/{{ source.id }}/delete-metadata/">Delete</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade in" id="edit-source-dialog{{ source.id }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="id_source_{{ source.id }}" action="/hsapi/_internal/{{ cm.short_id }}/source/{{ source.id }}/update-metadata/"
                          method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 class="modal-title" id="myModalLabel"> Edit Source </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <legend>Source</legend>
                                    <div id="div_id_derived_from" class="control-group">
                                        <label for="id_derived_from" class="control-label requiredField">
                                        Derived from<span class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_source-{{ forloop.counter0 }}-derived_from" maxlength="300" name="source-{{ forloop.counter0 }}-derived_from"
                                                type="text" value="{{ source.derived_from }}"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% endfor %}

        {% for relation in relation_formset.initial %}
        <div class="modal fade in" id="delete-relation-element-dialog{{ relation.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                        <h4 class="modal-title" id="myModalLabel">Delete metadata element</h4></div>
                    <div class="modal-body"><strong>Are you sure you want to delete this metadata element?</strong>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger"
                           href="/hsapi/_internal/{{ cm.short_id }}/relation/{{ relation.id }}/delete-metadata/">Delete</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade in" id="edit-relation-dialog_{{ relation.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/relation/{{ relation.id }}/update-metadata/"
                          method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 class="modal-title" id="myModalLabel"> Edit Relation </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}

                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <legend>Relation</legend>
                                    <div id="div_id_type" class="control-group">
                                        <label for="id_type" class="control-label requiredField">
                                        Relation type<span class="asteriskField">*</span></label>

                                        <div class="controls">
                                            <select class="form-control input-sm select" id="id_relation-{{ forloop.counter0 }}-type" name="relation-{{ forloop.counter0 }}-type">
                                                <option value="">---------</option>
                                                <option value="isPartOf" {% if relation.type == "isPartOf" %} selected="selected" {% endif %}>Part Of</option>
                                                <option value="isExecutedBy" {% if relation.type == "isExecutedBy" %}selected="selected"{% endif %}>Executed By</option>
                                                <option value="isCreatedBy" {% if relation.type == "isCreatedBy" %}selected="selected"{% endif %}>Created By</option>
                                                <option value="isVersionOf" {% if relation.type == "isVersionOf" %}selected="selected"{% endif %}>Version Of</option>
                                                <option value="isDataFor" {% if relation.type == "isDataFor" %}selected="selected"{% endif %}>Data For</option>
                                                <option value="cites" {% if relation.type == "cites" %}selected="selected"{% endif %}>Cites</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="div_id_value" class="control-group">
                                        <label for="id_value" class="control-label requiredField">
                                        Related to<span class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput" id="id_relation-{{ forloop.counter0 }}-value"
                                                maxlength="500" name="relation-{{ forloop.counter0 }}-value" type="text"
                                                value="{{ relation.value }}"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}

        {% for contributor in contributor_formset.initial %}
        <div class="modal fade" id="edit-contributor-dialog{{ contributor.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="id_contributor_{{ contributor.id }}" action="/hsapi/_internal/{{ cm.short_id }}/contributor/{{ contributor.id }}/update-metadata/"
                          method="POST"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-hidden="true">
                            </button>
                            <h4 class="modal-title" id="myModalLabel"> Edit contributor </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <div id="div_id_name" class="control-group">
                                        <label class="control-label requiredField">Name<span
                                                class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_contributor-{{ contributor.order|add:"- 1" }}-name" maxlength="100" name="contributor-{{ contributor.order|add:"- 1" }}-name"
                                                required="required" type="text" value="{% if contributor.name %}{{ contributor.name }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_description" class="control-group">
                                        <label class="control-label">HydroShare User Identifier (URL)</label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_contributor-{{ contributor.order|add:"- 1" }}-description" maxlength="200"
                                                name="contributor-{{ contributor.order|add:"- 1" }}-description" type="url" value="{% if contributor.description %}{{ contributor.description }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_organization" class="control-group">
                                        <label class="control-label">Organization</label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_contributor-{{ contributor.order|add:"- 1" }}-organization" maxlength="200"
                                                name="contributor-{{ contributor.order|add:"- 1" }}-organization" type="text" value="{% if contributor.organization %}{{ contributor.organization }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_email" class="control-group">
                                        <label class="control-label">Email</label>

                                        <div class="controls">
                                            <input class="form-control input-sm emailinput"
                                                   id="id_contributor-{{ contributor.order|add:"- 1" }}-email" maxlength="75" name="contributor-{{ contributor.order|add:"- 1" }}-email"
                                                   type="email" value="{% if contributor.email %}{{ contributor.email }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_address" class="control-group">
                                        <label class="control-label">Address</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                   id="id_contributor-{{ contributor.order|add:"- 1" }}-address" maxlength="250"
                                                   name="contributor-{{ contributor.order|add:"- 1" }}-address"
                                                   type="text" value="{% if contributor.address %}{{ contributor.address }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_phone" class="control-group">
                                        <label class="control-label">Phone</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                   id="id_contributor-{{ contributor.order|add:"- 1" }}-phone" maxlength="25" name="contributor-{{ contributor.order|add:"- 1" }}-phone"
                                                   type="text" value="{% if contributor.phone %}{{ contributor.phone }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_homepage" class="control-group">
                                        <label class="control-label">Homepage</label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_contributor-{{ contributor.order|add:"- 1" }}-homepage" maxlength="200" name="contributor-{{ contributor.order|add:"- 1" }}-homepage"
                                                type="url" value="{% if contributor.homepage %}{{ contributor.homepage }}{% endif %}"></div>
                                    </div>

                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="delete-contributor-dialog{{ contributor.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                        <h4 class="modal-title" id="myModalLabel">Delete metadata element</h4></div>
                    <div class="modal-body"><strong>Are you sure you want to delete this metadata element?</strong>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger"
                           href="/hsapi/_internal/{{ cm.short_id }}/contributor/{{ contributor.id }}/delete-metadata/">Delete</a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% for author in creator_formset.initial %}
        <div class="modal fade" id="edit-creator-dialog{{ author.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="id_creator_{{ author.id }}" action="/hsapi/_internal/{{ cm.short_id }}/creator/{{ author.id }}/update-metadata/"
                          method="POST"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-hidden="true">
                            </button>
                            <h4 class="modal-title" id="myModalLabel"> Edit author </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <div id="div_id_name" class="control-group">
                                        <label class="control-label requiredField">Name<span
                                                class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-name" maxlength="100" name="creator-{{ author.order|add:"- 1" }}-name"
                                                required="required" type="text" value="{% if author.name %}{{ author.name }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_description" class="control-group">
                                        <label class="control-label">HydroShare User Identifier (URL)</label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-description" maxlength="200"
                                                name="creator-{{ author.order|add:"- 1" }}-description" type="url" value="{% if author.description %}{{ author.description }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_organization" class="control-group">
                                        <label class="control-label">Organization</label>

                                        <div class="controls"><input
                                                class="form-control input-sm textinput textInput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-organization" maxlength="200"
                                                name="creator-{{ author.order|add:"- 1" }}-organization" type="text" value="{% if author.organization %}{{ author.organization }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_email" class="control-group">
                                        <label class="control-label">Email</label>

                                        <div class="controls">
                                            <input class="form-control input-sm emailinput"
                                                   id="id_creator-{{ author.order|add:"- 1" }}-email" maxlength="75" name="creator-{{ author.order|add:"- 1" }}-email"
                                                   type="email" value="{% if author.email %}{{ author.email }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_address" class="control-group">
                                        <label class="control-label">Address</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                   id="id_creator-{{ author.order|add:"- 1" }}-address" maxlength="250"
                                                   name="creator-{{ author.order|add:"- 1" }}-address"
                                                   type="text" value="{% if author.address %}{{ author.address }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_phone" class="control-group">
                                        <label class="control-label">Phone</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                   id="id_creator-{{ author.order|add:"- 1" }}-phone" maxlength="25" name="creator-{{ author.order|add:"- 1" }}-phone"
                                                   type="text" value="{% if author.phone %}{{ author.phone }}{% endif %}">
                                        </div>
                                    </div>
                                    <div id="div_id_homepage" class="control-group">
                                        <label class="control-label">Homepage</label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-homepage" maxlength="200" name="creator-{{ author.order|add:"- 1" }}-homepage"
                                                type="url" value="{% if author.homepage %}{{ author.homepage }}{% endif %}"></div>
                                    </div>
                                    <div id="div_id_order" class="control-group">
                                        <label class="control-label">Order<span class="asteriskField">*</span></label>

                                        <div class="controls"><input
                                                class="form-control input-sm urlinput"
                                                id="id_creator-{{ author.order|add:"- 1" }}-order" name="creator-{{ author.order|add:"- 1" }}-order" required="required"
                                                type="number" value="{% if author.order %}{{ author.order }}{% endif %}"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="delete-creator-dialog{{ author.id }}" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                        <h4 class="modal-title" id="myModalLabel">Delete metadata element</h4></div>
                    <div class="modal-body"><strong>Are you sure you want to delete this metadata element?</strong>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a type="button" class="btn btn-danger"
                           href="/hsapi/_internal/{{ cm.short_id }}/creator/{{ author.id }}/delete-metadata/">Delete</a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {%  block modal_publish_resource %}
            <div class="modal fade" id="submit-for-publication-dialog" tabindex="-1" role="dialog"
                 aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="submit-for-publication-title">Submit resource for publication</h4>
                        </div>
                        <div class="modal-body">
                            <p>
                                Once you submit the resource for publication it cannot be changed again. This will assign a
                                DOI to the
                                resource as it stands now and mark it as permanent. To make any changes after this, you
                                <strong>must</strong>
                                create a brand new resource. Click "Publish" if you really intend to do this.
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <a type="button" class="btn btn-danger" href="/hsapi/_internal/{{ cm.short_id }}/publish/">Publish</a>
                        </div>
                    </div>
                </div>
            </div>
        {%  endblock %}

        <div class="modal fade" id="add-source-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/source/add-metadata/" method="POST"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 class="modal-title" id="myModalLabel">Add Source</h4></div>
                        <div class="modal-body">
                            {% csrf_token %}

                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <legend>Source</legend>
                                    <div id="div_id_derived_from" class="control-group">
                                        <label for="id_derived_from" class="control-label requiredField">Derived from<span class="asteriskField">*</span></label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_derived_from" maxlength="300"
                                                                     name="derived_from" type="text">
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="add-relation-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/relation/add-metadata/"
                          method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 class="modal-title" id="myModalLabel"> Add Relation </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}

                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <legend>Relation</legend>
                                    <div id="div_id_type" class="control-group"><label for="id_type"
                                                                                       class="control-label requiredField">
                                        Relation type<span class="asteriskField">*</span></label>

                                        <div class="controls"><select class="form-control input-sm select" id="id_type"
                                                                      name="type">
                                            <option value="" selected="selected">---------</option>
                                            <option value="isPartOf">Part Of</option>
                                            <option value="isExecutedBy">Executed By</option>
                                            <option value="isCreatedBy">Created By</option>
                                            <option value="isVersionOf">Version Of</option>
                                            <option value="isDataFor">Data For</option>
                                            <option value="cites">Cites</option>
                                        </select></div>
                                    </div>
                                    <div id="div_id_value" class="control-group"><label for="id_value"
                                                                                        class="control-label requiredField">
                                        Related to<span class="asteriskField">*</span></label>

                                        <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                     id="id_value" maxlength="500" name="value"
                                                                     type="text"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {% block modal_delete_resource %}
            <div class="modal fade" id="delete-resource-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="delete-resource-title">Delete Resource</h4>
                        </div>
                        <div class="modal-body">
                            <strong>THIS IS A PERMANENT ACTION. </strong>
                            <ul>
                                <li>This will delete the resource file.</li>
                                <li>A copy of your resource file will not be retained by Hydroshare.</li>
                                <li>We highly recommend that you download the latest copy of your resource file before
                                    confirming this action.
                                </li>
                            </ul>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                            <a type="button" class="btn btn-danger"
                               href="/hsapi/_internal/{{ cm.short_id }}/delete-resource/">Delete</a>
                        </div>
                    </div>
                </div>
            </div>
        {%  endblock %}

        <div class="modal fade" id="add-dcterm-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/add-metadata/">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Add metadata term</h4>
                        </div>
                        <div class="modal-body">
                            {% csrf_token %}

                            {{ dcterm_frm|crispy }}

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="add-reference-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/add-citation/">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">Add reference</h4>
                        </div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                <label for="add-citation-input">Citation text:</label>
                                <textarea class="form-control" name="content" id="add-citation-input" cols="30"
                                          rows="10"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="add-creator-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/creator/add-metadata/" method="POST"
                          enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 class="modal-title" id="myModalLabel"> Add author </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <div id="div_id_name" class="control-group">
                                        <label for="id_name" class="control-label requiredField">Name<span class="asteriskField">*</span></label>

                                        <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                     id="id_name" maxlength="100" name="name"
                                                                     required="required" type="text"></div>
                                    </div>
                                    <div id="div_id_description" class="control-group">
                                        <label for="id_description" class="control-label">HydroShare User Identifier (URL)</label>
                                        <div class="controls"><input class="form-control input-sm urlinput"
                                                                     id="id_description" maxlength="200"
                                                                     name="description" type="url"></div>
                                    </div>
                                    <div id="div_id_organization" class="control-group">
                                        <label for="id_organization" class="control-label">Organization</label>
                                        <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                     id="id_organization" maxlength="200"
                                                                     name="organization" type="text"></div>
                                    </div>
                                    <div id="div_id_email" class="control-group">
                                        <label for="id_email" class="control-label">Email</label>

                                        <div class="controls">
                                            <input class="form-control input-sm emailinput"
                                                                     id="id_email" maxlength="75" name="email"
                                                                     type="email">
                                        </div>
                                    </div>
                                    <div id="div_id_address" class="control-group">
                                        <label for="id_address" class="control-label">Address</label>
                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_address" maxlength="250" name="address"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_phone" class="control-group">
                                        <label for="id_phone"class="control-label">Phone</label>
                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_phone" maxlength="25" name="phone"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_homepage" class="control-group">
                                        <label for="id_homepage" class="control-label">Homepage</label>
                                        <div class="controls"><input class="form-control input-sm urlinput"
                                                                     id="id_homepage" maxlength="200" name="homepage"
                                                                     type="url"></div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade in" id="add-contributor-dialog" tabindex="-1" role="dialog"
             aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form action="/hsapi/_internal/{{ cm.short_id }}/contributor/add-metadata/"
                          method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input name="resource-mode" type="hidden" value="edit">

                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                            <h4 class="modal-title" id="myModalLabel"> Add Contributor </h4></div>
                        <div class="modal-body">
                            {% csrf_token %}
                            <div class="form-group">
                                {% csrf_token %}
                                <fieldset>
                                    <div id="div_id_name" class="control-group">
                                        <label for="id_name" class="control-label requiredField">Name<span class="asteriskField">*</span></label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_name" maxlength="100" name="name"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_description" class="control-group">
                                        <label for="id_description" class="control-label">HydroShare User Identifier (URL)</label>

                                        <div class="controls">
                                            <input class="form-control input-sm urlinput"
                                                                     id="id_description" maxlength="200"
                                                                     name="description" type="url">
                                        </div>
                                    </div>
                                    <div id="div_id_organization" class="control-group">
                                        <label for="id_organization" class="control-label">Organization</label>

                                        <div class="controls"><input class="form-control input-sm textinput textInput"
                                                                     id="id_organization" maxlength="200"
                                                                     name="organization" type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_email" class="control-group">
                                        <label for="id_email" class="control-label">Email</label>

                                        <div class="controls">
                                            <input class="form-control input-sm emailinput"
                                                                     id="id_email" maxlength="75" name="email"
                                                                     type="email">
                                        </div>
                                    </div>
                                    <div id="div_id_address" class="control-group">
                                        <label for="id_address" class="control-label">Address</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_address" maxlength="250" name="address"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_phone" class="control-group">
                                        <label for="id_phone" class="control-label">Phone</label>

                                        <div class="controls">
                                            <input class="form-control input-sm textinput textInput"
                                                                     id="id_phone" maxlength="25" name="phone"
                                                                     type="text">
                                        </div>
                                    </div>
                                    <div id="div_id_homepage" class="control-group">
                                        <label for="id_homepage" class="control-label">Homepage</label>

                                        <div class="controls">
                                            <input class="form-control input-sm urlinput"
                                                                     id="id_homepage" maxlength="200" name="homepage"
                                                                     type="url">
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal -->
        {%  block modal_add_file %}
            <div class="modal fade" id="add-file-dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="/hsapi/_internal/{{ cm.short_id }}/add-file-to-resource/" method="POST"
                              enctype="multipart/form-data">

                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="myModalLabel">Add file to resource</h4>
                            </div>
                            <div class="modal-body">
                                {% csrf_token %}
                                <div class="form-group">
                                    <label for="add-file-input">Select files:</label>
                                    <input type="file" name="files" id="add-file-input" multiple/>
                                </div>
                                <div id="file-types">Any file type can be uploaded.</div>
                                <div id="file-multiple">Multiple file upload is allowed.</div>
                                <br>
                                <h3 style="color: red" id="file-type-error"></h3>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Save changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {%  endblock %}
        {%  endblock %}
    {% endwith %}

    {% block extra_js %}
    <script type="text/javascript">
    function onRemoveKeyword(event){
        $($(this).closest(".tags").parent().find(".btn-primary")[0]).show();    // Show save button
        $(event.target).closest(".tag").remove();
        updateKeywords();
        return false;
    }

    function onAddKeyword(event){
        var keyword = $("#txt-keyword").val();
        keyword = keyword.split(",");

        for (var i = 0; i < keyword.length; i++){
            keyword[i] = keyword[i].trim(); // Remove leading and trailing whitespace
            var exists = false;
            // Check if the keyword already exists
            for (var x = 0; x < $("#lst-tags").find(".tag > span").length; x++){
                if ($($("#lst-tags").find(".tag > span")[x]).text() == keyword[i]){
                    exists = true;
                }
            }

            // If does not exist, add it
            if(!exists && keyword[i] != ""){
                var li = $("<li class='tag'><span></span></li>");
                li.find('span').text(keyword[i]);
                li.append('&nbsp;<a><span class="glyphicon glyphicon-remove-circle icon-remove"></span></a>')
                $("#lst-tags").append(li);

                $(".icon-remove").click(onRemoveKeyword);
                $(this).closest("form-control").find("button").show();
                updateKeywords();
            }
        }

        $("#txt-keyword").val("");  // Clear text input
        return false;
    }

    function updateKeywords(){
        var keywords = "";
        var count = $("#lst-tags").find(".tag > span").length;
        for (var x = 0; x < count; x++){
            keywords += $($("#lst-tags").find(".tag > span")[x]).text();
            if (x != count - 1){
                keywords +=  ",";
            }
        }

        $("#id-subject").find("#id_value").val(keywords);
    }

    function metadata_update_ajax_submit(form_id){
            $alert_success = '<div class="alert alert-success" id="success-alert"> \
                <button type="button" class="close" data-dismiss="alert">x</button> \
                <strong>Success! </strong> \
                Metadata updated.\
            </div>'
            $alert_error = '<div class="alert alert-danger" id="error-alert"> \
                <button type="button" class="close" data-dismiss="alert">x</button> \
                <strong>Error! </strong> \
                Metadata updated failed.\
            </div>'
            $form=$('#' + form_id);
            var datastring = $form.serialize();
            $.ajax({
                type: "POST",
                url: $form.attr('action'),
                dataType: 'html',
                data: datastring,
                success: function(result)
                {
                    /* The div contains now the updated form */
                    //$('#' + form_id).html(result);
                    console.log(result);
                    json_response = JSON.parse(result);
                    console.log(json_response);
                    if (json_response.status === 'success')
                    {
                        $form.find("button").hide();
                        if (json_response.hasOwnProperty('element_id')){
                            form_update_action = $form.attr('action');
                            res_short_id = form_update_action.split('/')[3];
                            update_url = "/hsapi/_internal/" + res_short_id + "/" + json_response.element_name +"/" + json_response.element_id + "/update-metadata/"
                            $form.attr('action', update_url);
                        }
                        if (json_response.hasOwnProperty('element_name')){
                            if(json_response.element_name === 'title'){
                                $res_title = $(".section-header").find("span").first();
                                field_name_value = $res_title.text();
                                console.log(field_name_value);
                                updated_title = $form.find("#id_value").val();
                                $res_title.text(updated_title);
                            }
                        }
                        if (json_response.hasOwnProperty('metadata_status')){
                            if(json_response.metadata_status !== $('#metadata-status').text()){
                                $('#metadata-status').text(json_response.metadata_status);
                                if(json_response.metadata_status == "Sufficient to make public")
                                {
                                    customAlert("Metadata Status:Sufficient to make public", 3000);
                                    $('#metadata-status').removeClass('text-danger');
                                    $('#metadata-status').addClass('text-success');
                                    $('#id_sharing #make-public').remove();
                                    $('#id_sharing').append('<input name="t" type="hidden" value="make_public"/><button id="make-public" type="submit" class="btn btn-danger">Make public</button>');
                                }
                                else{
                                    $('#metadata-status').removeClass('text-success');
                                    $('#metadata-status').addClass('text-danger');
                                    $('#id_sharing #make-public').hide();
                                    $('#id_sharing #make-private').hide();
                                    $('#sharing-status').text('Private');
                                }
                            }
                        }
                        $('body > .container').append($alert_success);
                        $('#error-alert').each(function(){
                            this.remove();
                        });
                        $(".alert-success").fadeTo(2000, 500).fadeOut(1000, function(){
                            $(".alert-success").alert('close');
                        });
                    }
                    else{
                        $('body > .container').append($alert_error);
                        $(".alert-danger").fadeTo(3000, 500).fadeOut(1000, function(){
                            $(".alert-danger").alert('close');
                        });
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown)
                {
                    $('#' + form_id).before($alert_error)
                    $(".alert-error").fadeTo(2000, 500).slideUp(1000, function(){
                        $(".alert-error").alert('close');
                    });
                }
            });
        //don't submit the form
        return false;
    }

    function customAlert(msg,duration){
        var el = document.createElement("div");
        var top = ($(window).height() / 2) - 25;
        var left = ($(window).width() / 2) - 150;
        var style = "position:fixed;top:" + top + "px;left:" + left + "px;background-color:lightgreen; width:300px; height:50px; text-align:center; line-height:50px";
        el.setAttribute("style",style);
        el.innerHTML = msg;
        setTimeout(function(){
        el.parentNode.removeChild(el);
    },duration);
        document.body.appendChild(el);
    }
    $(document).ready(function () {
        var keywordString = "{% for k, v in subjects_form.initial.iteritems  %}{{ v }}{% endfor %}";
        $("#id-subject").find("#id_value").val(keywordString);

        // Populate keywords field
        var keywords = keywordString.split(",");
        $("#lst-tags").empty();
        for (var i = 0; i < keywords.length; i++){
            if (keywords[i] != ""){
                var li = $("<li class='tag'><span></span></li>");
                li.find('span').text(keywords[i]);
                li.append('&nbsp;<a><span class="glyphicon glyphicon-remove-circle icon-remove"></span></a>')
                $("#lst-tags").append(li);
            }
        }

        $(".icon-remove").click(onRemoveKeyword);
        $("#btn-add-keyword").click(onAddKeyword);
        $("#txt-keyword").keyup(function(e){
             e.which = e.which || e.keyCode;
            if(e.which == 13) {
                onAddKeyword();
            }
        });

        // hide add file button if necessary
        var file_count = $("#file-count").attr('value');
        //set allowed file types
        var file_types = $("#supported-file-types").attr('value');
        console.log(file_types)
        if(file_types!= ".*"){
            var display_file_types = file_types.substring(0, file_types.length-2) + ').'
            $("#file-types").text("Only the listed file types can be uploaded: " + display_file_types);
        }
        else{
           $("#file-types").text("Any file type can be uploaded.");
        }
        // set if multiple file can be uploaded
        var allow_multiple_file_upload = $("#allow-multiple-file-upload").attr('value');
        if(allow_multiple_file_upload === "True"){
            $("#file-multiple").text("Multiple file upload is allowed.");
            $("#btn-add-file").attr('multiple', 'multiple');
            $("#add-file-input").attr('multiple', 'multiple');
        }
        else{
            $("#file-multiple").text("Only one file can be uploaded.");
            $("#btn-add-file").removeAttr('multiple');
            $("#add-file-input").removeAttr('multiple');
            if(file_count > 0){
                $("#btn-add-file").hide();
            }
        }
        // hide add file button if file upload is not allowed for the resource type
        if(file_types == "()"){
            $("#btn-add-file").hide();
        }

        // file upload validation when file is selected for upload
        $('#add-file-input').on('change', function() {
            var file_types = $("#supported-file-types").attr('value');
            if(file_types!= ".*"){
                file_types = file_types.substring(1,file_types.length - 1).split(",");
            }
            else{
               $("#file-types").text("Any file type can be uploaded.");
                return;
            }
            var fileList = this.files || []
            var ext = ".*";
            for (var i = 0; i < fileList.length; i++) {
                ext = fileList[i].name.match(/\.([^\.]+)$/)[1];
                ext = "'." + ext +"'";
                var ext_found = false;
                if (ext === file_types) {
                    ext_found = true;
                }
                else {
                    var index;
                    for (index = 0; index < file_types.length; index++) {
                        if (ext === file_types[index].trim()) {
                            ext_found = true;
                            break;
                        }
                    }
                }
                if (!ext_found) {
                    //remove user selected files
                    this.value = '';
                    var err_msg = 'Invalid file type: ' + ext;
                    $('#file-type-error').text(err_msg);
                    //alert('Invalid file type:' + ext)
                }
                else{
                    $('#file-type-error').text('');
                }
            }
        });
        if($("#id_type_1").is(':checked')){ //box type coverage
             $("#div_id_north").hide();
             $("#div_id_east").hide();
             $("#div_id_elevation").hide();
        }
        if($("#id_type_2").is(':checked')){ // point type coverage
            $("#div_id_northlimit").hide();
            $("#div_id_eastlimit").hide();
            $("#div_id_southlimit").hide();
            $("#div_id_westlimit").hide();
            $("#div_id_uplimit").hide();
            $("#div_id_downlimit").hide();
        }
        if ($("input:button[value='Delete creator']").length == 1){
            $("input:button[value='Delete creator']").first().hide();
        }
        // disable all save changes button on load
        $("form").each(function(){
            $save_button = $(this).find("button").first();
            if ($save_button.text() === "Save changes"){
                $save_button.hide();
            }
        })
        // open all metadata collasible elements on page load
{#        $('.accordion-body:not(".in")').collapse('show');#}
        $("#select_license").on('change', function () {
            var value = this.value;
            if (value === "other") {
                $(this).closest("form").find("#id_statement").first().text("");
                $(this).closest("form").find("#id_url").first().attr('value', "");
                $(this).closest("form").find("#id_statement").first().attr('readonly', false);
                $(this).closest("form").find("#id_url").first().attr('readonly', false);
                $("#img-badge").first().hide();
            }
            else {
                var text = $(this).find('option:selected').text();
                text = "This resource is shared under the " + text + ".";
                $(this).closest("form").find("#id_statement").first().text(text);
                $(this).closest("form").find("#id_url").first().attr('value', value);
                $(this).closest("form").find("#id_statement").first().attr('readonly', true);
                $(this).closest("form").find("#id_url").first().attr('readonly', true);
                $("#img-badge").first().show();
                if (text == "This resource is shared under the Creative Commons Attribution CC BY."){
                    $(this).closest("form").find("#img-badge").first().attr('src',"{{ STATIC_URL }}img/cc-badges/CC-BY.png");
                    $(this).closest("form").find("#img-badge").first().attr('alt',"CC-BY");
                }
                else if (text == "This resource is shared under the Creative Commons Attribution-ShareAlike CC BY-SA."){
                    $(this).closest("form").find("#img-badge").first().attr('src',"{{ STATIC_URL }}img/cc-badges/CC-BY-SA.png");
                    $(this).closest("form").find("#img-badge").first().attr('alt',"CC-BY-SA");
                }
                else if (text == "This resource is shared under the Creative Commons Attribution-NoDerivs CC BY-ND."){
                    $(this).closest("form").find("#img-badge").first().attr('src',"{{ STATIC_URL }}img/cc-badges/CC-BY-ND.png");
                    $(this).closest("form").find("#img-badge").first().attr('alt',"CC-BY-ND");
                }
                else if (text == "This resource is shared under the Creative Commons Attribution-NoCommercial-ShareAlike CC BY-NC-SA."){
                    $(this).closest("form").find("#img-badge").first().attr('src',"{{ STATIC_URL }}img/cc-badges/CC-BY-NC-SA.png");
                    $(this).closest("form").find("#img-badge").first().attr('alt',"CC-BY-NC-SA");
                }
                else if (text == "This resource is shared under the Creative Commons Attribution-NoCommercial CC BY-NC."){
                    $(this).closest("form").find("#img-badge").first().attr('src',"{{ STATIC_URL }}img/cc-badges/CC-BY-NC.png");
                    $(this).closest("form").find("#img-badge").first().attr('alt',"CC-BY-NC");
                }
                else if (text == "This resource is shared under the Creative Commons Attribution-NoCommercial-NoDerivs CC BY-NC-ND."){
                    $(this).closest("form").find("#img-badge").first().attr('src',"{{ STATIC_URL }}img/cc-badges/CC-BY-NC-ND.png");
                    $(this).closest("form").find("#img-badge").first().attr('alt',"CC-BY-NC-ND");
                }
            }
        });
        // set the selected license in the select license dropdown
        var value_exists = false;
        $("#select_license option").each(function(){
            if (this.value == $("#id_url").attr('value')){
                $("#select_license").val($("#id_url").attr('value'));
                value_exists = true;
                return;
            }
        })
         if (value_exists == false) {
            // set the selected license type to 'other'
            $("#select_license").val('other');
{#            console.log($("#select_license").attr('readonly'));#}
            if ($("#select_license").attr('readonly') == undefined) {
                $("#select_license").closest("form").find("#id_statement").first().attr('readonly', false);
                $("#select_license").closest("form").find("#id_url").first().attr('readonly', false);
                $("#img-badge").first().hide();
            }
            else {
                $("#select_license").attr('style', "background-color:white;");
                $("#select_license").closest("form").find("#id_statement").first().attr('readonly', true);
                $("#select_license").closest("form").find("#id_url").first().attr('readonly', true);
            }
        }
        // show "Save changes" button when form editing starts
        $(".form-control").each(function(){
            $(this).on('input', function(e){
                //$(this).css('border-color', 'gray');
                $(this).closest("form").find("button").show();
            });
            $(this).on('change', function(e){
                //$(this).css('border-color', 'gray');
                $(this).closest("form").find("button").show();
            });
        })
        $(".dateinput").each(function(){
            $(this).datepicker({
                format: 'mm-dd-yyyy',
                changeMonth: true,
                changeYear: true
             });
            $(this).on('change', function(){
                $(this).closest("form").find("button").show();
            });
        })
        // Code adapted from http://djangosnippets.org/snippets/1389/
        function updateElementIndex(el, prefix, ndx) {
            var id_regex = new RegExp('(' + prefix + '-\\d+-)');
            var replacement = prefix + '-' + ndx + '-';
            if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex,
            replacement));
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
        }
        function deleteForm(btn, prefix) {
            var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
            if (formCount > 1) {
                // Delete the item/form
                $(btn).parents('.item').slideUp(300);
                $(btn).parents('.item').remove();
                var forms = $("#" + prefix + ' .item'); // Get all the forms
                // Update the total number of forms (1 less than before)
                $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
                var i = 0;
                // Go through the forms and set their indices, names and IDs
                for (formCount = forms.length; i < formCount; i++) {
                    $(forms.get(i)).children().children().each(function () {
                        if ($(this).attr('type') == 'text') updateElementIndex(this, prefix, i);
                        if($(this).is('input')) updateElementIndex(this, prefix, i);
                    });
                    $(forms.get(i)).find('input').each(function (){
                        updateElementIndex(this, prefix, i);
                    })
                }
            } // End if
            else {
                if (prefix == 'creators'){
                    alert("Resource needs to have at least one creator!");
                }
            }
            return false;
        }
        function addForm(btn, prefix) {
            var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
            // You can only submit a maximum of 10 todo items
            if (formCount < 10) {
                // Clone a form (without event handlers) from the first form
                var row = $("#" + prefix + " .item:first").clone(false).get(0);
                // Insert it after the last form
                $(row).removeAttr('id').hide().insertAfter("#" + prefix + " .item:last").slideDown(300);
                // Remove the bits we don't want in the new row/form
                // e.g. error messages
                $(".errorlist", row).remove();
                $(row).children().removeClass("error");
                $(row).find(".item_link:not(:first)").remove();
                // Relabel or rename all the relevant bits of the main form
                $(row).children().children().each(function () {
                    updateElementIndex(this, prefix, formCount);
                    $(this).val("");
                });
                // Relabel or rename all the relevant bits of the child form
                var link_prefix = prefix + '_links'
                $(row).find("*").each(function () {
                    updateElementIndex(this, link_prefix, formCount);
                    if ($(this).attr("id")){
                        if($(this).attr("id").substr(-6) !== "_FORMS"){
                            $(this).val("");
                        }
                        else{
                            if($(this).attr("id").substr(-11) === "TOTAL_FORMS"){
                                $(this).val("1");
                            }
                        }
                    }
                    else{
                        $(this).val("");
                    }
                });
                $(row).find('input').each(function () {
                    updateElementIndex(this, prefix, formCount);
                    if ($(this).attr('type') == 'button'){
                        if (prefix === 'creator'){
                            $(this).attr('value', 'Delete creator');
                        }
                        else if(prefix === 'contributor'){
                            $(this).attr('value', 'Delete contributor');
                        }
                        else{
                            $(this).attr('value', 'Delete');
                        }
                    }
                    if ($(this).attr('type') == 'submit'){
                        $(this).attr('value', 'Save');
                    }
                })
                // Add an event handler for the delete item/form link
                $(row).find(".delete-creator").click(function () {
                    return deleteForm(this, prefix);
                });
                $(row).find(".delete-contributor").click(function () {
                    return deleteForm(this, prefix);
                });
                $(row).find("#addLinkCreator").click(function () {
                    return addLink(this, "creator");
                });
                // Add an event handler for the delete item/form link
                $(row).find(".delete-link-creator").click(function () {
                    return deleteLink(this, prefix);
                });
                $(row).find(".delete-link-contributor").click(function () {
                    return deleteLink(this, prefix);
                });
                // Update the total form count
                $("#id_" + prefix + "-TOTAL_FORMS").val(formCount + 1);
            } // End if
            else {
                alert("Sorry, you can only enter a maximum of ten items.");
            }
            return false;
        }
        function deleteLink(btn, prefix) {
            var link_form_input = $(btn).parents('.item').children('input:first');
            var id = $(link_form_input).attr('id');
            var link_formset_index = id.split("-")[1];
            var formCount = parseInt($('#id_' + prefix + '_links-' + link_formset_index+ '-TOTAL_FORMS').val());
            if (formCount > 1) {
                // Delete the item/form
                $(btn).parents('.item_link').slideUp(300);
                $(btn).parents('.item_link').remove();
                var forms = $("#" + prefix + ' .item_link'); // Get all the forms
                // Update the total number of forms (1 less than before)
                var update_prefix = prefix + '_links-' + link_formset_index;
                $('#id_' + update_prefix + '-TOTAL_FORMS').val(forms.length);
                var i = 0;
                // Go through the forms and set their indices, names and IDs
                for (formCount = forms.length; i < formCount; i++) {
                    $(forms.get(i)).children().children().each(function () {
                        if ($(this).attr('type') == 'text') updateElementIndex(this, update_prefix, i);
                        if($(this).is('input')) updateElementIndex(this, update_prefix, i);
                    });
                    $(forms.get(i)).find('input').each(function (){
                        updateElementIndex(this, update_prefix, i);
                    })
                }
            } // End if
            return false;
        }
        function addLink(btn, prefix) {
            var link_form_input = $(btn).parents('.item').children('input:first');
            var id = $(link_form_input).attr('id');
            var link_formset_index = id.split("-")[1];
            var formCount = parseInt($('#id_' + prefix + '_links-' + link_formset_index + '-TOTAL_FORMS').val());
            // You can only submit a maximum of 10 todo items
            if (formCount < 10) {
                // Clone a form (without event handlers) from the first form
                //var row = $("#" + prefix + " .item_link:first").clone(false).get(0);
                var row = $(btn).parents(".item").find(".item_link:last").clone(false).get(0);
                // Insert it after the last form
                $(row).removeAttr('id').hide().insertAfter("#" + prefix + " .item_link:last").slideDown(300);
                // Remove the bits we don't want in the new row/form
                // e.g. error messages
                $(".errorlist", row).remove();
                $(row).children().removeClass("error");
                var update_prefix = prefix + '_links-' + link_formset_index;
                // Relabel or rename all the relevant bits
                $(row).find('*').each(function (){
                    updateElementIndex(this, update_prefix, formCount);
                    $(this).val("");
                })
                $(row).find('button').each(function () {
                    updateElementIndex(this, update_prefix, formCount);
                    if ($(this).attr('type') == 'button'){
                        $(this).text('Delete Link');
                    }
                })
                // Add an event handler for the delete item/form link
                $(row).find(".delete-link-creator").click(function () {
                    return deleteLink(this, prefix);
                });
                $(row).find(".delete-link-contributor").click(function () {
                    return deleteLink(this, prefix);
                });
                // Update the total form count
                $("#id_" + update_prefix + "-TOTAL_FORMS").val(formCount + 1);
            } // End if
            else {
                alert("Sorry, you can only enter a maximum of ten links.");
            }
            return false;
        }
        // Register the click event handlers
{#        $("#addCreator").click(function () {#}
{#            return addForm(this, "creator");#}
{#        });#}
{#        $(".delete-creator").click(function () {#}
{#            return deleteForm(this, "creator");#}
{#        });#}
{#        $("#addContributor").click(function () {#}
{#            return addForm(this, "contributor");#}
{#        });#}
{#        $("#addLinkCreator").click(function () {#}
{#            return addLink(this, "creator");#}
{#        });#}
{#        $(".delete-contributor").click(function () {#}
{#            return deleteForm(this, "contributors");#}
{#        });#}
{#        $(".delete-link-contributor").click(function () {#}
{#            return deleteLink(this, "contributors");#}
{#        });#}
{#        $(".delete-link-creator").click(function () {#}
{#            return deleteLink(this, "creator");#}
{#        });#}
{#        $("#addSource").click(function () {#}
{#            return addForm(this, "source");#}
{#        });#}
        $("form input:radio").change(function () {
            if ($(this).val() == "point") {
                //alert('you select the point radio button');
                $("#div_id_north").show();
                $("#div_id_east").show();
                $("#div_id_elevation").show();
                $("#div_id_northlimit").hide();
                $("#div_id_eastlimit").hide();
                $("#div_id_southlimit").hide();
                $("#div_id_westlimit").hide();
                $("#div_id_uplimit").hide();
                $("#div_id_downlimit").hide();
            }
            else {
                //alert('you select the box radio button');
                $("#div_id_north").hide();
                $("#div_id_east").hide();
                $("#div_id_elevation").hide();
                $("#div_id_northlimit").show();
                $("#div_id_eastlimit").show();
                $("#div_id_southlimit").show();
                $("#div_id_westlimit").show();
                $("#div_id_uplimit").show();
                $("#div_id_downlimit").show();
            }
        });
    });
    </script>
{% endblock %}

{% endblock %}
