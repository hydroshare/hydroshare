{% extends "pages/page.html" %}

{% load geoanalytics_tags mezzanine_tags pages_tags hydroshare_tags crispy_forms_tags%}

{% block title %}

    Create Resource

{% endblock %}

{% block main %}

    <h2>Upload files to create a new Resource:</h2>

    <ul>
    <li>All of the files you upload here will be grouped together into a "Resource"</li>
    <li>File size is limited to 4 GB per file</li>
    <li>Once you've added all of your files, you can describe your Resource using the form below</li>
    <li>Files are private, until you choose to share them</li>
    </ul>

<h3>Add your files here:</h3>

<form class="form-horizontal" role="form" method="POST" enctype="multipart/form-data" action="/hsapi/_internal/create-resource/">
    {% csrf_token %}
    <table class="table" id="file-list">
    <tbody id="files">
        <tr>
            <td><input type="file" name="files" id="" multiple/></td>
        </tr>
    </tbody>
    </table>

    <h2 style="color:red">{{ file_size_error }}</h2>

    <h2>Describe your Resource with metadata:</h2>

    <p>Use this form to create metadata for your Resource. Be as descriptive as you can since all of this information
        will show up when your Resource is displayed. You can edit this information later.
    </p>

  <h3>Add your metadata here:</h3>
  <div class="form-group">
    <label for="" class="col-sm-2 control-label">Resource Type</label>
    <div class="col-sm-10">
        <select class="form-control" name="resource-type" id="resource-type">
            <option value="GenericResource">Generic Resource</option>
            <option value="InstResource">RHESSys Instance Resource</option>
            <option value="TimeSeriesResource">Time Series Resource</option>
        </select>
    </div>
  </div>

{#  <div class="form-group">#}
{#    <label for="" class="col-sm-2 control-label">Title</label>#}
{#    <div class="col-sm-10">#}
{#      <input type="text" class="form-control" name="title" id="" placeholder="Title">#}
{#    </div>#}
{#  </div>#}

{#  <div class="form-group">#}
{#    <label for="" class="col-sm-2 control-label">Creators</label>#}
{#    <div class="col-sm-10">#}
{#      <input type="text" class="form-control" name="creators" id="" placeholder="Creators" value="{{ user|best_name }}">#}
{#    </div>#}
{#  </div>#}

    <div class="form-group">
        <label for="" class="col-sm-2 control-label">Science Metadata</label>
        <div class="col-sm-10">
{#            {{ creator_formset.management_form }}#}
            {% crispy metadata_form %}

        </div>
    </div>

{#   <div class="form-group">#}
{#        <label for="" class="col-sm-2 control-label">Creators</label>#}
{#        <div class="col-sm-10">#}
{#            {{ creator_formset.management_form }}#}
{#            {% crispy creator_formset creator_helper %}#}
{##}
{#        </div>#}
{#   </div>#}
{#    <div class="form-group">#}
{#       <label for="" class="col-sm-2 control-label">Contributors</label>#}
{#        <div class="col-sm-10">#}
{#            {{ contributor_formset.management_form }}#}
{#            {% for form in contributor_formset %}#}
{#                {{ form|crispy }}#}
{#            {% endfor %}#}
{#        </div>#}
{#   </div>#}


{#   <div class="form-group">#}
{#    <label for="" class="col-sm-2 control-label">Contributors</label>#}
{#    <div class="col-sm-10">#}
{#      <input type="text" class="form-control" name="contributors" id="" placeholder="Contributors" value="{{ user|best_name }}">#}
{#    </div>#}
{#   </div>#}

{#  <div class="form-group">#}
{#    <label for="" class="col-sm-2 control-label">Abstract</label>#}
{#    <div class="col-sm-10">#}
{#        <textarea class="mceEditor charfield" cols="40" id="" name="abstract" rows="10" placeholder="Abstract"> </textarea>#}
{#    </div>#}
{#  </div>#}

{#  <div class="form-group">#}
{#    <label for="" class="col-sm-2 control-label">Subject Keywords</label>#}
{#    <div class="col-sm-10">#}
{#      <input type="text" class="form-control" id="" name='keywords' placeholder="Keywords">#}
{#    </div>#}
{#  </div>#}

  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <button type="submit" class="btn btn-primary btn-lg btn-block">Create Resource</button>
    </div>
  </div>
</form>

{% endblock %}

{% block extra_js %}
    <script type="text/javascript">
        function deleteRow(r) {
                $(r).remove();
        }

        $(function() {
            var fileCount = 1;


            $("#add-row").click(function() {
                fileCount++;

                $("#files").append(
                    '<tr id="file' + fileCount + '">' +
                        '<td><input class="form-control" type="file" name="file' + fileCount + '"/></td>' +
                        '<td><button class="btn btn-danger btn-block deleter" onClick=\'deleteRow("#file' + fileCount + '")\'>Delete</button></td>' +
                    '</tr>'
                );
                return false;
            });
        });
        $(document).ready(function () {
        // Code adapted from http://djangosnippets.org/snippets/1389/
        function updateElementIndex(el, prefix, ndx) {
            var id_regex = new RegExp('(' + prefix + '-\\d+-)');
            var replacement = prefix + '-' + ndx + '-';
            if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex,
            replacement));
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
        }

        function deleteForm(btn, prefix) {
            var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
            if (formCount > 1) {
                // Delete the item/form
                $(btn).parents('.item').slideUp(300);
                $(btn).parents('.item').remove();
                var forms = $("#" + prefix + ' .item'); // Get all the forms
                // Update the total number of forms (1 less than before)
                $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
                var i = 0;
                // Go through the forms and set their indices, names and IDs
                for (formCount = forms.length; i < formCount; i++) {
                    $(forms.get(i)).children().children().each(function () {
                        if ($(this).attr('type') == 'text') updateElementIndex(this, prefix, i);
                        if($(this).is('input')) updateElementIndex(this, prefix, i);
                    });
                    $(forms.get(i)).find('input').each(function (){
                        updateElementIndex(this, prefix, i);
                    })
                }
            } // End if
            else {
                if (prefix == 'creators'){
                    alert("Resource needs to have at least one creator!");
                }
            }
            return false;
        }

        function addForm(btn, prefix) {
            var formCount = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
            // You can only submit a maximum of 10 todo items
            if (formCount < 10) {
                // Clone a form (without event handlers) from the first form
                var row = $("#" + prefix + " .item:first").clone(false).get(0);
                // Insert it after the last form
                $(row).removeAttr('id').hide().insertAfter("#" + prefix + " .item:last").slideDown(300);

                // Remove the bits we don't want in the new row/form
                // e.g. error messages
                $(".errorlist", row).remove();
                $(row).children().removeClass("error");
                $(row).find(".item_link:not(:first)").remove();

                // Relabel or rename all the relevant bits of the main form
                $(row).children().children().each(function () {
                    updateElementIndex(this, prefix, formCount);
                    $(this).val("");

                });

                // Relabel or rename all the relevant bits of the child form
                var link_prefix = prefix + '_links'
                $(row).find("*").each(function () {
                    updateElementIndex(this, link_prefix, formCount);
                    if ($(this).attr("id")){
                        if($(this).attr("id").substr(-6) !== "_FORMS"){
                            $(this).val("");
                        }
                        else{
                            if($(this).attr("id").substr(-11) === "TOTAL_FORMS"){
                                $(this).val("1");
                            }
                        }
                    }
                    else{
                        $(this).val("");
                    }
                });

                $(row).find('input').each(function () {
                    updateElementIndex(this, prefix, formCount);
                    if ($(this).attr('type') == 'button'){
                        if (prefix === 'creator'){
                            $(this).attr('value', 'Delete creator');
                        }
                        else if(prefix === 'contributor'){
                            $(this).attr('value', 'Delete contributor');
                        }
                        else{
                            $(this).attr('value', 'Delete');
                        }


                    }
                    if ($(this).attr('type') == 'submit'){
                        $(this).attr('value', 'Save');
                    }
                })

                // Add an event handler for the delete item/form link
                $(row).find(".delete-creator").click(function () {
                    return deleteForm(this, prefix);
                });

                $(row).find(".delete-contributor").click(function () {
                    return deleteForm(this, prefix);
                });

                $(row).find("#addLinkCreator").click(function () {
                    return addLink(this, "creator");
                });
                // Add an event handler for the delete item/form link
                $(row).find(".delete-link-creator").click(function () {
                    return deleteLink(this, prefix);
                });

                $(row).find(".delete-link-contributor").click(function () {
                    return deleteLink(this, prefix);
                });

                // Update the total form count
                $("#id_" + prefix + "-TOTAL_FORMS").val(formCount + 1);
            } // End if
            else {
                alert("Sorry, you can only enter a maximum of ten items.");
            }
            return false;
        }

        function deleteLink(btn, prefix) {
            var link_form_input = $(btn).parents('.item').children('input[id^="id_"]:first');
            var id = $(link_form_input).attr('id');
            var link_formset_index = id.split("-")[1];

            var formCount = parseInt($('#id_' + prefix + '_links-' + link_formset_index+ '-TOTAL_FORMS').val());
            if (formCount > 1) {
                // Delete the item/form
                $(btn).parents('.item_link').slideUp(300);
                $(btn).parents('.item_link').remove();
                var forms = $("#" + prefix + ' .item_link'); // Get all the forms
                // Update the total number of forms (1 less than before)
                var update_prefix = prefix + '_links-' + link_formset_index;
                $('#id_' + update_prefix + '-TOTAL_FORMS').val(forms.length);
                var i = 0;
                // Go through the forms and set their indices, names and IDs
                for (formCount = forms.length; i < formCount; i++) {
                    $(forms.get(i)).children().children().each(function () {
                        if ($(this).attr('type') == 'text') updateElementIndex(this, update_prefix, i);
                        if($(this).is('input')) updateElementIndex(this, update_prefix, i);
                    });
                    $(forms.get(i)).find('input').each(function (){
                        updateElementIndex(this, update_prefix, i);
                    })
                }
            } // End if
{#            else {#}
{#                if (prefix == 'creators'){#}
{#                    alert("Resource needs to have at least one creator!");#}
{#                }#}
{#            }#}
            return false;
        }

        function addLink(btn, prefix) {

            var link_form_input = $(btn).parents('.item').children('input[id^="id_"]:first');
            var id = $(link_form_input).attr('id');
            var link_formset_index = id.split("-")[1];
            var formCount = parseInt($('#id_' + prefix + '_links-' + link_formset_index + '-TOTAL_FORMS').val());
            // You can only submit a maximum of 10 todo items
            if (formCount < 10) {
                // Clone a form (without event handlers) from the first form
                //var row = $("#" + prefix + " .item_link:first").clone(false).get(0);
                var row = $(btn).parents(".item").find(".item_link:last").clone(false).get(0);
                // Insert it after the last form
                $(row).removeAttr('id').hide().insertAfter("#" + prefix + " .item_link:last").slideDown(300);

                // Remove the bits we don't want in the new row/form
                // e.g. error messages
                $(".errorlist", row).remove();
                $(row).children().removeClass("error");

                var update_prefix = prefix + '_links-' + link_formset_index;
                // Relabel or rename all the relevant bits
                $(row).find('*').each(function (){
                    updateElementIndex(this, update_prefix, formCount);
                    $(this).val("");
                })
{#                $(row).children().children().each(function () {#}
{#                    updateElementIndex(this, update_prefix, formCount);#}
{#                    $(this).val("");#}
{#                });#}
                $(row).find('button').each(function () {
                    updateElementIndex(this, update_prefix, formCount);
                    if ($(this).attr('type') == 'button'){
                        $(this).text('Delete Link');
                    }
{#                    if ($(this).attr('type') == 'submit'){#}
{#                        $(this).attr('value', 'Save');#}
{#                    }#}
                })

                // Add an event handler for the delete item/form link
                $(row).find(".delete-link-creator").click(function () {
                    return deleteLink(this, prefix);
                });

                $(row).find(".delete-link-contributor").click(function () {
                    return deleteLink(this, prefix);
                });

                // Update the total form count
                $("#id_" + update_prefix + "-TOTAL_FORMS").val(formCount + 1);
            } // End if
            else {
                alert("Sorry, you can only enter a maximum of ten links.");
            }
            return false;
        }

        // Register the click event handlers
        $("#addCreator").click(function () {
            return addForm(this, "creator");
        });

        $(".delete-creator").click(function () {
            return deleteForm(this, "creator");
        });

        $("#addContributor").click(function () {
            return addForm(this, "contributor");
        });

        $("#addLinkCreator").click(function () {
            return addLink(this, "creator");
        });

        $("#addLinkContributor").click(function () {
            return addLink(this, "contributor");
        });

        $(".delete-contributor").click(function () {
            return deleteForm(this, "contributor");
        });

        $(".delete-link-contributor").click(function () {
            return deleteLink(this, "contributor");
        });

        $(".delete-link-creator").click(function () {
            return deleteLink(this, "creator");
        });
    });
    </script>
{% endblock %}