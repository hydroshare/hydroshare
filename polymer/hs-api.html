<link rel="import" href="./bower_components/polymer/polymer.html">

<dom-module id="hs-api">
  <script>
    Polymer({
      is: "hs-api",

      properties: {
          baseUrl: "//localhost:8000"
      },

      /* Generics  */

      _get: function(path, eventKey) {
        fetch(this.baseUrl + path, {credentials: 'same-origin'})
          .then(function(response) {
            return response.json()
          }).then(function(body) {
            document.body.dispatchEvent(new CustomEvent(eventKey, { detail: body }));
          });
      },

      _post: function(path, payload) {
        var formdata = new FormData();

        for ( var key in payload ) {
          formdata.append(key, payload[key]);
        }

        fetch(this.baseUrl + path, {
          method: 'post',
          credentials: 'same-origin',
          body: formdata
        })
          .then(function(response) {
            return response.json()
          }).then(function(body) {
            document.body.dispatchEvent(new CustomEvent(eventKey, { detail: body }));
          });
      },

      /* API Methods */

      updateFavorite: function(e) {
        this._post('/hsapi/_internal/' + e.detail.id + '/label-resource-action/', {
          csrfmiddlewaretoken: hydroshare_globals.crsf_token,
          action: e.detail.favorited ? "CREATE": "DELETE",
          label_type: "FAVORITE"
        }, 'favorite');
      },

      getResourceList: function() { this._get("/hsapi/resource/", 'resource-list'); },


      getResourceFiles: function(e) { this._get("/hsapi/resource/"+ e.detail.id +"/files/", 'resource-files'); },

      /* Lifecycle Functions */

      ready: function() {
        document.body.addEventListener('update-favorite', this.updateFavorite.bind(this));
        document.body.addEventListener('get-resource-list', this.getResourceList.bind(this));
        document.body.addEventListener('get-resource-files', this.getResourceFiles.bind(this));
      }
    })
  </script>
</dom-module>